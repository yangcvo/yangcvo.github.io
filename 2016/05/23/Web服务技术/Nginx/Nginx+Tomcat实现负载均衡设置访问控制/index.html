<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="theme-color" content="#33474d">
	<title>Nginx+Tomcatå®ç°è´Ÿè½½å‡è¡¡è®¾ç½®è®¿é—®æ§åˆ¶ | Yancy&#39;s blog</title>
	<link rel="stylesheet" href="/css/style.css" />
	
      <link rel="alternate" href="/atom.xml" title="Yancy&#39;s blog" type="application/atom+xml">
    
</head>

<body>

	<header class="header">
		<nav class="header__nav">
			
				<a href="/" class="header__link">Home</a>
			
				<a href="/tags" class="header__link">Tags</a>
			
				<a href="/archives" class="header__link">ARCHIVES</a>
			
				<a href="/about/About" class="header__link">ABOUT</a>
			
				<a href="http://weibo.com/yangcvo" class="header__link">Weibo</a>
			
				<a href="/atom.xml" class="header__link">RSS</a>
			
		</nav>
		<h1 class="header__title"><a href="/">Yancy&#39;s blog</a></h1>
		<h2 class="header__subtitle">SIMPLICITY IS PREREQUISITE FOR  RELIABILITY</h2>
	</header>

	<main>
		<article>
	
		<h1>Nginx+Tomcatå®ç°è´Ÿè½½å‡è¡¡è®¾ç½®è®¿é—®æ§åˆ¶</h1>
	
	<div class="article__infos">
		<span class="article__date">2016-05-23</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/nginx/">nginx</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Nginx/">Nginx</a> <a class="article__tag-link" href="/tags/Web-Service/">Web Service</a>
			</span>
		
	</div>

	

	
		<h3 id="Nginx-Tomcatå®ç°è´Ÿè½½å‡è¡¡è®¾ç½®è®¿é—®æ§åˆ¶"><a href="#Nginx-Tomcatå®ç°è´Ÿè½½å‡è¡¡è®¾ç½®è®¿é—®æ§åˆ¶" class="headerlink" title="Nginx+Tomcatå®ç°è´Ÿè½½å‡è¡¡è®¾ç½®è®¿é—®æ§åˆ¶"></a>Nginx+Tomcatå®ç°è´Ÿè½½å‡è¡¡è®¾ç½®è®¿é—®æ§åˆ¶</h3><h3 id="ä¸€ã€ç¯å¢ƒå‡†å¤‡"><a href="#ä¸€ã€ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ä¸€ã€ç¯å¢ƒå‡†å¤‡"></a>ä¸€ã€ç¯å¢ƒå‡†å¤‡</h3><ul>
<li>Tomcat1ï¼š10.11.155.26</li>
<li>Tomcat2ï¼š10.11.155.41</li>
<li><p>Nginxï¼š192.168.31.154 </p>
<ul>
<li>åœ¨26å’Œ41ä¸Šåˆ†åˆ«éƒ¨ç½²ç›¸åŒçš„Tomcatç¨‹åºï¼Œä¿®æ”¹index.jspé¡µé¢ï¼ŒæŠŠå†…å®¹æ”¹ä¸ºå„è‡ªçš„IPåœ°å€.</li>
</ul>
</li>
</ul>
<h3 id="äºŒã€ä¿®æ”¹é…ç½®æ–‡ä»¶nginx-conf"><a href="#äºŒã€ä¿®æ”¹é…ç½®æ–‡ä»¶nginx-conf" class="headerlink" title="äºŒã€ä¿®æ”¹é…ç½®æ–‡ä»¶nginx.conf"></a>äºŒã€ä¿®æ”¹é…ç½®æ–‡ä»¶nginx.conf</h3><p>Nginxè´Ÿè½½å‡è¡¡ï¼Œå…¶å®ä¸»è¦å°±æ˜¯ç”¨upstreamã€serveræŒ‡ä»¤ï¼Œå†é…ä»¥æƒé‡ç­‰ç­‰å‚æ•°ã€‚å¦‚æœä¸ºäº†è®©nginxæ”¯æŒsessionå…±äº«ï¼Œè¿˜éœ€è¦é¢å¤–å¢åŠ ä¸€ä¸ªæ¨¡å—ã€‚</p>
<p>ä¸€ã€Nginxè´Ÿè½½å‡è¡¡</p>
<p>åœ¨http{â€¦}ä¸­é…ç½®ä¸€ä¸ªupstream{â€¦}ï¼Œå‚è€ƒå¦‚ä¸‹ï¼š<br>å¼•ç”¨</p>
<pre><code>upstream tomcat-account {
    server 10.11.155.26:8080 weight=1;    
    server 10.11.155.41:8080 weight=1;
}
</code></pre><p>æ¥ç€ä¿®æ”¹locationèŠ‚ç‚¹ï¼Œé…ç½®ä»£ç†ï¼š</p>
<p>å¼•ç”¨</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  10001.test.intranet;</div><div class="line">        location / &#123;</div><div class="line">           index        index.html index.php index.jsp index.htm;</div><div class="line">           proxy_pass           http://tomcat-account;</div><div class="line">           proxy_ignore_client_abort on;</div><div class="line">           proxy_redirect               off;</div><div class="line">           proxy_set_header     Host    <span class="variable">$host</span>;</div><div class="line">           proxy_set_header     X-Real-IP       <span class="variable">$remote_addr</span>;</div><div class="line">           proxy_set_header     X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">```  </div><div class="line">  </div><div class="line">è¿™é‡Œå¯ä»¥å†™è‡ªå·±çš„å†…ç½‘åŸŸåä¹Ÿå¯ä»¥å†™IP.</div><div class="line">å½“è®¿é—®æ ¹è·¯å¾„æ—¶ï¼Œä¼šè½®æ’­è·¯ç”±åˆ°ä¸¤å°æœåŠ¡å™¨ä¸Šï¼Œè‡³äºåç«¯æœåŠ¡å™¨æ˜¯tomcatè¿˜æ˜¯jettyä¹‹ç±»çš„ï¼Œéƒ½æ— æ‰€è°“ï¼Œç…§è‘«èŠ¦ç”»ç“¢å°±æ˜¯äº†ã€‚</div><div class="line"></div><div class="line">å½“ç„¶ï¼Œæœ‰çš„æœºå™¨æ€§èƒ½å¥½ï¼Œæˆ–è€…è´Ÿè½½ä½ï¼Œå¯ä»¥æ‰¿æ‹…é«˜è´Ÿè·è®¿é—®é‡ï¼Œå¯ä»¥é€šè¿‡æƒé‡ï¼ˆweightï¼‰ï¼Œæå‡è®¿é—®é¢‘ç‡ã€‚æ•°å€¼è¶Šé«˜ï¼Œè¢«åˆ†é…åˆ°çš„è¯·æ±‚æ•°è¶Šå¤šã€‚</div><div class="line"></div><div class="line"><span class="comment">#### 1ã€weightï¼ˆæƒé‡ï¼‰</span></div><div class="line">æŒ‡å®šè½®è¯¢å‡ ç‡ï¼Œweightå’Œè®¿é—®æ¯”ç‡æˆæ­£æ¯”ï¼Œç”¨äºåç«¯æœåŠ¡å™¨æ€§èƒ½ä¸å‡çš„æƒ…å†µã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œ10.0.0.88çš„è®¿é—®æ¯”ç‡è¦æ¯”10.0.0.77çš„è®¿é—®æ¯”ç‡é«˜ä¸€å€ã€‚</div><div class="line"></div><div class="line">```bash</div><div class="line">upstream linuxidc&#123; </div><div class="line">    server 10.11.155.26 weight=5; </div><div class="line">    server 10.11.155.41 weight=10; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2ã€ip-hashï¼ˆè®¿é—®ipï¼‰"><a href="#2ã€ip-hashï¼ˆè®¿é—®ipï¼‰" class="headerlink" title="2ã€ip_hashï¼ˆè®¿é—®ipï¼‰"></a>2ã€ip_hashï¼ˆè®¿é—®ipï¼‰</h4><p>æ¯ä¸ªè¯·æ±‚æŒ‰è®¿é—®ipçš„hashç»“æœåˆ†é…ï¼Œè¿™æ ·æ¯ä¸ªè®¿å®¢å›ºå®šè®¿é—®ä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œå¯ä»¥è§£å†³sessionçš„é—®é¢˜ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream favresin&#123; </div><div class="line">   ip_hash; </div><div class="line">   server 10.11.155.26:8080; </div><div class="line">   server 10.11.155.41:8080; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="3ã€fairï¼ˆç¬¬ä¸‰æ–¹ï¼‰"><a href="#3ã€fairï¼ˆç¬¬ä¸‰æ–¹ï¼‰" class="headerlink" title="3ã€fairï¼ˆç¬¬ä¸‰æ–¹ï¼‰"></a>3ã€fairï¼ˆç¬¬ä¸‰æ–¹ï¼‰</h4><p>æŒ‰åç«¯æœåŠ¡å™¨çš„å“åº”æ—¶é—´æ¥åˆ†é…è¯·æ±‚ï¼Œå“åº”æ—¶é—´çŸ­çš„ä¼˜å…ˆåˆ†é…ã€‚ä¸weightåˆ†é…ç­–ç•¥ç±»ä¼¼ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream favresin&#123;      </div><div class="line">    server 10.11.155.26:8080; </div><div class="line">    server 10.11.155.41:8080; </div><div class="line">    fair; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>serveræŒ‡ä»¤å‚æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- weight   â€”â€”æƒé‡ï¼Œæ•°å€¼è¶Šå¤§ï¼Œåˆ†å¾—çš„è¯·æ±‚æ•°å°±è¶Šå¤šï¼Œé»˜è®¤å€¼ä¸º1ã€‚</div><div class="line">- max_fails â€”â€”å¯¹è®¿é—®å¤±è´¥çš„åç«¯æœåŠ¡å™¨å°è¯•è®¿é—®çš„æ¬¡æ•°ã€‚é»˜è®¤å€¼ä¸º1ï¼Œå½“è®¾ç½®ä¸º0æ—¶å°†å…³é—­æ£€æŸ¥ã€‚</div><div class="line">- fail_timeoutâ€”â€”å¤±æ•ˆè¶…æ—¶æ—¶é—´ï¼Œå½“å¤šæ¬¡è®¿é—®å¤±è´¥åï¼Œå¯¹è¯¥èŠ‚ç‚¹æš‚åœè®¿é—®ã€‚</div><div class="line">- downâ€”â€”æ ‡è®°æœåŠ¡å™¨ä¸ºæ°¸ä¹…ç¦»çº¿çŠ¶æ€ï¼Œç”¨äºip_hashæŒ‡ä»¤ã€‚</div><div class="line">- backupâ€”â€”ä»…å½“ébackupæœåŠ¡å™¨å…¨éƒ¨å®•æœºæˆ–ç¹å¿™æ—¶å¯ç”¨ã€‚</div></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼Œå¯ä»¥è¿™æ ·é…ç½®ï¼š</p>
<p>å¼•ç”¨</p>
<pre><code>upstream tomcat {
    server 10.11.155.26:8080 weight=5;
    server 10.11.155.41:8080 weight=10;
}
</code></pre><p>åè€…åˆ†å¾—çš„è¯·æ±‚æ•°å°±ä¼šè¾ƒé«˜ã€‚</p>
<h3 id="è¯¦ç»†ç‚¹çš„è´Ÿè½½å‡è¡¡é…ç½®nginx-conf"><a href="#è¯¦ç»†ç‚¹çš„è´Ÿè½½å‡è¡¡é…ç½®nginx-conf" class="headerlink" title="è¯¦ç»†ç‚¹çš„è´Ÿè½½å‡è¡¡é…ç½®nginx.conf:"></a>è¯¦ç»†ç‚¹çš„è´Ÿè½½å‡è¡¡é…ç½®nginx.conf:</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="attribute">user</span>  www;</div><div class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="comment">#error_log  logs/error.log;</span></div><div class="line"><span class="comment">#error_log  logs/error.log  notice;</span></div><div class="line"><span class="comment">#error_log  logs/error.log  info;</span></div><div class="line"><span class="attribute">error_log</span>  /opt/logs/nginx/error.log  <span class="literal">crit</span>;</div><div class="line"></div><div class="line"><span class="comment"># pid        /usr/local/nginx/nginx.pid;</span></div><div class="line"><span class="attribute">pid</span>         /var/run/nginx.pid;</div><div class="line"></div><div class="line"><span class="attribute">worker_rlimit_nofile</span> <span class="number">1024</span>;</div><div class="line"></div><div class="line"><span class="section">events</span> &#123;</div><div class="line">    <span class="attribute">use</span> <span class="literal">epoll</span>;</div><div class="line">    <span class="attribute">worker_connections</span>  <span class="number">65535</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#è®¾å®šhttpæœåŠ¡å™¨ï¼Œåˆ©ç”¨å®ƒçš„åå‘ä»£ç†åŠŸèƒ½æä¾›è´Ÿè½½å‡è¡¡æ”¯æŒ</span></div><div class="line"><span class="section">http</span> &#123;</div><div class="line"></div><div class="line">    <span class="comment">#è®¾å®šmimeç±»å‹,ç±»å‹ç”±mime.typeæ–‡ä»¶å®šä¹‰</span></div><div class="line">    <span class="attribute">include</span>             /etc/nginx/mime.types;</div><div class="line">    <span class="attribute">default_type</span>    application/octet-stream;</div><div class="line">    </div><div class="line"> <span class="comment">#access_log  logs/access.log  main;</span></div><div class="line">    <span class="attribute">server_names_hash_bucket_size</span> <span class="number">128</span>;</div><div class="line">    <span class="attribute">client_header_buffer_size</span> <span class="number">32k</span>;</div><div class="line">    <span class="attribute">large_client_header_buffers</span> <span class="number">4</span> <span class="number">32k</span>;</div><div class="line"></div><div class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</div><div class="line">    <span class="attribute">tcp_nopush</span>  <span class="literal">on</span>;</div><div class="line">    <span class="attribute">tcp_nodelay</span> <span class="literal">on</span>;</div><div class="line"></div><div class="line">    <span class="comment">#keepalive_timeout  0;</span></div><div class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</div><div class="line"></div><div class="line">    <span class="comment">#gzip  on;</span></div><div class="line">    <span class="attribute">log_format</span> access <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></div><div class="line">                      <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></div><div class="line">                      <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">#è®¾å®šæ—¥å¿—æ ¼å¼</span></div><div class="line">    <span class="attribute">access_log</span>        /var/log/nginx/access.log;</div><div class="line"></div><div class="line">  <span class="section">server</span> &#123;</div><div class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</div><div class="line">        <span class="attribute">server_name</span>  localhost;</div><div class="line"></div><div class="line">        <span class="attribute">location</span> / &#123;</div><div class="line">            <span class="attribute">root</span>   html;</div><div class="line">            <span class="attribute">index</span>  index.html index.htm;</div><div class="line">        <span class="attribute">limit_req</span>  zone=one;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</div><div class="line">        <span class="attribute">location</span> = /50x.html &#123;</div><div class="line">            <span class="attribute">root</span>   html;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">#çœç•¥ä¸Šæ–‡æœ‰çš„ä¸€äº›é…ç½®èŠ‚ç‚¹</span></div><div class="line">    <span class="comment">#ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</span></div><div class="line"></div><div class="line">    <span class="comment">#è®¾å®šè´Ÿè½½å‡è¡¡çš„æœåŠ¡å™¨åˆ—è¡¨</span></div><div class="line">    <span class="attribute">upstream</span> tomcat-account &#123;</div><div class="line">        <span class="comment">#weigthå‚æ•°è¡¨ç¤ºæƒå€¼ï¼Œæƒå€¼è¶Šé«˜è¢«åˆ†é…åˆ°çš„å‡ ç‡è¶Šå¤§</span></div><div class="line">        <span class="attribute">server</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">8</span>.1x:<span class="number">3128</span> weight=<span class="number">5</span>;</div><div class="line">        <span class="comment">#æœ¬æœºä¸Šçš„Squidå¼€å¯3128ç«¯å£,ä¸æ˜¯å¿…é¡»è¦squid</span></div><div class="line">        <span class="attribute">server</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">8</span>.2x:<span class="number">80</span>    weight=<span class="number">1</span>;</div><div class="line">        <span class="attribute">server</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">8</span>.3x:<span class="number">80</span>    weight=<span class="number">6</span>;</div><div class="line">    &#125;</div><div class="line">        </div><div class="line">    <span class="attribute">upstream</span> mysvr2 &#123;</div><div class="line">        <span class="comment">#weigthå‚æ•°è¡¨ç¤ºæƒå€¼ï¼Œæƒå€¼è¶Šé«˜è¢«åˆ†é…åˆ°çš„å‡ ç‡è¶Šå¤§</span></div><div class="line">        <span class="attribute">server</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">8</span>.x:<span class="number">80</span>    weight=<span class="number">1</span>;</div><div class="line">        <span class="attribute">server</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">8</span>.x:<span class="number">80</span>    weight=<span class="number">6</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">#ç¬¬ä¸€ä¸ªè™šæ‹ŸæœåŠ¡å™¨</span></div><div class="line">    <span class="section">server</span> &#123;</div><div class="line">        <span class="comment">#ä¾¦å¬192.168.8.xçš„80ç«¯å£</span></div><div class="line">        <span class="attribute">listen</span>             <span class="number">80</span>;</div><div class="line">        <span class="attribute">server_name</span>    <span class="number">192</span>.<span class="number">168</span>.<span class="number">8</span>.x;</div><div class="line"></div><div class="line">        <span class="comment">#å¯¹aspxåç¼€çš„è¿›è¡Œè´Ÿè½½å‡è¡¡è¯·æ±‚</span></div><div class="line">        <span class="attribute">location</span> <span class="regexp">~ .*.aspx$</span> &#123;</div><div class="line">            <span class="comment">#å®šä¹‰æœåŠ¡å™¨çš„é»˜è®¤ç½‘ç«™æ ¹ç›®å½•ä½ç½®</span></div><div class="line">            <span class="attribute">root</span>     /root; </div><div class="line">            <span class="comment">#å®šä¹‰é¦–é¡µç´¢å¼•æ–‡ä»¶çš„åç§°</span></div><div class="line">            <span class="attribute">index</span> index.php index.html index.htm;</div><div class="line">            </div><div class="line">            <span class="comment">#è¯·æ±‚è½¬å‘mysvr å®šä¹‰çš„æœåŠ¡å™¨åˆ—è¡¨</span></div><div class="line">            <span class="attribute">proxy_pass</span>   http://tomcat-account;</div><div class="line"></div><div class="line">            <span class="comment">#ä»¥ä¸‹æ˜¯ä¸€äº›åå‘ä»£ç†çš„é…ç½®å¯åˆ é™¤.æ‰€ä»¥å¯ä»¥æŒ‰nginx+tomcat åšè´Ÿè½½å‡è¡¡å³å¯ã€‚</span></div><div class="line"></div><div class="line">            <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</div><div class="line"></div><div class="line">            <span class="comment">#åç«¯çš„WebæœåŠ¡å™¨å¯ä»¥é€šè¿‡X-Forwarded-Forè·å–ç”¨æˆ·çœŸå®IP</span></div><div class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</div><div class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line"></div><div class="line">            <span class="comment">#å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•°</span></div><div class="line">            <span class="attribute">client_max_body_size</span> <span class="number">10m</span>; </div><div class="line"></div><div class="line">            <span class="comment">#ç¼“å†²åŒºä»£ç†ç¼“å†²ç”¨æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å­—èŠ‚æ•°ï¼Œ</span></div><div class="line">            <span class="attribute">client_body_buffer_size</span> <span class="number">128k</span>;</div><div class="line"></div><div class="line">            <span class="comment">#nginxè·Ÿåç«¯æœåŠ¡å™¨è¿æ¥è¶…æ—¶æ—¶é—´(ä»£ç†è¿æ¥è¶…æ—¶)</span></div><div class="line">            <span class="attribute">proxy_connect_timeout</span> <span class="number">90</span>;</div><div class="line"></div><div class="line">            <span class="comment">#è¿æ¥æˆåŠŸåï¼Œåç«¯æœåŠ¡å™¨å“åº”æ—¶é—´(ä»£ç†æ¥æ”¶è¶…æ—¶)</span></div><div class="line">            <span class="attribute">proxy_read_timeout</span> <span class="number">90</span>;</div><div class="line"></div><div class="line">            <span class="comment">#è®¾ç½®ä»£ç†æœåŠ¡å™¨ï¼ˆnginxï¼‰ä¿å­˜ç”¨æˆ·å¤´ä¿¡æ¯çš„ç¼“å†²åŒºå¤§å°</span></div><div class="line">            <span class="attribute">proxy_buffer_size</span> <span class="number">4k</span>;</div><div class="line"></div><div class="line">            <span class="comment">#proxy_buffersç¼“å†²åŒºï¼Œç½‘é¡µå¹³å‡åœ¨32kä»¥ä¸‹çš„è¯ï¼Œè¿™æ ·è®¾ç½®</span></div><div class="line">            <span class="attribute">proxy_buffers</span> <span class="number">4</span> <span class="number">32k</span>;</div><div class="line"></div><div class="line">            <span class="comment">#é«˜è´Ÿè·ä¸‹ç¼“å†²å¤§å°ï¼ˆproxy_buffers*2ï¼‰</span></div><div class="line">            <span class="attribute">proxy_busy_buffers_size</span> <span class="number">64k</span>; </div><div class="line"></div><div class="line">            <span class="comment">#è®¾å®šç¼“å­˜æ–‡ä»¶å¤¹å¤§å°ï¼Œå¤§äºè¿™ä¸ªå€¼ï¼Œå°†ä»upstreamæœåŠ¡å™¨ä¼ </span></div><div class="line">            <span class="attribute">proxy_temp_file_write_size</span> <span class="number">64k</span>;    </div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å¸¸ç”¨æŒ‡ä»¤è¯´æ˜"><a href="#å¸¸ç”¨æŒ‡ä»¤è¯´æ˜" class="headerlink" title="å¸¸ç”¨æŒ‡ä»¤è¯´æ˜"></a>å¸¸ç”¨æŒ‡ä»¤è¯´æ˜</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line">nginxåœ¨è¿è¡Œæ—¶ä¸å…·ä½“ä¸šåŠ¡åŠŸèƒ½ï¼ˆæ¯”å¦‚httpæœåŠ¡æˆ–è€…emailæœåŠ¡ä»£ç†ï¼‰æ— å…³çš„ä¸€äº›å‚æ•°ï¼Œæ¯”å¦‚å·¥ä½œè¿›ç¨‹æ•°ï¼Œè¿è¡Œçš„èº«ä»½ç­‰ã€‚</div><div class="line"></div><div class="line">woker_processes 2</div><div class="line">åœ¨é…ç½®æ–‡ä»¶çš„é¡¶çº§mainéƒ¨åˆ†ï¼Œworkerè§’è‰²çš„å·¥ä½œè¿›ç¨‹çš„ä¸ªæ•°ï¼Œmasterè¿›ç¨‹æ˜¯æ¥æ”¶å¹¶åˆ†é…è¯·æ±‚ç»™workerå¤„ç†ã€‚è¿™ä¸ªæ•°å€¼ç®€å•ä¸€ç‚¹å¯ä»¥è®¾ç½®ä¸ºcpuçš„æ ¸æ•°grep ^processor /proc/cpuinfo | wc <span class="_">-l</span>ï¼Œä¹Ÿæ˜¯ auto å€¼ï¼Œå¦‚æœå¼€å¯äº†sslå’Œgzipæ›´åº”è¯¥è®¾ç½®æˆä¸é€»è¾‘CPUæ•°é‡ä¸€æ ·ç”šè‡³ä¸º2å€ï¼Œå¯ä»¥å‡å°‘I/Oæ“ä½œã€‚å¦‚æœnginxæœåŠ¡å™¨è¿˜æœ‰å…¶å®ƒæœåŠ¡ï¼Œå¯ä»¥è€ƒè™‘é€‚å½“å‡å°‘ã€‚</div><div class="line"></div><div class="line">worker_cpu_affinity</div><div class="line">ä¹Ÿæ˜¯å†™åœ¨mainéƒ¨åˆ†ã€‚åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œé€šè¿‡è®¾ç½®cpuç²˜æ€§æ¥é™ä½ç”±äºå¤šCPUæ ¸åˆ‡æ¢é€ æˆçš„å¯„å­˜å™¨ç­‰ç°åœºé‡å»ºå¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚å¦‚worker_cpu_affinity 0001 0010 0100 1000; ï¼ˆå››æ ¸ï¼‰ã€‚</div><div class="line"></div><div class="line">worker_connections 2048</div><div class="line">å†™åœ¨eventséƒ¨åˆ†ã€‚æ¯ä¸€ä¸ªworkerè¿›ç¨‹èƒ½å¹¶å‘å¤„ç†ï¼ˆå‘èµ·ï¼‰çš„æœ€å¤§è¿æ¥æ•°ï¼ˆåŒ…å«ä¸å®¢æˆ·ç«¯æˆ–åç«¯è¢«ä»£ç†æœåŠ¡å™¨é—´ç­‰æ‰€æœ‰è¿æ¥æ•°ï¼‰ã€‚nginxä½œä¸ºåå‘ä»£ç†æœåŠ¡å™¨ï¼Œè®¡ç®—å…¬å¼ æœ€å¤§è¿æ¥æ•° = worker_processes * worker_connections/4ï¼Œæ‰€ä»¥è¿™é‡Œå®¢æˆ·ç«¯æœ€å¤§è¿æ¥æ•°æ˜¯1024ï¼Œè¿™ä¸ªå¯ä»¥å¢åˆ°åˆ°8192éƒ½æ²¡å…³ç³»ï¼Œçœ‹æƒ…å†µè€Œå®šï¼Œä½†ä¸èƒ½è¶…è¿‡åé¢çš„worker_rlimit_nofileã€‚å½“nginxä½œä¸ºhttpæœåŠ¡å™¨æ—¶ï¼Œè®¡ç®—å…¬å¼é‡Œé¢æ˜¯é™¤ä»¥2ã€‚</div><div class="line"></div><div class="line">worker_rlimit_nofile 10240</div><div class="line">å†™åœ¨mainéƒ¨åˆ†ã€‚é»˜è®¤æ˜¯æ²¡æœ‰è®¾ç½®ï¼Œå¯ä»¥é™åˆ¶ä¸ºæ“ä½œç³»ç»Ÿæœ€å¤§çš„é™åˆ¶65535ã€‚</div><div class="line"></div><div class="line">use epoll</div><div class="line">å†™åœ¨eventséƒ¨åˆ†ã€‚åœ¨Linuxæ“ä½œç³»ç»Ÿä¸‹ï¼Œnginxé»˜è®¤ä½¿ç”¨epolläº‹ä»¶æ¨¡å‹ï¼Œå¾—ç›Šäºæ­¤ï¼Œnginxåœ¨Linuxæ“ä½œç³»ç»Ÿä¸‹æ•ˆç‡ç›¸å½“é«˜ã€‚åŒæ—¶Nginxåœ¨OpenBSDæˆ–FreeBSDæ“ä½œç³»ç»Ÿä¸Šé‡‡ç”¨ç±»ä¼¼äºepollçš„é«˜æ•ˆäº‹ä»¶æ¨¡å‹kqueueã€‚åœ¨æ“ä½œç³»ç»Ÿä¸æ”¯æŒè¿™äº›é«˜æ•ˆæ¨¡å‹æ—¶æ‰ä½¿ç”¨selectã€‚</div><div class="line"></div><div class="line">2.2.2 httpæœåŠ¡å™¨</div><div class="line"></div><div class="line">ä¸æä¾›httpæœåŠ¡ç›¸å…³çš„ä¸€äº›é…ç½®å‚æ•°ã€‚ä¾‹å¦‚ï¼šæ˜¯å¦ä½¿ç”¨keepaliveå•Šï¼Œæ˜¯å¦ä½¿ç”¨gzipè¿›è¡Œå‹ç¼©ç­‰ã€‚</div><div class="line"></div><div class="line">sendfile on</div><div class="line">å¼€å¯é«˜æ•ˆæ–‡ä»¶ä¼ è¾“æ¨¡å¼ï¼ŒsendfileæŒ‡ä»¤æŒ‡å®šnginxæ˜¯å¦è°ƒç”¨sendfileå‡½æ•°æ¥è¾“å‡ºæ–‡ä»¶ï¼Œå‡å°‘ç”¨æˆ·ç©ºé—´åˆ°å†…æ ¸ç©ºé—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚å¯¹äºæ™®é€šåº”ç”¨è®¾ä¸º onï¼Œå¦‚æœç”¨æ¥è¿›è¡Œä¸‹è½½ç­‰åº”ç”¨ç£ç›˜IOé‡è´Ÿè½½åº”ç”¨ï¼Œå¯è®¾ç½®ä¸ºoffï¼Œä»¥å¹³è¡¡ç£ç›˜ä¸ç½‘ç»œI/Oå¤„ç†é€Ÿåº¦ï¼Œé™ä½ç³»ç»Ÿçš„è´Ÿè½½ã€‚</div><div class="line"></div><div class="line">keepalive_timeout 65 : é•¿è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ˜¯ç§’ï¼Œè¿™ä¸ªå‚æ•°å¾ˆæ•æ„Ÿï¼Œæ¶‰åŠæµè§ˆå™¨çš„ç§ç±»ã€åç«¯æœåŠ¡å™¨çš„è¶…æ—¶è®¾ç½®ã€æ“ä½œç³»ç»Ÿçš„è®¾ç½®ï¼Œå¯ä»¥å¦å¤–èµ·ä¸€ç‰‡æ–‡ç« äº†ã€‚é•¿è¿æ¥è¯·æ±‚å¤§é‡å°æ–‡ä»¶çš„æ—¶å€™ï¼Œå¯ä»¥å‡å°‘é‡å»ºè¿æ¥çš„å¼€é”€ï¼Œä½†å‡å¦‚æœ‰å¤§æ–‡ä»¶ä¸Šä¼ ï¼Œ65så†…æ²¡ä¸Šä¼ å®Œæˆä¼šå¯¼è‡´å¤±è´¥ã€‚å¦‚æœè®¾ç½®æ—¶é—´è¿‡é•¿ï¼Œç”¨æˆ·åˆå¤šï¼Œé•¿æ—¶é—´ä¿æŒè¿æ¥ä¼šå ç”¨å¤§é‡èµ„æºã€‚</div><div class="line"></div><div class="line">send_timeout : ç”¨äºæŒ‡å®šå“åº”å®¢æˆ·ç«¯çš„è¶…æ—¶æ—¶é—´ã€‚è¿™ä¸ªè¶…æ—¶ä»…é™äºä¸¤ä¸ªè¿æ¥æ´»åŠ¨ä¹‹é—´çš„æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œå®¢æˆ·ç«¯æ²¡æœ‰ä»»ä½•æ´»åŠ¨ï¼ŒNginxå°†ä¼šå…³é—­è¿æ¥ã€‚</div><div class="line"></div><div class="line">client_max_body_size 10m</div><div class="line">å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•°ã€‚å¦‚æœæœ‰ä¸Šä¼ è¾ƒå¤§æ–‡ä»¶ï¼Œè¯·è®¾ç½®å®ƒçš„é™åˆ¶å€¼</div><div class="line"></div><div class="line">client_body_buffer_size 128k</div><div class="line">ç¼“å†²åŒºä»£ç†ç¼“å†²ç”¨æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å­—èŠ‚æ•°</div><div class="line">æ¨¡å—http_proxyï¼š</div><div class="line">è¿™ä¸ªæ¨¡å—å®ç°çš„æ˜¯nginxä½œä¸ºåå‘ä»£ç†æœåŠ¡å™¨çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç¼“å­˜åŠŸèƒ½ï¼ˆå¦è§æ–‡ç« ï¼‰</div><div class="line"></div><div class="line">proxy_connect_timeout 60</div><div class="line">nginxè·Ÿåç«¯æœåŠ¡å™¨è¿æ¥è¶…æ—¶æ—¶é—´(ä»£ç†è¿æ¥è¶…æ—¶)</div><div class="line">proxy_read_timeout 60</div><div class="line">è¿æ¥æˆåŠŸåï¼Œä¸åç«¯æœåŠ¡å™¨ä¸¤ä¸ªæˆåŠŸçš„å“åº”æ“ä½œä¹‹é—´è¶…æ—¶æ—¶é—´(ä»£ç†æ¥æ”¶è¶…æ—¶)</div><div class="line"></div><div class="line">proxy_buffer_size 4k</div><div class="line">è®¾ç½®ä»£ç†æœåŠ¡å™¨ï¼ˆnginxï¼‰ä»åç«¯realserverè¯»å–å¹¶ä¿å­˜ç”¨æˆ·å¤´ä¿¡æ¯çš„ç¼“å†²åŒºå¤§å°ï¼Œé»˜è®¤ä¸proxy_bufferså¤§å°ç›¸åŒï¼Œå…¶å®å¯ä»¥å°†è¿™ä¸ªæŒ‡ä»¤å€¼è®¾çš„å°ä¸€ç‚¹</div><div class="line"></div><div class="line">proxy_buffers 4 32k</div><div class="line">proxy_buffersç¼“å†²åŒºï¼Œnginxé’ˆå¯¹å•ä¸ªè¿æ¥ç¼“å­˜æ¥è‡ªåç«¯realserverçš„å“åº”ï¼Œç½‘é¡µå¹³å‡åœ¨32kä»¥ä¸‹çš„è¯ï¼Œè¿™æ ·è®¾ç½®</div><div class="line"></div><div class="line">proxy_busy_buffers_size 64k</div><div class="line">é«˜è´Ÿè·ä¸‹ç¼“å†²å¤§å°ï¼ˆproxy_buffers*2ï¼‰</div><div class="line"></div><div class="line">proxy_max_temp_file_size</div><div class="line">å½“ proxy_buffers æ”¾ä¸ä¸‹åç«¯æœåŠ¡å™¨çš„å“åº”å†…å®¹æ—¶ï¼Œä¼šå°†ä¸€éƒ¨åˆ†ä¿å­˜åˆ°ç¡¬ç›˜çš„ä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œè¿™ä¸ªå€¼ç”¨æ¥è®¾ç½®æœ€å¤§ä¸´æ—¶æ–‡ä»¶å¤§å°ï¼Œé»˜è®¤1024Mï¼Œå®ƒä¸ proxy_cache æ²¡æœ‰å…³ç³»ã€‚å¤§äºè¿™ä¸ªå€¼ï¼Œå°†ä»upstreamæœåŠ¡å™¨ä¼ å›ã€‚è®¾ç½®ä¸º0ç¦ç”¨ã€‚</div><div class="line"></div><div class="line">proxy_temp_file_write_size 64k</div><div class="line">å½“ç¼“å­˜è¢«ä»£ç†çš„æœåŠ¡å™¨å“åº”åˆ°ä¸´æ—¶æ–‡ä»¶æ—¶ï¼Œè¿™ä¸ªé€‰é¡¹é™åˆ¶æ¯æ¬¡å†™ä¸´æ—¶æ–‡ä»¶çš„å¤§å°ã€‚proxy_temp_pathï¼ˆå¯ä»¥åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼‰æŒ‡å®šå†™åˆ°å“ªé‚£ä¸ªç›®å½•ã€‚</div><div class="line"></div><div class="line">proxy_passï¼Œproxy_redirectè§ location éƒ¨åˆ†ã€‚</div><div class="line"></div><div class="line">æ¨¡å—http_gzipï¼š</div><div class="line"></div><div class="line">gzip on : å¼€å¯gzipå‹ç¼©è¾“å‡ºï¼Œå‡å°‘ç½‘ç»œä¼ è¾“ã€‚</div><div class="line">gzip_min_length 1k ï¼š è®¾ç½®å…è®¸å‹ç¼©çš„é¡µé¢æœ€å°å­—èŠ‚æ•°ï¼Œé¡µé¢å­—èŠ‚æ•°ä»headerå¤´å¾—content-lengthä¸­è¿›è¡Œè·å–ã€‚é»˜è®¤å€¼æ˜¯20ã€‚å»ºè®®è®¾ç½®æˆå¤§äº1kçš„å­—èŠ‚æ•°ï¼Œå°äº1kå¯èƒ½ä¼šè¶Šå‹è¶Šå¤§ã€‚</div><div class="line">gzip_buffers 4 16k ï¼š è®¾ç½®ç³»ç»Ÿè·å–å‡ ä¸ªå•ä½çš„ç¼“å­˜ç”¨äºå­˜å‚¨gzipçš„å‹ç¼©ç»“æœæ•°æ®æµã€‚4 16kä»£è¡¨ä»¥16kä¸ºå•ä½ï¼Œå®‰è£…åŸå§‹æ•°æ®å¤§å°ä»¥16kä¸ºå•ä½çš„4å€ç”³è¯·å†…å­˜ã€‚</div><div class="line">gzip_http_version 1.0 ï¼š ç”¨äºè¯†åˆ« http åè®®çš„ç‰ˆæœ¬ï¼Œæ—©æœŸçš„æµè§ˆå™¨ä¸æ”¯æŒ Gzip å‹ç¼©ï¼Œç”¨æˆ·å°±ä¼šçœ‹åˆ°ä¹±ç ï¼Œæ‰€ä»¥ä¸ºäº†æ”¯æŒå‰æœŸç‰ˆæœ¬åŠ ä¸Šäº†è¿™ä¸ªé€‰é¡¹ï¼Œå¦‚æœä½ ç”¨äº† Nginx çš„åå‘ä»£ç†å¹¶æœŸæœ›ä¹Ÿå¯ç”¨ Gzip å‹ç¼©çš„è¯ï¼Œç”±äºæœ«ç«¯é€šä¿¡æ˜¯ http/1.0ï¼Œæ•…è¯·è®¾ç½®ä¸º 1.0ã€‚</div><div class="line">gzip_comp_level 6 ï¼š gzipå‹ç¼©æ¯”ï¼Œ1å‹ç¼©æ¯”æœ€å°å¤„ç†é€Ÿåº¦æœ€å¿«ï¼Œ9å‹ç¼©æ¯”æœ€å¤§ä½†å¤„ç†é€Ÿåº¦æœ€æ…¢(ä¼ è¾“å¿«ä½†æ¯”è¾ƒæ¶ˆè€—cpu)</div><div class="line">gzip_types ï¼šåŒ¹é…mimeç±»å‹è¿›è¡Œå‹ç¼©ï¼Œæ— è®ºæ˜¯å¦æŒ‡å®š,â€text/htmlâ€ç±»å‹æ€»æ˜¯ä¼šè¢«å‹ç¼©çš„ã€‚</div><div class="line">gzip_proxied any ï¼š Nginxä½œä¸ºåå‘ä»£ç†çš„æ—¶å€™å¯ç”¨ï¼Œå†³å®šå¼€å¯æˆ–è€…å…³é—­åç«¯æœåŠ¡å™¨è¿”å›çš„ç»“æœæ˜¯å¦å‹ç¼©ï¼ŒåŒ¹é…çš„å‰ææ˜¯åç«¯æœåŠ¡å™¨å¿…é¡»è¦è¿”å›åŒ…å«â€Viaâ€çš„ headerå¤´ã€‚</div><div class="line">gzip_vary on ï¼š å’Œhttpå¤´æœ‰å…³ç³»ï¼Œä¼šåœ¨å“åº”å¤´åŠ ä¸ª Vary: Accept-Encoding ï¼Œå¯ä»¥è®©å‰ç«¯çš„ç¼“å­˜æœåŠ¡å™¨ç¼“å­˜ç»è¿‡gzipå‹ç¼©çš„é¡µé¢ï¼Œä¾‹å¦‚ï¼Œç”¨Squidç¼“å­˜ç»è¿‡Nginxå‹ç¼©çš„æ•°æ®ã€‚ã€‚</div><div class="line">2.2.3 serverè™šæ‹Ÿä¸»æœº</div><div class="line"></div><div class="line">httpæœåŠ¡ä¸Šæ”¯æŒè‹¥å¹²è™šæ‹Ÿä¸»æœºã€‚æ¯ä¸ªè™šæ‹Ÿä¸»æœºä¸€ä¸ªå¯¹åº”çš„serveré…ç½®é¡¹ï¼Œé…ç½®é¡¹é‡Œé¢åŒ…å«è¯¥è™šæ‹Ÿä¸»æœºç›¸å…³çš„é…ç½®ã€‚åœ¨æä¾›mailæœåŠ¡çš„ä»£ç†æ—¶ï¼Œä¹Ÿå¯ä»¥å»ºç«‹è‹¥å¹²serverã€‚æ¯ä¸ªserveré€šè¿‡ç›‘å¬åœ°å€æˆ–ç«¯å£æ¥åŒºåˆ†ã€‚</div><div class="line"></div><div class="line">listen</div><div class="line">ç›‘å¬ç«¯å£ï¼Œé»˜è®¤80ï¼Œå°äº1024çš„è¦ä»¥rootå¯åŠ¨ã€‚å¯ä»¥ä¸ºlisten *:80ã€listen 127.0.0.1:80ç­‰å½¢å¼ã€‚</div><div class="line"></div><div class="line">server_name</div><div class="line">æœåŠ¡å™¨åï¼Œå¦‚localhostã€www.example.comï¼Œå¯ä»¥é€šè¿‡æ­£åˆ™åŒ¹é…ã€‚</div><div class="line"></div><div class="line">æ¨¡å—http_stream</div><div class="line">è¿™ä¸ªæ¨¡å—é€šè¿‡ä¸€ä¸ªç®€å•çš„è°ƒåº¦ç®—æ³•æ¥å®ç°å®¢æˆ·ç«¯IPåˆ°åç«¯æœåŠ¡å™¨çš„è´Ÿè½½å‡è¡¡ï¼Œupstreamåæ¥è´Ÿè½½å‡è¡¡å™¨çš„åå­—ï¼Œåç«¯realserverä»¥ host:port options; æ–¹å¼ç»„ç»‡åœ¨ &#123;&#125; ä¸­ã€‚å¦‚æœåç«¯è¢«ä»£ç†çš„åªæœ‰ä¸€å°ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å†™åœ¨ proxy_pass ã€‚</div><div class="line"></div><div class="line">2.2.4 location</div><div class="line"></div><div class="line">httpæœåŠ¡ä¸­ï¼ŒæŸäº›ç‰¹å®šçš„URLå¯¹åº”çš„ä¸€ç³»åˆ—é…ç½®é¡¹ã€‚</div><div class="line"></div><div class="line">root /var/www/html</div><div class="line">å®šä¹‰æœåŠ¡å™¨çš„é»˜è®¤ç½‘ç«™æ ¹ç›®å½•ä½ç½®ã€‚å¦‚æœlocationURLåŒ¹é…çš„æ˜¯å­ç›®å½•æˆ–æ–‡ä»¶ï¼Œrootæ²¡ä»€ä¹ˆä½œç”¨ï¼Œä¸€èˆ¬æ”¾åœ¨serveræŒ‡ä»¤é‡Œé¢æˆ–/ä¸‹ã€‚</div><div class="line"></div><div class="line">index index.jsp index.html index.htm</div><div class="line">å®šä¹‰è·¯å¾„ä¸‹é»˜è®¤è®¿é—®çš„æ–‡ä»¶åï¼Œä¸€èˆ¬è·Ÿç€rootæ”¾</div><div class="line"></div><div class="line">proxy_pass http:/backend</div><div class="line">è¯·æ±‚è½¬å‘backendå®šä¹‰çš„æœåŠ¡å™¨åˆ—è¡¨ï¼Œå³åå‘ä»£ç†ï¼Œå¯¹åº”upstreamè´Ÿè½½å‡è¡¡å™¨ã€‚ä¹Ÿå¯ä»¥proxy_pass http://ip:portã€‚</div><div class="line"></div><div class="line">proxy_redirect off;</div><div class="line">proxy_set_header Host <span class="variable">$host</span>;</div><div class="line">proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line">proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">è¿™å››ä¸ªæš‚ä¸”è¿™æ ·è®¾ï¼Œå¦‚æœæ·±ç©¶çš„è¯ï¼Œæ¯ä¸€ä¸ªéƒ½æ¶‰åŠåˆ°å¾ˆå¤æ‚çš„å†…å®¹ï¼Œä¹Ÿå°†é€šè¿‡å¦ä¸€ç¯‡æ–‡ç« æ¥è§£è¯»ã€‚</div></pre></td></tr></table></figure>
<h3 id="è¿™é‡Œæˆ‘è´´å‡ºæˆ‘å…¬å¸ç°åœ¨Nginxå•èŠ‚ç‚¹è´Ÿè½½å‡è¡¡ä»£ç†å¯ä»¥ä½¿ç”¨ä¸‹é¢æ ¼å¼ï¼š"><a href="#è¿™é‡Œæˆ‘è´´å‡ºæˆ‘å…¬å¸ç°åœ¨Nginxå•èŠ‚ç‚¹è´Ÿè½½å‡è¡¡ä»£ç†å¯ä»¥ä½¿ç”¨ä¸‹é¢æ ¼å¼ï¼š" class="headerlink" title="è¿™é‡Œæˆ‘è´´å‡ºæˆ‘å…¬å¸ç°åœ¨Nginxå•èŠ‚ç‚¹è´Ÿè½½å‡è¡¡ä»£ç†å¯ä»¥ä½¿ç”¨ä¸‹é¢æ ¼å¼ï¼š"></a>è¿™é‡Œæˆ‘è´´å‡ºæˆ‘å…¬å¸ç°åœ¨Nginxå•èŠ‚ç‚¹è´Ÿè½½å‡è¡¡ä»£ç†å¯ä»¥ä½¿ç”¨ä¸‹é¢æ ¼å¼ï¼š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    include       mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line"></div><div class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></div><div class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></div><div class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</div><div class="line">    access_log /var/<span class="built_in">log</span>/nginx/access.log;</div><div class="line"></div><div class="line">    sendfile        on;</div><div class="line">    <span class="comment">#tcp_nopush     on;</span></div><div class="line">    <span class="comment">#keepalive_timeout  0;</span></div><div class="line">    keepalive_timeout  65;</div><div class="line">    <span class="comment">#gzip  on;</span></div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  localhost;</div><div class="line">        location / &#123;</div><div class="line">            root   html;</div><div class="line">            index  index.html index.htm;</div><div class="line">        &#125;</div><div class="line">        error_page   500 502 503 504  /50x.html;</div><div class="line">        location = /50x.html &#123;</div><div class="line">            root   html;</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line">  upstream sentry &#123;</div><div class="line">        server  120.26.164.217:9000 weight=1;</div><div class="line"></div><div class="line"> &#125;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  sentdy.ihaozhuo.com;</div><div class="line">        location / &#123;</div><div class="line">           index        index.html index.php index.jsp index.htm;</div><div class="line">           proxy_pass           http://sentry;</div><div class="line">           proxy_ignore_client_abort on;</div><div class="line">           proxy_redirect               off;</div><div class="line">           proxy_set_header     Host    <span class="variable">$host</span>;</div><div class="line">           proxy_set_header     X-Real-IP       <span class="variable">$remote_addr</span>;</div><div class="line">           proxy_set_header     X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="è®¿é—®æ§åˆ¶-allow-deny"><a href="#è®¿é—®æ§åˆ¶-allow-deny" class="headerlink" title="è®¿é—®æ§åˆ¶ allow/deny"></a>è®¿é—®æ§åˆ¶ allow/deny</h3><p>Nginx çš„è®¿é—®æ§åˆ¶æ¨¡å—é»˜è®¤å°±ä¼šå®‰è£…ï¼Œè€Œä¸”å†™æ³•ä¹Ÿéå¸¸ç®€å•ï¼Œå¯ä»¥åˆ†åˆ«æœ‰å¤šä¸ªallow,denyï¼Œå…è®¸æˆ–ç¦æ­¢æŸä¸ªipæˆ–ipæ®µè®¿é—®ï¼Œä¾æ¬¡æ»¡è¶³ä»»ä½•ä¸€ä¸ªè§„åˆ™å°±åœæ­¢å¾€ä¸‹åŒ¹é…ã€‚å¦‚ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">location /nginx-status &#123;</div><div class="line">  stub_status on;</div><div class="line">  access_log off;</div><div class="line"><span class="comment">#  auth_basic   "NginxStatus";</span></div><div class="line"><span class="comment">#  auth_basic_user_file   /usr/local/nginx-1.6/htpasswd;</span></div><div class="line"></div><div class="line">  allow 192.168.1.100;</div><div class="line">  allow 172.29.73.0/24;</div><div class="line">  deny all;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä¹Ÿå¸¸ç”¨ httpd-devel å·¥å…·çš„ htpasswd æ¥ä¸ºè®¿é—®çš„è·¯å¾„è®¾ç½®ç™»å½•å¯†ç ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment"># htpasswd -c htpasswd admin</span></div><div class="line">New passwd:</div><div class="line">Re-type new password:</div><div class="line">Adding password <span class="keyword">for</span> user admin</div><div class="line"></div><div class="line"><span class="comment"># htpasswd htpasswd admin    //ä¿®æ”¹adminå¯†ç </span></div><div class="line"><span class="comment"># htpasswd htpasswd sean    //å¤šæ·»åŠ ä¸€ä¸ªè®¤è¯ç”¨æˆ·</span></div><div class="line">è¿™æ ·å°±ç”Ÿæˆäº†é»˜è®¤ä½¿ç”¨CRYPTåŠ å¯†çš„å¯†ç æ–‡ä»¶ã€‚æ‰“å¼€ä¸Šé¢nginx-statusçš„ä¸¤è¡Œæ³¨é‡Šï¼Œé‡å¯nginxç”Ÿæ•ˆã€‚</div></pre></td></tr></table></figure>
<p>å‚è€ƒ</p>
<ul>
<li><a href="http://liuqunying.blog.51cto.com/3984207/1420556" target="_blank" rel="external">http://liuqunying.blog.51cto.com/3984207/1420556</a></li>
<li><a href="http://nginx.org/en/docs/ngx_core_module.html#worker_cpu_affinity" target="_blank" rel="external">http://nginx.org/en/docs/ngx_core_module.html#worker_cpu_affinity</a></li>
<li><a href="http://wiki.nginx.org/HttpCoreModule#sendfile" target="_blank" rel="external">http://wiki.nginx.org/HttpCoreModule#sendfile</a></li>
</ul>

	

	
		<span class="different-posts"><a href="/2016/05/23/WebæœåŠ¡æŠ€æœ¯/Nginx/Nginx+Tomcatå®ç°è´Ÿè½½å‡è¡¡è®¾ç½®è®¿é—®æ§åˆ¶/" onclick="window.history.go(-1); return false;">â¬…ï¸ Go back </a></span>

	

</article>

	</main>

	<footer class="footer">
	<div class="footer-content">
		
	      <div class="footer__element">
	<h5>Hi there,</h5>
	<p style="text-align:justify;">my name is Yancy, they know me as RadiantğŸ‘ğŸ‘. This blog is about Bi-data and my live.<br> I like ğŸŒ³ğŸŒ³ğŸŒ³</p>
</div>


	    
	      <div class="footer__element">
	<h5>Check out</h5>
	<ul class="footer-links">
		<li class="footer-links__link"><a href="/archives">Archive</a></li>
		
		  <li class="footer-links__link"><a href="/atom.xml">RSS</a></li>
	    
		<li class="footer-links__link"><a href="/about">about page</a></li>
		<li class="footer-links__link"><a href="/tags">Tags</a></li>
		<li class="footer-links__link"><a href="/categories">Categories</a></li>
	</ul>
</div>

	    

		<div class="footer-credit">
			<span>Â© 2018 Yancy | Powered by <a href="http://blog.yancy.cc/">Yancy</a> | Theme <a href="https://github.com/yangcvo">Yancy_GitHub</a></span>
		</div>

	</div>


</footer>



</body>

</html>
