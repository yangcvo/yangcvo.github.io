<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="theme-color" content="#33474d">
	<title>如何解决秒杀的性能问题和微信推广活动的讨论 | Yancy&#39;s blog</title>
	<link rel="stylesheet" href="/css/style.css" />
	
      <link rel="alternate" href="/atom.xml" title="Yancy&#39;s blog" type="application/atom+xml">
    
</head>

<body>

	<header class="header">
		<nav class="header__nav">
			
				<a href="/" class="header__link">Home</a>
			
				<a href="/tags" class="header__link">Tags</a>
			
				<a href="/archives" class="header__link">ARCHIVES</a>
			
				<a href="/about/About" class="header__link">ABOUT</a>
			
				<a href="http://weibo.com/yangcvo" class="header__link">Weibo</a>
			
				<a href="/atom.xml" class="header__link">RSS</a>
			
		</nav>
		<h1 class="header__title"><a href="/">Yancy&#39;s blog</a></h1>
		<h2 class="header__subtitle">SIMPLICITY IS PREREQUISITE FOR  RELIABILITY</h2>
	</header>

	<main>
		<article>
	
		<h1>如何解决秒杀的性能问题和微信推广活动的讨论</h1>
	
	<div class="article__infos">
		<span class="article__date">2016-11-10</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/运维笔记/">运维笔记</a>
			</span><br />
		
		
	</div>

	

	
		<p>最近业务试水微信抽奖活动，公司现在打算推广下产品。增加些粉丝量 之前经常看到淘宝的同行们讨论秒杀，讨论电商，这次终于轮到我们自己理论结合实际一次了。</p>
<p>ps：进入正文前先说一点个人感受，之前看淘宝的ppt感觉都懂了，等到自己出解决方案的时候发现还是有很多想不到的地方其实都没懂，再次验证了“细节是魔鬼”的理论。并且一个人的能力有限，只有大家一起讨论才能想的更周全，更细致。好了，闲话少说，下面进入正文。</p>
<h4 id="一、抽奖活动带来了什么？"><a href="#一、抽奖活动带来了什么？" class="headerlink" title="一、抽奖活动带来了什么？"></a>一、抽奖活动带来了什么？</h4><p>微信积分兑换现金或抢购抽奖活动一般会经过【关注公众号】【分享活动获得积分】【积分兑换】【抽奖安全环节】这3个大环节，而其中【抢订单】这个环节是最考验业务提供方的抗压能力的。</p>
<p>积分兑换环节一般会带来2个问题：</p>
<ul>
<li>1、高并发</li>
</ul>
<p>　　比较火热的抽奖在线人数都是20w起的，如此之高的在线人数对于网站架构从前到后都是一种考验。</p>
<ul>
<li>2、抽奖人员过多</li>
<li>3、 抢订单</li>
</ul>
<p>　　任何商品都会有数量上限，如何避免成功下订单买到商品的人数不超过商品数量的上限，这是每个抢购活动都要面临的难题。</p>
<h4 id="二、如何解决？"><a href="#二、如何解决？" class="headerlink" title="二、如何解决？"></a>二、如何解决？</h4><p>首先，产品解决方案我们就不予讨论了。我们只讨论技术解决方案</p>
<p><strong>1、前端架构</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">面对高并发的抢购活动，前端常用的三板斧是【扩容】【静态化】【限流】</div><div class="line"></div><div class="line">　　A：扩容</div><div class="line">　　</div><div class="line">　加机器，这是最简单的方法，通过增加前端池的整体承载量来抗峰值。 </div><div class="line">　这里我们都是多台主从集群去跑。</div><div class="line"></div><div class="line">　　B：静态化</div><div class="line"></div><div class="line">　　将活动页面上的所有可以静态的元素全部静态化，并尽量减少动态元素。通过CDN来抗峰值。</div><div class="line">　　这里我们都是把图片静态放在又拍云和阿里云上面。</div><div class="line">　</div><div class="line">　　C：限流</div><div class="line"></div><div class="line">　　一般都会采用IP级别的限流，即针对某一个IP，限制单位时间内发起请求数量。</div><div class="line">　　或者活动入口的时候增加游戏或者问题环节进行消峰操作。</div><div class="line">　　我们采用Nginx前面做了反向代理后面优化nginx。</div><div class="line">　　</div><div class="line">　　D：有损服务</div><div class="line"></div><div class="line">　　最后一招，在接近前端池承载能力的水位上限的时候，随机拒绝部分请求来保护活动整体的可用性。</div></pre></td></tr></table></figure>
<p><strong>2、后端架构</strong></p>
<p>那么后端的数据库在高并发和超卖下会遇到什么问题呢？主要会有如下3个问题：（主要讨论写的问题，读的问题通过增加cache可以很容易的解决）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">　　I：　首先MySQL自身对于高并发的处理性能就会出现问题，一般来说，MySQL的处理性能会随着并发thread上升而上升，但是到了一定的并发度之后会出现明显的拐点，之后一路下降，最终甚至会比单thread的性能还要差。</div><div class="line"></div><div class="line">　　II： 其次，超卖的根结在于减库存操作是一个事务操作，需要先<span class="keyword">select</span>，然后<span class="keyword">insert</span>，最后<span class="keyword">update</span> <span class="number">-1</span>。最后这个<span class="number">-1</span>操作是不能出现负数的，但是当多用户在有库存的情况下并发操作，出现负数这是无法避免的。</div><div class="line"></div><div class="line">　　III：最后，当减库存和高并发碰到一起的时候，由于操作的库存数目在同一行，就会出现争抢<span class="keyword">InnoDB</span>行锁的问题，导致出现互相等待甚至死锁，从而大大降低MySQL的处理性能，最终导致前端页面出现超时异常。</div><div class="line">　　</div><div class="line">　　这个有遇到过的，就是锁表导致访问出现网络异常。</div></pre></td></tr></table></figure>
<p>针对上述问题，如何解决呢？ 我们先看眼淘宝的高大上解决方案：</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">I：关闭死锁检测，提高并发处理性能。</div><div class="line">II：修改源代码，将排队提到进入引擎层前，降低引擎层面的并发度。</div><div class="line">III：组提交，降低<span class="keyword">server</span>和引擎的交互次数，降低IO消耗。</div></pre></td></tr></table></figure>
<h3 id="解决方案1："><a href="#解决方案1：" class="headerlink" title="解决方案1："></a>解决方案1：</h3><p>将存库从MySQL前移到Redis中，所有的写操作放到内存中，由于Redis中不存在锁故不会出现互相等待，并且由于Redis的写性能和读性能都远高于MySQL，这就解决了高并发下的性能问题。然后通过队列等异步手段，将变化的数据异步写入到DB中。</p>
<p>优点：解决性能问题<br>缺点：没有解决超卖问题，同时由于异步写入DB，存在某一时刻DB和Redis中数据不一致的风险。</p>
<h3 id="解决方案2："><a href="#解决方案2：" class="headerlink" title="解决方案2："></a>解决方案2：</h3><p>引入队列，然后将所有写DB操作在单队列中排队，完全串行处理。当达到库存阀值的时候就不在消费队列，并关闭购买功能。这就解决了超卖问题。</p>
<p>优点：解决超卖问题，略微提升性能。<br>缺点：性能受限于队列处理机处理性能和DB的写入性能中最短的那个，另外多商品同时抢购的时候需要准备多条队列。</p>
<h3 id="解决方案3："><a href="#解决方案3：" class="headerlink" title="解决方案3："></a>解决方案3：</h3><p>将写操作前移到MC中，同时利用MC的轻量级的锁机制CAS来实现减库存操作。<br>优点：读写在内存中，操作性能快，引入轻量级锁之后可以保证同一时刻只有一个写入成功，解决减库存问题。<br>缺点：没有实测，基于CAS的特性不知道高并发下是否会出现大量更新失败？不过加锁之后肯定对并发性能会有影响。</p>
<h3 id="解决方案4："><a href="#解决方案4：" class="headerlink" title="解决方案4："></a>解决方案4：</h3><p>将提交操作变成两段式，先申请后确认。然后利用Redis的原子自增操作（相比较MySQL的自增来说没有空洞），同时利用Redis的事务特性来发号，保证拿到小于等于库存阀值的号的人都可以成功提交订单。然后数据异步更新到DB中。</p>
<p>优点：解决超卖问题，库存读写都在内存中，故同时解决性能问题。<br>缺点：由于异步写入DB，可能存在数据不一致。另可能存在少买，也就是如果拿到号的人不真正下订单，可能库存减为0，但是订单数并没有达到库存阀值。</p>
<p> 三、总结</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>、前端三板斧【扩容】【限流】【静态化】</div><div class="line"><span class="number">2</span>、后端两条路【内存】+【排队】</div></pre></td></tr></table></figure>
<h4 id="测试总结经验"><a href="#测试总结经验" class="headerlink" title="测试总结经验"></a>测试总结经验</h4><p>第一次做抽奖活动，测试那边测试出很多问题。 下面是遇到的问题。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">测试第一次: 访问压测出现了访问白屏。定位：代码写的有问题。 tomcat需要做优化。 我们一般用户量粉丝在100W</div><div class="line"></div><div class="line">测试第二次： 出现数据库<span class="meta">CPU</span>瓶颈过高。主从同步，然后做了数据库读写分离， redis集群缓存。 最主要是数据库SQL语句做了优化。优化了提升了很大一部分。</div><div class="line"></div><div class="line">测试第三次：还有出现了<span class="number">503</span>访问受限了。 后面做了nginx代理 防止同一个<span class="built_in">IP</span>同一个时间超过多少次去请求，会被受限。 不过这个做DDOS攻击 有很大一部分影响用户名体验度。</div></pre></td></tr></table></figure>
<h4 id="四、非技术感想"><a href="#四、非技术感想" class="headerlink" title="四、非技术感想"></a>四、非技术感想</h4><p>1、团队的力量是无穷的，各种各样的解决方案（先不谈可行性）都是在小伙伴们七嘴八舌中讨论出来的。我们需要让所有人都发出自己的声音，不要着急去否定。<br>2、优化需要从整体层面去思考，不要只纠结于自己负责的部分，如果只盯着一个点思考，最后很可能就走进死胡同中了。<br>3、有很多东西以为读过了就懂了，其实不然。依然还是需要实践，否则别人的知识永远不可能变成自己的。<br>4、多思考为什么，会发生什么，不要想当然。只有这样才能深入进去，而不是留在表面。</p>
<h3 id="交流学习："><a href="#交流学习：" class="headerlink" title="交流学习："></a>交流学习：</h3><p>🐧  Linux shell_高级运维派: <code>459096184</code>    圈子 (系统运维-应用运维-自动化运维-虚拟化技术研究欢迎加入)<br>🐧  BigData-Exchange School : <code>521621407</code>  圈子（大数据运维)（Hadoop开发人员)（大数据研究爱好者) 欢迎加入</p>
<p>相应Bidata有内部微信交流群互相学习，加入QQ群有链接。</p>

	

	
		<span class="different-posts"><a href="/2016/11/10/运维笔记/如何解决抽奖的性能问题和秒杀的讨论  /" onclick="window.history.go(-1); return false;">⬅️ Go back </a></span>

	

</article>

	</main>

	<footer class="footer">
	<div class="footer-content">
		
	      <div class="footer__element">
	<h5>Hi there,</h5>
	<p style="text-align:justify;">my name is Yancy, they know me as Radiant🐑🐑. This blog is about Bi-data and my live.<br> I like 🌳🌳🌳</p>
</div>


	    
	      <div class="footer__element">
	<h5>Check out</h5>
	<ul class="footer-links">
		<li class="footer-links__link"><a href="/archives">Archive</a></li>
		
		  <li class="footer-links__link"><a href="/atom.xml">RSS</a></li>
	    
		<li class="footer-links__link"><a href="/about">about page</a></li>
		<li class="footer-links__link"><a href="/tags">Tags</a></li>
		<li class="footer-links__link"><a href="/categories">Categories</a></li>
	</ul>
</div>

	    

		<div class="footer-credit">
			<span>© 2019 Yancy | Powered by <a href="http://blog.yancy.cc/">Yancy</a> | Theme <a href="https://github.com/yangcvo">Yancy_GitHub</a></span>
		</div>

	</div>


</footer>



</body>

</html>
