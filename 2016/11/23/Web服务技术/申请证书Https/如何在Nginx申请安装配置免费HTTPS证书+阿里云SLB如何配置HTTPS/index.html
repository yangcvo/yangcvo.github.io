<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="null">
    <meta name="keyword"  content="undefined">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          如何在Nginx申请安装配置免费HTTPS证书+阿里云SLB如何配置HTTPS - Yancy
        
    </title>

    <link rel="canonical" href="http://blog.yancy.cc/2016/11/23/Web服务技术/申请证书Https/如何在Nginx申请安装配置免费HTTPS证书+阿里云SLB如何配置HTTPS/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Grocery store</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/ARCHIVES/archives.html">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/ABOUT/About.html">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="http://blog.yancy.cc/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#Web Service" title="Web Service">Web Service</a>
                        
                          <a class="tag" href="/tags/#Nginx" title="Nginx">Nginx</a>
                        
                    </div>
                    <h1>如何在Nginx申请安装配置免费HTTPS证书+阿里云SLB如何配置HTTPS</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by Yancy on
                        2016-11-23
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h2 id="如何在Nginx申请安装配置免费HTTPS证书"><a href="#如何在Nginx申请安装配置免费HTTPS证书" class="headerlink" title="如何在Nginx申请安装配置免费HTTPS证书"></a>如何在Nginx申请安装配置免费HTTPS证书</h2><p>HTTPS在各大互联网站已经成为标配，就连某度也在前不久全面启用HTTPS，很多小网站也配置了HTTPS，这是未来的一种趋势.HTTPS的好处多多，可以防止各种攻击劫持，运营商广告植入，客户传输信息泄露等问题。为了让HTTPS能够全面普及，让我们加密项目应运而生，它由互联网安全研究小组ISRG（互联网安全研究小组）提供服务，很早之前我就在关注 <a href="https://letsencrypt.org/" target="_blank" rel="external">Let’s Encrypt</a>这个免费、自动化、开放的证书签发服务。<br>ISRG是来自美国加利福尼亚州的一个公益组织.Let’s Encrypt得到了Mozilla，Cisco和Chrome等众多公司和机构的支持。</p>
<p>申请 <code>Let&#39;s Encrypt</code> 证书不但免费，还非常简单，虽然每次只有 90 天的有效期，但可以通过脚本定期更新，配好之后一劳永逸。本教程亲测有效，希望对正在寻找免费HTTPS方案的你有一定的帮助，本文记录本站申请过程和遇到的问题。</p>
<p>按照我们的加密官方提供的工具安装HTTPS的话与过于复杂，于是有好心人提供了更为轻巧的工具安装，极致纤巧诞生了，它的代码量在200行内，只需依赖的Python和OpenSSL的。</p>
<h3 id="第一步：创建Let’s-Encrypt加密账号"><a href="#第一步：创建Let’s-Encrypt加密账号" class="headerlink" title="第一步：创建Let’s Encrypt加密账号"></a>第一步：创建Let’s Encrypt加密账号</h3><p>首先创建一个目录，例如 <code>ssl</code>用来存放各种临时文件和最后的证书文件。进入这个目录，创建一个<code>RSA</code>私钥用于 Let’s Encrypt 识别你的身份：</p>
<p>让我们加密使用一个私钥来进行账号的创建与登陆，因此我们需要使用openssl创建一个<code>account.key</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@ihaozhuo1 srv]<span class="comment"># mkdir ssl &amp;&amp; cd ssl</span></div><div class="line">[root@ihaozhuo1 ssl]<span class="comment"># openssl genrsa 4096 &gt; account.key</span></div><div class="line">Generating RSA private key, 4096 bit long modulus</div><div class="line">...........................++</div><div class="line">...........................++</div><div class="line">e is 65537 (0x10001)</div></pre></td></tr></table></figure>
<h3 id="第二步：创建域名的CSR（证书签名请求）"><a href="#第二步：创建域名的CSR（证书签名请求）" class="headerlink" title="第二步：创建域名的CSR（证书签名请求）"></a>第二步：创建域名的CSR（证书签名请求）</h3><p>让我们加密使用的ACME协议需要一个CSR文件，可以使用它来重新申请HTTPS证书，接下来我们就可以创建域名CSR，在创建CSR之前，我们需要给我们的域名创建一个私钥（这个和上面的账户私钥无关）。<br>接着就可以生成 <code>CSR（Certificate Signing Request，证书签名请求）文件了。</code>在这之前，还需要创建域名私钥（一定不要使用上面的账户私钥），根据证书不同类型，域名私钥也可以选择 RSA 和 ECC 两种不同类型。以下两种方式请根据实际情况二选一。</p>
<p><strong>1）创建 RSA 私钥（兼容性好）：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl genrsa 4096 &gt; domain.key</div></pre></td></tr></table></figure>
<p><strong>2）注意：一定不要使用上面创建好的account.key 来当domain.key ❗️</strong></p>
<p>有了私钥文件，就可以创建生成 <code>CSR文件</code>了。在 <code>CSR</code>中推荐至少把域名带 <code>www</code> 和不带<code>www</code>的两种情况都加进去，其它子域可以根据需要添加,替换下面的ihaozhuo.com即可  <code>(目前一张证书最多可以包含 100 个域名)</code></p>
<p><strong>3）注意，稍后会说到，每个域名都会涉及到验证）</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">＃单个域名</div><div class="line"></div><div class="line">openssl req -new -sha256 -key domain.key -subj“/CN=ihaozhuo.ccom”&gt; domain.csr</div><div class="line"></div><div class="line">＃多个域名（如果你有多个域名，比如：www.ihaozhuo.com 和ihaozhuo.com，使用这种方式）</div><div class="line"></div><div class="line">openssl req -new -sha256 -key domain.key -subj <span class="string">"/"</span> -reqexts SAN -config &lt;(cat /etc/ssl/openssl.cnf &lt;(<span class="built_in">printf</span> <span class="string">"[SAN]\nsubjectAltName=DNS:ihaozhuo.com,DNS:www.ihaozhuo.com"</span>)) &gt; domain.csr</div></pre></td></tr></table></figure>
<p><strong>4）说明：ihaozhuo.com，www.ihaozhuo.com 替换成你的域名执行这一步时，需要指定openssl.cnf文件，一般这个文件在你的openssl安装目录底下。 如果提示找不到 /etc/ssl/openssl.cnf文件，请看看/usr/local/openssl/ssl/openssl.cnf 和/etc/pki/tls/openssl.cnf是否存在。</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@ihaozhuo1 ssl]<span class="comment"># find / -name openssl.cnf    ##查找openssl.cnf文件</span></div><div class="line">/etc/pki/tls/openssl.cnf</div><div class="line">[root@ihaozhuo1 ssl]<span class="comment"># ln -s /etc/pki/tls/openssl.cnf /etc/ssl/openssl.cnf    #做个软链接 </span></div><div class="line"></div><div class="line">[root@ihaozhuo1 ssl]<span class="comment"># openssl req -new -sha256 -key domain.key -subj "/" -reqexts SAN -config &lt;(cat /etc/ssl/openssl.cnf &lt;(printf "[SAN]\nsubjectAltName=DNS:ihaozhuo.com,DNS:www.ihaozhuo.com")) &gt; domain.csr</span></div></pre></td></tr></table></figure>
<p>如果还是不行，也可以使用交互方式创建<code>CSR</code>（需要注意 <code>Common Name</code>必须为你的域名）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl req -new -sha256 -key domain.key -out domain.csr</div></pre></td></tr></table></figure>
<h3 id="第三步：配置域名验证"><a href="#第三步：配置域名验证" class="headerlink" title="第三步：配置域名验证"></a>第三步：配置域名验证</h3><p>CA在签发DV（域验证）证书时，需要验证域名所有权。传统CA的验证方式一般是往<code>admin@ihaozhuo.com</code>发验验邮件，而让我们加密是在你的服务器上生成一个随机验证文件，再通过创建CSR时指定的域名访问，如果可以访问则表明你对这个域名有控制权。</p>
<p>首先创建用于存放验证文件的目录，例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir -p var/www/challenge</div></pre></td></tr></table></figure>
<p>然后配置一个<code>Nginx</code>服务，以Nginx为例:(注意：这里的端口是80，不是443）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    </div><div class="line">       listen       80;</div><div class="line">       server_name www.ihaozhuo.com ihaozhuo.com;</div><div class="line">       location /.well-known/acme-challenge/ &#123;</div><div class="line">       <span class="built_in">alias</span> /var/www/challenges/;</div><div class="line">       index  index.html index.php index.jsp index.htm;</div><div class="line">       try_files <span class="variable">$uri</span> =404;</div><div class="line">&#125;</div><div class="line">        error_page   500 502 503 504  /50x.html;</div><div class="line">        location = /50x.html &#123;</div><div class="line">            root   html;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这是我在上面配置完成以后需要重启Nginx，先<code>Nginx -t</code>校验下是否有没有问题。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@ihaozhuo1 conf]<span class="comment"># nginx -t</span></div><div class="line">nginx: the configuration file /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf syntax is ok</div><div class="line">nginx: configuration file /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf <span class="built_in">test</span> is successful</div><div class="line">``` </div><div class="line"></div><div class="line">如何验证上面设置是否成功？ 我们只要在目录：/var/www/challenges/ 下面创建文件：test.html</div><div class="line">然后通过http://www.ihaozhuo.com/.well-known/acme-challenge/test.html URL访问地址那个文件，如果能访问成功说明你配置没问题;否则就说明配置错误❌，这一步不能实现下面就不能成功了。</div><div class="line"></div><div class="line">以上配置优先查找 `var/www/challenge`目录下的文件，如果找不到就重定向到` HTTPS` 地址。这个验证服务以后更新证书还要用到，建议一直保留。</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">### 第四步：获取网站证书</span></div><div class="line"></div><div class="line">**1）上面配置好，现在我们使用acme-tiny.py来获取网站证书** acme-tiny脚本文件上Github下载：[acme-tiny.py](https://github.com/diafygi/acme-tiny)</div><div class="line"></div><div class="line">**2）先把 acme-tiny 脚本保存到之前的ssl目录**</div><div class="line">```bash</div><div class="line">wget https://raw.githubusercontent.com/diafygi/acme-tiny/master/acme_tiny.py</div></pre></td></tr></table></figure>
<p><strong>3）然后指定账户私钥、CSR 以及验证目录，执行脚本来获取网站证书</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python acme_tiny.py --account-key ./account.key --csr ./domain.csr --acme-dir /var/www/challenges/ &gt; ./signed.crt</div></pre></td></tr></table></figure>
<p><strong>4）如果一切正常，当前目录下就会生成一个<code>signed.crt</code>这就是申请好的证书文件，如果跟我一样报错了请看下面</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@ihaozhuo1 ssl]<span class="comment"># python acme_tiny.py --account-key ./account.key --csr ./domain.csr --acme-dir /var/www/challenges/ &gt; ./signed.crt</span></div><div class="line">Parsing account key...</div><div class="line">Parsing CSR...</div><div class="line">Registering account...</div><div class="line">Already registered!</div><div class="line">Verifying ihaozhuo.com...</div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"acme_tiny.py"</span>, line 198, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    main(sys.argv[1:])</div><div class="line">  File <span class="string">"acme_tiny.py"</span>, line 194, <span class="keyword">in</span> main</div><div class="line">    signed_crt = get_crt(args.account_key, args.csr, args.acme_dir, <span class="built_in">log</span>=LOGGER, CA=args.ca)</div><div class="line">  File <span class="string">"acme_tiny.py"</span>, line 123, <span class="keyword">in</span> get_crt</div><div class="line">    wellknown_path, wellknown_url))</div><div class="line">ValueError: Wrote file to /var/www/challenges/fWyC6BvCCSlVunoaltJrnEV-ewj6FBpOv7Eu8LluBUg, but couldn<span class="string">'t download http://ihaozhuo.com/.well-known/acme-challenge/fWyC6BvCCSlVunoaltJrnEV-ewj6FBpOv7Eu8LluBUg</span></div></pre></td></tr></table></figure>
<p><strong>5）脚本问题：</strong></p>
<ol>
<li>记得在网站记得域名解析要对，都是你现在申请证书这台外网解析地址： <code>http://ihaozhuo.com/</code>不通那解析就出现问题了。</li>
<li>网上也有很多人说域名DNS服务器解析导致域名不行，这个验证了以后不是的，这个是GitHub这个脚本<code>acme_tiny.py</code>问题导致的，需要编辑脚本注释掉下面全部内容即可 116行-123行：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#  try:</span></div><div class="line"> <span class="comment">#     resp = urlopen(wellknown_url)</span></div><div class="line"> <span class="comment">#    resp_data = resp.read().decode('utf8').strip()</span></div><div class="line"> <span class="comment">#   assert resp_data == keyauthorization</span></div><div class="line"> <span class="comment"># except (IOError, AssertionError):</span></div><div class="line"> <span class="comment">#    os.remove(wellknown_path)</span></div><div class="line"> <span class="comment">#   raise ValueError("Wrote file to &#123;0&#125;, but couldn't download &#123;1&#125;".format(</span></div><div class="line"> <span class="comment">#      wellknown_path, wellknown_url))</span></div></pre></td></tr></table></figure>
<p>如果修改没有用，可以到我这里下载Github下载<a href="https://github.com/yangcvo/Let-s-Encrypt" target="_blank" rel="external">acme_tiny.py</a></p>
<p><strong>6）然后保存再次获取网站证书</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@ihaozhuo1 ssl]<span class="comment"># python acme_tiny.py --account-key ./account.key --csr ./domain.csr --acme-dir /var/www/challenges/ &gt; ./signed.crt</span></div><div class="line">Parsing account key...</div><div class="line">Parsing CSR...</div><div class="line">Registering account...</div><div class="line">Already registered!</div><div class="line">Verifying ihaozhuo.com...</div><div class="line">ihaozhuo.com verified!</div><div class="line">Verifying www.ihaozhuo.com...</div><div class="line">www.ihaozhuo.com verified!</div><div class="line">Signing certificate...</div><div class="line">Certificate signed!</div></pre></td></tr></table></figure>
<p><img src="http://image.chengyangyang.com/zhengshu2.png" alt=""></p>
<p>㊗️ 如果看到如上内容，那么恭喜你，你的网站证书已经成功获取了。这时候查看目录下面有如下几个文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@ihaozhuo1 ssl]<span class="comment"># ll</span></div><div class="line">总用量 36</div><div class="line">-rw-r--r-- 1 root root 3243 3月  30 16:42 account.key</div><div class="line">drwxr-xr-x 4 root root 4096 3月  30 17:31 acme-tiny</div><div class="line">-rw-r--r-- 1 root root 9159 3月  30 19:23 acme_tiny.py</div><div class="line">-rw-r--r-- 1 root root 1639 3月  30 17:00 domain.csr</div><div class="line">-rw-r--r-- 1 root root 3243 3月  30 16:53 domain.key</div><div class="line">-rw-r--r-- 1 root root 2159 3月  30 22:11 signed.crt</div></pre></td></tr></table></figure>
<p>到目前为止我们已经成功申请到Let’sENcrpyt的网站证书，对于Nginx用户我们还需要把Let’s ENcrpyt的中间证书加入到刚刚生成的signed.crt文件中。具体操作：</p>
<h3 id="第五步：安装证书"><a href="#第五步：安装证书" class="headerlink" title="第五步：安装证书"></a>第五步：安装证书</h3><p>证书生成后，就可以把它配置在web 服务器上了，需要注意的是，Nginx需要追加一个Let’s Encrypt的中间证书，在 Nginx 配置中，需要把中间证书和网站证书合在一起：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">wget -O - https://letsencrypt.org/certs/lets-encrypt-x1-cross-signed.pem &gt; intermediate.pem</div><div class="line">cat signed.crt intermediate.pem &gt; chained.pem</div><div class="line"></div><div class="line">[root@ihaozhuo1 ssl]<span class="comment"># ll</span></div><div class="line">总用量 36</div><div class="line">-rw-r--r-- 1 root root 3243 3月  30 22:06 account.key</div><div class="line">-rw-r--r-- 1 root root 9159 3月  30 19:23 acme_tiny.py</div><div class="line">-rw-r--r-- 1 root root 3834 3月  30 22:51 chained.pem</div><div class="line">-rw-r--r-- 1 root root 1639 3月  30 22:07 domain.csr</div><div class="line">-rw-r--r-- 1 root root 3243 3月  30 22:06 domain.key</div><div class="line">-rw-r--r-- 1 root root 1675 3月  30 22:51 intermediate.pem</div><div class="line">-rw-r--r-- 1 root root 2159 3月  30 22:51 signed.crt</div></pre></td></tr></table></figure>
<p><strong>1）现在我们可以在Nginx启动HTTPS，你可以直接在你之前网站Nginx.conf里面配置</strong></p>
<p>注意⚠️ ：为了不影响现在正在运行的网站，在配置HTTPS的时候最好将你现在配置好的文件全部备份起来，这样你在启动HTTPS出现问题可以能够快速恢复回来。</p>
<p>Nginx配置文件加入以下配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">server &#123;</div><div class="line">    listen 80;</div><div class="line">    server_name ihaozhuo.com, www.ihaozhuo.com;</div><div class="line"></div><div class="line">    location /.well-known/acme-challenge/ &#123;</div><div class="line">        <span class="built_in">alias</span> /var/www/challenges/;</div><div class="line">        try_files <span class="variable">$uri</span> =404;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...the rest of your config</div><div class="line">&#125;</div><div class="line"></div><div class="line">server &#123;</div><div class="line">    listen 443;</div><div class="line">    server_name ihaozhuo.com, www.ihaozhuo.com;</div><div class="line"></div><div class="line">    ssl on;</div><div class="line">    ssl_certificate /srv/ssl/chained.pem;</div><div class="line">    ssl_certificate_key /srv/ssl/domain.key;</div><div class="line">    ssl_session_timeout 5m;</div><div class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA;</div><div class="line">    ssl_session_cache shared:SSL:50m;</div><div class="line">    ssl_prefer_server_ciphers on;</div><div class="line"></div><div class="line">    ...the rest of your config</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在Chrome浏览器里面你可以访问https开头的，但没有看到绿色锁标记，这是因为你网站有请求<code>http://xxx</code>资源，这个问题我遇到以后查了很多，因为我网站很早之前就有了，里面配置的地址都是http要修改过来非常麻烦，所以申请证书一开始域名下来就要申请这是最好的，如果你情况已经跟我一样，那你需要把所有的<code>http://xxxx</code> 资源全部切换成：<a href="https://xxx" target="_blank" rel="external">https://xxx</a> 的资源，这样绿色的锁才会出现。<br><img src="http://image.chengyangyang.com/zhengshu.png" alt=""></p>
<h3 id="第六步：定期更新"><a href="#第六步：定期更新" class="headerlink" title="第六步：定期更新"></a>第六步：定期更新</h3><p>访问查看下网站详细信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">[root@ihaozhuo1 conf]<span class="comment">#  curl -v https://www.ihaozhuo.com/home.html</span></div><div class="line">* About to connect() to www.ihaozhuo.com port 443 (<span class="comment">#0)</span></div><div class="line">*   Trying 120.27.185.86...</div><div class="line">* Connected to www.ihaozhuo.com (120.27.185.86) port 443 (<span class="comment">#0)</span></div><div class="line">* Initializing NSS with certpath: sql:/etc/pki/nssdb</div><div class="line">*   CAfile: /etc/pki/tls/certs/ca-bundle.crt</div><div class="line">  CApath: none</div><div class="line">* Server certificate:</div><div class="line">* 	subject: CN=ihaozhuo.com</div><div class="line">* 	start date: 3月 30 13:51:00 2017 GMT</div><div class="line">* 	expire date: 6月 28 13:51:00 2017 GMT</div><div class="line">* 	common name: ihaozhuo.com</div><div class="line">* 	issuer: CN=Let<span class="string">'s Encrypt Authority X3,O=Let'</span>s Encrypt,C=US</div><div class="line">* NSS error -8179 (SEC_ERROR_UNKNOWN_ISSUER)</div><div class="line">* Peer<span class="string">'s Certificate issuer is not recognized.</span></div><div class="line">* Closing connection 0</div><div class="line">curl: (60) Peer's Certificate issuer is not recognized.</div><div class="line">More details here: http://curl.haxx.se/docs/sslcerts.html</div><div class="line"></div><div class="line">curl performs SSL certificate verification by default, using a <span class="string">"bundle"</span></div><div class="line"> of Certificate Authority (CA) public keys (CA certs). If the default</div><div class="line"> bundle file isn<span class="string">'t adequate, you can specify an alternate file</span></div><div class="line"> using the --cacert option.</div><div class="line">If this HTTPS server uses a certificate signed by a CA represented in</div><div class="line"> the bundle, the certificate verification probably failed due to a</div><div class="line"> problem with the certificate (it might be expired, or the name might</div><div class="line"> not match the domain name in the URL).</div><div class="line">If you'd like to turn off curl<span class="string">'s verification of the certificate, use</span></div><div class="line"> the -k (or --insecure) option.</div></pre></td></tr></table></figure>
<p>Let’s Encrypt 签发的证书只有90天有效期，但可以通过脚本定期更新。你可以创建了一个自动更新脚本<code>renew_cert.sh</code>，内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/usr/bin/sh</span></div><div class="line">python /srv/ssl/acme_tiny.py --account-key /srv/ssl/account.key --csr /srv/ssl/domain.csr --acme-dir /var/www/challenges/ &gt; /srv/ssl/signed.crt || <span class="built_in">exit</span></div><div class="line">wget -O - https://letsencrypt.org/certs/lets-encrypt-x1-cross-signed.pem &gt; intermediate.pem</div><div class="line"></div><div class="line">cat /srv/ssl/signed.crt intermediate.pem &gt; /srv/ssl/chained.pem</div><div class="line">service nginx reload</div></pre></td></tr></table></figure>
<p>修改crontab配置，加入以下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#每个月执行一次</span></div><div class="line">0 0 1 * * /srv/ssl/renew_cert.sh 2&gt;&gt; /var/<span class="built_in">log</span>/acme_tiny.log</div></pre></td></tr></table></figure>
<p>大功告成，不过先别急，访问下自己的HTTPS网站是否正常，不出意外的话，网站正式启用HTTPS，但是网站如果有用CDN的话，那么需要CDN也支持HTTPS才行，否则无法正常加载CDN的资源，类似的错误如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Mixed Content: The page at <span class="string">'https://ihaozhuo.com/'</span> was loaded over HTTPS, but requested an insecure script <span class="string">'http://app.h5.ihaozhuo.combdimg.com/yjk/css/jquery.min.js'</span>. This request has been blocked; the content must be served over HTTPS.</div></pre></td></tr></table></figure>
<p>一种解决方法就是使用Upyun来解决这个问题。可参考：我写的一篇文章如何解决https跨站访问证书不安全访问。</p>
<p>一种解决方法就是使用七牛的云存储来解决这个问题。可参考：<a href="https://blog.blahgeek.com/qiniu-cdn-serve-static/" target="_blank" rel="external">https://blog.blahgeek.com/qiniu-cdn-serve-static/</a></p>
<h2 id="阿里云SLB如何配置HTTPS"><a href="#阿里云SLB如何配置HTTPS" class="headerlink" title="阿里云SLB如何配置HTTPS"></a>阿里云SLB如何配置HTTPS</h2><p>使用阿里云很简单，不需要太多的配置不过个人还是喜欢Nginx去做代理访问。</p>
<p>公司后期更新了本地的Nginx去做负载均衡直接使用SLB ，这里记录下申请了证书以后只需要<code>chained.pem</code>和私钥<code>domain.key</code>。</p>
<p>在SLB负载均衡左侧有证书管理-创建证书-选择服务器证书。</p>
<p><img src="http://image.chengyangyang.com/Nginx-ssl2.png" alt=""></p>
<p>然后在负载均衡上面设置下监听端口选择下对应证书就可以了。 </p>
<h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><p><a href="https://github.com/diafygi/acme-tiny" target="_blank" rel="external">GitHub 安装教程 </a></p>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2016/11/24/Web服务技术/申请证书Https/免费 Https 证书（Let'S Encrypt）申请与配置 /" data-toggle="tooltip" data-placement="top" title="免费 Https证书（Let'S Encrypt）申请与配置">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2016/11/23/Web服务技术/申请证书Https/解决Https请求跨域CDN资源http网站出现访问失败-证书显示不安全/" data-toggle="tooltip" data-placement="top" title="解决Https请求跨域CDN资源http网站出现访问失败-证书显示不安全">Next Post &rarr;</a>
                        </li>
                    
                </ul>
		 

                

                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

            </div>
    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Web Service" title="Web Service">Web Service</a>
                        
                          <a class="tag" href="/tags/#Nginx" title="Nginx">Nginx</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="http://openskill.cn/" target="_blank">openskill.cn</a></li>
                    
                        <li><a href="http://yuzhouwan.com/" target="_blank">Benedict Jin&#39;s Blog</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>





<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "blog-yancy-cc";
    var disqus_identifier = "http://blog.yancy.cc/2016/11/23/Web服务技术/申请证书Https/如何在Nginx申请安装配置免费HTTPS证书+阿里云SLB如何配置HTTPS/";
    var disqus_url = "http://blog.yancy.cc/2016/11/23/Web服务技术/申请证书Https/如何在Nginx申请安装配置免费HTTPS证书+阿里云SLB如何配置HTTPS/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                    <li>
                        <a target="_blank" href="https://twitter.com/yancyoo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/benet1006">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/yangcvo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/yangcvo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Grocery store 2019 
                    <br>
                 Theme by <a href="http://chengyangyang.com">Chengyangyang.com</a>
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span>
                    Ported by <a href="http://chengyangyang.com">Yancy.blog</a>

                    <!--<iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>--> 
		</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://blog.yancy.cc/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->


<!-- Side Catalog -->





<!-- Image to hack wechat -->
<img src="http://blog.yancy.cc/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
