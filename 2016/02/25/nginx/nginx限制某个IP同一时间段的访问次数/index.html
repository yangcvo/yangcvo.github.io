<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> nginx限制某个IP同一时间段的访问次数 · Cheng yang's Blog</title><meta name="description" content="nginx限制某个IP同一时间段的访问次数 - yangc"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.yangcvo.me/atom.xml" title="Cheng yang's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/yangcvo" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/yangcvo" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://blog.yangcvo.me/2014/05/04/%E4%B8%AA%E4%BA%BA%E8%AE%B0%E5%BD%95/About-me/" target="_blank" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">nginx限制某个IP同一时间段的访问次数</h1><div class="post-info">2016年2月25日</div><div class="post-content"><p>如何设置能限制某个IP某一时间段的访问次数是一个让人头疼的问题，特别面对恶意的ddos攻击的时候。其中<code>CC攻击（Challenge Collapsar）是DDOS（分布式拒绝服务）</code>的一种，也是一种常见的网站攻击方法，攻击者通过代理服务器或者肉鸡向向受害主机不停地发大量数据包，造成对方服务器资源耗尽，一直到宕机崩溃。</p>
<p><code>cc攻击</code>一般就是使用有限的ip数对服务器频繁发送数据来达到攻击的目的，nginx可以通过<code>HttpLimitReqModul</code>和<code>HttpLimitZoneModule</code>配置来限制ip在同一时间段的访问次数来防cc攻击。</p>
<p><code>HttpLimitReqModul</code>用来限制连单位时间内连接数的模块，使用<code>limit_req_zone</code>和<code>limit_req</code>指令配合使用来达到限制。一旦并发连接超过指定数量，就会返回503错误。</p>
<p><code>HttpLimitConnModul</code>用来限制单个ip的并发连接数，使用limit_zone和limit_conn指令</p>
<p>这两个模块的区别前一个是对一段时间内的连接数限制，后者是对同一时刻的连接数限制</p>
<p>####HttpLimitReqModul 限制某一段时间内同一ip访问数实例</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">#定义一个名为allips的limit_req_zone用来存储session，大小是10M内存，</span></span><br><span class="line">    <span class="comment">#以$binary_remote_addr 为key,限制平均每秒的请求为20个，</span></span><br><span class="line">    <span class="comment">#1M能存储16000个状态，rete的值必须为整数，</span></span><br><span class="line">    <span class="comment">#如果限制两秒钟一个请求，可以设置成30r/m</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">limit</span>_req_zone <span class="variable">$binary_remote_addr</span> zone=allips:10m rate=20r/s;</span><br><span class="line">    ...</span><br><span class="line">    server&#123;</span><br><span class="line">        ...</span><br><span class="line">        location &#123;</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="comment">#限制每ip每秒不超过20个请求，漏桶数burst为5</span></span><br><span class="line">            <span class="comment">#brust的意思就是，如果第1秒、2,3,4秒请求为19个，</span></span><br><span class="line">            <span class="comment">#第5秒的请求为25个是被允许的。</span></span><br><span class="line">            <span class="comment">#但是如果你第1秒就25个请求，第2秒超过20的请求返回503错误。</span></span><br><span class="line">            <span class="comment">#nodelay，如果不设置该选项，严格使用平均速率限制请求数，</span></span><br><span class="line">            <span class="comment">#第1秒25个请求时，5个请求放到第2秒执行，</span></span><br><span class="line">            <span class="comment">#设置nodelay，25个请求将在第1秒执行。</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">limit</span>_req zone=allips burst=5 nodelay;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="HttpLimitZoneModule-限制并发连接数实例"><a href="#HttpLimitZoneModule-限制并发连接数实例" class="headerlink" title="HttpLimitZoneModule 限制并发连接数实例"></a>HttpLimitZoneModule 限制并发连接数实例</h4><p>limit_zone只能定义在http作用域，limit_conn可以定义在http server location作用域</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">#定义一个名为one的limit_zone,大小10M内存来存储session，</span></span><br><span class="line">    <span class="comment">#以$binary_remote_addr 为key</span></span><br><span class="line">    <span class="comment">#nginx 1.18以后用limit_conn_zone替换了limit_conn</span></span><br><span class="line">    <span class="comment">#且只能放在http作用域</span></span><br><span class="line">    <span class="built_in">limit</span>_conn_zone   one  <span class="variable">$binary_remote_addr</span>  10m;  </span><br><span class="line">    ...</span><br><span class="line">    server&#123;</span><br><span class="line">        ...</span><br><span class="line">        location &#123;</span><br><span class="line">            ...</span><br><span class="line">           <span class="built_in">limit</span>_conn one 20;          <span class="comment">#连接数限制</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">#带宽限制,对单个连接限数，如果一个ip两个连接，就是500x2k</span></span><br><span class="line">           <span class="built_in">limit</span>_rate 500k;            </span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="nginx白名单设置"><a href="#nginx白名单设置" class="headerlink" title="nginx白名单设置"></a>nginx白名单设置</h4><p>以上配置会对所有的ip都进行限制，有些时候我们不希望对搜索引擎的蜘蛛或者自己测试ip进行限制，<br>对于特定的白名单ip我们可以借助geo指令实现。<br>1.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">     geo <span class="variable">$limited</span>&#123;</span><br><span class="line">        default 1;</span><br><span class="line">        <span class="comment">#google </span></span><br><span class="line">        64.233.160.0/19 0;</span><br><span class="line">        65.52.0.0/14 0;</span><br><span class="line">        66.102.0.0/20 0;</span><br><span class="line">        66.249.64.0/19 0;</span><br><span class="line">        72.14.192.0/18 0;</span><br><span class="line">        74.125.0.0/16 0;</span><br><span class="line">        209.85.128.0/17 0;</span><br><span class="line">        216.239.32.0/19 0;</span><br><span class="line">        <span class="comment">#M$</span></span><br><span class="line">        64.4.0.0/18 0;</span><br><span class="line">        157.60.0.0/16 0;</span><br><span class="line">        157.54.0.0/15 0;</span><br><span class="line">        157.56.0.0/14 0;</span><br><span class="line">        207.46.0.0/16 0;</span><br><span class="line">        207.68.192.0/20 0;</span><br><span class="line">        207.68.128.0/18 0;</span><br><span class="line">        <span class="comment">#yahoo</span></span><br><span class="line">        8.12.144.0/24 0;</span><br><span class="line">        66.196.64.0/18 0;</span><br><span class="line">        66.228.160.0/19 0;</span><br><span class="line">        67.195.0.0/16 0;</span><br><span class="line">        74.6.0.0/16 0;</span><br><span class="line">        68.142.192.0/18 0;</span><br><span class="line">        72.30.0.0/16 0;</span><br><span class="line">        209.191.64.0/18 0;</span><br><span class="line">        <span class="comment">#My IPs</span></span><br><span class="line">        127.0.0.1/32 0;</span><br><span class="line">        123.456.0.0/28 0; <span class="comment">#example for your server CIDR</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>geo指令定义了一个白名单$limited变量，默认值为1，如果客户端ip在上面的范围内，$limited的值为0</p>
<p>2.使用map指令映射搜索引擎客户端的ip为空串，如果不是搜索引擎就显示本身真是的ip，这样搜索引擎ip就不能存到limit_req_zone内存session中，所以不会限制搜索引擎的ip访问</p>
<p>map $limited $limit {<br>1 $binary_remote_addr;<br>0 “”;<br>}</p>
<p>3.设置limit_req_zone和limit_req<br>limit_req_zone $limit zone=foo:1m rate=10r/m;</p>
<p>limit_req zone=foo burst=5;</p>
<p>最后我们使用ab压php-fpm的方式，对上面的方法效果实际测试下</p>
<p>例1：限制只允许一分钟内只允许一个ip访问60次配置，也就是平均每秒1次<br>首先我们准备一个php脚本放在根目录下$document_root</p>
<p>test.php</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>( <span class="variable">$i</span>=0; <span class="variable">$i</span> &lt; 1000; <span class="variable">$i</span>++)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'Hello World'</span>;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>nginx配置增加limit_req_zone 和 limit_req</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">    ...</span><br><span class="line">    limit_req_zone $binary_remote_addr zone=allips:10m rate=60r/m;</span><br><span class="line">    ...</span><br><span class="line">    server&#123;</span><br><span class="line">        ...</span><br><span class="line">        location &#123;</span><br><span class="line">            ...</span><br><span class="line">            limit_req zone=allips;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ab -n 5 -c 1 <a href="http://www.weizhang.org/test.php" target="_blank" rel="external">http://www.weizhang.org/test.php</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">118.144.94.193 - - [22/Dec/2012:06:27:06 +0000] &quot;GET /test.php HTTP/1.0&quot; 200 11000 &quot;-&quot; &quot;ApacheBench/2.3&quot;</span><br><span class="line">118.144.94.193 - - [22/Dec/2012:06:27:06 +0000] &quot;GET /test.php HTTP/1.0&quot; 503 537 &quot;-&quot; &quot;ApacheBench/2.3&quot;</span><br><span class="line">118.144.94.193 - - [22/Dec/2012:06:27:07 +0000] &quot;GET /test.php HTTP/1.0&quot; 503 537 &quot;-&quot; &quot;ApacheBench/2.3&quot;</span><br><span class="line">118.144.94.193 - - [22/Dec/2012:06:27:07 +0000] &quot;GET /test.php HTTP/1.0&quot; 503 537 &quot;-&quot; &quot;ApacheBench/2.3&quot;</span><br><span class="line">118.144.94.193 - - [22/Dec/2012:06:27:07 +0000] &quot;GET /test.php HTTP/1.0&quot; 503 537 &quot;-&quot; &quot;ApacheBench/2.3&quot;</span><br></pre></td></tr></table></figure>
<p>未设置brust和nodelay可以看到该配置只允许每秒访问1次，超出的请求返回503错误</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">    ...</span><br><span class="line">    limit_req_zone $binary_remote_addr zone=allips:10m rate=60r/m;</span><br><span class="line">    ...</span><br><span class="line">    server&#123;</span><br><span class="line">        ...</span><br><span class="line">        location &#123;</span><br><span class="line">            ...</span><br><span class="line">            limit_req zone=allips burst=1 nodelay;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ab -n 5 -c 1 <a href="http://www.weizhang.org/test.php" target="_blank" rel="external">http://www.weizhang.org/test.php</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">118.144.94.193 - - [22/Dec/2012:07:01:00 +0000] &quot;GET /test.php HTTP/1.0&quot; 200 11000 &quot;-&quot; &quot;ApacheBench/2.3&quot;</span><br><span class="line">118.144.94.193 - - [22/Dec/2012:07:01:00 +0000] &quot;GET /test.php HTTP/1.0&quot; 200 11000 &quot;-&quot; &quot;ApacheBench/2.3&quot;</span><br><span class="line">118.144.94.193 - - [22/Dec/2012:07:01:01 +0000] &quot;GET /test.php HTTP/1.0&quot; 503 537 &quot;-&quot; &quot;ApacheBench/2.3&quot;</span><br><span class="line">118.144.94.193 - - [22/Dec/2012:07:01:01 +0000] &quot;GET /test.php HTTP/1.0&quot; 503 537 &quot;-&quot; &quot;ApacheBench/2.3&quot;</span><br><span class="line">118.144.94.193 - - [22/Dec/2012:07:01:01 +0000] &quot;GET /test.php HTTP/1.0&quot; 503 537 &quot;-&quot; &quot;ApacheBench/2.3&quot;</span><br></pre></td></tr></table></figure>
<p>设置brust=1和nodelay后允许第1秒处理两个请求。</p>
<p>参考例子：<a href="http://storysky.blog.51cto.com/628458/642970/" target="_blank" rel="external">http://storysky.blog.51cto.com/628458/642970/</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/02/26/nginx/nginx-反向代理/" class="prev">PREV</a><a href="/2016/02/23/nginx/nginx安装与负载均衡及配置文件详解/" class="next">NEXT</a></div><div data-thread-key="2016/02/25/nginx/nginx限制某个IP同一时间段的访问次数/" data-title="nginx限制某个IP同一时间段的访问次数" data-url="http://blog.yangcvo.me/2016/02/25/nginx/nginx限制某个IP同一时间段的访问次数/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"true"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2014 - 2016 <a href="http://blog.yangcvo.me">yangc</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yangcvo" target="_blank">Github-yangcvo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>