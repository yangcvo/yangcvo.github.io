<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="theme-color" content="#33474d">
	<title>Yancy&#39;s blog</title>
	<link rel="stylesheet" href="/css/style.css" />
	
      <link rel="alternate" href="/atom.xml" title="Yancy&#39;s blog" type="application/atom+xml">
    
</head>

<body>

	<header class="header">
		<nav class="header__nav">
			
				<a href="/" class="header__link">Home</a>
			
				<a href="/tags" class="header__link">Tags</a>
			
				<a href="/archives" class="header__link">ARCHIVES</a>
			
				<a href="/about/About" class="header__link">ABOUT</a>
			
				<a href="http://weibo.com/yangcvo" class="header__link">Weibo</a>
			
				<a href="/atom.xml" class="header__link">RSS</a>
			
		</nav>
		<h1 class="header__title"><a href="/">Yancy&#39;s blog</a></h1>
		<h2 class="header__subtitle">SIMPLICITY IS PREREQUISITE FOR  RELIABILITY</h2>
	</header>

	<main>
		
	<span class="different-posts different-posts_earlier">📖 <a href="/page/4">earlier posts</a> 📖</span>




	<article>
	
		<h1><a href="/2016/11/24/Node.js-npm/Node.js-Grunt工具搭建后台管理实践/">Node.js+Grunt工具搭建后台管理实践</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-11-24</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Grunt/">Grunt</a> <a class="article__tag-link" href="/tags/Node-js/">Node.js</a>
			</span>
		
	</div>

	

	
		<p>最近弄灰度发布系统，由于最近体检项目需要对css文件和js文件进行压缩，各种比较之后，选择了grunt进行构建。google一下，几乎都是grunt最新版的使用说明<code>查看gruntjs的入门 Getting started</code>，又是云里雾里的，好吧，只能耐心看文档和不断的实践吧。</p>
		<p><a class="article__read-more-link" href="/2016/11/24/Node.js-npm/Node.js-Grunt工具搭建后台管理实践/">...read more</a></p>
	

	

</article>




	<article>
	
		<h1><a href="/2016/11/14/日志分析平台/Graylog/graylog 升级2.1 集中日志解决方案/">graylog 升级2.1 集中日志解决方案</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-11-14</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/Log-Analysis-Platform/">Log Analysis Platform</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Graylog/">Graylog</a>
			</span>
		
	</div>

	

	
		<h1 id="graylog-升级2-1-集中日志解决方案"><a href="#graylog-升级2-1-集中日志解决方案" class="headerlink" title="graylog 升级2.1 集中日志解决方案"></a>graylog 升级2.1 集中日志解决方案</h1><p>参考官网：<a href="http://docs.graylog.org/en/2.1/pages/upgrade/graylog-2.1.html" target="_blank" rel="external">升级到Graylog的2.1.x</a></p>
<h3 id="一：为什么需要集中日志解决方案？"><a href="#一：为什么需要集中日志解决方案？" class="headerlink" title="一：为什么需要集中日志解决方案？"></a>一：为什么需要集中日志解决方案？</h3><p>在公司服务机子部署越来越多的情况下，让我们来想想会遇到的问题：</p>
<ul>
<li>开发人员不能登录线上服务器查看详细日志，经过运维周转费时费力</li>
<li>日志数据分散在多个系统，难以查找</li>
<li>日志数据量大，查询速度慢</li>
<li>一个调用会涉及多个系统，难以在这些系统的日志中快速定位数据</li>
<li>数据不够实时</li>
<li>很难对数据进行挖掘，分析，业务告警，审计</li>
<li>这些问题的存在让开发以及运维人员很是头痛，严重影响效率！</li>
</ul>
<h3 id="二：什么是graylog技术栈？"><a href="#二：什么是graylog技术栈？" class="headerlink" title="二：什么是graylog技术栈？"></a>二：什么是graylog技术栈？</h3><p>为了解决上述问题，我们需要一个日志的集中管理方案，graylog技术栈：</p>
<ul>
<li>java （jdk1.8.0_66/）环境</li>
<li>Collector-sidecar（收集日志）或者syslog</li>
<li>Mongodb（存储日志源文件）</li>
<li>Elasticsearch（提供搜索日志）</li>
<li>Graylog2.1.1（搜索和视图展示日志，告警和权限）</li>
</ul>
<p>有了这些，我们就能把日志先收集起来，进行我们想要的分析之后，web的形式展示出来，提供查询！</p>
<h3 id="三：graylog的安装部署"><a href="#三：graylog的安装部署" class="headerlink" title="三：graylog的安装部署"></a>三：graylog的安装部署</h3><p>安装环境：linux centOS系统安装，已安装JDK1.8版本，安装启动顺序</p>
<p>1.安装部署mongodb<br>2.安装部署elasticsearch<br>3.安装部署graylog<br>4.安装部署Graylog Collector Sidecar</p>
<hr>
<p> <strong>1：安装部署mongodb</strong> <strong>Java也安装</strong>  参考我博文有介绍。 </p>
<p> <strong>2：安装部署elasticsearch</strong></p>
<p><strong>(1)下载jar包</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">wget https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/tar/elasticsearch/2.3.5/elasticsearch-2.3.5.tar.gz</div><div class="line"></div><div class="line">如果报错</div><div class="line">执行</div><div class="line"></div><div class="line">wget --no-check-certificate</div><div class="line"></div><div class="line">https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/tar/elasticsearch/2.3.5/elasticsearch-2.3.5.tar.gz</div></pre></td></tr></table></figure>
<p><strong>(2)解压jar包</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar -zxvf elasticsearch-2.3.5.tar.gz -C /opt/</div></pre></td></tr></table></figure>
<p><strong>(3)修改elasticsearch.yml配置文件</strong></p>
<p> 这里需要修改配置文件：配置前先创建几个目录文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir /home/data/es-data -p</div><div class="line">mkdir /home/data/es-work -p</div></pre></td></tr></table></figure>
<p>elasticsearch-2.3.5安装目录conf下执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">vim elasticsearch-2.3.5/config/elasticsearch.yml</div><div class="line"> </div><div class="line">cluster.name: graylog              <span class="comment">#集群名称建议命名graylog，便于识别区分</span></div><div class="line">node.name: elasticsearch-node-1     <span class="comment"># elasticsearch集群节点名称</span></div><div class="line">network.host: 192.168.1.234    <span class="comment"># 绑定节点IP</span></div><div class="line">http.port: 9200         <span class="comment"># 外部访问端口，默认，也可以安全考虑修改</span></div><div class="line">path.logs: /home/data/logs</div><div class="line">path.data: /home/data/es-data</div><div class="line">discovery.zen.ping.multicast.enabled: <span class="literal">false</span>   <span class="comment">#多播发现方式关闭，因为graylog采用单播方式发现elasticsearch集群方式</span></div><div class="line">discovery.zen.ping.unicast.hosts                   <span class="comment">#多个节点用逗号隔开</span></div><div class="line">discovery.zen.minimum_master_nodes: 3    <span class="comment"># elasticsearch集群节点，最少选举数，这个数一定要设置为整个集群节点个数的一半加1，即N/2+1，必须为奇数</span></div></pre></td></tr></table></figure>
<p><strong>(4)启动elasticsearch服务</strong></p>
<p>新建一个elasticsearch用户，出于安全考虑，elasticsearch服务不能使用root用户启动</p>
<p>创建elasticsearch用户组及elasticsearch用户，执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">groupadd elasticsearch</div><div class="line">useradd elasticsearch -g elasticsearch -p elasticsearch</div></pre></td></tr></table></figure>
<p>其中-g使用户属于某个组，-p为新用户使用加密密码）<br>更改elasticsearch-2.3.5文件夹及内部文件的所属用户及组为elasticsearch:elasticsearch</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chown -R elasticsearch:elasticsearch  /home/data/</div><div class="line">chown -R elasticsearch:elasticsearch  elasticsearch-2.3.5</div></pre></td></tr></table></figure>
<p>切换用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">su elasticsearch</div></pre></td></tr></table></figure>
<p>在elasticsearch-2.3.5/bin目录下执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[elasticsearch@graylog bin]$ ps -ef | grep elasticsearch</div><div class="line">root     18265 16004  0 14:27 pts/1    00:00:00 su elasticsearch</div><div class="line">502      18405     1 62 14:27 pts/1    00:00:13 /srv/jdk1.8.0_66/bin/java -Xms256m -Xmx1g -Djava.awt.headless=<span class="literal">true</span> -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -XX:+HeapDumpOnOutOfMemoryError -XX:+DisableExplicitGC -Dfile.encoding=UTF-8 -Djna.nosys=<span class="literal">true</span> -Des.path.home=/opt/elasticsearch-2.3.5 -cp /opt/elasticsearch-2.3.5/lib/elasticsearch-2.3.5.jar:/opt/elasticsearch-2.3.5/lib/* org.elasticsearch.bootstrap.Elasticsearch start <span class="_">-d</span></div><div class="line">502      18530 18266  0 14:27 pts/1    00:00:00 grep --color=auto ela</div></pre></td></tr></table></figure>
<p><strong>(5)检查elasticsearch服务状态</strong></p>
<p>执行如下命令测试Elasticsearch是否正常运行：</p>
<p>$ curl -XGET ‘<a href="http://localhost:9200/_cluster/health?pretty=true" target="_blank" rel="external">http://localhost:9200/_cluster/health?pretty=true</a>‘</p>
<p>输出的信息如下表示Elasticsearch安装成功：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[elasticsearch@graylog bin]$ curl -XGET <span class="string">'http://192.168.1.234:9200/_cluster/health?pretty=true'</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"cluster_name"</span> : <span class="string">"graylog"</span>,</div><div class="line">  <span class="string">"status"</span> : <span class="string">"yellow"</span>,</div><div class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</div><div class="line">  <span class="string">"number_of_nodes"</span> : 1,</div><div class="line">  <span class="string">"number_of_data_nodes"</span> : 1,</div><div class="line">  <span class="string">"active_primary_shards"</span> : 30,</div><div class="line">  <span class="string">"active_shards"</span> : 30,</div><div class="line">  <span class="string">"relocating_shards"</span> : 0,</div><div class="line">  <span class="string">"initializing_shards"</span> : 0,</div><div class="line">  <span class="string">"unassigned_shards"</span> : 30,</div><div class="line">  <span class="string">"delayed_unassigned_shards"</span> : 0,</div><div class="line">  <span class="string">"number_of_pending_tasks"</span> : 0,</div><div class="line">  <span class="string">"number_of_in_flight_fetch"</span> : 0,</div><div class="line">  <span class="string">"task_max_waiting_in_queue_millis"</span> : 0,</div><div class="line">  <span class="string">"active_shards_percent_as_number"</span> : 50.0</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3：安装部署graylog-2-1版本"><a href="#3：安装部署graylog-2-1版本" class="headerlink" title="3：安装部署graylog-2.1版本"></a>3：安装部署graylog-2.1版本</h3><p><strong>(1)下载安装包</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget https://packages.graylog2.org/releases/graylog/graylog-2.1.1.tgz</div></pre></td></tr></table></figure>
<p><strong>(2)解压安装包</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar -zxvf graylog-2.1.1.tgz -C /opt/.</div></pre></td></tr></table></figure>
<p><strong>(3)修改配置文件</strong></p>
<p>修改安装目录下 graylog.conf.example 文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim graylog.conf.example</div></pre></td></tr></table></figure>
<p>web_listen_uri 值是graylog启动成功后，web服务访问地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">web_listen_uri = http://192.168.1.234:9000/</div></pre></td></tr></table></figure>
<p>rest_listen_uri 的值，是graylog启动成功后，api访问地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rest_listen_uri = http://192.168.1.234:9000/api/</div></pre></td></tr></table></figure>
<p>root_timezone = UTC  #设置时区，否则默认使用的是UTC时间也就是世界时间 这里是必须改下的，因为后期收集日志显示时间是有变化的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">root_timezone = Asia/Shanghai</div></pre></td></tr></table></figure>
<p>其中 password_secret 的值用命令生成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">yum install -y pwgen</div><div class="line">pwgen -N 1 <span class="_">-s</span> 96       H1R5v17kWtyDxj2PzxLMxu41D6HDt9JzhfZcj6QlCURVddgkLAdnUmpkdIscmmu4ELKsTrHwKvPmxFKSYyTn0YlqebbpQqyr</div><div class="line"></div><div class="line">    password_secret = H1R5v17kWtyDxj2PzxLMxu41D6HDt9JzhfZcj6QlCURVddgkLAdnUmpkdIscmmu4ELKsTrHwKvPmxFKSYyTn0YlqebbpQqyr</div></pre></td></tr></table></figure>
<p>其中root_password_sha2 的值使用命令生成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="built_in">echo</span> -n Ihaozhuo_b313 | sha256sum  (这里对密码123456哈希加密)</div><div class="line"></div><div class="line"><span class="built_in">fc</span>88c28d48b0cb97f3fb5286cc35c520409ef037acd30ec687f0c0bd3d5a5115 </div><div class="line">   </div><div class="line">root_password_sha2 = <span class="built_in">fc</span>88c28d48b0cb97f3fb5286cc35c520409ef037acd30ec687f0c0bd3d5a5115</div></pre></td></tr></table></figure>
<p>elasticsearch_cluster_name 值必须是elasticsearch配置文件中的cluster_name</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">elasticsearch_cluster_name = graylog</div></pre></td></tr></table></figure>
<p>elasticsearch_discovery_zen_ping_unicast_hosts 填写elasticsearch地址，如果是多个，用逗号隔开</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">elasticsearch_discovery_zen_ping_unicast_hosts = 192.168.1.234:9300</div></pre></td></tr></table></figure>
<p>elasticsearch_discovery_zen_ping_multicast_enabled = false 多播模式关闭</p>
<p>由于我们只有一个Elasticsearch shard，需要把elasticsearch_shards参数设置为1：<br>elasticsearch集群分片数量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">elasticsearch_shards = 1</div></pre></td></tr></table></figure>
<p>elasticsearch绑定的节点IP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">299 elasticsearch_network_host = 192.168.1.234</div><div class="line">300 elasticsearch_network_bind_host = 192.168.1.234</div><div class="line">301 elasticsearch_network_publish_host = 192.168.1.234</div></pre></td></tr></table></figure>
<p>mongodb安装服务的ip地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongodb_uri = mongodb://192.168.1.234/graylog</div></pre></td></tr></table></figure>
<p>这里mongodb是安装在我同一台服务器上面的。如果要把mongodb单独服务器跑连接方式配置文件里面也有例子说明：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongodb_uri =mongodb://graylog:123456@160.17.2.251:27017/graylog2             <span class="comment">#连接到mongodb的服务器地址为160.17.2.251:27017，账号为graylog，密码为123456 数据库为graylog2</span></div></pre></td></tr></table></figure>
<p> 设置告警邮件发送者信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"> <span class="comment"># Email transport</span></div><div class="line">transport_email_enabled = <span class="literal">false</span></div><div class="line">transport_email_hostname = smtp.exmail.qq.com</div><div class="line">transport_email_port = 465</div><div class="line">transport_email_use_auth = <span class="literal">true</span></div><div class="line">transport_email_use_tls = <span class="literal">true</span></div><div class="line">transport_email_use_ssl = <span class="literal">true</span></div><div class="line">transport_email_auth_username = chengyangyang@qq.cn</div><div class="line">transport_email_auth_password = beneTqq</div><div class="line">transport_email_subject_prefix = [graylog]</div><div class="line">transport_email_from_email = chengyangyang@qq.cn</div></pre></td></tr></table></figure>
<p><strong>(4)复制配置文件</strong></p>
<p> 因为graylog安装bin目录下，默认启动配置文件</p>
<p>配置文件路径：<code>/etc/graylog/server/server.conf</code></p>
<p>所以需要将<code>graylog.conf.example</code> 复制到<code>/etc/graylog/server/</code>目录下，并且改名 <code>server.conf</code></p>
<p>执行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir -p /etc/graylog/server/ </div><div class="line">cp graylog.conf.example /etc/graylog/server/server.conf</div></pre></td></tr></table></figure>
<p><strong>(5)启动graylog</strong></p>
<p>在graylog安装bin目录下执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./graylogctl start</div></pre></td></tr></table></figure>
<p>查看日志，在graylog安装目录下执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tail -200f /<span class="built_in">log</span>/graylog-server.log</div></pre></td></tr></table></figure>
<p>如果报错：</p>
<p>原因：</p>
<p>在mongodb版本2.6之后，是需要日志journaling设置的，而默认情况下是关闭的</p>
<p>解决办法：</p>
<p>在mongodb启动命令加上 –journal</p>
<p>最后启动命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./mongod --dbpath=/usr/<span class="built_in">local</span>/mongodb/data/ --fork --logpath=/usr/<span class="built_in">local</span>/mongodb/logs --storageEngine=mmapv1 --journal</div></pre></td></tr></table></figure>
<p>重启mongodb后，重启graylog服务即可！</p>
<p><strong>(6)启动graylog(报错二)</strong></p>
<p>查看日志，在graylog安装目录下执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">tail -200f /<span class="built_in">log</span>/graylog-server.log</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;com.mongodb.MongoSocketOpenException: Exception opening socket&#125;, caused by &#123;java.net.ConnectException: 拒绝连接&#125;&#125;]&#125;. Waiting <span class="keyword">for</span> 30000 ms before timing out</div><div class="line">2016-11-22 15:10:29,355 INFO : org.graylog2.bootstrap.CmdLineTool - Loaded plugin: Elastic Beats Input 1.1.1 [org.graylog.plugins.beats.BeatsInputPlugin]</div><div class="line">2016-11-22 15:10:29,357 INFO : org.graylog2.bootstrap.CmdLineTool - Loaded plugin: Collector 1.1.1 [org.graylog.plugins.collector.CollectorPlugin]</div><div class="line">2016-11-22 15:10:29,357 INFO : org.graylog2.bootstrap.CmdLineTool - Loaded plugin: Enterprise Integration Plugin 1.1.1 [org.graylog.plugins.enterprise_integration.EnterpriseIntegrationPlugin]</div><div class="line">2016-11-22 15:10:29,358 INFO : org.graylog2.bootstrap.CmdLineTool - Loaded plugin: MapWidgetPlugin 1.1.1 [org.graylog.plugins.map.MapWidgetPlugin]</div><div class="line">2016-11-22 15:10:29,359 INFO : org.graylog2.bootstrap.CmdLineTool - Loaded plugin: Pipeline Processor Plugin 1.1.1 [org.graylog.plugins.pipelineprocessor.ProcessorPlugin]</div><div class="line">2016-11-22 15:10:29,359 INFO : org.graylog2.bootstrap.CmdLineTool - Loaded plugin: Anonymous Usage Statistics 2.1.1 [org.graylog.plugins.usagestatistics.UsageStatsPlugin]</div><div class="line">2016-11-22 15:10:29,487 INFO : org.graylog2.bootstrap.CmdLineTool - Running with JVM arguments: -Djava.library.path=./../lib/sigar -Xms1g -Xmx1g -XX:NewRatio=1 -XX:+ResizeTLAB -XX:+UseConcMarkSweepGC -XX:+CMSConcurrentMTEnabled -XX:+CMSClassUnloadingEnabled -XX:+UseParNewGC -XX:-OmitStackTraceInFastThrow</div></pre></td></tr></table></figure>
<p>提示mongodb 拒绝连接。 这个时候需要看下端口地址是否是IP地址还是127.0.0.1 如果不是需要修改下在重启服务就可以了。</p>
<p><strong>查看启动服务端口：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@graylog graylog-2.1.1]<span class="comment"># netstat -ntulp</span></div><div class="line">Active Internet connections (only servers)</div><div class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</div><div class="line">tcp        0      0 127.0.0.1:27017             0.0.0.0:*                   LISTEN      22308/mongod</div><div class="line">tcp        0      0 0.0.0.0:22                  0.0.0.0:*                   LISTEN      1974/sshd</div><div class="line">tcp        0      0 127.0.0.1:25                0.0.0.0:*                   LISTEN      1287/master</div><div class="line">tcp        0      0 ::ffff:192.168.1.234:9350   :::*                        LISTEN      23642/java</div><div class="line">tcp        0      0 ::ffff:192.168.1.234:9000   :::*                        LISTEN      23642/java</div><div class="line">tcp        0      0 ::ffff:192.168.1.234:9200   :::*                        LISTEN      18405/java</div><div class="line">tcp        0      0 ::ffff:192.168.1.234:9300   :::*                        LISTEN      18405/java</div><div class="line">tcp        0      0 :::22                       :::*                        LISTEN      1974/sshd</div><div class="line">tcp        0      0 ::1:25                      :::*                        LISTEN      1287/master</div></pre></td></tr></table></figure>
<p><strong>(6)访问graylog</strong></p>
<p>graylog启动成功后，浏览器访问：<strong>graylog安装IP:9000</strong></p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/graylog10.png" alt=""></figure></p>
<h3 id="四：总结"><a href="#四：总结" class="headerlink" title="四：总结"></a>四：总结</h3><p>到此，基础的集中日志管理graylog安装完毕！，后续将继续介绍：</p>
<p>安装部署Graylog Collector Sidecar 收集应用日志</p>
<p>采用syslog收集日志方式</p>
<p>graylog一些使用，包括日志截取，告警等。</p>
<p>之前也实践过ELK技术栈，后来选型graylog，是基于graylog带有的权限管理，和告警功能比较完善！</p>

	

	

</article>




	<article>
	
		<h1><a href="/2016/11/13/日志分析平台/Graylog/Graylog—日志分析平台完美代替Elasticsearch/">Graylog——日志分析平台完美代替Elasticsearch</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-11-13</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/Log-Analysis-Platform/">Log Analysis Platform</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Graylog/">Graylog</a>
			</span>
		
	</div>

	

	
		<p>摘要: 提起日志聚合工具，有开源界的ELK，商业界的Splunk，但我要介绍开源的后起之秀Graylog，可以说是龙头老大Splunk的开源版。</p>
<h1 id="Graylog——日志分析平台完美代替Elasticsearch"><a href="#Graylog——日志分析平台完美代替Elasticsearch" class="headerlink" title="Graylog——日志分析平台完美代替Elasticsearch"></a>Graylog——日志分析平台完美代替Elasticsearch</h1><p>先看看 推荐！<a href="https://my.oschina.net/HeAlvin/blog/378262" target="_blank" rel="external">国外程序员整理的系统管理员资源大全</a> 中，国外程序员整理的日志聚合工具的列表：</p>
<p><strong>日志管理工具：收集，解析，可视化</strong></p>
<ul>
<li>Elasticsearch - 一个基于Lucene的文档存储，主要用于日志索引、存储和分析。</li>
<li>Fluentd - 日志收集和发出</li>
<li>Flume -分布式日志收集和聚合系统</li>
<li>Graylog2 -具有报警选项的可插入日志和事件分析服务器</li>
<li>Heka -流处理系统，可用于日志聚合</li>
<li>Kibana - 可视化日志和时间戳数据</li>
<li>Logstash -管理事件和日志的工具</li>
<li>Octopussy -日志管理解决方案（可视化/报警/报告）</li>
</ul>
<p>Graylog与ELK方案的对比</p>
<ul>
<li>ELK： Logstash -&gt; Elasticsearch -&gt; Kibana （使用了一些插件head ，marvel）</li>
<li>Graylog： Graylog Collector -&gt; Graylog Server(封装Elasticsearch) -&gt; Graylog Web</li>
</ul>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/Graylog.png" alt=""></figure></p>
<p>做为运维，公司内部使用elk处理日志发现很多问题。</p>
<p>顺便截图了几张：</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/graylog-elk.png" alt=""></figure><br><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/graylog-elk1.png" alt=""></figure></p>
<p>之前试过Logstash + Elasticsearch + Kibana的方案，发现有几个缺点：</p>
<ol>
<li>不能处理多行日志，比如Mysql慢查询，Tomcat/Jetty应用的Java异常打印</li>
<li>不能保留原始日志，只能把原始日志分字段保存，这样搜索日志结果是一堆Json格式文本，无法阅读。</li>
<li>不复合正则表达式匹配的日志行，被全部丢弃。</li>
<li>kibana结合使用经常会出现卡死。资源消耗非常大。</li>
</ol>
<p>本着解决以上3个缺点的原则，再次寻找替代方案。 首先找到了商业日志工具Splunk，号称日志界的Google，意思是全文搜索日志的能力，不光能解决以上3个缺点，还提供搜索单词高亮显示，不同错误级别日志标色等吸引人的特性，但是免费版有500M限制，付费版据说要3万美刀，只能放弃，继续寻找。 最后找到了Graylog，第一眼看到Graylog，只是系统日志syslog的采集工具，一点也没吸引到我。但后来深入了解后，才发现Graylog简直就是开源版的Splunk。 我自己总结的Graylog吸引人的地方：</p>
<ol>
<li>一体化方案，安装方便，不像ELK有3个独立系统间的集成问题。</li>
<li>采集原始日志，并可以事后再添加字段，比如http_status_code，response_time等等。</li>
<li>自己开发采集日志的脚本，并用curl/nc发送到Graylog Server，发送格式是自定义的GELF，Flunted和Logstash都有相应的输出GELF消息的插件。自己开发带来很大的自由度。实际上只需要用inotifywait监控日志的modify事件，并把日志的新增行用curl/netcat发送到Graylog Server就可。</li>
<li>搜索结果高亮显示，就像google一样。</li>
<li>搜索语法简单，比如： source:mongo AND reponse_time_ms:&gt;5000，避免直接输入elasticsearch搜索json语法</li>
<li>搜索条件可以导出为elasticsearch的搜索json文本，方便直接开发调用elasticsearch rest api的搜索脚本。</li>
</ol>
<p>Graylog图解</p>
<p>Graylog开源版官网： <a href="https://www.graylog.org/" target="_blank" rel="external">https://www.graylog.org/</a></p>
<p>来几张官网的截图：</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/graylog2.png" alt=""></figure></p>
<p><figure class="figure"><img src="https://www.graylog.org/assets/itops_full-87fe2811ab676116142c145affa95b902635b1d6da99718057e8ae9d45c15007.png" alt=""></figure></p>
<p><figure class="figure"><img src="https://www.graylog.org/assets/overview_dashboard-3817012f923d4a00e9bde1c0547796319cf0396149464f434cfc2ae83a9da826.png" alt=""></figure></p>
<p>Graylog是强大的日志管理、分析工具。它基于 Elasticsearch, Java和MongoDB。</p>
<p>Graylog可以收集监控多种不同应用的日志。但是为了示范说明，我只收集syslog。并且，我将会把用到的组件全部安装到一个单独的服务器上。对于大型、生产系统你可以把组件分开安装在不同的服务器上，这样可以提高效率。</p>
<h3 id="Graylog的组件"><a href="#Graylog的组件" class="headerlink" title="Graylog的组件"></a>Graylog的组件</h3><p>Graylog有4个基本组件：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Graylog <span class="built_in">Server</span>：这个服务负责接收和处理日志/消息，并且和其他组件沟通。</div><div class="line">Elasticsearch：存储所有的日志，它的性能依赖内存和硬盘IO。</div><div class="line">MongoDB：存储元数据，负载不高。</div><div class="line">graylog-Web接口：用户接口。</div></pre></td></tr></table></figure>
<p>下面是Graylog组件之间的关系图：</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/graylog3.png" alt=""></figure></p>
<p>下面来自我公司内部分享的PPT拍图：</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/Graylog4-ppt.png" alt=""></figure></p>
<p>生产环境 我参考网上一些博客画的图：</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/graylog5.png" alt=""></figure></p>
<h3 id="系统要求："><a href="#系统要求：" class="headerlink" title="系统要求："></a>系统要求：</h3><ul>
<li>CentOS 6.7</li>
<li>内存至少2GB</li>
<li>有root权限</li>
<li>服务器ip是192.168.1.234，已安装 1.8.0_77-b03</li>
</ul>
<p>这里我只是举例单一模式跑服务。</p>
<h3 id="安装MongoDB"><a href="#安装MongoDB" class="headerlink" title="安装MongoDB"></a>安装MongoDB</h3><p>MongoDB的安装非常简单，执行如下命令导入MongoDB GPG密钥到rpm：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="string">[root@graylog</span> <span class="string">yum.repos.d]#</span> <span class="string">vim</span> <span class="string">/etc/yum.repos.d/mongodb-org-3.0.repo</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="string">[mongodb-org-3.0]</span></div><div class="line"><span class="string">name=MongoDB</span> <span class="string">Repository</span></div><div class="line"><span class="string">baseurl=http://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.0/x86_64/</span></div><div class="line"><span class="string">gpgcheck=0</span></div><div class="line"><span class="string">enabled=1</span></div><div class="line"><span class="meta">---</span></div><div class="line"></div><div class="line"><span class="string">[root@graylog</span> <span class="string">yum.repos.d]#</span> <span class="string">yum</span> <span class="string">install</span> <span class="bullet">-y</span> <span class="string">mongodb-org</span></div><div class="line"></div><div class="line"><span class="string">[root@graylog</span> <span class="string">yum.repos.d]#</span> <span class="string">vi</span> <span class="string">/etc/yum.conf</span></div><div class="line"><span class="string">最后一行添加：</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="string">exclude=mongodb-org,mongodb-org-server,mongodb-org-shell,mongodb-org-mongos,mongodb-org-tools</span></div><div class="line"><span class="meta">---</span></div><div class="line"></div><div class="line"><span class="string">[root@graylog</span> <span class="string">yum.repos.d]#</span> <span class="string">service</span> <span class="string">mongod</span> <span class="string">start</span></div><div class="line"><span class="string">[root@graylog</span> <span class="string">yum.repos.d]#</span> <span class="string">chkconfig</span> <span class="string">mongod</span> <span class="string">on</span></div><div class="line"></div><div class="line"><span class="string">[root@graylog</span> <span class="string">yum.repos.d]#</span> <span class="string">vi</span> <span class="string">/etc/security/limits.conf</span></div><div class="line"><span class="string">最后一行添加：</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="string">*</span>                <span class="string">soft</span>    <span class="string">nproc</span>           <span class="number">65536</span></div><div class="line"><span class="string">*</span>                <span class="string">hard</span>    <span class="string">nproc</span>           <span class="number">65536</span></div><div class="line"><span class="string">mongod</span>           <span class="string">soft</span>    <span class="string">nproc</span>           <span class="number">65536</span></div><div class="line"></div><div class="line"><span class="string">*</span>                <span class="string">soft</span>    <span class="string">nofile</span>          <span class="number">131072</span></div><div class="line"><span class="string">*</span>                <span class="string">hard</span>    <span class="string">nofile</span>          <span class="number">131072</span></div><div class="line"><span class="meta">---</span></div><div class="line"></div><div class="line"><span class="string">[root@graylog</span> <span class="string">~]#</span> <span class="string">vi</span> <span class="string">/etc/init.d/mongod</span></div><div class="line"><span class="string">ulimit</span> <span class="bullet">-f</span> <span class="string">unlimited</span> <span class="string">行前插入：</span></div><div class="line"><span class="meta">---</span></div><div class="line">  <span class="string">if</span> <span class="string">test</span> <span class="bullet">-f</span> <span class="string">/sys/kernel/mm/transparent_hugepage/enabled;</span> <span class="string">then</span></div><div class="line">    <span class="string">echo</span> <span class="string">never</span> <span class="string">&gt; /sys/kernel/mm/transparent_hugepage/enabled</span></div><div class="line">  fi</div><div class="line">  if test -f /sys/kernel/mm/transparent_hugepage/defrag; then</div><div class="line">    echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag</div><div class="line">  fi</div><div class="line">---</div><div class="line">[root@graylog ~]# /etc/init.d/mongod restart</div></pre></td></tr></table></figure>
<h3 id="安装Elasticsearch"><a href="#安装Elasticsearch" class="headerlink" title="安装Elasticsearch"></a>安装Elasticsearch</h3><p>Graylog目前为止只能使用Elasticsearch 2.0以前的版本，所以，在这一步中，我将安装Elasticsearch 1.7.x。</p>
<p>添加Elasticsearch GPG密钥：</p>
<pre><code>$ sudo rpm --import http://packages.elastic.co/GPG-KEY-elasticsearch
</code></pre><p>创建Elasticsearch源：</p>
<pre><code>$ sudo vim /etc/yum.repos.d/elasticsearch.repo
</code></pre><p>写入如下内容：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="section">[elasticsearch-1.7]</span></div><div class="line"><span class="attr">name</span>=Elasticsearch repository for <span class="number">1.7</span>.x packages</div><div class="line"><span class="attr">baseurl</span>=http://packages.elastic.co/elasticsearch/<span class="number">1.7</span>/centos</div><div class="line"><span class="attr">gpgcheck</span>=<span class="number">1</span></div><div class="line"><span class="attr">gpgkey</span>=http://packages.elastic.co/GPG-KEY-elasticsearch</div><div class="line"><span class="attr">enabled</span>=<span class="number">1</span></div></pre></td></tr></table></figure>
<p>安装Elasticsearch：</p>
<pre><code>$ sudo yum -y install elasticsearch
</code></pre><p>配置前先创建几个目录文件</p>
<pre><code>mkdir /data/es-data -p
mkdir /data/es-work -p
</code></pre><p>Elasticsearch安装完成之后，编辑配置文件：</p>
<pre><code>sudo vim /etc/elasticsearch/elasticsearch.yml

 node.data: true  # 数据存放true
</code></pre><p>找到cluster.name一行，取消这一行的注释，并把值改为graylog-development：</p>
<pre><code>cluster.name: graylog-development


 path.data: /data/es-data     es数据存放目录  这里需要自己新建目录

 path.work: /data/es-work   
</code></pre><p>你也许想要限制外部访问Elasticsearch（端口9200），这样可以提高系统的安全性。找到network.host一行，取消注释，并把值改为localhost：</p>
<pre><code>network.host: 192.168.1.234
</code></pre><p>保存退出文件。</p>
<p>重启Elasticsearch：</p>
<pre><code>$ service elasticsearch start
</code></pre><p>设置开机启动：</p>
<pre><code>$ chkconfig --add elasticsearch
</code></pre><p>执行如下命令测试Elasticsearch是否正常运行：</p>
<pre><code>$ curl -XGET &apos;http://localhost:9200/_cluster/health?pretty=true&apos;
</code></pre><p>输出的信息如下表示Elasticsearch安装成功：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">drwxr-xr-x. <span class="number">2</span> root   root  <span class="number">4096</span> <span class="number">9</span>月  <span class="number">23</span> <span class="number">2011</span> src</div><div class="line">[root<span class="symbol">@ELK</span> <span class="keyword">local</span>]<span class="meta">#  curl -XGET <span class="string">'http://192.168.1.234:9200/_cluster/health?pretty=true'</span></span></div><div class="line">&#123;</div><div class="line">  <span class="string">"cluster_name"</span> : <span class="string">"graylog-development"</span>,</div><div class="line">  <span class="string">"status"</span> : <span class="string">"yellow"</span>,</div><div class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</div><div class="line">  <span class="string">"number_of_nodes"</span> : <span class="number">1</span>,</div><div class="line">  <span class="string">"number_of_data_nodes"</span> : <span class="number">1</span>,</div><div class="line">  <span class="string">"active_primary_shards"</span> : <span class="number">37</span>,</div><div class="line">  <span class="string">"active_shards"</span> : <span class="number">37</span>,</div><div class="line">  <span class="string">"relocating_shards"</span> : <span class="number">0</span>,</div><div class="line">  <span class="string">"initializing_shards"</span> : <span class="number">0</span>,</div><div class="line">  <span class="string">"unassigned_shards"</span> : <span class="number">37</span>,</div><div class="line">  <span class="string">"delayed_unassigned_shards"</span> : <span class="number">0</span>,</div><div class="line">  <span class="string">"number_of_pending_tasks"</span> : <span class="number">0</span>,</div><div class="line">  <span class="string">"number_of_in_flight_fetch"</span> : <span class="number">0</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>安装Graylag</p>
<p>Graylog的最新版是1.1.4，下载链接如下：<br><a href="https://packages.graylog2.org/repo/el/6Server/1.1/x86_64/graylog-server-1.1.4-1.noarch.rpm" target="_blank" rel="external">https://packages.graylog2.org/repo/el/6Server/1.1/x86_64/graylog-server-1.1.4-1.noarch.rpm</a><br><a href="https://packages.graylog2.org/repo/el/6Server/1.1/x86_64/graylog-web-1.1.4-1.noarch.rpm" target="_blank" rel="external">https://packages.graylog2.org/repo/el/6Server/1.1/x86_64/graylog-web-1.1.4-1.noarch.rpm</a></p>
<p>现在Graylog的所有依赖软件安装完成，这一步我们来安装graylog-server。</p>
<p>首先，下载Graylog RPM软件包：</p>
<pre><code>$ cd 
$ sudo rpm -Uvh https://packages.graylog2.org/repo/packages/graylog-1.3-repository-el7_latest.rpm
</code></pre><p>安装graylog-server：</p>
<pre><code>yum -y install graylog-server
</code></pre><p>安装pwgen，我们使用它生成随机密码：</p>
<pre><code>yum -y install epel-release
yum -y install pwgen
</code></pre><p>现在我们来设置Graylog管理员的密钥。配置文件位于/etc/graylog/server/server.conf目录，需要修改password_secret参数：</p>
<pre><code>$ SECRET=$(pwgen -s 96 1)
$ sudo -E sed -i -e &apos;s/password_secret =.*/password_secret = &apos;$SECRET&apos;/&apos; /etc/graylog/server/server.conf
</code></pre><p>执行完上面命令之后，password_secret参数的样子：</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/graylog6.png" alt=""></figure></p>
<p>这一步，设置管理员密码。由于密码使用sha哈希算法，我们需要把明文密码转换为hash，然后赋值给root_password_sha2参数。例如，我要设置的管理员密码是 Ihaozhuo_b313，它对应的hash为：</p>
<pre><code>$ echo -n Ihaozhuo_b313 | sha256sum | awk &apos;{print $1}&apos;
</code></pre><p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/graylog7.png" alt=""></figure></p>
<p>编辑/etc/graylog/server/server.conf，设置root_password_sha2参数：</p>
<pre><code>$ sudo vim /etc/graylog/server/server.conf
</code></pre><p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/graylog8.png" alt=""></figure></p>
<p>现在Graylog管理员密码为Ihaozhuo_b313。</p>
<p>配置rest_transport_uri参数，设置Graylog web接口和服务器的沟通方式。由于我们把所有组件都安装到了单独的一个服务器上，需要把值设置为<strong>127.0.0.1</strong> 或 <strong>localhost</strong>。找到rest_transport_uri一行，取消注释，并把值设置为：</p>
<pre><code>rest_transport_uri = http://192.168.1.234:12900/
</code></pre><p>由于我们只有一个Elasticsearch shard，需要把elasticsearch_shards参数设置为1：</p>
<pre><code>elasticsearch_shards = 1
</code></pre><p>更改elasticsearch_cluster_name参数，应该和前面Elasticsearch的<strong>cluster.name</strong>参数相对应：</p>
<pre><code>elasticsearch_cluster_name = graylog-development
</code></pre><p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/graylog9.png" alt=""></figure></p>
<p>取消下面两行的注释，检测Elasticsearch：</p>
<pre><code>172 elasticsearch_discovery_zen_ping_multicast_enabled = false
173 elasticsearch_discovery_zen_ping_unicast_hosts = 192.168.1.234:9300
</code></pre><p>启动graylog-server：</p>
<pre><code>/etc/init.d/graylog-web restart
</code></pre><h3 id="安装Graylog-Web"><a href="#安装Graylog-Web" class="headerlink" title="安装Graylog Web"></a>安装Graylog Web</h3><p>安装Graylog Web：</p>
<pre><code>$ sudo yum -y install graylog-web
</code></pre><p>安装完成之后配置Graylog Web的密钥，配置文件位于/etc/graylog/web/web.conf，更改application.secret参数：</p>
<pre><code>$ SECRET=$(pwgen -s 96 1)
$ sudo -E sed -i -e &apos;s/application\.secret=&quot;&quot;/application\.secret=&quot;&apos;$SECRET&apos;&quot;/&apos; /etc/graylog/web/web.conf
</code></pre><p>配置graylog2-server.uris参数，它的值应该和Graylog的rest_listen_uri参数相对应：</p>
<pre><code>$ sudo vim /etc/graylog/web/web.conf

graylog2-server.uris=&quot;http://127.0.0.1:12900/&quot;
</code></pre><p>重启graylog-web：</p>
<pre><code>/etc/init.d/graylog-web restart
</code></pre><h3 id="配置Graylog服务器接收其他服务器的syslog日志"><a href="#配置Graylog服务器接收其他服务器的syslog日志" class="headerlink" title="配置Graylog服务器接收其他服务器的syslog日志"></a>配置Graylog服务器接收其他服务器的syslog日志</h3><h4 id="登录Graylog-Web"><a href="#登录Graylog-Web" class="headerlink" title="登录Graylog Web"></a>登录Graylog Web</h4><p>使用浏览器访问Graylog服务器的域名或IP：<strong><a href="http://graylog_public_IP_domain:9000/" target="_blank" rel="external">http://graylog_public_IP_domain:9000/</a></strong>。</p>
<p>你应该能看到一个登录界面，使用admin做为用户名和前面设置的密码登录。</p>
<p>登录之后：</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/graylog10.png" alt=""></figure></p>
<p>上面的红数字1是通知（you have a node without any running inputs），下面设置通过UDP接收syslog。</p>
<p>创建syslog UDP输入</p>
<p>添加要接收的其他服务器syslog日志：System-&gt;Inputs-&gt;Syslog UDP-&gt;Launch new input。</p>
<p>在弹出的窗口上输入如下信息：</p>
<ul>
<li>Title: syslog</li>
<li>Port: 8514</li>
<li>Bind address: 这里写Graylog-server服务器主机IP</li>
</ul>
<p>点击Launch</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/graylog11.png" alt=""></figure></p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/graylog12.png" alt=""></figure></p>
<p>如果你需要收集多个服务器的日志，重复上面步骤。</p>
<p>现在，我们的Graylog服务器已经做好了接收其他服务器发来日志的准备。下面我们还需要配置其他服务器，让这些服务器给Graylog服务器发送日志。</p>
<h4 id="配置其他服务器给Graylog服务器发送syslog"><a href="#配置其他服务器给Graylog服务器发送syslog" class="headerlink" title="配置其他服务器给Graylog服务器发送syslog"></a>配置其他服务器给Graylog服务器发送syslog</h4><p>参考官网：<a href="https://marketplace.graylog.org/addons/a47beb3b-0bd9-4792-a56a-33b27b567856" target="_blank" rel="external">从Linux系统日志发送到Graylog</a></p>
<p>SSH登录“其他服务器”，创建rsyslog配置文件90-graylog.conf：</p>
<pre><code>sudo vim /etc/rsyslog.d/90-graylog.conf
</code></pre><p>添加如下代码，把 graylog_server_IP 替换为Graylog服务器ip地址：</p>
<pre><code>$template GRAYLOGRFC5424,&quot;&lt;%pri%&gt;%protocol-version% %timestamp:::date-rfc3339%    %HOSTNAME% %app-name% %procid% %msg%\n&quot;
*.* @graylog_server_IP:8514;GRAYLOGRFC5424
</code></pre><p>重启rsyslog服务使生效：</p>
<pre><code>/etc/init.d/rsyslog restart
</code></pre><p>配置完成之后，回到Graylog Web，点击Sources，查看是否有新添加rsyslog。</p>
<h4 id="Graylog使用http协议发送："><a href="#Graylog使用http协议发送：" class="headerlink" title="Graylog使用http协议发送："></a>Graylog使用http协议发送：</h4><p>添加要接收的其他服务器syslog日志：System-&gt;Inputs-&gt;GELF HTTP-&gt;Launch new input。</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/graylog14.png" alt=""></figure></p>
<p>然后在服务器上面发送下面命令。</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="string">[root@graylog-development ~]</span># curl -XPOST http://<span class="number">192.168.1.234:12201</span>/gelf -p0 -d '&#123;<span class="string">"short_message"</span>:<span class="string">"Hello there"</span>, <span class="string">"host"</span>:<span class="string">"example.org"</span>, <span class="string">"facility"</span>:<span class="string">"test"</span>, <span class="string">"_foo"</span>:<span class="string">"bar"</span>&#125;'</div><div class="line"><span class="string">[root@graylog-development ~]</span># curl -XPOST http://<span class="number">192.168.1.234:12201</span>/gelf -p0 -d '&#123;<span class="string">"short_message"</span>:<span class="string">"测试"</span>, <span class="string">"host"</span>:<span class="string">"example.org"</span>, <span class="string">"facility"</span>:<span class="string">"test"</span>, <span class="string">"_foo"</span>:<span class="string">"bar"</span>&#125;'</div></pre></td></tr></table></figure>
<p>这里定义192.168.1.234 是graylog-server服务器地址 12201 端口是之前创建好的。</p>
<h3 id="搜素Graylog"><a href="#搜素Graylog" class="headerlink" title="搜素Graylog"></a>搜素Graylog</h3><p>假如你要搜索hello：</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/graylog13.png" alt=""></figure></p>
<p>上面安装配置了基本的Graylog服务器。</p>
<h3 id="时区和高亮设置"><a href="#时区和高亮设置" class="headerlink" title="时区和高亮设置"></a>时区和高亮设置</h3><p>admin帐号的时区：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="string">[root@graylog</span> <span class="string">~]#</span> <span class="string">vi</span> <span class="string">/etc/graylog/server/server.conf</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="number">30</span> <span class="string">root_timezone</span> <span class="string">=</span> <span class="string">Asia/Shanghai</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="string">[root@graylog</span> <span class="string">~]#</span> <span class="string">/etc/init.d/graylog-server</span> <span class="string">restart</span></div></pre></td></tr></table></figure>
<p>其他帐号的默认时区：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="string">[root@graylog</span> <span class="string">~]#</span> <span class="string">vi</span> <span class="string">/etc/graylog/web/web.conf</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="number">18</span> <span class="string">timezone="Asia/Shanghai"</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="string">[root@graylog</span> <span class="string">~]#</span> <span class="string">/etc/init.d/graylog-web</span> <span class="string">restart</span></div></pre></td></tr></table></figure>
<p>允许查询结果高亮：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="string">[root@graylog</span> <span class="string">~]#</span> <span class="string">vi</span> <span class="string">/etc/graylog/server/server.conf</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="number">147</span> <span class="string">allow_highlighting</span> <span class="string">=</span> <span class="literal">true</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="string">[root@graylog</span> <span class="string">~]#</span> <span class="string">/etc/init.d/graylog-server</span> <span class="string">restart</span></div></pre></td></tr></table></figure>
<h3 id="移动数据目录"><a href="#移动数据目录" class="headerlink" title="移动数据目录"></a>移动数据目录</h3><figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">移动elasticsearch的数据目录</div><div class="line">[root@graylog ~]<span class="comment"># sudo /etc/init.d/elasticsearch stop</span></div><div class="line">[root@graylog ~]<span class="comment"># sudo cp -rp /var/lib/elasticsearch/ /data/</span></div><div class="line">[root@graylog ~]<span class="comment"># sudo vi /etc/sysconfig/elasticsearch</span></div><div class="line">+<span class="number">16</span> DATA_DIR=/data/elasticsearch</div><div class="line">[root@graylog ~]<span class="comment"># sudo /etc/init.d/elasticsearch start</span></div><div class="line"></div><div class="line">移动mongo的数据目录</div><div class="line">[root@graylog ~]<span class="comment"># sudo /etc/init.d/mongod stop</span></div><div class="line">[root@graylog ~]<span class="comment"># sudo cp -rp /var/lib/mongo /data/</span></div><div class="line">[root@graylog ~]<span class="comment"># sudo vi /etc/mongod.conf</span></div><div class="line">---</div><div class="line"><span class="number">13</span> dbpath=/<span class="keyword">var</span>/lib/mongo<span class="function"></span></div><div class="line">-&gt;</div><div class="line"><span class="number">13</span> dbpath=/data/mongo</div><div class="line">---</div><div class="line">[mtagent@access2 ~]$ sudo /etc/init.d/mongod start</div></pre></td></tr></table></figure>
<h4 id="其余参考文档"><a href="#其余参考文档" class="headerlink" title="其余参考文档"></a>其余参考文档</h4><p><a href="http://docs.graylog.org/en/1.3/" target="_blank" rel="external">参考官网</a></p>
<p><a href="http://blog.topspeedsnail.com/archives/4066" target="_blank" rel="external">Centos7 搭建graylog</a></p>
<p><a href="https://my.oschina.net/fitnessefan/blog/464351?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="external">Graylog——日志聚合工具中的后起之秀</a></p>

	

	

</article>




	<article>
	
		<h1><a href="/2016/11/10/运维笔记/如何解决抽奖的性能问题和秒杀的讨论  /">如何解决秒杀的性能问题和微信推广活动的讨论</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-11-10</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/运维笔记/">运维笔记</a>
			</span><br />
		
		
	</div>

	

	
		<p>最近业务试水微信抽奖活动，公司现在打算推广下产品。增加些粉丝量 之前经常看到淘宝的同行们讨论秒杀，讨论电商，这次终于轮到我们自己理论结合实际一次了。</p>
<p>ps：进入正文前先说一点个人感受，之前看淘宝的ppt感觉都懂了，等到自己出解决方案的时候发现还是有很多想不到的地方其实都没懂，再次验证了“细节是魔鬼”的理论。并且一个人的能力有限，只有大家一起讨论才能想的更周全，更细致。好了，闲话少说，下面进入正文。</p>
<h4 id="一、抽奖活动带来了什么？"><a href="#一、抽奖活动带来了什么？" class="headerlink" title="一、抽奖活动带来了什么？"></a>一、抽奖活动带来了什么？</h4><p>微信积分兑换现金或抢购抽奖活动一般会经过【关注公众号】【分享活动获得积分】【积分兑换】【抽奖安全环节】这3个大环节，而其中【抢订单】这个环节是最考验业务提供方的抗压能力的。</p>
<p>积分兑换环节一般会带来2个问题：</p>
<ul>
<li>1、高并发</li>
</ul>
<p>　　比较火热的抽奖在线人数都是20w起的，如此之高的在线人数对于网站架构从前到后都是一种考验。</p>
<ul>
<li>2、抽奖人员过多</li>
<li>3、 抢订单</li>
</ul>
<p>　　任何商品都会有数量上限，如何避免成功下订单买到商品的人数不超过商品数量的上限，这是每个抢购活动都要面临的难题。</p>
<h4 id="二、如何解决？"><a href="#二、如何解决？" class="headerlink" title="二、如何解决？"></a>二、如何解决？</h4><p>首先，产品解决方案我们就不予讨论了。我们只讨论技术解决方案</p>
<p><strong>1、前端架构</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">面对高并发的抢购活动，前端常用的三板斧是【扩容】【静态化】【限流】</div><div class="line"></div><div class="line">　　A：扩容</div><div class="line">　　</div><div class="line">　加机器，这是最简单的方法，通过增加前端池的整体承载量来抗峰值。 </div><div class="line">　这里我们都是多台主从集群去跑。</div><div class="line"></div><div class="line">　　B：静态化</div><div class="line"></div><div class="line">　　将活动页面上的所有可以静态的元素全部静态化，并尽量减少动态元素。通过CDN来抗峰值。</div><div class="line">　　这里我们都是把图片静态放在又拍云和阿里云上面。</div><div class="line">　</div><div class="line">　　C：限流</div><div class="line"></div><div class="line">　　一般都会采用IP级别的限流，即针对某一个IP，限制单位时间内发起请求数量。</div><div class="line">　　或者活动入口的时候增加游戏或者问题环节进行消峰操作。</div><div class="line">　　我们采用Nginx前面做了反向代理后面优化nginx。</div><div class="line">　　</div><div class="line">　　D：有损服务</div><div class="line"></div><div class="line">　　最后一招，在接近前端池承载能力的水位上限的时候，随机拒绝部分请求来保护活动整体的可用性。</div></pre></td></tr></table></figure>
<p><strong>2、后端架构</strong></p>
<p>那么后端的数据库在高并发和超卖下会遇到什么问题呢？主要会有如下3个问题：（主要讨论写的问题，读的问题通过增加cache可以很容易的解决）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">　　I：　首先MySQL自身对于高并发的处理性能就会出现问题，一般来说，MySQL的处理性能会随着并发thread上升而上升，但是到了一定的并发度之后会出现明显的拐点，之后一路下降，最终甚至会比单thread的性能还要差。</div><div class="line"></div><div class="line">　　II： 其次，超卖的根结在于减库存操作是一个事务操作，需要先<span class="keyword">select</span>，然后<span class="keyword">insert</span>，最后<span class="keyword">update</span> <span class="number">-1</span>。最后这个<span class="number">-1</span>操作是不能出现负数的，但是当多用户在有库存的情况下并发操作，出现负数这是无法避免的。</div><div class="line"></div><div class="line">　　III：最后，当减库存和高并发碰到一起的时候，由于操作的库存数目在同一行，就会出现争抢<span class="keyword">InnoDB</span>行锁的问题，导致出现互相等待甚至死锁，从而大大降低MySQL的处理性能，最终导致前端页面出现超时异常。</div><div class="line">　　</div><div class="line">　　这个有遇到过的，就是锁表导致访问出现网络异常。</div></pre></td></tr></table></figure>
<p>针对上述问题，如何解决呢？ 我们先看眼淘宝的高大上解决方案：</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">I：关闭死锁检测，提高并发处理性能。</div><div class="line">II：修改源代码，将排队提到进入引擎层前，降低引擎层面的并发度。</div><div class="line">III：组提交，降低<span class="keyword">server</span>和引擎的交互次数，降低IO消耗。</div></pre></td></tr></table></figure>
<h3 id="解决方案1："><a href="#解决方案1：" class="headerlink" title="解决方案1："></a>解决方案1：</h3><p>将存库从MySQL前移到Redis中，所有的写操作放到内存中，由于Redis中不存在锁故不会出现互相等待，并且由于Redis的写性能和读性能都远高于MySQL，这就解决了高并发下的性能问题。然后通过队列等异步手段，将变化的数据异步写入到DB中。</p>
<p>优点：解决性能问题<br>缺点：没有解决超卖问题，同时由于异步写入DB，存在某一时刻DB和Redis中数据不一致的风险。</p>
<h3 id="解决方案2："><a href="#解决方案2：" class="headerlink" title="解决方案2："></a>解决方案2：</h3><p>引入队列，然后将所有写DB操作在单队列中排队，完全串行处理。当达到库存阀值的时候就不在消费队列，并关闭购买功能。这就解决了超卖问题。</p>
<p>优点：解决超卖问题，略微提升性能。<br>缺点：性能受限于队列处理机处理性能和DB的写入性能中最短的那个，另外多商品同时抢购的时候需要准备多条队列。</p>
<h3 id="解决方案3："><a href="#解决方案3：" class="headerlink" title="解决方案3："></a>解决方案3：</h3><p>将写操作前移到MC中，同时利用MC的轻量级的锁机制CAS来实现减库存操作。<br>优点：读写在内存中，操作性能快，引入轻量级锁之后可以保证同一时刻只有一个写入成功，解决减库存问题。<br>缺点：没有实测，基于CAS的特性不知道高并发下是否会出现大量更新失败？不过加锁之后肯定对并发性能会有影响。</p>
<h3 id="解决方案4："><a href="#解决方案4：" class="headerlink" title="解决方案4："></a>解决方案4：</h3><p>将提交操作变成两段式，先申请后确认。然后利用Redis的原子自增操作（相比较MySQL的自增来说没有空洞），同时利用Redis的事务特性来发号，保证拿到小于等于库存阀值的号的人都可以成功提交订单。然后数据异步更新到DB中。</p>
<p>优点：解决超卖问题，库存读写都在内存中，故同时解决性能问题。<br>缺点：由于异步写入DB，可能存在数据不一致。另可能存在少买，也就是如果拿到号的人不真正下订单，可能库存减为0，但是订单数并没有达到库存阀值。</p>
<p> 三、总结</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>、前端三板斧【扩容】【限流】【静态化】</div><div class="line"><span class="number">2</span>、后端两条路【内存】+【排队】</div></pre></td></tr></table></figure>
<h4 id="测试总结经验"><a href="#测试总结经验" class="headerlink" title="测试总结经验"></a>测试总结经验</h4><p>第一次做抽奖活动，测试那边测试出很多问题。 下面是遇到的问题。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">测试第一次: 访问压测出现了访问白屏。定位：代码写的有问题。 tomcat需要做优化。 我们一般用户量粉丝在100W</div><div class="line"></div><div class="line">测试第二次： 出现数据库<span class="meta">CPU</span>瓶颈过高。主从同步，然后做了数据库读写分离， redis集群缓存。 最主要是数据库SQL语句做了优化。优化了提升了很大一部分。</div><div class="line"></div><div class="line">测试第三次：还有出现了<span class="number">503</span>访问受限了。 后面做了nginx代理 防止同一个<span class="built_in">IP</span>同一个时间超过多少次去请求，会被受限。 不过这个做DDOS攻击 有很大一部分影响用户名体验度。</div></pre></td></tr></table></figure>
<h4 id="四、非技术感想"><a href="#四、非技术感想" class="headerlink" title="四、非技术感想"></a>四、非技术感想</h4><p>1、团队的力量是无穷的，各种各样的解决方案（先不谈可行性）都是在小伙伴们七嘴八舌中讨论出来的。我们需要让所有人都发出自己的声音，不要着急去否定。<br>2、优化需要从整体层面去思考，不要只纠结于自己负责的部分，如果只盯着一个点思考，最后很可能就走进死胡同中了。<br>3、有很多东西以为读过了就懂了，其实不然。依然还是需要实践，否则别人的知识永远不可能变成自己的。<br>4、多思考为什么，会发生什么，不要想当然。只有这样才能深入进去，而不是留在表面。</p>
<h3 id="交流学习："><a href="#交流学习：" class="headerlink" title="交流学习："></a>交流学习：</h3><p>🐧  Linux shell_高级运维派: <code>459096184</code>    圈子 (系统运维-应用运维-自动化运维-虚拟化技术研究欢迎加入)<br>🐧  BigData-Exchange School : <code>521621407</code>  圈子（大数据运维)（Hadoop开发人员)（大数据研究爱好者) 欢迎加入</p>
<p>相应Bidata有内部微信交流群互相学习，加入QQ群有链接。</p>

	

	

</article>




	<article>
	
		<h1><a href="/2016/11/02/运维安全/运维安全重要性：创业公司如何维护好服务器/">运维安全重要性：创业公司如何维护好服务器</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-11-02</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/运维安全/">运维安全</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Operation-safety/">Operation safety</a>
			</span>
		
	</div>

	

	
		<h3 id="运维安全重要性-创业公司如何维护好服务器"><a href="#运维安全重要性-创业公司如何维护好服务器" class="headerlink" title="运维安全重要性:创业公司如何维护好服务器"></a>运维安全重要性:创业公司如何维护好服务器</h3><p>2016年下半年，勒索软件成了企业安全的一个致命伤。卡巴斯基在2016年12月份发布的年度热门事件：加密勒索报告显示，截止到2016年，全球有114个国家受到加密勒索事件的影响，共发现44000多个勒索软件样本。亚信安全发布的勒索软件风险研究报告也显示，近十个月内，全球传播的勒索软件数量增长了15倍，中国勒索软件数量增长更是突破了67倍。</p>
<p>企业如遭到勒索，需要按照要求支付“赎金”，否则文件将有可能永远无法打开。勒索软件欺诈金额巨大，且防范困难；通常，企业支出的赎金，会用来发展下一代勒索软件。近期，国外安全研究人员还发现，有勒索软件目标锁定 Linux服务器，还有新型的勒索软件集成了DDoS功能。可预测，加密勒索事件仍会持续蔓延。</p>
<h3 id="阿里云安全团队深入分析勒索软件背后成因"><a href="#阿里云安全团队深入分析勒索软件背后成因" class="headerlink" title="阿里云安全团队深入分析勒索软件背后成因"></a>阿里云安全团队深入分析勒索软件背后成因</h3><p>阿里云安全团队第一时间告知用户勒索软件的蔓延趋势，并为用户提供应急加固方案。同时，从勒索软件行为方式方面着手，研发针对勒索加密软件的查杀功能，保证用户云上安全。</p>
<p>点击链接查看加密勒索软件防护方案：<a href="https://help.aliyun.com/knowledge_detail/48701.html" target="_blank" rel="external">https://help.aliyun.com/knowledge_detail/48701.html</a></p>
<p>阿里云安全通过对目前勒索事件的数据分析，发现被勒索软件入侵的受害者，都有两大共性：</p>
<h3 id="1、关键账号存在弱口令或无认证机制"><a href="#1、关键账号存在弱口令或无认证机制" class="headerlink" title="1、关键账号存在弱口令或无认证机制"></a>1、关键账号存在弱口令或无认证机制</h3><p>· 服务器登录关键账号(root、administrator)密码简单或空密码；<br>· 数据库(Redis、MongoDB、MySQL、MSsql Server)等相关重要业务服务直接可以无密码登录。</p>
<h3 id="2、无访问控制策略，业务“裸奔”在互联网上"><a href="#2、无访问控制策略，业务“裸奔”在互联网上" class="headerlink" title="2、无访问控制策略，业务“裸奔”在互联网上"></a>2、无访问控制策略，业务“裸奔”在互联网上</h3><p>· RDP、SSH、Redis、MongoDB、MySQL、MSsql Server等高危服务直接裸奔在互联网上</p>
<p>以上两类问题是黑客利用成本较低的攻击方式。攻击者不需要获取账号密码，就可以对业务造成重创。目前，大部分勒索软件攻击都是通过Windows可执行文件中包含的恶意代码实现的，随着勒索软件的不断“变种”，还可能演化出新的攻击方式。</p>
<h4 id="云计算平台如何帮助企业减少被勒索风险"><a href="#云计算平台如何帮助企业减少被勒索风险" class="headerlink" title="云计算平台如何帮助企业减少被勒索风险"></a>云计算平台如何帮助企业减少被勒索风险</h4><p>云计算平台的威胁情报能力，基础安全功能，安全产品和专家团队，能够有效帮助企业减少风险。相比自建IDC的封闭环境，云上的安全防护选择和管理手段更加多样化，企业在了解业务现状和防御情况的前提下，可在云上定制防御策略，找到合适自己的预防措施。</p>
<p>云平台为企业提供必要的安全工具（如快照功能），并具备强大的容灾、数据恢复能力；经验丰富的安全专家，会针对最新的攻击类型制定相应加固措施。</p>
<p> 在应对勒索软件攻击的场景下，阿里云建议企业采用以下防护措施：</p>
<h4 id="定期备份数据。"><a href="#定期备份数据。" class="headerlink" title="定期备份数据。"></a>定期备份数据。</h4><p>在阿里云上，建议企业开启镜像和快照，每天进行备份，并保存3份以上的版本。这样即使遇到勒索软件病毒入侵，也可以迅速恢复到1天前的业务数据。</p>
<h4 id="对服务器进行合理的安全域规划。"><a href="#对服务器进行合理的安全域规划。" class="headerlink" title="对服务器进行合理的安全域规划。"></a>对服务器进行合理的安全域规划。</h4><p>建议使用阿里云的VPC服务，用于隔离不同租户间业务应用。同时将不同安全级别的服务器，划分到不同的安全域。以免低安全域的服务器中招后，感染高安全域的其它服务器。</p>
<h4 id="服务口令和远程访问权限管理。"><a href="#服务口令和远程访问权限管理。" class="headerlink" title="服务口令和远程访问权限管理。"></a>服务口令和远程访问权限管理。</h4><p>服务器的口令建议至少8位以上，同时必须包含复杂的字符。不应向外网直接开放服务器的远程访问权限。如需要远程运维，建议通过阿里云.云市场上的IPsecVPN或SSLVPN的远程访问解决方案。推荐企业在VPC网关处部署云市场的专业防火墙镜像系统：其可同时支持VPN的远程访问，还可实现VPC南北向流量的访问控制。</p>
<h4 id="服务器对外只开放必要的端口，控制服务器的主动外联访问。"><a href="#服务器对外只开放必要的端口，控制服务器的主动外联访问。" class="headerlink" title="服务器对外只开放必要的端口，控制服务器的主动外联访问。"></a>服务器对外只开放必要的端口，控制服务器的主动外联访问。</h4><p>可以在VPC 网关处的防火墙，或阿里云安全组防火墙上，设置服务器对外访问端口。只开放必要的端口，减少攻击面，保护服务器的安全。同时，通过阿里云安全组防火墙禁止服务器的主动访问行为，以阻止受感染服务器可能会尝试连接C&amp;C服务器。</p>
<h4 id="服务器口令和漏洞的防护。"><a href="#服务器口令和漏洞的防护。" class="headerlink" title="服务器口令和漏洞的防护。"></a>服务器口令和漏洞的防护。</h4><p>建议使用阿里云云盾的安骑士产品，以对非法破解密码的行为进行识别，避免被黑客多次猜解密码而入侵。同时可以一键清除网站后门维护服务器环境纯净，批量修复高危漏洞。</p>
<h4 id="Web应用漏洞的防护。"><a href="#Web应用漏洞的防护。" class="headerlink" title="Web应用漏洞的防护。"></a>Web应用漏洞的防护。</h4><p>对于Web网站，推荐使用阿里云云盾WAF，用于防御OWASP 常见威胁，并对SQL注入、XSS跨站、Webshell上传、后门隔离保护、命令注入、非法HTTP协议请求、常见Web服务器漏洞攻击、核心文件非授权访问、路径穿越、扫描防护等安全防护；定期及时更新0day补丁，对网站进行安全防护。</p>

	

	

</article>




	<article>
	
		<h1><a href="/2016/10/29/自动化+Jenkins/Jenkins/讲如何结合jenkins+ ansible构建发布系统/">讲如何结合jenkins+ ansible构建发布系统</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-10-29</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/automation/">automation</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Jenkins/">Jenkins</a>
			</span>
		
	</div>

	

	
		<h1 id="jenkins-ansible，打造一个web构建发布系统"><a href="#jenkins-ansible，打造一个web构建发布系统" class="headerlink" title="jenkins+ansible，打造一个web构建发布系统"></a>jenkins+ansible，打造一个web构建发布系统</h1><p>自动化这块我们测试生产环境已经用起来了。</p>
<p>这篇文章主要讲我们如何实现整个web发布系统，如何安装配置看我blog上面有。</p>
<p>需要了解几款自动化工具： SaltStack,Ansible,Puppet,jenkins</p>
<p>所以我们第1步做的就是：用Ansible + Jenkins搞定自动发布。Ansible是相对简单的批量管理工具，支持模板管理等高级功能。搞定了自动发布，开发的服务器需求已经明显下降，只要把代码提交到 Git主干，就会自动触发发布。</p>
<p>Git使用的是 GitLab，后期同时为了安全我们做了一层LDAP代理，效果相当于“将军令”，操作机、Git和Jenkins用 OpenLDAP 做统一认证，后续用到的Redmine、Grafana、Zabbix等都接入了OpenLDAP认证，每个人都有个动态口令，每次验证都需要用到。</p>
<h3 id="流程结构"><a href="#流程结构" class="headerlink" title="流程结构"></a>流程结构</h3><p> 简单绘制了下Jenkins的一个流程，如下图：</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/jenkins4.png" alt=""></figure></p>
<p> 拓扑图</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/jenkins5.png" alt=""></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">    &gt; 该平台以jenkins 为中心，然后围绕他进行扩展。</div><div class="line"></div><div class="line">    &gt; 代码全局配置通过”文件管理平台” 进行管理。每次代码进行build时，pull一下配置。使配置为最新的。</div><div class="line"></div><div class="line">    &gt; 开发人员将代码push到gitlab，开发者之间相互review代码。然后murge到master分支。jenkins上的pull代码到workspace空间。</div><div class="line"></div><div class="line">     &gt; 安装一些依赖的第三方包。 </div><div class="line"></div><div class="line">     &gt; 代码和配置文件进行合并，通过redis存储的版本信息创建版本。</div><div class="line"></div><div class="line">     &gt; 把将要发布的版本推送到远端机器，reload服务实现上线。</div><div class="line"></div><div class="line">     &gt; 当发布的代码出现问题，回滚指定版本(默认回滚上一版本)，最多可回滚之前5个版本。</div><div class="line">``` </div><div class="line"></div><div class="line">ansible是新出现的自动化运维工具，基于Python开发，集合了众多运维工具（puppet、cfengine、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。ansible是基于模块工作的，本身没有批量部署的能力。真正具有批量部署的是ansible所运行的模块，ansible只是提供一种框架。主要包括：</div><div class="line"></div><div class="line">```bash</div><div class="line">(1)、连接插件connection plugins：负责和被监控端实现通信；</div><div class="line">(2)、host inventory：指定操作的主机，是一个配置文件里面定义监控的主机；</div><div class="line">(3)、各种模块核心模块、<span class="built_in">command</span>模块、自定义模块；</div><div class="line">(4)、借助于插件完成记录日志邮件等功能；</div><div class="line">(5)、playbook：剧本执行多个任务时，非必需可以让节点一次性运行多个任务。</div></pre></td></tr></table></figure>
<p>这里之前用Jenkins使用起来。遇到个难题这里分析哪几点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">github作为源代码仓库 </div><div class="line">jenkins做为打包服务器，Web控制服务器</div><div class="line">在jenkins的系统配置里，可以找到maven，git，Java相关的配置，只要勾选了，在开时执行job时，会自动下载。</div><div class="line">ansible把war包，发布到远程机器</div><div class="line">tomcat每台服务器环境都需要在ansible /etc/ansible/hosts配置好，这样可以让它自动化下发到对应机器。</div><div class="line">把jenkins生成的war包发布到远程服务器上。</div><div class="line">进入该项目的workspace目录下保存该playbook的仓库子目录下, 检查ansible版本, 并执行最终的部署命令.会不会发布出现乱码。</div></pre></td></tr></table></figure>
<p><strong>监控：</strong></p>
<p>由于原始的监控不满足快速增长的业务，我这边部署了开源监控系统 Zabbix，虽然运维能够很好的使用Zabbix，但其他部门同事总觉得易用性不高、而且很多定制化监控实现起来很麻烦。还是需要有运维开发同事帮忙辅助会更好。</p>

	

	

</article>




	<article>
	
		<h1><a href="/2016/10/10/运维笔记/个人总结：为什要学习docker，如何学习Docker/">个人总结：为什要学习docker，如何学习Docker</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-10-10</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/运维笔记/">运维笔记</a>
			</span><br />
		
		
	</div>

	

	
		<p>学习任何一个开源新技术，首先问自己几个问题：</p>
<h6 id="1-为什要学习它？"><a href="#1-为什要学习它？" class="headerlink" title="1. 为什要学习它？"></a>1. 为什要学习它？</h6><h6 id="2-学习它需要了解哪些相关知识点？"><a href="#2-学习它需要了解哪些相关知识点？" class="headerlink" title="2. 学习它需要了解哪些相关知识点？"></a>2. 学习它需要了解哪些相关知识点？</h6><h6 id="3-如何快速学习？"><a href="#3-如何快速学习？" class="headerlink" title="3. 如何快速学习？"></a>3. 如何快速学习？</h6><h6 id="4-该技术的使用场景是什么？"><a href="#4-该技术的使用场景是什么？" class="headerlink" title="4. 该技术的使用场景是什么？"></a>4. 该技术的使用场景是什么？</h6><p>拿我个人的学习经验来举例（本人之前比较了解KVM，ESxi,OpenStack）</p>
<h3 id="为什要学习docker？"><a href="#为什要学习docker？" class="headerlink" title="为什要学习docker？"></a>为什要学习docker？</h3><p>个人回答：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">docker是轻量级虚拟化技术，docker使linux容器技术的应用更加简单和标准化</div><div class="line">docker的速度很快,容器启动时毫秒级的</div><div class="line">docker将开发和运维职责分清</div><div class="line">docker解决了依赖地狱问题</div><div class="line">docker支持几乎所有操作系统</div><div class="line">docker有着飞速发展的生态圈</div><div class="line">很多IT巨头逐渐加入和支持</div></pre></td></tr></table></figure>
<p>学习它需要了解哪些相关知识点？</p>
<p>回答：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">云计算概念相关（restapi, 微服务，OpenStack）</div><div class="line">Linux 系统管理（软件包管理，用户管理，进程管理等）</div><div class="line">Linux 内核相关（Cgroup, namespace 等）</div><div class="line">Linux 文件系统和存储相关（AUFS，BRFS,devicemapper 等）</div><div class="line">Linux 网络（网桥，veth,iptables等）</div><div class="line">Linux安全相关（Appmor,Selinux 等）</div><div class="line">Linux进程管理（Supervisord,Systemd etc)</div><div class="line">Linux容器技术（LXC等）</div><div class="line">开发语言（Python, GO,Shell 等）</div></pre></td></tr></table></figure>
<p>3.如何快速学习？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">回答：个人体会最好有一个实际的需求或项目来边实践边学习，入门可以参考</div><div class="line">（第一本docker书）写的不错，非常适合入门。</div><div class="line"></div><div class="line">除此之外，阅读牛人的blog比如官方blog http://blog.docker.com/</div></pre></td></tr></table></figure>
<p>最后，参与社区互动也是很好的学习方式。</p>
<p>该技术的使用场景是什么？<br>回答：docker非常适用于dev/test CI/CD 场景，用完就扔。还有就是PasS了。</p>
<h3 id="为什要学习Docker"><a href="#为什要学习Docker" class="headerlink" title="为什要学习Docker"></a>为什要学习Docker</h3><ul>
<li><p>1.学习Docker，如果没有云计算的基本知识，以及内核的基本知识，那么学习并理解起来会稍吃力。作为容器，Docker容器的优势在哪，不足在哪，最好了解容器的实现是怎样的（简单了解）；拥有镜像管理，Docker又该如何体现软件开发，集成，部署，发布，再迭代的软件生命周期管理优势。以上两点我认为最为关键，有这两方面的认识势必会对之后的工作帮助巨大。</p>
</li>
<li><p>2.关于学习资源，起码的硬件设施总是要有的。Docker及其生态的发展很快，不使用纯理论肯定收效甚微。另外，资源还包括Docker官方，各大电子媒体平台，技术论坛，开源社区等，往往大拿的观点能点破自己的困惑，或者让自己知道哪方面的认识还很欠缺，以及让自己少走很多的弯路。</p>
</li>
<li><p>3.个人兴趣的话，归结为强扭的瓜不甜。起码应该认同Docker的设计价值，以及Docker的未来潜力，当然有依据的批判Docker并带动大家的思考，也是深切关注的表现。</p>
</li>
<li><p>4.个人发展方向，我认为如果需要把Docker当作软件生命周期管理工具的话，那用好Docker最为重要，API及命令的理解与使用是必需的。如果专注系统设计方面，那么除Docker以上的知识与经验之外，若有Docker源码的学习与理解，那么这些肯定会让你的Docker水平提高一个层次。</p>
</li>
</ul>
<ul>
<li><p>学习Docker，最大的好处是跟进新技术发展方向。我觉得在校生应该没有多少硬性需求在Docker的研究上，这也是为什么学校没做具体应用要求的原因。最实际的做法是看一些Docker使用案例，自己实践出一些经验应该会再以后的社会实践中起到作用。</p>
</li>
<li><p>研究docker的源代码，应该到你下定决心从事云计算方面的事业或者研究，那么你就需要以研究者的身份去做仔细的源码分析的工作。</p>
</li>
</ul>
<h4 id="Docker火起来的真正原因是什么？"><a href="#Docker火起来的真正原因是什么？" class="headerlink" title="Docker火起来的真正原因是什么？"></a>Docker火起来的真正原因是什么？</h4><p>我认为有这么几点，</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">普通开发者有机会接触容器技术，享受开发发布一体化的便利。</div><div class="line">容器云是区别于传统IaaS服务的另一种更快速更高效的轻量级选择。</div><div class="line">基于镜像的第二个GitHub、<span class="keyword">CI</span>/<span class="keyword">CD</span>服务、代码发布、在线debug。</div></pre></td></tr></table></figure>
<h3 id="交流学习："><a href="#交流学习：" class="headerlink" title="交流学习："></a>交流学习：</h3><p>🐧  Linux shell_高级运维派: <code>459096184</code>    圈子 (系统运维-应用运维-自动化运维-虚拟化技术研究欢迎加入)<br>🐧  BigData-Exchange School : <code>521621407</code>  圈子（大数据运维)（Hadoop开发人员)（大数据研究爱好者) 欢迎加入</p>
<p>相应Bidata有内部微信交流群互相学习，加入QQ群有链接。</p>

	

	

</article>




	<article>
	
		<h1><a href="/2016/09/24/Node.js-npm/Node.js使用pm2进程守护+keymetrics实时监控Node.js程序/">Node.js使用pm2进程守护+keymetrics实时监控Node.js程序</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-09-24</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Node-js/">Node.js</a>
			</span>
		
	</div>

	

	
		<p>通过pm2能守护node.js程序永远在线，在实际应用中是非常有必要的。另外，pm2配合keymetrics能实时监控node.js程序的运行，达到监控node.js程序的目的。</p>
		<p><a class="article__read-more-link" href="/2016/09/24/Node.js-npm/Node.js使用pm2进程守护+keymetrics实时监控Node.js程序/">...read more</a></p>
	

	

</article>





	<span class="different-posts">📖 <a href="/page/6">more posts</a> 📖</span>



	</main>

	<footer class="footer">
	<div class="footer-content">
		
	      <div class="footer__element">
	<h5>Hi there,</h5>
	<p style="text-align:justify;">my name is Yancy, they know me as Radiant🐑🐑. This blog is about Bi-data and my live.<br> I like 🌳🌳🌳</p>
</div>


	    
	      <div class="footer__element">
	<h5>Check out</h5>
	<ul class="footer-links">
		<li class="footer-links__link"><a href="/archives">Archive</a></li>
		
		  <li class="footer-links__link"><a href="/atom.xml">RSS</a></li>
	    
		<li class="footer-links__link"><a href="/about">about page</a></li>
		<li class="footer-links__link"><a href="/tags">Tags</a></li>
		<li class="footer-links__link"><a href="/categories">Categories</a></li>
	</ul>
</div>

	    

		<div class="footer-credit">
			<span>© 2017 Yancy | Powered by <a href="http://blog.yancy.cc/">Yancy</a> | Theme <a href="https://github.com/yangcvo">Yancy_GitHub</a></span>
		</div>

	</div>


</footer>



</body>

</html>
