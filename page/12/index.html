<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="theme-color" content="#33474d">
	<title>Yancy&#39;s blog</title>
	<link rel="stylesheet" href="/css/style.css" />
	
      <link rel="alternate" href="/atom.xml" title="Yancy&#39;s blog" type="application/atom+xml">
    
</head>

<body>

	<header class="header">
		<nav class="header__nav">
			
				<a href="/" class="header__link">Home</a>
			
				<a href="/tags" class="header__link">Tags</a>
			
				<a href="/archives" class="header__link">ARCHIVES</a>
			
				<a href="/about/About" class="header__link">ABOUT</a>
			
				<a href="http://weibo.com/yangcvo" class="header__link">Weibo</a>
			
				<a href="/atom.xml" class="header__link">RSS</a>
			
		</nav>
		<h1 class="header__title"><a href="/">Yancy&#39;s blog</a></h1>
		<h2 class="header__subtitle">SIMPLICITY IS PREREQUISITE FOR  RELIABILITY</h2>
	</header>

	<main>
		
	<span class="different-posts different-posts_earlier">📖 <a href="/page/11">earlier posts</a> 📖</span>




	<article>
	
		<h1><a href="/2014/10/01/性能监控/Zabbix/zabbix的ICMP-Ping模版实现对客户端网络状态的监控/">zabbix的ICMP_Ping模版实现对客户端网络状态的监控</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2014-10-01</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/monitoring/">monitoring</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Zabbix-monitoring/">Zabbix monitoring</a>
			</span>
		
	</div>

	

	
		<p>上一次搭建了邮件告警和微信告警，可以很方便及时接收到告警的。<br>这里讲zabbix里面ICMP-ping模板的实现网络监控。</p>
<p>Zabbix使用外部命令fping处理ICMP ping的请求，fping不包含在zabbix的发行版本中，需要额外去下载安装fping程序，安装完毕之后需要在<code>zabinx_server.conf</code>中的参数<code>FpingLocation</code>配置fping安装的路径。</p>
<p>由于fping默认是<code>root</code>权限工作，而<code>zabbix-server</code>是zabbix用户运行的，所以需要对fping程序设置<code>setuid</code>权限，<br>如果在自定义key的时候需要用到<code>netstat</code>命令，也同样要设置<code>setuid</code>，否则不能获取到数据，而在日志中提示权拒绝。</p>
<h3 id="一、登陆Zabbix服务器做以下操作："><a href="#一、登陆Zabbix服务器做以下操作：" class="headerlink" title="一、登陆Zabbix服务器做以下操作："></a>一、登陆Zabbix服务器做以下操作：</h3><p>1.fping安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">wget http://www.fping.org/dist/fping-3.10.tar.gz</div><div class="line">tar zxvf fping-3.10.tar.gz</div><div class="line"><span class="built_in">cd</span> fping-3.10</div><div class="line">./configure --prefix=/usr/<span class="built_in">local</span>/fping/</div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure>
<p>2.修改zabbix_server.conf配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">vim /usr/<span class="built_in">local</span>/zabbix/etc/zabbix_server.conf</div><div class="line"></div><div class="line">把FpingLocation路径修改为刚安装的fping路径。</div><div class="line"></div><div class="line">FpingLocation=/usr/<span class="built_in">local</span>/fping/sbin/fping</div></pre></td></tr></table></figure>
<p>如果不修改zabbix_server.conf配置件需要使用软连接到/usr/local/sbin/fping，zabbix默认fping的路径是/usr/sbin/fping</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ln <span class="_">-s</span> /usr/sbin/fping /path/to/non-existant/fping</div><div class="line">ln <span class="_">-s</span> /usr/sbin/fping6 /path/to/non-existant/fping6</div></pre></td></tr></table></figure>
<p>3.修改fping权限（如果不设下面权限，zabbix服务端会采集不到数据）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># chown root:zabbix /usr/local/fping/sbin/fping</span></div><div class="line"><span class="comment"># chmod 4710 /usr/local/fping/sbin/fping</span></div></pre></td></tr></table></figure>
<p>安装完fping，设置好zabbix-server 配置文件，需要重启服务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service zabbix_server restart  <span class="comment">#重启服务</span></div></pre></td></tr></table></figure>
<p>4.zabbix用户测试fping命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/usr/<span class="built_in">local</span>/fping/sbin/fping www.baidu.com</div><div class="line">www.baidu.com is alive   <span class="comment"># 说明命令返回成功。</span></div></pre></td></tr></table></figure>
<h3 id="二、登陆Zabbix监控网页做以下设置"><a href="#二、登陆Zabbix监控网页做以下设置" class="headerlink" title="二、登陆Zabbix监控网页做以下设置"></a>二、登陆Zabbix监控网页做以下设置</h3><p>打开zabbix-configuration-host-creat </p>
<p>1.host添加需要监控的ip地址,这里就不介绍了。</p>
<p>2.选择模版template icmp ping</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/zabbix-icmp.png" alt=""></figure></p>
<p>3.添加Graphs</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/zabbix-icmp1.png" alt=""></figure></p>
<p>添加完以后可以查看对应的机器图形：</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/zabbix-icmp2.png" alt=""></figure></p>
<p>四、触发器模版已自带，设置报警方式后就可以接收报警邮件了。</p>
<p>zabbix-server2.4服务端编译安装 <a href="http://blog.yangcvo.me/2015/01/18/zabbix-server服务端编译安装/" target="_blank" rel="external">zabbix-server服务端编译安装</a></p>
<p>zabbix2.4监控80端口状态 : <a href="http://blog.yangcvo.me/2016/07/20/zabbix监控80端口状态/" target="_blank" rel="external">zabbix监控80端口状态</a></p>
<p>zabbix+Grafana安装使用监控结合 ：<a href="http://blog.yangcvo.me/2016/07/13/zabbix-Grafana安装使用结合/" target="_blank" rel="external">zabbix+Grafana安装使用监控结合</a></p>
<p>zabbix监控MySQL-添加自定义监控项 : <a href="http://blog.yangcvo.me/2015/09/29/zabbix监控MySQL-添加自定义监控项/" target="_blank" rel="external">zabbix监控MySQL-添加自定义监控项</a></p>
<p>zabbix的ICMP_Ping模版实现对客户端网络状态的监控 : <a href="http://blog.yangcvo.me/2015/11/18/zabbix的ICMP-Ping模版实现对客户端网络状态的监控/" target="_blank" rel="external">zabbix的ICMP_Ping模版实现对客户端网络状态的监控</a></p>
<p>zabbix性能监控故障总结 <a href="http://blog.yangcvo.me/2016/02/07/zabbix-故障总结/" target="_blank" rel="external">zabbix性能监控故障总结</a></p>

	

	

</article>




	<article>
	
		<h1><a href="/2014/09/29/性能监控/Zabbix/zabbix监控MySQL-添加自定义监控项/">zabbix监控MySQL-添加自定义监控项</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2014-09-29</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/monitoring/">monitoring</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Zabbix-monitoring/">Zabbix monitoring</a>
			</span>
		
	</div>

	

	
		<h2 id="zabbix监控MySQL"><a href="#zabbix监控MySQL" class="headerlink" title="zabbix监控MySQL"></a>zabbix监控MySQL</h2><p>前面一些简单的已在上一篇文章大概讲了zabbix原理和使用安装方法等等。<br>在Zabbix的监控系统中通常是由Zabbix Server与Zabbix Agent一起配合实现监控。在Zabbix Agent内置了很多监控基础的监控项。<a href="https://www.zabbix.com/documentation/2.0/manual/config/items/itemtypes/zabbix_agent" target="_blank" rel="external">参见</a></p>
<p>这些监控项都是CPU, 文件系统, 网络，磁盘等基础的监控项，对于自己开发服务的监控，Zabbix提供了良好框架为用户实现监控和报警，下面将以为MySQL添加监控为例，介绍如何添加自定义监控。</p>
<h3 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">MySQL 是分开安装的 ：192.168.1.201</div><div class="line">zabbix server 端 ：192.168.1.220</div></pre></td></tr></table></figure>
<h3 id="角色：Zabbix-Agent-Zabbix-Server-MySQL-模板"><a href="#角色：Zabbix-Agent-Zabbix-Server-MySQL-模板" class="headerlink" title="角色：Zabbix Agent, Zabbix Server, MySQL, 模板"></a>角色：Zabbix Agent, Zabbix Server, MySQL, 模板</h3><h3 id="第一步，监控规划"><a href="#第一步，监控规划" class="headerlink" title="第一步，监控规划"></a>第一步，监控规划</h3><p>在创建监控项之前要尽量考虑清楚要监控什么，怎么监控，监控数据如何存储，监控数据如何展现，如何处理报警等。要进行监控的系统规划需要对Zabbix很了解，这里只是提出监控的需求。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">需求一：监控MySQL的状态，当状态发生异常，发出报警；</div><div class="line">需求二：监控MySQL的操作，并用图表展现；</div><div class="line">第二步，使用自定义脚本监控扩展Agent。</div></pre></td></tr></table></figure>
<p>Zabbix Server与Agent之间监控数据的采集主要是通过Zabbix Server主动向Agent询问某个Key的值，Agent会根据Key去调用相应的函数去获取这个值并返回给Server端。Zabbix 2.4.7的Agent本并没有内置MySQL的监控功能（但是Server端提供了相应的Template配置），所以我们需要使用Zabbix的User Parameters功能，为MySQL添加监控脚本。</p>
<h3 id="Trapper工作原理"><a href="#Trapper工作原理" class="headerlink" title="Trapper工作原理:"></a>Trapper工作原理:</h3><p>被监控主机根据用户设定的时间间隔定期将数据push到Zabbix Server.这里主要介绍Agent.</p>
<h3 id="Agent工作原理"><a href="#Agent工作原理" class="headerlink" title="Agent工作原理:"></a>Agent工作原理:</h3><ul>
<li>Agent 安装在被监控主机上，定期主动的监控本机的资源和应用,然后将数据进行处理发送给ZabbixServer. Agent工作方式又分为Passive Check 和 Active Check。</li>
<li>Passive Check: Zabbix Server 发起数据索取请求，Agent响应对应的数据.</li>
<li>Active Check: Agent首先从Zabbix Server 检索监控项列表,然后定期将对应的数据主动的发送到.Zabbix ServerZabbix Agent 本身预定义了一些监控类型,而对于没有预定义的需要管理员自行定义.因此，Zabbix提供了”UserParameter”参数,以方便用户根据自己的需求自定义想要获取的数据.</li>
</ul>
<h3 id="“UserParameter”-语法"><a href="#“UserParameter”-语法" class="headerlink" title="“UserParameter” 语法:"></a>“UserParameter” 语法:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UserParameter=&lt;key&gt;,&lt;<span class="built_in">command</span>&gt;</div></pre></td></tr></table></figure>
<p><key> 用户自定义一个key; <command>为命令，该命令用来获取用户想要监控的数据,也就是key的值;<br>定好UserParameter参数后，在为主机或者模板配置监控项的时候，在”key”中输入上面自定义的key的<br>名字就可以了.</key></p>
<p>假如我要获取Mysql Server的版本，我可以这样定义”UserParameter”:<br>打开 Zabbix Agent安装路径下的 ../etc/zabbix_agentd.conf 配置文件，翻页到最后页面，键入如下<br>行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UserParameter=mysql.version,mysql -V</div></pre></td></tr></table></figure>
<p>这里我们自定义的key名就是<code>&quot;mysql.version&quot;</code>,命令<code>&quot;mysql -V&quot;</code>用来获取Mysql 版本号,其实就是key对<br>应的值.</p>
<p>UserParameter参数实现的原理通俗来讲，就是我们先要熟悉Mysql命令，通过Mysql的命令获取想要的<br>数据，然后赋值给自定义的key，最后通过Zabbix Server获取这个值通过图像等方式展示出来.</p>
<p>下面利用Agent来实现对mysql性能的监控。</p>
<h3 id="agent端："><a href="#agent端：" class="headerlink" title="agent端："></a>agent端：</h3><p>1.利用UserParameter参数自定义Agent Key。<br>对于需求一 ，我们采用mysqladmin这个工具来实现，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@mysql ~]<span class="comment"># mysqladmin -h 192.168.1.201 -uroot -ppassword ping</span></div><div class="line">mysqld is alive</div></pre></td></tr></table></figure>
<p>如果MySQL状态正常，会显示mysqld is alive，否则会提示连接不上。对于服务器端，mysqld is alive这样的句子不好理解，服务器端最好只接收1和0，1表示服务可用，0表示服务不可用。那么再改进一下这个命令，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@mysql ~]<span class="comment"># mysqladmin -h 192.168.1.201 -uroot -ppassword ping |  grep -c alive</span></div><div class="line">1</div></pre></td></tr></table></figure>
<p>用户名和密码放在命令中对于以后的维护不好，所以我们在/var/lib/zabbix/下创建一个包含MySQL用户名和密码的配置文件“.my.cnf”，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[client]</div><div class="line">user=root</div><div class="line">host=192.168.1.201</div><div class="line">password=xxxx</div></pre></td></tr></table></figure>
<p>有了这个文件后的命令变更为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">HOME=/etc mysqladmin ping | grep -c alive</div><div class="line">[root@mysql ~]<span class="comment">#   HOME=/var/lib/zabbix/ mysqladmin ping | grep -c alive</span></div><div class="line">1</div></pre></td></tr></table></figure>
<p>做完这一步后需要做的就是，将这个监控命令添加到Zabbix Agent中，并与一个Key对应，这样Zabbox Server就能通过这个Key获取MySQL的状态了。我们使用mysql.ping作为MySQL状态的Key。</p>
<p>首先在去除/etc/zabbix/zabbix_agentd.conf中</p>
<p>“Include=/etc/zabbix_agentd.conf.d/”这一行的注释符。</p>
<p>其次，在etc/zabbix/zabbix_agentd.conf.d/目录下创建userparameter_mysql.conf文件。在文件中添加如下命令：</p>
<pre><code>UserParameter=mysql.ping,HOME=/var/lib/zabbix mysqladmin ping | grep -c alive
</code></pre><p>这个命令中”UserParameter”表示这是一个用户自定义的脚本；“=”号后是脚本的内容；“mysql.ping”是Key，“，”号后的命令会在Zabbix Server向Agent发起获取“mysql.ping”这个key的请求时被调用，并将返回值返回给Server。<br>保存并退出后可以使用下面的命令测试是否正常工作。</p>
<pre><code>[root@mysql ~]# /usr/sbin/zabbix_agentd -t mysql.ping
  mysql.ping                                    [t|1]
</code></pre><p>这里zabbix_agentd使用方法可参考：</p>
<pre><code>http://www.ttlsa.com/zabbix/zabbix-command-zabbix_agentd/
</code></pre><p>同时，在Server端也可以使用使用zabbix_get命令来测试从Server端获取指定的Client端的数据，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ zabbix_get <span class="_">-s</span> 192.168.1.201 -p 10050 -k mysql.ping</div><div class="line">1</div></pre></td></tr></table></figure>
<p>这里如果是跟我一开始有错误的。<a href="https://www.zabbix.com/documentation/3.0/manual/config/items/userparameters/extending_agent" target="_blank" rel="external">zabbix</a></p>
<p>可能跟你安装版本不统一有问题。</p>
<p>这里zabbix_get使用方法可参考: <a href="http://www.ttlsa.com/zabbix/zabbix-zabbix_get-get-items/" target="_blank" rel="external">zabbix_agent</a></p>
<p>我这里参考官网方法：</p>
<pre><code>https://www.zabbix.com/documentation/3.0/manual/config/items/userparameters/extending_agent
</code></pre><p>我在我这里查看MySQL状态zabbix_agentd.conf:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UserParameter=mysql.questions,mysqladmin -uroot status | cut <span class="_">-f</span>4 <span class="_">-d</span><span class="string">":"</span> | cut <span class="_">-f</span>1 <span class="_">-d</span><span class="string">"S"</span></div></pre></td></tr></table></figure>
<h3 id="MySQL机器上面查看是有数据的："><a href="#MySQL机器上面查看是有数据的：" class="headerlink" title="MySQL机器上面查看是有数据的："></a>MySQL机器上面查看是有数据的：</h3><pre><code>[root@mysql scripts]# zabbix_agentd -t mysql.questions
 mysql.questions                               [t| 22273707]
</code></pre><h3 id="zabbix-server端："><a href="#zabbix-server端：" class="headerlink" title="zabbix server端："></a>zabbix server端：</h3><pre><code>[root@LAN_zabbix ~]# /usr/local/zabbix/bin/zabbix_get -s 192.168.1.201 -p10050 -k &apos;mysql.questions&apos;
ZBX_NOTSUPPORTED: Unsupported item key.
</code></pre><p>提示ZBX_NOTSUPPORTED: Unsupported item key.</p>
<p>如果直接查看定义的系统cpu</p>
<pre><code>[root@LAN_zabbix ~]# /usr/local/zabbix/bin/zabbix_get -s 192.168.1.201 -p   10050 -k system.cpu.load[all,avg1]
0.350000
</code></pre><p>这样是有数据的。</p>
<p>所以可以判断上面那个提示ZBX_NOTSUPPORTED: Unsupported item key.</p>
<h3 id="服务端测试可能报各类错误："><a href="#服务端测试可能报各类错误：" class="headerlink" title="服务端测试可能报各类错误："></a>服务端测试可能报各类错误：</h3><ol>
<li>ZBX_NOTSUPPORTED: Unsupported item key</li>
</ol>
<p>确认key名字配对了，并且客户端要重启</p>
<p>2.[root@zabbix zabbix]# zabbix_get -s 192.168.9.251 -k mysql.Innodb_log_buffer_size<br>sh: mysql: command not found<br>加全路径：/mysql/bin/mysql</p>
<p>我试着修改了/etc/zabbix/zabbix_agentd.d/userparameter_mysql.conf 这个文件里”HOME=/var/lib/zabbix mysql -N”，把mysql的路径补全，即改为HOME=/etc/zabbix /usr/bin/mysql -N。我是改了这个就可以了</p>
<pre><code>server端： /usr/local/zabbix/bin/zabbix_get -s 192.168.1.201  /usr/bin/mysqladmin -k  mysql.questions
sh: mysqladmin: 未找到命令
</code></pre><p>加了绝对路径，我几乎要绝望了。为什么这么坑,后来我看了下，是我seLinux没有关闭。关闭就可以了。</p>
<ul>
<li>我参考这篇文章操作的：<a href="http://canghai.coding.io/2015/07/29/monitoring-mysql-with-zabbix/" target="_blank" rel="external">monitoring-mysql-with-zabbix</a></li>
</ul>
<p>如果有一下回显，表示工作正常</p>
<pre><code>[root@zabbix ~]#  /usr/local/bin/zabbix_get -s 192.168.1.201 -k   mysql.status[GlobalStatus,Uptime]
 12364726
</code></pre><p>然后下载安装MySQL监控的模板在我github上面：</p>
<p>导入模版：<a href="https://github.com/yangcvo/zabbix.2.4/" target="_blank" rel="external">MySQL监控的模板</a></p>
<p>并关联到主机</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/zabbix-monitoring.jpg" alt=""></figure></p>
<p>PS：可自行添加对应key可监控项目，模版自带了几种，脚本包括800多项目，<br><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/zabbix-mintor.jpg" alt=""></figure><br>然后在添加各自项目的图行：</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/zabbix-moin1.jpg" alt=""></figure></p>
<p>zabbix监控mysql性能<br>通过获取mysql状态值将这些状态值传递给服务器并绘制成图片，这样可以观察mysql的工作情况，通常需要获得状态变量有以下</p>
<pre><code>Com_update：mysql执行的更新个数
Com_select：mysql执行的查询个数
Com_insert：mysql执行插入的个数
Com_delete：执行删除的个数
Com_rollback：执行回滚的操作个数
Bytes_received:接受的字节数
Bytes_sent：发送的字节数
Slow_queries：慢查询语句的个数
</code></pre><p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/zabbix-mion2.png" alt=""></figure></p>
<p>查看图像都是有数据：<br><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/zabbix-mion3.png" alt=""></figure></p>
<p>   2)我这里是测试环境用root账号，线上服务器安全期间可以给mysql用户授权readonly权限。</p>
<p>   3)根据实际的需求，除了监控上述监控项之外，还可以监控mysql processlist,Innodb等。</p>

	

	

</article>




	<article>
	
		<h1><a href="/2014/09/13/运维安全/httpd进程非常多，查找被攻击的原因/">httpd进程非常多，查找被攻击的原因</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2014-09-13</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/运维安全/">运维安全</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Operation-safety/">Operation safety</a>
			</span>
		
	</div>

	

	
		<p>前两天，公司托管在电信机房的vps服务器突然网络中断，运营商那边说我们的服务器不断往外发包，严重影响到机房的网络，所以把该机器的端口封了，无比蛋疼啊，无奈下只能亲自跑到机房解决问题。<br>去到机房，使用top命令查看后发现httpd进程居然占到90%多的CPU。</p>
<pre><code>ps -aux |grep httpd |wc -l
</code></pre><p>   发现有300多个httpd进程应该是受到SYN Flood攻击这时候没有直接杀掉进程，要找出是哪个网站受攻击。</p>
<pre><code>top |grep httpd
</code></pre><p>   选取进程中占用CPU%多的，用lsof -p pid 来查看，如果有几个httpd进程都显示同一个网站，则基本上可以判定该网站就是问题网站</p>
<pre><code>lsof -p &lt;pid&gt; 
</code></pre><p>找到问题网站后停掉该网站vps</p>
<pre><code>killall -9 httpd ,service httpd start 强制杀掉http进程，再重新启动。
</code></pre><p>以下是在网上找的预防SYN flood的办法linux下防止SYN Flood攻击，能够有效防范SYN Flood攻击的手段之一，就是SYN Cookie</p>
<p>Linux下设置<br>如果你的服务器配置不太好，TCP TIME_WAIT套接字数量达到两、三万，服务器很容易被拖死。通过修改Linux内核参数，可以减少服务器的TIME_WAIT套接字数量。</p>
<p>TIME_WAIT可以通过以下命令查看：</p>
<p>以下是代码片段：</p>
<pre><code>netstat -an | grep &quot;TIME_WAIT&quot; | wc -l
</code></pre><p>在Linux下，如CentOS，可以通过修改/etc/sysctl.conf文件来达到目的增加以下几行：</p>
<p>以下是代码片段：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_fin_timeout</span> = <span class="number">30</span></div><div class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_keepalive_time</span> = <span class="number">1200</span></div><div class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_syncookies</span> = <span class="number">1</span></div><div class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_tw_reuse</span> = <span class="number">1</span></div><div class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_tw_recycle</span> = <span class="number">1</span></div><div class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.ip_local_port_range</span> = <span class="number">1024</span>    <span class="number">65000</span></div><div class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_max_syn_backlog</span> = <span class="number">8192</span></div><div class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_max_tw_buckets</span> = <span class="number">5000</span></div><div class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_synack_retries</span> = <span class="number">2</span></div><div class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_syn_retries</span> = <span class="number">2</span></div></pre></td></tr></table></figure>
<p>说明：</p>
<p><code>net.ipv4.tcp_syncookies = 1</code>表示开启SYN Cookies，这是个BOOLEAN。当出现SYN等待队列溢出时，启用cookies来处理，可防范少量SYN攻击，默认为0，表示关闭；<br><code>net.ipv4.tcp_tw_reuse = 1</code> 表示开启重用,这是个BOOLEAN。允许将TIME-WAIT sockets重新用于新的TCP连接，默认为0，表示关闭；<br><code>net.ipv4.tcp_tw_recycle = 1</code>表示开启TCP连接中TIME-WAIT sockets的快速回收,这是个BOOLEAN，默认为0，表示关闭。<br><code>net.ipv4.tcp_fin_timeout = 30</code> 表示如果套接字由本端要求关闭，这个参数决定了它保持在FIN-WAIT-2状态的时间。单位为秒。<br><code>net.ipv4.tcp_keepalive_time = 1200</code>表示当keepalive起用的时候，TCP发送keepalive消息的频度。缺省是2小时，改为20分钟。单位为秒。<br><code>net.ipv4.ip_local_port_range = 1024</code>   65000 表示用于向外连接的端口范围。缺省情况下很小：32768到61000，改为1024到65000。<br><code>net.ipv4.tcp_max_syn_backlog = 8192</code>表示SYN队列的长度，默认为1024，加大队列长度为8192，可以容纳更多等待连接的网络连接数。<br><code>net.ipv4.tcp_max_tw_buckets = 5000</code> 表示系统同时保持TIME_WAIT套接字的最大数量，如果超过这个数字，TIME_WAIT套接字将立刻被清除并打印警告信息。默认为180000，改为5000。对于Apache、Nginx等服务器，上几行的参数可以很好地减少TIME_WAIT套接字数量，但是对于Squid，效果却不大。此项参数可以控制TIME_WAIT套接字的最大数量，避免Squid服务器被大量的TIME_WAIT套接字拖死。<br><code>net.ipv4.tcp_synack_retries</code>和<code>net.ipv4.tcp_syn_retries</code>是定义SYN重试次数。</p>
<p>执行以下命令使配置生效：</p>
<p>以下是代码片段：<br><code>/sbin/sysctl -p</code></p>
<p>如果你不想修改/etc/sysctl.conf，你也可以直接使用命令修改:</p>
<p>以下是代码片段：</p>
<p><code>/sbin/sysctl -w key=value</code></p>
<h4 id="找漏洞："><a href="#找漏洞：" class="headerlink" title="找漏洞："></a>找漏洞：</h4><p>重新审视了M站目录下文件权限。仅对几个必要的缓存、静态化的目录为apache开启了写权限，防止<code>phzLtoxn.php</code>文件再次生成。</p>
<p>重新开启httpd服务，使用360网站检测对H站进行漏洞检测，发现M站中有严重的远程执行漏洞，于是赶紧打了补丁。</p>
<p>补丁打好之后，顺便修改了系统用户、数据库用户、ftp用户的密码、M站系统用户密码。<br>观察几日之后，一切正常。</p>

	

	

</article>




	<article>
	
		<h1><a href="/2014/04/19/性能监控/Somekeping/用最简单易懂的方式安装smokeping/">用最简单的方式安装smokeping</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2014-04-19</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/monitoring/">monitoring</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/IDC监控/">IDC监控</a> <a class="article__tag-link" href="/tags/Performance-monitoring/">Performance monitoring</a> <a class="article__tag-link" href="/tags/Smokeping/">Smokeping</a>
			</span>
		
	</div>

	

	
		<p>smokeping这个监控还是很强大的，用这个监控是在第一家公司做IDC起家后面转型CDN云计算云加速。<br>这个也是我学的最早的一款监控，在这里我用编译安装方式。也有脚本安装不过需要了解过somkeping安装过程会比较看的懂脚本。</p>
<p>适用于宽带运营商维护和IDC机房维护可以检测本地网络的到上级运营商出口这段路由各个节点的稳定性            可以检测本地网络到各主要门户网站的<code>延时，丢包率，稳定性</code><br>可以检测本地网络到各地游戏服务器的<code>延时，丢包率，稳定性</code></p>
<p>smokeping缺点：不能在前台Web页面添加要检测的节点，必须在后台smokeping的配置文件中添加 </p>
<h3 id="安装前的准备："><a href="#安装前的准备：" class="headerlink" title="安装前的准备："></a>安装前的准备：</h3><ol>
<li>操作系统：选择centOS6.5最小化版， 里面的RPM包基本上都是最新的。   </li>
<li>注1: centOS 5.6版本在安装rpmforge-release-0.5.3-1.el6.rf.x86_64.rpm包是会遇到依赖性问题，要求安装rpmlib包，但centOS5.6版本中的rpmlib版本较低，无法直接安装   </li>
<li>注2：在安装centOS6.5时，要注意设置系统的IP地址，如下图,点击【configure network】按钮，选择【system eth0】, 点击 【IPv4Seting】,设置IP地址    </li>
<li>注3: 选择安装包时，点选【Basic Server】, 要安装621个基本包 注4: 其他安装步骤，按照正常的安装流程操作即可 </li>
</ol>
<h3 id="二-安装过程"><a href="#二-安装过程" class="headerlink" title="二. 安装过程"></a>二. 安装过程</h3><p>修改时区</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</div></pre></td></tr></table></figure>
<p>同步时间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ntpdate time.nist.gov</div></pre></td></tr></table></figure>
<p>写入BIOS</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hwclock -w</div></pre></td></tr></table></figure>
<p>关闭防火墙</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service iptables stop</div></pre></td></tr></table></figure>
<h3 id="1-安装第三方软件源"><a href="#1-安装第三方软件源" class="headerlink" title="1. 安装第三方软件源"></a>1. 安装第三方软件源</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">64位系统 </div><div class="line">rpm  -Uvh http://apt.sw.be/redhat/el6/en/x86_64/rpmforge/RPMS/rpmforge-release-0.5.3-1.el6.rf.x86_64.rpm</div><div class="line">32位系统</div><div class="line">rpm  -Uvh http://apt.sw.be/redhat/el6/en/i386/rpmforge/RPMS/rpmforge-release-0.5.3-1.el6.rf.i686.rpm</div></pre></td></tr></table></figure>
<p>注：安装这个源后，接下来要安装的大量的依赖包就不会报错</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">rpm -Uvh  http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm </div><div class="line">sed -i <span class="string">'s/^#baseurl/baseurl/g'</span> /etc/yum.repos.d/epel.repo</div><div class="line">sed -i <span class="string">'s/mirrorlist/#mirrorlist/g'</span> /etc/yum.repos.d/epel.repo</div></pre></td></tr></table></figure>
<h3 id="2-安装rrdtool与依赖库"><a href="#2-安装rrdtool与依赖库" class="headerlink" title="2. 安装rrdtool与依赖库"></a>2. 安装rrdtool与依赖库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -y install perl perl-Net-Telnet perl-Net-DNS perl-LDAP perl-libwww-perl perl-RadiusPerl perl-IO-Socket-SSL perl-Socket6 perl-CGI-SpeedyCGI perl-FCGI perl-CGI-SpeedCGI perl-Time-HiRes perl-ExtUtils-MakeMaker perl-RRD-Simple rrdtool rrdtool-perl curl fping echoping  httpd httpd-devel gcc make  wget libxml2-devel libpng-devel glib pango pango-devel freetype freetype-devel fontconfig cairo cairo-devel libart_lgpl libart_lgpl-devel mod_fastcgi screen wqy-zenhei-fonts.noarch wqy-zenhei-fonts-common.noarch lrzsz nginx</div></pre></td></tr></table></figure>
<p>注：<code>perl-CGI-SpeedyCGI，perl-CGI-SpeedCGI</code>这两个包在安装过程中会提示找不到，但没关系<br>注：用yum安装大量的依赖包还是很方便的，而百度上有些关于安装smokeping的文档要求使用wget下载后再用<code>make,make install</code>方式安装，虽然make方式不复杂，但通过make编译再安装几十个包就显得有点繁锁了。</p>
<h3 id="3-下载与安装smokeping"><a href="#3-下载与安装smokeping" class="headerlink" title="3.下载与安装smokeping"></a>3.下载与安装smokeping</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">wget http://oss.oetiker.ch/smokeping/pub/smokeping-2.6.8.tar.gz</div><div class="line">wget http://oss.oetiker.ch/smokeping/pub/smokeping-2.6.11.tar.gz    </div><div class="line">tar zxvf smokeping-2.6.8.tar.gz</div><div class="line"><span class="built_in">cd</span> smokeping-2.6.8</div><div class="line">./configure --prefix=/usr/<span class="built_in">local</span>/smokeping</div></pre></td></tr></table></figure>
<p>出现问题是因为需要安装perl的模块，所以运行下面内容即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">如果只出现 Config::Grammar<span class="string">' ... Failed</span></div><div class="line">解决 'Config::Grammar<span class="string">' ... Failed</span></div><div class="line">wget http://search.cpan.org/CPAN/authors/id/D/DS/DSCHWEI/Config-Grammar-1.10.tar.gz</div><div class="line">tar zxvf Config-Grammar-1.10.tar.gz</div><div class="line">cd Config-Grammar-1.10</div><div class="line">perl Makefile.PL</div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure>
<p>如果出现很多个failed，就用下面的方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">./setup/build-perl-modules.sh /usr/<span class="built_in">local</span>/smokeping/thirdparty  这个是为前面failed做安装  </div><div class="line">./co nfigure --prefix=/usr/<span class="built_in">local</span>/smokeping   </div><div class="line">                                                                      </div><div class="line">如果还出现问题可以看下这里面的参考。http://bbs.51cto.com/thread-1106181-1.html</div><div class="line">/usr/bin/gmake install</div><div class="line"></div><div class="line">安装下yum install cpan     perl -MCPAN <span class="_">-e</span> <span class="string">'install CGI'</span>           perl -MCPAN <span class="_">-e</span> <span class="string">'install CGI::Fast '</span>  这个安装好了然后再执行这一步。</div></pre></td></tr></table></figure>
<p>如果上面提示CGI 没有安装成功。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">wgethttp://www.cpan.org/authors/id/M/MA/MARKSTOS/</div><div class="line">CGI.pm-3.65.tar.gz</div><div class="line">tar zxvf CGI.pm-3.65.tar.gz</div><div class="line"><span class="built_in">cd</span> CGI.pm-3.65</div><div class="line">perl Makefile.PL</div><div class="line">make &amp;&amp; make install</div><div class="line">然后再执行下 ./configure --prefix=/usr/<span class="built_in">local</span>/smokeping</div></pre></td></tr></table></figure>
<p>现在smokeping安装完成</p>
<h3 id="4-配置smokeping"><a href="#4-配置smokeping" class="headerlink" title="4. 配置smokeping"></a>4. 配置smokeping</h3><h2 id="第一种-使用nginx"><a href="#第一种-使用nginx" class="headerlink" title="第一种 使用nginx"></a>第一种 使用nginx</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">1.安装nginx</div><div class="line">rpm -Uvh  http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</div><div class="line">yum install -y nginx</div><div class="line">https://metacpan.org/pod/release/MSTROUT/ExtUtils-MakeMaker-6.59/lib/ExtUtils/MakeMaker.pm  下载Make 让他直接执行</div></pre></td></tr></table></figure>
<p>2.安装基础IO </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /root</div><div class="line">wget  http://220.194.199.196/download/IO-All-0.46.tar.gz</div><div class="line">tar xvzf IO-All-0.46.tar.gz</div><div class="line"><span class="built_in">cd</span> IO-All-0.46</div><div class="line">perl Makefile.PL       <span class="comment">#  这里出现这个问题 把那个文件删了就行了。</span></div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure>
<p>3.配置nginx的sock<br>创建fcgi sock 文件，配置nginx fcgi使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#wget http://autonagios.googlecode.com/svn/trunk/autonagios-20100103/files/nginx-fcgi.txt  -O /etc/nginx-fcgi</span></div><div class="line">wget http://117.27.153.133/nginx-fcgi.txt -O /etc/nginx-fcgi </div><div class="line">chmod a+x /etc/nginx-fcgi</div><div class="line">/etc/nginx-fcgi <span class="_">-l</span> /var/<span class="built_in">log</span>/nginx-fcgi.log -pid /var/run/nginx-fcgi.pid -S /var/run/nginx-fcgi.sock</div><div class="line">chmod 777 /var/run/nginx-fcgi.sock</div></pre></td></tr></table></figure>
<p>4.增加smokeping使用的data、var、和cache目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/smokeping</div><div class="line">mkdir data var cache</div><div class="line">mv htdocs/smokeping.fcgi.dist htdocs/smokeping.fcgi</div><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/smokeping/etc</div><div class="line">mv config.dist config</div><div class="line">chmod 600 /usr/<span class="built_in">local</span>/smokeping/etc/smokeping_secrets.dist</div></pre></td></tr></table></figure>
<p>5.上传监控节点conf文件到smokeping的etc目录<br>6.修改smokpeing配置脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">vi config</div><div class="line">在如下位置修改</div><div class="line"></div><div class="line">*** Database ***</div><div class="line">step     = 300</div><div class="line">pings    = 20</div><div class="line">修改为</div><div class="line">*** Database ***</div><div class="line">step     = 60</div><div class="line">pings    = 20</div><div class="line"></div><div class="line">在如下位置添加一句话</div><div class="line">*** Presentation ***</div><div class="line">template = /usr/<span class="built_in">local</span>/smokeping/etc/basepage.html.dist</div><div class="line">charset=utf-8</div></pre></td></tr></table></figure>
<p>在第一个加号位置下将监控节点文件引入，如下例子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">+ testnetwork</div><div class="line">menu=测试网络状况</div><div class="line">title= 测试网络状况</div><div class="line">@include CT-IP.conf</div><div class="line">@include CN-IP.conf</div><div class="line">@include CT_IDC.conf</div><div class="line">@include CNC-IDC.conf</div></pre></td></tr></table></figure>
<p>保存退出</p>
<p>7.增加data、var、cache目录的软连接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ln <span class="_">-s</span> /usr/<span class="built_in">local</span>/smokeping/data/ /usr/share/nginx/html/data</div><div class="line">ln <span class="_">-s</span>  /usr/<span class="built_in">local</span>/smokeping/cache/ /usr/share/nginx/html/cache</div><div class="line">ln <span class="_">-s</span> /usr/<span class="built_in">local</span>/smokeping/htdocs/cropper/ /usr/share/nginx/html/cropper</div></pre></td></tr></table></figure>
<p>8.修改nginx 配置文件<br>查看下nginx的版本，使用nginx -v 查看，如下例子：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> nginx -v</div><div class="line">nginx version: nginx/1.0.15</div></pre></td></tr></table></figure>
<p>修改nginx配置</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">vi</span> /etc/nginx/conf.d/default.conf</div><div class="line">--增加fcgi 指向</div><div class="line">    location  <span class="regexp">~ .*\.fcgi$</span> &#123;</div><div class="line">        <span class="attribute">root</span> /usr/local/smokeping/htdocs/;</div><div class="line">        <span class="attribute">gzip</span> <span class="literal">off</span>;</div><div class="line">        <span class="attribute">fastcgi_pass</span>  unix:/var/run/nginx-fcgi.sock;</div><div class="line">        <span class="attribute">fastcgi_index</span> smokeping.fcgi;</div><div class="line">        <span class="attribute">include</span> fastcgi.conf;                 <span class="comment">#1.0.x 与0.8.x 用这个</span></div><div class="line">        <span class="comment">#include fastcgi_params;            #1.4.x版本用 fastcgi_params</span></div><div class="line">        <span class="comment">#fastcgi_param   SCRIPT_FILENAME /opt/smokeping/htdocs$fastcgi_script_name; #1.4.x版本必加</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>保存退出</p>
<h2 id="第二种-使用apache"><a href="#第二种-使用apache" class="headerlink" title="第二种 使用apache"></a>第二种 使用apache</h2><p>(1) 创建cache、data、var目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/smokeping</div><div class="line">mkdir htdocs/cache data var</div></pre></td></tr></table></figure>
<p>(2) 在创建日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">touch /var/<span class="built_in">log</span>/smokeping.log</div></pre></td></tr></table></figure>
<p>(3) 上传监控节点的conf文件到smokeping的etc目录下<br>修改smokeping目录的用户和组权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chown apache:apache -R /usr/<span class="built_in">local</span>/smokeping</div><div class="line">chown apache:apache /var/<span class="built_in">log</span>/smokeping.log</div></pre></td></tr></table></figure>
<p>(4) 修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/smokeping/htdocs/</div><div class="line">mv smokeping.fcgi.dist smokeping.fcgi</div><div class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/smokeping/etc</div><div class="line">mv config.dist config</div><div class="line">vi config</div><div class="line"></div><div class="line">修改改行设置</div><div class="line">imgcache = /usr/<span class="built_in">local</span>/smokeping/cache</div><div class="line">imgcache = /usr/<span class="built_in">local</span>/smokeping/htdocs/cache</div><div class="line"></div><div class="line"> *** Database ***</div><div class="line">step  = 300</div><div class="line">pings  = 60</div><div class="line">然后修改step，从300改为60，这是检测的时间, pings 从20 改为60, 即60秒ping 60次</div><div class="line"></div><div class="line">在如下位置添加一句话</div><div class="line">*** Presentation ***</div><div class="line">template = /usr/<span class="built_in">local</span>/smokeping/etc/basepage.html.dist</div><div class="line">charset=utf-8</div><div class="line"></div><div class="line">在第一个加号位置下将监控节点文件引入，如下例子</div><div class="line">+ testnetwork</div><div class="line">menu=测试网络状况</div><div class="line">title= 测试网络状况</div><div class="line">@include CT-IP.conf</div><div class="line">@include CN-IP.conf</div><div class="line">@include CT_IDC.conf</div><div class="line">@include CNC-IDC.conf</div></pre></td></tr></table></figure>
<p>保存退出 </p>
<p> (5) 配置完成之后修改密码文件权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chmod 600 /usr/<span class="built_in">local</span>/smokeping/etc/smokeping_secrets.dist</div></pre></td></tr></table></figure>
<ol>
<li>修改apache的配置</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">vim /etc/httpd/conf/httpd.conf</div><div class="line">在DocumentRoot <span class="string">"/var/www/html"</span> 这一行之下添加如下内容：</div><div class="line"></div><div class="line">Alias /cache <span class="string">"/usr/local/smokeping/htdocs/cache"</span></div><div class="line">Alias /cropper <span class="string">"/usr/local/smokeping/htdocs/cropper"</span></div><div class="line">Alias /smokeping <span class="string">"/usr/local/smokeping/htdocs"</span></div><div class="line">&lt;Directory <span class="string">"/usr/local/smokeping/htdocs"</span>&gt;</div><div class="line">  AllowOverride None</div><div class="line">  AddHandler cgi-script .fcgi .cgi</div><div class="line">  Options ExecCGI</div><div class="line">  &lt;IfModule dir_module&gt;</div><div class="line">     DirectoryIndex smokeping.fcgi</div><div class="line">  &lt;/IfModule&gt;</div><div class="line">  Order allow,deny</div><div class="line">  Allow from all </div><div class="line">&lt;/Directory&gt;</div></pre></td></tr></table></figure>
<ol>
<li>设置开机启动httpd, smokeping,并关闭iptables.</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">"/usr/local/smokeping/bin/smokeping --logfile=/var/log/smokeping.log 2&gt;&amp;1 &amp;"</span> &gt;&gt; /etc/rc.local</div><div class="line">chkconfig httpd on      <span class="comment">#开机启动httpd进程</span></div><div class="line">chkconfig iptables off  <span class="comment">#开机不启动iptables服务</span></div><div class="line">chkconfig nginx on</div></pre></td></tr></table></figure>
<ol>
<li>启动http或者nginx以及smokeping</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">service httpd start service nginx start</div><div class="line">/usr/<span class="built_in">local</span>/smokeping/bin/smokeping --debug-daemon</div><div class="line">chown apache:apache -R /usr/<span class="built_in">local</span>/smokeping</div></pre></td></tr></table></figure>
<ol>
<li>打开检测主机的Web页面.</li>
</ol>
<p>使用httpd做web，在Web浏览器里输入<code>http://您的监控主机IP/smokeping</code>      这里启动不了，看下什么原因。是不是CT-IDC.conf 没有上传到etc下面</p>
<p>打开这里出现500  说明配置正确防火墙看下。<code>serenfroce 0</code> 有没有关闭。</p>
<p>使用nginx做web，在Web浏览器里输入 <a href="http://您的监控主机IP/smokeping.fcgi" target="_blank" rel="external">http://您的监控主机IP/smokeping.fcgi</a>    这里启动不了，看下什么原因。是不是CT-IDC.conf 没有上传到etc下面</p>
<p>如果遇到500错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Internal Server Error</div><div class="line">The server encountered an internal error or misconfiguration and was unable to complete your request.</div><div class="line">Please contact the server administrator, root@localhost and inform them of the time the error occurred, and anything you might have <span class="keyword">done</span> that may have caused the error.</div><div class="line">More information about this error may be available <span class="keyword">in</span> the server error log.</div><div class="line">--------------------------------------------------------------------------------</div><div class="line">Apache/2.2.15 (CentOS) Server at 192.168.2.101 Port 80</div><div class="line"></div><div class="line">说明没有关闭SElinux 选项，关闭就正常了</div><div class="line">vi /etc/sysconfig/selinux</div><div class="line">SELINUX=permissive</div><div class="line">[root@localhost ~]<span class="comment"># getenforce     #查看SElinux 的命令</span></div><div class="line">Permissive                      <span class="comment">#返回的结果是Permissive, 表示已经关闭SElinux了</span></div></pre></td></tr></table></figure>
<ol>
<li>在Web页面增加验证用户名和密码(可选步骤)</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">(1)修改httpd.conf里的内容</div><div class="line">&lt;Directory <span class="string">"/usr/local/smokeping"</span>&gt;</div><div class="line">AllowOverride None</div><div class="line">Options All</div><div class="line">AddHandler cgi-script .fcgi .cgi</div><div class="line">AllowOverride AuthConfig</div><div class="line">Order allow,deny</div><div class="line">Allow from all</div><div class="line">AuthName <span class="string">"Smokeping"</span></div><div class="line">AuthType Basic</div><div class="line">AuthUserFile /usr/<span class="built_in">local</span>/smokeping/htdocs/htpasswd</div><div class="line">Require valid-user</div><div class="line">DirectoryIndex smokeping.fcgi</div><div class="line">&lt;/Directory&gt;</div></pre></td></tr></table></figure>
<p>注：上面的内容部分已经添加，这里仅添加红色字体内容即可。</p>
<p>(2) 设置登录账户与密码<br>进入cd /usr/local/smokeping/htdocs目录， 执行命令：htpasswd -c /usr/local/smokeping/htdocs/htpasswd admin<br>这个是设置登录账户为admin，密码在后面输入，然后重启httpd就可以实现密码验证登录<br>重新登录web页面，会要求输入用户名和密码.</p>
<ol>
<li>一定要同步好时间</li>
</ol>
<p>在ESXI4的虚拟机中，定期执行<code>ntpdate 210.72.145.44</code>    #或者与本地的时间服务器同步<br>在vmware workstation中，安装vmware-tools， 虚拟机的时间会自动与其宿主机时间同步</p>
<p>注： 如果vmware workstation中的虚拟机不安装vmware-tools，则虚拟机时间会与宿主机时间相隔整整8个小时(虚拟机时间早于宿主机时间)<br> vmware-tools的安装不在此叙述</p>
<ol>
<li><p>特别说明: 修改/usr/local/smokeping/etc/config 文件的配置参数，必须重启动smokeping程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(1)如果重启动smokeping程序失败，根据报错提示删除/usr/<span class="built_in">local</span>/smokeping/data子文件夹的rrd文件</div><div class="line">(2)中文问题：如果需要在网页里展示中文，修改/usr/<span class="built_in">local</span>/smokeping/etc的config文件</div><div class="line">*** Presentation ***</div><div class="line">charset = utf-8 //注：在这里添加</div><div class="line">然后在menu与titile里修改中文，重启即可</div></pre></td></tr></table></figure>
<p>有一个要注意的地方就是，你输入的中文必须在utf-8的字符编码下输入的中文字符，不然会出现乱码。<br> 如果在xshel下，选择file-properities-terminal<br>如果还是不显示就看看你系统里是否安装了中文字体，或者在安装一个</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@smokeping data]<span class="comment"># ps -ef |grep smoke   #查找smokeping进程</span></div><div class="line">root      8740     1  0 09:08 ?        00:00:00 /usr/<span class="built_in">local</span>/smokeping/bin/smokeping [FPing]</div><div class="line">root     35552 35529  0 09:33 pts/2    00:00:00 grep smoke</div><div class="line">[root@smokeping data]<span class="comment"># kill 8740     #杀掉smokeping进程</span></div><div class="line">[root@smokeping data]<span class="comment"># ps -ef |grep smoke</span></div><div class="line">root     35554 35529  4 09:33 pts/2    00:00:00 grep smoke</div><div class="line">smokeping进程已经被杀掉</div><div class="line">[root@smokeping data]<span class="comment">#screen                    #如果通过SSH远程登录到监控主机，最后执行screen，在虚拟窗口中启动smokeping</span></div><div class="line">/usr/<span class="built_in">local</span>/smokeping/bin/smokeping --logfile=/var/<span class="built_in">log</span>/smokeping.log 2&gt;&amp;1 &amp;</div></pre></td></tr></table></figure>
<p>三. 添加需要监控的网站和节点(在/usr/local/smokeping/etc/config中添加)</p>
<ul>
<li><p>smokeping就这点不好，添加节点不能在前台Web页面添加，一定要在后台的配置文件中添加,希望以后的版本中能改进一下  *</p>
</li>
<li><p>修改/usr/local/smokeping/etc/config 后，必须重启smokeping 程序，配置才会生效  *  </p>
</li>
<li><p>smokeping 会根据配置文件config 在/usr/local/smokeping/data 之下添加moniter文件夹，其下包含website子文件夹 *</p>
</li>
<li><p>用vmware workstation的虚拟机测试有一点好处，workstation下的虚拟网卡可以设置出入的丢包率，适合smokeping做丢包测试, 经过测试smokeping检测出的丢包率与vmware worksation虚拟网卡设置的丢包率基本相同,也就是说smokeping 能够反应网络的真实状况 *<br> 添加监控节点示例：注意+是第一层，++是第二层，+++ 是第三层</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">+ moniter                       </div><div class="line">menu = moniter</div><div class="line">++ website</div><div class="line">menu = website</div><div class="line">title = moniter website</div><div class="line"><span class="comment">#host = /moniter/website/baidu /moniter/website/sina /moniter/website/taobao /moniter/website/QQ</span></div><div class="line"></div><div class="line">+++ baidu</div><div class="line">menu = baidu</div><div class="line">title = baidu.com</div><div class="line">alerts = someloss</div><div class="line">host = www.baidu.com</div><div class="line"></div><div class="line">+++ sina</div><div class="line">menu = sina</div><div class="line">title = sina.com.cn</div><div class="line">alerts = someloss</div><div class="line">host = www.sina.com.cn</div><div class="line"></div><div class="line">+++ taobao</div><div class="line">menu = taobao</div><div class="line">title = taobao.com</div><div class="line">alerts = someloss</div><div class="line">host = www.taobao.com</div><div class="line"></div><div class="line">+++ QQ</div><div class="line">menu = QQ</div><div class="line">title = QQ</div><div class="line">alerts = someloss</div><div class="line">host = www.qq.com.cn</div><div class="line"></div><div class="line">+++ sohu</div><div class="line">menu = sohu</div><div class="line">title = sohu</div><div class="line">alerts = someloss</div><div class="line">host = www.sohu.com</div></pre></td></tr></table></figure>
<p>效果图：当前菜单下主机延时，丢包图</p>
<p>效果图：当前菜单下某主机延时，丢包详细图</p>
<p>13.图例说明</p>
<p>绿块表示不丢包，其他颜色的块表示不同程序的丢包。<br>图形越平稳，表示网络越稳定，如果图形峰值和低谷很多，则表示网络时延不稳定，忽高忽低。</p>
<p>这里apache 如果要你做个URL的文件下载测试 </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dd <span class="keyword">if</span>=<span class="regexp">/dev/</span><span class="keyword">null</span> bs=<span class="number">1</span>M <span class="keyword">count</span>=<span class="number">1</span> of=<span class="regexp">/var/</span>www<span class="regexp">/html/i</span>ndex.html</div></pre></td></tr></table></figure>

	

	

</article>






	<span class="different-posts">📕 end of posts 📕</span>


	</main>

	<footer class="footer">
	<div class="footer-content">
		
	      <div class="footer__element">
	<h5>Hi there,</h5>
	<p style="text-align:justify;">my name is Yancy, they know me as Radiant🐑🐑. This blog is about Bi-data and my live.<br> I like 🌳🌳🌳</p>
</div>


	    
	      <div class="footer__element">
	<h5>Check out</h5>
	<ul class="footer-links">
		<li class="footer-links__link"><a href="/archives">Archive</a></li>
		
		  <li class="footer-links__link"><a href="/atom.xml">RSS</a></li>
	    
		<li class="footer-links__link"><a href="/about">about page</a></li>
		<li class="footer-links__link"><a href="/tags">Tags</a></li>
		<li class="footer-links__link"><a href="/categories">Categories</a></li>
	</ul>
</div>

	    

		<div class="footer-credit">
			<span>© 2017 Yancy | Powered by <a href="http://blog.yancy.cc/">Yancy</a> | Theme <a href="https://github.com/yangcvo">Yancy_GitHub</a></span>
		</div>

	</div>


</footer>



</body>

</html>
