<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="theme-color" content="#33474d">
	<title>Yancy&#39;s blog</title>
	<link rel="stylesheet" href="/css/style.css" />
	
      <link rel="alternate" href="/atom.xml" title="Yancy&#39;s blog" type="application/atom+xml">
    
</head>

<body>

	<header class="header">
		<nav class="header__nav">
			
				<a href="/" class="header__link">Home</a>
			
				<a href="/tags" class="header__link">Tags</a>
			
				<a href="/archives" class="header__link">ARCHIVES</a>
			
				<a href="/about/About" class="header__link">ABOUT</a>
			
				<a href="http://weibo.com/yangcvo" class="header__link">Weibo</a>
			
				<a href="/atom.xml" class="header__link">RSS</a>
			
		</nav>
		<h1 class="header__title"><a href="/">Yancy&#39;s blog</a></h1>
		<h2 class="header__subtitle">SIMPLICITY IS PREREQUISITE FOR  RELIABILITY</h2>
	</header>

	<main>
		
	<span class="different-posts different-posts_earlier">ğŸ“– <a href="/page/9">earlier posts</a> ğŸ“–</span>




	<article>
	
		<h1><a href="/2016/05/24/WebæœåŠ¡æŠ€æœ¯/Nginx/nginxè§£å†³åŠæ³•-503-Service.Temporarily.Unavailable/">NGINXè§£å†³åŠæ³•-503-Service.Temporarily.Unavailable</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-05-24</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/nginx/">nginx</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Nginx/">Nginx</a> <a class="article__tag-link" href="/tags/Web-Service/">Web Service</a>
			</span>
		
	</div>

	

	
		<h3 id="503-Service-Temporarily-Unavailable-è§£å†³åŠæ³•-nginx"><a href="#503-Service-Temporarily-Unavailable-è§£å†³åŠæ³•-nginx" class="headerlink" title="503 Service Temporarily Unavailable è§£å†³åŠæ³•-nginx"></a>503 Service Temporarily Unavailable è§£å†³åŠæ³•-nginx</h3><p>å› ä¸ºæœ€è¿‘å…¬å¸å¾®ä¿¡æŠ½å¥–æ´»åŠ¨é¡¹ç›®ç¯å¢ƒ  - ginxåšè´Ÿè½½å‡è¡¡é™åˆ¶æŸä¸ªIPåŒä¸€æ—¶é—´æ®µçš„è®¿é—®æ¬¡æ•°ã€‚</p>
<p>å°±æ˜¯é˜²æ­¢æœ‰äººåŒä¸€ä¸ªIPä¸æ–­è¯·æ±‚ï¼Œç½‘ç«™åˆ·æ–°åç»å¸¸å‡ºç°<code>503 Service Temporarily Unavailable</code>é”™è¯¯ï¼Œæœ‰æ—¶æœ‰å¯ä»¥ï¼Œè”æƒ³åˆ°æœ€è¿‘åœ¨<code>nginx.conf</code>é‡Œåšäº†å•ipè®¿é—®æ¬¡æ•°é™åˆ¶.</p>
<p><code>(limit_req_zone $binary_remote_addr zone=allips:10m rate=20r/s;)</code> æŠŠè¿™ä¸ªæ•°é‡æ”¾å¤§ååœ¨åˆ·æ–°å‘ç°é—®é¢˜è§£å†³ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">vim nginx.conf</div><div class="line"></div><div class="line">http &#123;</div><div class="line">    limit_req_zone <span class="variable">$binary_remote_addr</span> zone=allips:10m rate=20r/s;</div><div class="line">   </div><div class="line">    æ·»åŠ ä¸Šé¢é‚£æ¡è¯­å¥å°±è¡Œã€‚</div><div class="line"> </div><div class="line">    include       mime.types;</div><div class="line">    default_type  application/octet-stream;</div></pre></td></tr></table></figure>
<p><code>ï¼ˆè¿˜é¡ºä¾¿æŠŠè¿™ä¸ªæ”¹å¤§äº† limit_req zone=allips burst=50 nodelay;   ï¼‰</code><br>ä¸ºäº†è¯å®è¯¥é—®é¢˜ï¼Œåå¤æ”¹åŠ¨è¯¥æ•°é‡æµ‹è¯•å‘ç°é—®é¢˜ç¡®å®åœ¨è¿™ã€‚è¿™ä¸ªæ•°é‡è®¾å¾—å¤ªå°æœ‰é—®é¢˜ï¼Œé€šè¿‡fiddlerå‘ç°webé¡µé¢åˆ·æ–°ä¸€ä¸‹ï¼Œå› ä¸ºé¡µé¢ä¸Šå¼•ç”¨çš„js,css,å›¾ç‰‡éƒ½ç®—ä¸€ä¸ªè¿æ¥ã€‚æ‰€ä»¥å•ä¸ªé¡µé¢åˆ·æ–°ä¸‹å°±æœ‰å¯èƒ½åˆ·çˆ†è¿™ä¸ªé™åˆ¶ï¼Œè¶…è¿‡è¿™ä¸ªé™åˆ¶å°±ä¼šæç¤º<code>503 Service Temporarily Unavailableã€‚</code></p>
<p>è¿™é‡Œæ·»åŠ ä¸‹åªèƒ½è®¾ç½®ä»€ä¹ˆIPç½‘æ®µå¯ä»¥è®¿é—®www.jollychic.comã€‚å…¶ä»–çš„å…¨éƒ¨æ‹’ç»è®¿é—®80ç«¯å£è¿™ä¸ªåŸŸåwww.jollychic.comã€‚</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">   <span class="section">server</span> &#123;</div><div class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</div><div class="line">        <span class="attribute">allow</span>   <span class="number">218.17.158.2</span>;</div><div class="line"><span class="attribute">allow</span> <span class="number">127.0.0.0</span>/<span class="number">24</span>;</div><div class="line"><span class="attribute">allow</span> <span class="number">192.168.0.0</span>/<span class="number">16</span>;</div><div class="line"><span class="attribute">allow</span> <span class="number">58.251.130.1</span>;</div><div class="line"><span class="attribute">allow</span> <span class="number">183.239.167.3</span>;</div><div class="line"><span class="attribute">allow</span> <span class="number">61.145.164.1</span>;</div><div class="line"><span class="attribute">deny</span>    all;</div><div class="line"><span class="attribute">server_name</span>  www.jollychic.com;</div><div class="line">        <span class="attribute">location</span> / &#123;</div><div class="line">                <span class="attribute">proxy_pass</span> http://www.jollychic.com;</div><div class="line"><span class="attribute">proxy_set_header</span>  X-Real-IP  <span class="variable">$remote_addr</span>;</div><div class="line"><span class="attribute">limit_req</span> zone=allips burst=<span class="number">50</span> nodelay;    </div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>

	

	

</article>




	<article>
	
		<h1><a href="/2016/05/23/WebæœåŠ¡æŠ€æœ¯/Nginx/Nginxå¤šç§å®‰è£…ä¸é…ç½®æ–‡ä»¶è¯¦è§£/">Nginxå¤šç§å®‰è£…ä¸é…ç½®æ–‡ä»¶è¯¦è§£</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-05-23</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/nginx/">nginx</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Nginx/">Nginx</a> <a class="article__tag-link" href="/tags/Web-Service/">Web Service</a>
			</span>
		
	</div>

	

	
		<h2 id="å®‰è£…nginx"><a href="#å®‰è£…nginx" class="headerlink" title="å®‰è£…nginx"></a>å®‰è£…nginx</h2><p>æœ€è¿‘åœ¨å¼„ç°åº¦å‘å¸ƒç¯å¢ƒï¼Œä¹‹å‰nginxåœ¨æµ‹è¯•å’Œçº¿ä¸Šéƒ½æœ‰æ­å»ºé…ç½®ã€‚è´Ÿè½½å‡è¡¡é…ç½®ï¼ˆåŒ…æ‹¬å¥åº·æ£€æŸ¥ï¼‰ã€ç¼“å­˜ï¼ˆåŒ…æ‹¬æ¸…ç©ºç¼“å­˜ï¼‰åå‘ä»£ç†ã€‚å°±æ‰“ç®—è‡ªå·±æ•´ç†ç¯‡è‡ªå·±æ“ä½œçš„æ–‡æ¡£ï¼Œå„ç§ç¼–è¯‘é…ç½®ï¼Œä»Šå¤©è‡ªå·±ä¹Ÿæ•´ç†ä¸€ä»½å®‰è£…æ–‡æ¡£å’Œnginx.confé…ç½®é€‰é¡¹çš„è¯´æ˜ã€‚</p>
<h4 id="é€‰æ‹©ç¨³å®šç‰ˆæœ¬"><a href="#é€‰æ‹©ç¨³å®šç‰ˆæœ¬" class="headerlink" title="é€‰æ‹©ç¨³å®šç‰ˆæœ¬"></a>é€‰æ‹©ç¨³å®šç‰ˆæœ¬</h4><p> æˆ‘ä»¬ç¼–è¯‘å®‰è£…nginxæ¥å®šåˆ¶è‡ªå·±çš„æ¨¡å—ã€‚</p>
<ul>
<li>æœºå™¨CentOS 6.6 x86_64ã€‚</li>
<li>è½¯ä»¶ç‰ˆæœ¬ï¼šNginx 1.9.9</li>
<li>nginxæœ€æ–°å®‰è£…åŒ…ä¸‹è½½åœ°å€ï¼š<a href="http://www.nginx.cn/ng" target="_blank" rel="external">http://www.nginx.cn/ng</a></li>
</ul>
<h3 id="yum-ä¸€é”®å®‰è£…nginx"><a href="#yum-ä¸€é”®å®‰è£…nginx" class="headerlink" title="yum ä¸€é”®å®‰è£…nginx"></a>yum ä¸€é”®å®‰è£…nginx</h3><p>yumå®‰è£…rpmåŒ…ä¼šæ¯”ç¼–è¯‘å®‰è£…ç®€å•å¾ˆå¤šï¼Œé»˜è®¤ä¼šå®‰è£…è®¸å¤šæ¨¡å—ï¼Œå¸®æˆ‘ä»¬è§£å†³åˆ°å¾ˆå¤šä¾èµ–çš„å®‰è£…åŒ…ï¼Œä½†ç¼ºç‚¹æ˜¯å¦‚æœä½ æƒ³ä»¥åå®‰è£…ç¬¬ä¸‰æ–¹æ¨¡å—é‚£å°±æ²¡åŠæ³•äº†ã€‚</p>
<p>ä½¿ç”¨Nginxå®˜æ–¹æº,Epelæ‰©å±•åº“å’Œremiæº,remiæºåŸºäºepel,å¿…é¡»å…ˆå®‰è£…epelæº,remiåŒ…å«php-fpm,mysql-server5.5,å¦‚æœåªéœ€è¦php-fpmå¯ä»¥å•ç‹¬å®‰è£…php-fpmåç¦ç”¨æ­¤æº. </p>
<h3 id="ç¬¬ä¸€ç§æ–¹æ³•"><a href="#ç¬¬ä¸€ç§æ–¹æ³•" class="headerlink" title="ç¬¬ä¸€ç§æ–¹æ³•:"></a>ç¬¬ä¸€ç§æ–¹æ³•:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vi /etc/yum.repo.d/nginx.repo</span></div><div class="line">[nginx]</div><div class="line">name=nginx repo</div><div class="line">baseurl=http://nginx.org/packages/centos/<span class="variable">$releasever</span>/<span class="variable">$basearch</span>/</div><div class="line">gpgcheck=0</div><div class="line">enabled=1</div></pre></td></tr></table></figure>
<p>å‰©ä¸‹çš„å°±yum install nginxæå®šï¼Œä¹Ÿå¯ä»¥yum install nginx-1.11.10å®‰è£…æŒ‡å®šç‰ˆæœ¬ï¼ˆå‰ææ˜¯ä½ å»packagesé‡Œçœ‹åˆ°æœ‰å¯¹åº”çš„ç‰ˆæœ¬ï¼Œé»˜è®¤æ˜¯æœ€æ–°ç‰ˆç¨³å®šç‰ˆï¼‰</p>
<h3 id="ç¬¬äºŒç§æ–¹æ³•"><a href="#ç¬¬äºŒç§æ–¹æ³•" class="headerlink" title="ç¬¬äºŒç§æ–¹æ³•:"></a>ç¬¬äºŒç§æ–¹æ³•:</h3><p>å„èŠ‚ç‚¹æ—¶é—´åŒæ­¥</p>
<pre><code>[root@nginx ~]# ntpdate 202.120.2.101
</code></pre><p>å®‰è£…EPELæº:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">rpm -Uvh  http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</div><div class="line"> yum clean all</div><div class="line"> yum makecache</div><div class="line"> yum install -y nginx</div><div class="line"> service nginx start</div></pre></td></tr></table></figure>
<p>è¿˜æœ‰ä¸€ç§å°±æ˜¯ä¸‹è½½Centos-6.repo ï¼Œå¯ä»¥åˆ°æˆ‘githubä¸Šé¢nginxåº“ä¸‹è½½ï¼Œè¿™ä¸ªæ˜¯æœ€æ–°çš„æºåœ°å€é‡Œé¢ã€‚<a href="https://github.com/yangcvo/nginx.git" target="_blank" rel="external">nginx</a></p>
<h3 id="ç¼–è¯‘å®‰è£…ï¼š"><a href="#ç¼–è¯‘å®‰è£…ï¼š" class="headerlink" title="ç¼–è¯‘å®‰è£…ï¼š"></a>ç¼–è¯‘å®‰è£…ï¼š</h3><p>é¦–å…ˆå®‰è£…ç¼ºå°‘çš„ä¾èµ–åŒ…ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"> <span class="comment"># yum -y install gcc gcc-c++ make libtool zlib zlib-devel openssl openssl-devel pcre pcre-devel</span></div><div class="line">```    </div><div class="line">è¿™äº›è½¯ä»¶åŒ…å¦‚æœyumä¸Šæ²¡æœ‰çš„è¯å¯ä»¥ä¸‹è½½æºç æ¥ç¼–è¯‘å®‰è£…ï¼Œåªæ˜¯è¦æ³¨æ„ç¼–è¯‘æ—¶é»˜è®¤å®‰è£…çš„ç›®å½•ï¼Œç¡®ä¿ä¸‹é¢åœ¨å®‰è£…nginxæ—¶èƒ½å¤Ÿæ‰¾åˆ°è¿™äº›åŠ¨æ€åº“æ–‡ä»¶ï¼ˆldconfigï¼‰ã€‚</div><div class="line"></div><div class="line">nginxå®˜ç½‘ä¸‹è½½ç¼–è¯‘å®‰è£…åŒ…åœ°å€:[nginx](http://nginx.org/en/download.html)</div><div class="line"></div><div class="line">nginx-1.11.10ç‰ˆæœ¬ä¸‹è½½ï¼š[nginx-1.11.10](http://nginx.org/download/nginx-1.11.10.tar.gz)</div><div class="line"><span class="comment">### æ–°å»ºnginxç”¨æˆ·ä¸ç»„</span></div><div class="line"></div><div class="line">``` bash</div><div class="line"> groupadd www</div><div class="line"> useradd <span class="_">-s</span> /sbin/nologin -g www www</div></pre></td></tr></table></figure>
<h3 id="ç¼–è¯‘é…ç½®æ–‡ä»¶"><a href="#ç¼–è¯‘é…ç½®æ–‡ä»¶" class="headerlink" title="ç¼–è¯‘é…ç½®æ–‡ä»¶"></a>ç¼–è¯‘é…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">    tar -zxvf nginx-1.11.10.tar.gz</div><div class="line">    <span class="built_in">cd</span> nginx-1.11.10/</div><div class="line">     ./configure --user=www --group=www </div><div class="line">     --prefix=/usr/<span class="built_in">local</span>/nginx </div><div class="line">     --error-log-path=/var/<span class="built_in">log</span>/nginx/error.log </div><div class="line">     --http-log-path=/var/<span class="built_in">log</span>/nginx/access.log </div><div class="line">     --with-http_stub_status_module </div><div class="line">     --with-http_ssl_module</div><div class="line">     --with-http_gzip_static_module </div><div class="line">     --with-http_realip_module</div><div class="line">    </div><div class="line">     ./configure --user=www --group=www --prefix=/usr/<span class="built_in">local</span>/nginx --error-log-path=/var/<span class="built_in">log</span>/nginx/error.log --http-log-path=/var/<span class="built_in">log</span>/nginx/access.log --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-http_realip_module</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">   å…¶ä¸­å‚æ•° `--with-http_stub_status_module `æ˜¯ä¸ºäº†å¯ç”¨ nginx çš„ NginxStatus åŠŸèƒ½ï¼Œç”¨æ¥ç›‘æ§ Nginx çš„å½“å‰çŠ¶æ€ã€‚</div><div class="line"> </div><div class="line">     make &amp;&amp; make install</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">### å¸¸ç”¨ç¼–è¯‘é€‰é¡¹è¯´æ˜</span></div><div class="line">nginxå¤§éƒ¨åˆ†å¸¸ç”¨æ¨¡å—ï¼Œç¼–è¯‘æ—¶./configure --helpä»¥--withoutå¼€å¤´çš„éƒ½é»˜è®¤å®‰è£…ã€‚</div><div class="line"></div><div class="line">```bash</div><div class="line">--prefix=PATH ï¼š æŒ‡å®šnginxçš„å®‰è£…ç›®å½•ã€‚é»˜è®¤ /usr/<span class="built_in">local</span>/nginx</div><div class="line">--conf-path=PATH ï¼š è®¾ç½®nginx.confé…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚nginxå…è®¸ä½¿ç”¨ä¸åŒçš„é…ç½®æ–‡ä»¶å¯åŠ¨ï¼Œé€šè¿‡å‘½ä»¤è¡Œä¸­çš„-cé€‰é¡¹ã€‚é»˜è®¤ä¸ºprefix/conf/nginx.conf</div><div class="line">--user=nameï¼š è®¾ç½®nginxå·¥ä½œè¿›ç¨‹çš„ç”¨æˆ·ã€‚å®‰è£…å®Œæˆåï¼Œå¯ä»¥éšæ—¶åœ¨nginx.confé…ç½®æ–‡ä»¶æ›´æ”¹useræŒ‡ä»¤ã€‚é»˜è®¤çš„ç”¨æˆ·åæ˜¯nobodyã€‚--group=nameç±»ä¼¼</div><div class="line">--with-pcre ï¼š è®¾ç½®PCREåº“çš„æºç è·¯å¾„ï¼Œå¦‚æœå·²é€šè¿‡yumæ–¹å¼å®‰è£…ï¼Œä½¿ç”¨--with-pcreè‡ªåŠ¨æ‰¾åˆ°åº“æ–‡ä»¶ã€‚ä½¿ç”¨--with-pcre=PATHæ—¶ï¼Œéœ€è¦ä»PCREç½‘ç«™ä¸‹è½½pcreåº“çš„æºç ï¼ˆç‰ˆæœ¬4.4 - 8.30ï¼‰å¹¶è§£å‹ï¼Œå‰©ä¸‹çš„å°±äº¤ç»™Nginxçš„./configureå’Œmakeæ¥å®Œæˆã€‚perlæ­£åˆ™è¡¨è¾¾å¼ä½¿ç”¨åœ¨locationæŒ‡ä»¤å’Œ ngx_http_rewrite_moduleæ¨¡å—ä¸­ã€‚</div><div class="line">--with-zlib=PATH ï¼š æŒ‡å®š zlibï¼ˆç‰ˆæœ¬1.1.3 - 1.2.5ï¼‰çš„æºç è§£å‹ç›®å½•ã€‚åœ¨é»˜è®¤å°±å¯ç”¨çš„ç½‘ç»œä¼ è¾“å‹ç¼©æ¨¡å—ngx_http_gzip_moduleæ—¶éœ€è¦ä½¿ç”¨zlib ã€‚</div><div class="line">--with-http_ssl_module ï¼š ä½¿ç”¨httpsåè®®æ¨¡å—ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥æ¨¡å—æ²¡æœ‰è¢«æ„å»ºã€‚å‰ææ˜¯opensslä¸openssl-develå·²å®‰è£…</div><div class="line">--with-http_stub_status_module ï¼š ç”¨æ¥ç›‘æ§ Nginx çš„å½“å‰çŠ¶æ€</div><div class="line">--with-http_realip_module ï¼š é€šè¿‡è¿™ä¸ªæ¨¡å—å…è®¸æˆ‘ä»¬æ”¹å˜å®¢æˆ·ç«¯è¯·æ±‚å¤´ä¸­å®¢æˆ·ç«¯IPåœ°å€å€¼(ä¾‹å¦‚X-Real-IP æˆ– X-Forwarded-For)ï¼Œæ„ä¹‰åœ¨äºèƒ½å¤Ÿä½¿å¾—åå°æœåŠ¡å™¨è®°å½•åŸå§‹å®¢æˆ·ç«¯çš„IPåœ°å€</div><div class="line">--add-module=PATH ï¼š æ·»åŠ ç¬¬ä¸‰æ–¹å¤–éƒ¨æ¨¡å—ï¼Œå¦‚nginx-sticky-module-ngæˆ–ç¼“å­˜æ¨¡å—ã€‚æ¯æ¬¡æ·»åŠ æ–°çš„æ¨¡å—éƒ½è¦é‡æ–°ç¼–è¯‘ï¼ˆTengineå¯ä»¥åœ¨æ–°åŠ å…¥moduleæ—¶æ— éœ€é‡æ–°ç¼–è¯‘ï¼‰</div></pre></td></tr></table></figure>
<p>å†æä¾›ä¸€ç§ç¼–è¯‘æ–¹æ¡ˆï¼šæœ€å…¨æ–¹æ¡ˆçš„ç¼–è¯‘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">./configure \</div><div class="line"> --prefix=/usr \</div><div class="line"> --sbin-path=/usr/sbin/nginx \</div><div class="line"> --conf-path=/etc/nginx/nginx.conf \</div><div class="line"> --error-log-path=/var/<span class="built_in">log</span>/nginx/error.log \</div><div class="line"> --http-log-path=/var/<span class="built_in">log</span>/nginx/access.log \</div><div class="line"> --pid-path=/var/run/nginx/nginx.pid  \</div><div class="line"> --lock-path=/var/lock/nginx.lock \   </div><div class="line"> --user=nginx \</div><div class="line"> --group=nginx \</div><div class="line"> --with-http_ssl_module \</div><div class="line"> --with-http_stub_status_module \</div><div class="line">--with-http_gzip_static_module \</div><div class="line"> --http-client-body-temp-path=/var/tmp/nginx/client/ \</div><div class="line"> --http-proxy-temp-path=/var/tmp/nginx/proxy/ \</div><div class="line"> --http-fastcgi-temp-path=/var/tmp/nginx/fcgi/ \</div><div class="line"> --http-uwsgi-temp-path=/var/tmp/nginx/uwsgi \</div><div class="line"> --with-pcre=../pcre-7.8</div><div class="line"> --with-zlib=../zlib-1.2.3</div></pre></td></tr></table></figure>
<p>ç¼–è¯‘å®Œæˆåé¢æ‰§è¡Œå®‰è£…ï¼šmake </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">creating objs/Makefile</div><div class="line"></div><div class="line">Configuration summary</div><div class="line">  + using system PCRE library</div><div class="line">  + using system OpenSSL library</div><div class="line">  + using system zlib library</div><div class="line"></div><div class="line">  nginx path prefix: "/usr/local/nginx"</div><div class="line">  nginx binary file: "/usr/local/nginx/sbin/nginx"</div><div class="line">  nginx modules path: "/usr/local/nginx/modules"</div><div class="line">  nginx configuration prefix: "/usr/local/nginx/conf"</div><div class="line">  nginx configuration file: "/usr/local/nginx/conf/nginx.conf"</div><div class="line">  nginx pid file: "/usr/local/nginx/logs/nginx.pid"</div><div class="line">  nginx error log file: "/var/log/nginx/error.log"</div><div class="line">  nginx http access log file: "/var/log/nginx/access.log"</div><div class="line">  nginx http client request body temporary files: "client_body_temp"</div><div class="line">  nginx http proxy temporary files: "proxy_temp"</div><div class="line">  nginx http fastcgi temporary files: "fastcgi_temp"</div><div class="line">  nginx http uwsgi temporary files: "uwsgi_temp"</div><div class="line">  nginx http scgi temporary files: "scgi_temp"</div><div class="line">  </div><div class="line">[root@nginx nginx-1.11.10]# make &amp;&amp; make install</div><div class="line">make -f objs/Makefile</div><div class="line">make[1]: Entering directory `/root/nginx-1.11.10'</div><div class="line">cc -c -pipe  -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Werror -g  -I src/core -I src/event -I src/event/modules -I src/os/unix -I objs \</div><div class="line">		-o objs/src/core/nginx.o \</div><div class="line">		src/core/nginx.c</div><div class="line">cc -c -pipe  -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Werror -g  -I src/core -I src/event -I src/event/modules -I src/os/unix -I objs \</div><div class="line">		-o objs/src/core/ngx_log.o \</div><div class="line">		src/core/ngx_log.c</div><div class="line">cc -c -pipe  -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Werror -g  -I src/core -I src/event -I src/event/modules -I src/os/unix -I objs \</div><div class="line">.....</div></pre></td></tr></table></figure>
<h3 id="å¯åŠ¨nginxæœåŠ¡"><a href="#å¯åŠ¨nginxæœåŠ¡" class="headerlink" title="å¯åŠ¨nginxæœåŠ¡"></a>å¯åŠ¨nginxæœåŠ¡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -c /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</div><div class="line">ln <span class="_">-s</span> /usr/<span class="built_in">local</span>/nginx/sbin/nginx /usr/bin/nginx   <span class="comment">##åšè½¯è¿æ¥</span></div><div class="line">cp nginx.init /etc/init.d/nginx  å¯åŠ¨è„šæœ¬</div><div class="line">chmod +x /etc/init.d/nginx</div></pre></td></tr></table></figure>
<h3 id="ä¸‹è½½nginxå¯åŠ¨è„šæœ¬"><a href="#ä¸‹è½½nginxå¯åŠ¨è„šæœ¬" class="headerlink" title="ä¸‹è½½nginxå¯åŠ¨è„šæœ¬"></a>ä¸‹è½½nginxå¯åŠ¨è„šæœ¬</h3><p>è¿™ä¸ªæˆ‘å…¨éƒ¨æ”¾åˆ°githubä¸Šé¢ï¼Œ<a href="https://github.com/yangcvo/nginx.git" target="_blank" rel="external">nginxå¯åŠ¨è„šæœ¬</a></p>
<p>å¯åŠ¨å…³é—­nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®</span></div><div class="line"><span class="comment"># /usr/local/nginx-1.6/sbin/nginx -t </span></div><div class="line"><span class="comment"># ./sbin/nginx -V     # å¯ä»¥çœ‹åˆ°ç¼–è¯‘é€‰é¡¹</span></div><div class="line"></div><div class="line"><span class="comment">## å¯åŠ¨ã€å…³é—­</span></div><div class="line"><span class="comment"># ./sbin/nginx        # é»˜è®¤é…ç½®æ–‡ä»¶ conf/nginx.confï¼Œ-c æŒ‡å®š</span></div><div class="line"><span class="comment"># ./sbin/nginx -s stop</span></div><div class="line">æˆ– pkill nginx</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#nginxå¹³æ»‘é‡å¯ã€</span></div><div class="line"></div><div class="line"></div><div class="line">nginx -t -c /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</div><div class="line"></div><div class="line"><span class="comment">## é‡å¯ï¼Œä¸ä¼šæ”¹å˜å¯åŠ¨æ—¶æŒ‡å®šçš„é…ç½®æ–‡ä»¶</span></div><div class="line"><span class="comment"># ./sbin/nginx -s reload</span></div><div class="line">æˆ– <span class="built_in">kill</span> -HUP `cat /usr/<span class="built_in">local</span>/nginx-1.6/logs/nginx.pid`</div></pre></td></tr></table></figure>
<h3 id="è®¾ç½®å¼€æœºå¯åŠ¨"><a href="#è®¾ç½®å¼€æœºå¯åŠ¨" class="headerlink" title="è®¾ç½®å¼€æœºå¯åŠ¨"></a>è®¾ç½®å¼€æœºå¯åŠ¨</h3><pre><code>chkconfig --level 345 nginx on
chkconfig nginx on 
chkconfig nginx --list 
  nginx              0:å…³é—­    1:å…³é—­    2:å¯ç”¨    3:å¯ç”¨    4:å¯ç”¨    5:å¯ç”¨    6:å…³é—­
</code></pre><p>å½“ç„¶ä¹Ÿå¯ä»¥å°† nginx ä½œä¸ºç³»ç»ŸæœåŠ¡ç®¡ç†ï¼Œä¸‹è½½ nginx åˆ°/etc/init.d/ï¼Œä¿®æ”¹é‡Œé¢çš„è·¯å¾„ç„¶åèµ‹äºˆå¯æ‰§è¡Œæƒé™ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># service nginx &#123;start|stop|status|restart|reload|configtest&#125;</span></div></pre></td></tr></table></figure>
<h3 id="nginx-confé…ç½®æ–‡ä»¶"><a href="#nginx-confé…ç½®æ–‡ä»¶" class="headerlink" title="nginx.confé…ç½®æ–‡ä»¶"></a>nginx.confé…ç½®æ–‡ä»¶</h3><p>Nginxé…ç½®æ–‡ä»¶ä¸»è¦åˆ†æˆå››éƒ¨åˆ†ï¼šmainï¼ˆå…¨å±€è®¾ç½®ï¼‰ã€serverï¼ˆä¸»æœºè®¾ç½®ï¼‰ã€upstreamï¼ˆä¸Šæ¸¸æœåŠ¡å™¨è®¾ç½®ï¼Œä¸»è¦ä¸ºåå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ç›¸å…³é…ç½®ï¼‰å’Œ locationï¼ˆURLåŒ¹é…ç‰¹å®šä½ç½®åçš„è®¾ç½®ï¼‰ï¼Œæ¯éƒ¨åˆ†åŒ…å«è‹¥å¹²ä¸ªæŒ‡ä»¤ã€‚mainéƒ¨åˆ†è®¾ç½®çš„æŒ‡ä»¤å°†å½±å“å…¶å®ƒæ‰€æœ‰éƒ¨åˆ†çš„è®¾ç½®ï¼›serveréƒ¨åˆ†çš„æŒ‡ä»¤ä¸»è¦ç”¨äºæŒ‡å®šè™šæ‹Ÿä¸»æœºåŸŸåã€IPå’Œç«¯å£ï¼›upstreamçš„æŒ‡ä»¤ç”¨äºè®¾ç½®ä¸€ç³»åˆ—çš„åç«¯æœåŠ¡å™¨ï¼Œè®¾ç½®åå‘ä»£ç†åŠåç«¯æœåŠ¡å™¨çš„è´Ÿè½½å‡è¡¡ï¼›locationéƒ¨åˆ†ç”¨äºåŒ¹é…ç½‘é¡µä½ç½®ï¼ˆæ¯”å¦‚ï¼Œæ ¹ç›®å½•â€œ/â€,â€œ/imagesâ€,ç­‰ç­‰ï¼‰ã€‚ä»–ä»¬ä¹‹é—´çš„å…³ç³»å¼ï¼šserverç»§æ‰¿mainï¼Œlocationç»§æ‰¿serverï¼›upstreamæ—¢ä¸ä¼šç»§æ‰¿æŒ‡ä»¤ä¹Ÿä¸ä¼šè¢«ç»§æ‰¿ã€‚å®ƒæœ‰è‡ªå·±çš„ç‰¹æ®ŠæŒ‡ä»¤ï¼Œä¸éœ€è¦åœ¨å…¶ä»–åœ°æ–¹çš„åº”ç”¨ã€‚</p>
<p>å½“å‰nginxæ”¯æŒçš„å‡ ä¸ªæŒ‡ä»¤ä¸Šä¸‹æ–‡ï¼š</p>
<p>2.1 é€šç”¨<br>ä¸‹é¢çš„nginx.confç®€å•çš„å®ç°nginxåœ¨å‰ç«¯åšåå‘ä»£ç†æœåŠ¡å™¨çš„ä¾‹å­ï¼Œå¤„ç†jsã€pngç­‰é™æ€æ–‡ä»¶ï¼Œjspç­‰åŠ¨æ€è¯·æ±‚è½¬å‘åˆ°å…¶å®ƒæœåŠ¡å™¨tomcatï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line">user  www www;</div><div class="line">worker_processes  2;</div><div class="line"></div><div class="line">worker_cpu_affinity 00000001; </div><div class="line"></div><div class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log;</div><div class="line"><span class="comment">#error_log  logs/error.log  notice;</span></div><div class="line"><span class="comment">#error_log  logs/error.log  info;</span></div><div class="line"></div><div class="line">pid         /var/run/nginx.pid;</div><div class="line"></div><div class="line"></div><div class="line">worker_rlimit_nofile 1024;</div><div class="line"></div><div class="line">events &#123;</div><div class="line">    use epoll;</div><div class="line">    worker_connections  65535;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">http &#123;</div><div class="line">    include       mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line"></div><div class="line">    <span class="comment">#log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span></div><div class="line">    <span class="comment">#                  '$status $body_bytes_sent "$http_referer" '</span></div><div class="line">    <span class="comment">#                  '"$http_user_agent" "$http_x_forwarded_for"';</span></div><div class="line"></div><div class="line">    <span class="comment">#access_log  logs/access.log  main;</span></div><div class="line"></div><div class="line">    sendfile        on;</div><div class="line">    <span class="comment"># tcp_nopush     on;</span></div><div class="line"></div><div class="line">    keepalive_timeout  65;</div><div class="line"></div><div class="line">  <span class="comment"># gzipå‹ç¼©åŠŸèƒ½è®¾ç½®</span></div><div class="line">    gzip on;</div><div class="line">    gzip_min_length 1k;</div><div class="line">    gzip_buffers    4 16k;</div><div class="line">    gzip_http_version 1.0;</div><div class="line">    gzip_comp_level 6;</div><div class="line">    gzip_types text/html text/plain text/css text/javascript application/json application/javascript application/x-javascript application/xml;</div><div class="line">    gzip_vary on;</div><div class="line">  </div><div class="line">  <span class="comment"># http_proxy è®¾ç½®</span></div><div class="line">    client_max_body_size   10m;</div><div class="line">    client_body_buffer_size   128k;</div><div class="line">    proxy_connect_timeout   75;</div><div class="line">    proxy_send_timeout   75;</div><div class="line">    proxy_read_timeout   75;</div><div class="line">    proxy_buffer_size   4k;</div><div class="line">    proxy_buffers   4 32k;</div><div class="line">    proxy_busy_buffers_size   64k;</div><div class="line">    proxy_temp_file_write_size  64k;</div><div class="line">    proxy_temp_path   /usr/<span class="built_in">local</span>/nginx/proxy_temp 1 2;</div><div class="line"></div><div class="line">  <span class="comment"># è®¾å®šè´Ÿè½½å‡è¡¡åå°æœåŠ¡å™¨åˆ—è¡¨ </span></div><div class="line">  </div><div class="line">    upstream  backend  &#123; </div><div class="line">              <span class="comment">#ip_hash; </span></div><div class="line">              server   192.168.10.100:8080 max_fails=2 fail_timeout=30s ;  </div><div class="line">              server   192.168.10.101:8080 max_fails=2 fail_timeout=30s ;  </div><div class="line">    &#125;</div><div class="line"></div><div class="line">  <span class="comment"># å¾ˆé‡è¦çš„è™šæ‹Ÿä¸»æœºé…ç½®</span></div><div class="line">    server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  itoatest.example.com;</div><div class="line">        root   /apps/oaapp;</div><div class="line"></div><div class="line">        charset utf-8;</div><div class="line">        access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">        <span class="comment">#å¯¹ / æ‰€æœ‰åšè´Ÿè½½å‡è¡¡+åå‘ä»£ç†</span></div><div class="line">        location / &#123;</div><div class="line">            root   /apps/oaapp;</div><div class="line">            index  index.jsp index.html index.htm;</div><div class="line"></div><div class="line">            proxy_pass        http://backend;  </div><div class="line">            proxy_redirect off;</div><div class="line">            <span class="comment"># åç«¯çš„WebæœåŠ¡å™¨å¯ä»¥é€šè¿‡X-Forwarded-Forè·å–ç”¨æˆ·çœŸå®IP</span></div><div class="line">            proxy_set_header  Host  <span class="variable">$host</span>;</div><div class="line">            proxy_set_header  X-Real-IP  <span class="variable">$remote_addr</span>;  </div><div class="line">            proxy_set_header  X-Forwarded-For  <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;</div><div class="line">            </div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">#é™æ€æ–‡ä»¶ï¼Œnginxè‡ªå·±å¤„ç†ï¼Œä¸å»backendè¯·æ±‚tomcat</span></div><div class="line">        location  ~* /download/ &#123;  </div><div class="line">            root /apps/oa/fs;  </div><div class="line">            </div><div class="line">        &#125;</div><div class="line">        location ~ .*\.(gif|jpg|jpeg|bmp|png|ico|txt|js|css)$   </div><div class="line">        &#123;   </div><div class="line">            root /apps/oaapp;   </div><div class="line">            expires      7d; </div><div class="line">        &#125;</div><div class="line">       	location /nginx_status &#123;</div><div class="line">            stub_status on;</div><div class="line">            access_log off;</div><div class="line">            allow 192.168.10.0/24;</div><div class="line">            deny all;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        location ~ ^/(WEB-INF)/ &#123;   </div><div class="line">            deny all;   </div><div class="line">        &#125;</div><div class="line">        <span class="comment">#error_page  404              /404.html;</span></div><div class="line"></div><div class="line">        <span class="comment"># redirect server error pages to the static page /50x.html</span></div><div class="line">        <span class="comment">#</span></div><div class="line">        error_page   500 502 503 504  /50x.html;</div><div class="line">        location = /50x.html &#123;</div><div class="line">            root   html;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  <span class="comment">## å…¶å®ƒè™šæ‹Ÿä¸»æœºï¼Œserver æŒ‡ä»¤å¼€å§‹</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘æ•´ç†äº†ä¸€ä»½æ¯ä¸ªå«ä¹‰çš„è¯¦è§£ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#å®šä¹‰Nginxè¿è¡Œçš„ç”¨æˆ·å’Œç”¨æˆ·</span></div><div class="line">user www www;</div><div class="line"></div><div class="line"><span class="comment">#nginxè¿›ç¨‹æ•°ï¼Œå»ºè®®è®¾ç½®ä¸ºç­‰äºCPUæ€»æ ¸å¿ƒæ•°ã€‚è¿™é‡Œæˆ‘æœåŠ¡å™¨4æ ¸</span></div><div class="line">worker_processes 4;</div><div class="line"></div><div class="line"><span class="comment">#ä¸€ä¸ª1æ ¸CPUå¯¹åº”ä¸€ä¸ªè¿›ç¨‹æ•°ç®¡ç†ã€‚è¿™æ ·èƒ½å¾ˆå¥½åˆ†é…èµ„æºã€‚</span></div><div class="line"></div><div class="line">worker_cpu_affinity 00000001 00000010 00000100 00001000; </div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#å…¨å±€é”™è¯¯æ—¥å¿—å®šä¹‰ç±»å‹ï¼Œ[ debug | info | notice | warn | error | crit ]</span></div><div class="line">error_log /var/<span class="built_in">log</span>/nginx/error.log info;</div><div class="line"></div><div class="line"><span class="comment">#è¿›ç¨‹æ–‡ä»¶</span></div><div class="line">pid /var/run/nginx.pid;</div><div class="line"></div><div class="line"><span class="comment">#ä¸€ä¸ªnginxè¿›ç¨‹æ‰“å¼€çš„æœ€å¤šæ–‡ä»¶æè¿°ç¬¦æ•°ç›®ï¼Œç†è®ºå€¼åº”è¯¥æ˜¯æœ€å¤šæ‰“å¼€æ–‡ä»¶æ•°ï¼ˆç³»ç»Ÿçš„å€¼ulimit -nï¼‰ä¸nginxè¿›ç¨‹æ•°ç›¸é™¤ï¼Œä½†æ˜¯nginxåˆ†é…è¯·æ±‚å¹¶ä¸å‡åŒ€ï¼Œæ‰€ä»¥å»ºè®®ä¸ulimit -nçš„å€¼ä¿æŒä¸€è‡´ã€‚</span></div><div class="line">worker_rlimit_nofile 65535;</div><div class="line"></div><div class="line"><span class="comment">#å·¥ä½œæ¨¡å¼ä¸è¿æ¥æ•°ä¸Šé™</span></div><div class="line">events</div><div class="line">&#123;</div><div class="line"><span class="comment">#å‚è€ƒäº‹ä»¶æ¨¡å‹ï¼Œuse [ kqueue | rtsig | epoll | /dev/poll | select | poll ]; epollæ¨¡å‹æ˜¯Linux 2.6ä»¥ä¸Šç‰ˆæœ¬å†…æ ¸ä¸­çš„é«˜æ€§èƒ½ç½‘ç»œI/Oæ¨¡å‹ï¼Œå¦‚æœè·‘åœ¨FreeBSDä¸Šé¢ï¼Œå°±ç”¨kqueueæ¨¡å‹ã€‚</span></div><div class="line">use epoll;</div><div class="line"><span class="comment">#å•ä¸ªè¿›ç¨‹æœ€å¤§è¿æ¥æ•°ï¼ˆæœ€å¤§è¿æ¥æ•°=è¿æ¥æ•°*è¿›ç¨‹æ•°ï¼‰</span></div><div class="line">worker_connections 65535;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#è®¾å®šhttpæœåŠ¡å™¨</span></div><div class="line">http</div><div class="line">&#123;</div><div class="line">include mime.types; <span class="comment">#æ–‡ä»¶æ‰©å±•åä¸æ–‡ä»¶ç±»å‹æ˜ å°„è¡¨</span></div><div class="line">default_type application/octet-stream; <span class="comment">#é»˜è®¤æ–‡ä»¶ç±»å‹</span></div><div class="line"><span class="comment">#charset utf-8; #é»˜è®¤ç¼–ç </span></div><div class="line">server_names_hash_bucket_size 128; <span class="comment">#æœåŠ¡å™¨åå­—çš„hashè¡¨å¤§å°</span></div><div class="line">client_header_buffer_size 32k; <span class="comment">#ä¸Šä¼ æ–‡ä»¶å¤§å°é™åˆ¶</span></div><div class="line">large_client_header_buffers 4 64k; <span class="comment">#è®¾å®šè¯·æ±‚ç¼“</span></div><div class="line">client_max_body_size 8m; <span class="comment">#è®¾å®šè¯·æ±‚ç¼“</span></div><div class="line">sendfile on; <span class="comment">#å¼€å¯é«˜æ•ˆæ–‡ä»¶ä¼ è¾“æ¨¡å¼ï¼ŒsendfileæŒ‡ä»¤æŒ‡å®šnginxæ˜¯å¦è°ƒç”¨sendfileå‡½æ•°æ¥è¾“å‡ºæ–‡ä»¶ï¼Œå¯¹äºæ™®é€šåº”ç”¨è®¾ä¸º onï¼Œå¦‚æœç”¨æ¥è¿›è¡Œä¸‹è½½ç­‰åº”ç”¨ç£ç›˜IOé‡è´Ÿè½½åº”ç”¨ï¼Œå¯è®¾ç½®ä¸ºoffï¼Œä»¥å¹³è¡¡ç£ç›˜ä¸ç½‘ç»œI/Oå¤„ç†é€Ÿåº¦ï¼Œé™ä½ç³»ç»Ÿçš„è´Ÿè½½ã€‚æ³¨æ„ï¼šå¦‚æœå›¾ç‰‡æ˜¾ç¤ºä¸æ­£å¸¸æŠŠè¿™ä¸ªæ”¹æˆoffã€‚</span></div><div class="line">autoindex on; <span class="comment">#å¼€å¯ç›®å½•åˆ—è¡¨è®¿é—®ï¼Œåˆé€‚ä¸‹è½½æœåŠ¡å™¨ï¼Œé»˜è®¤å…³é—­ã€‚</span></div><div class="line">tcp_nopush on; <span class="comment">#é˜²æ­¢ç½‘ç»œé˜»å¡</span></div><div class="line">tcp_nodelay on; <span class="comment">#é˜²æ­¢ç½‘ç»œé˜»å¡</span></div><div class="line">keepalive_timeout 120; <span class="comment">#é•¿è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ˜¯ç§’</span></div><div class="line"><span class="comment">#keepalive è¶…æ—¶æ—¶é—´ï¼Œå®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯çš„è¿æ¥æŒç»­æœ‰æ•ˆæ—¶é—´å½“å‡ºç°å¯¹æœåŠ¡å™¨åï¼Œç»§ç»­è¯·æ±‚æ—¶keepalive_timeoutåŠŸèƒ½å¯é¿å…å»ºç«‹æˆ–è€…é‡æ–°ã€‚</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#FastCGIç›¸å…³å‚æ•°æ˜¯ä¸ºäº†æ”¹å–„ç½‘ç«™çš„æ€§èƒ½ï¼šå‡å°‘èµ„æºå ç”¨ï¼Œæé«˜è®¿é—®é€Ÿåº¦ã€‚ä¸‹é¢å‚æ•°çœ‹å­—é¢æ„æ€éƒ½èƒ½ç†è§£ã€‚</span></div><div class="line">fastcgi_connect_timeout 300;</div><div class="line">fastcgi_send_timeout 300;</div><div class="line">fastcgi_read_timeout 300;</div><div class="line">fastcgi_buffer_size 64k;</div><div class="line">fastcgi_buffers 4 64k;</div><div class="line">fastcgi_busy_buffers_size 128k;</div><div class="line">fastcgi_temp_file_write_size 128k;</div><div class="line"></div><div class="line"><span class="comment">#gzipæ¨¡å—è®¾ç½®</span></div><div class="line">gzip on; <span class="comment">#å¼€å¯gzipå‹ç¼©è¾“å‡º</span></div><div class="line">gzip_min_length 1k; <span class="comment">#æœ€å°å‹ç¼©æ–‡ä»¶å¤§å°</span></div><div class="line">gzip_buffers 4 16k; <span class="comment">#å‹ç¼©ç¼“å†²åŒº</span></div><div class="line">gzip_http_version 1.0; <span class="comment">#å‹ç¼©ç‰ˆæœ¬ï¼ˆé»˜è®¤1.1ï¼Œå‰ç«¯å¦‚æœæ˜¯squid2.5è¯·ä½¿ç”¨1.0ï¼‰</span></div><div class="line">gzip_comp_level 2; <span class="comment">#å‹ç¼©ç­‰çº§</span></div><div class="line">gzip_types text/plain application/x-javascript text/css application/xml;</div><div class="line"><span class="comment">#å‹ç¼©ç±»å‹ï¼Œé»˜è®¤å°±å·²ç»åŒ…å«text/htmlï¼Œæ‰€ä»¥ä¸‹é¢å°±ä¸ç”¨å†å†™äº†ï¼Œå†™ä¸Šå»ä¹Ÿä¸ä¼šæœ‰é—®é¢˜ï¼Œä½†æ˜¯ä¼šæœ‰ä¸€ä¸ªwarnã€‚</span></div><div class="line">gzip_vary on;</div><div class="line"><span class="comment">#limit_zone crawler $binary_remote_addr 10m; #å¼€å¯é™åˆ¶IPè¿æ¥æ•°çš„æ—¶å€™éœ€è¦ä½¿ç”¨</span></div><div class="line"></div><div class="line">upstream blog.kern.com &#123;</div><div class="line"><span class="comment">#upstreamçš„è´Ÿè½½å‡è¡¡ï¼Œweightæ˜¯æƒé‡ï¼Œå¯ä»¥æ ¹æ®æœºå™¨é…ç½®å®šä¹‰æƒé‡ã€‚weigthå‚æ•°è¡¨ç¤ºæƒå€¼ï¼Œæƒå€¼è¶Šé«˜è¢«åˆ†é…åˆ°çš„å‡ ç‡è¶Šå¤§ã€‚</span></div><div class="line">	server   192.168.58.139:80 weight=1 max_fails=2 fail_timeout=30s;</div><div class="line">	server   192.168.58.140:80 weight=1 max_fails=2 fail_timeout=30s;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#è™šæ‹Ÿä¸»æœºçš„é…ç½®</span></div><div class="line">    server</div><div class="line">&#123;</div><div class="line"><span class="comment">#ç›‘å¬ç«¯å£</span></div><div class="line">    listen 80;</div><div class="line"><span class="comment">#åŸŸåå¯ä»¥æœ‰å¤šä¸ªï¼Œç”¨ç©ºæ ¼éš”å¼€</span></div><div class="line">    server_name www.ihaozhuo.com ;   <span class="comment">##(æœåŠ¡å™¨å)</span></div><div class="line">    index index.html index.htm index.php;</div><div class="line">    root /data/www/ha97; </div><div class="line">    location ~ .*\.(php|php5)?$</div><div class="line">&#123;</div><div class="line">    fastcgi_pass 127.0.0.1:9000;</div><div class="line">    fastcgi_index index.php;</div><div class="line">    include fastcgi.conf;</div><div class="line">&#125;</div><div class="line"><span class="comment">#å›¾ç‰‡ç¼“å­˜æ—¶é—´è®¾ç½®</span></div><div class="line">location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$</div><div class="line">&#123;</div><div class="line">expires 10d;</div><div class="line">&#125;</div><div class="line"><span class="comment">#JSå’ŒCSSç¼“å­˜æ—¶é—´è®¾ç½®</span></div><div class="line">location ~ .*\.(js|css)?$</div><div class="line">&#123;</div><div class="line">expires 1h;</div><div class="line">&#125;</div><div class="line"><span class="comment">#æ—¥å¿—æ ¼å¼è®¾å®š</span></div><div class="line">log_format access <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></div><div class="line"><span class="string">'$status $body_bytes_sent "$http_referer" '</span></div><div class="line"><span class="string">'"$http_user_agent" $http_x_forwarded_for'</span>;</div><div class="line"><span class="comment">#å®šä¹‰æœ¬è™šæ‹Ÿä¸»æœºçš„è®¿é—®æ—¥å¿—</span></div><div class="line">access_log /var/<span class="built_in">log</span>/nginx/ha97access.log access;</div><div class="line"></div><div class="line"><span class="comment">#å¯¹ "/" å¯ç”¨åå‘ä»£ç†</span></div><div class="line">location / &#123;</div><div class="line">proxy_pass http://127.0.0.1:88;</div><div class="line">proxy_cache cache_one; <span class="comment">#å¼€å¯ç¼“å­˜</span></div><div class="line">proxy_cache_valid 200 304 7d; <span class="comment">#æ­£å¸¸çŠ¶æ€ç¼“å­˜ï¼Œå› ä¸ºå¤´åƒä¸ç»å¸¸æ”¹åŠ¨æ‰€ä»¥ç¼“å­˜7å¤©</span></div><div class="line">proxy_redirect off;</div><div class="line">proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line"><span class="comment">#åç«¯çš„WebæœåŠ¡å™¨å¯ä»¥é€šè¿‡X-Forwarded-Forè·å–ç”¨æˆ·çœŸå®IP</span></div><div class="line">proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line"><span class="comment">#ä»¥ä¸‹æ˜¯ä¸€äº›åå‘ä»£ç†çš„é…ç½®ï¼Œå¯é€‰ã€‚</span></div><div class="line">proxy_set_header Host <span class="variable">$host</span>;</div><div class="line">client_max_body_size 10m; <span class="comment">#å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•°</span></div><div class="line">client_body_buffer_size 128k; <span class="comment">#ç¼“å†²åŒºä»£ç†ç¼“å†²ç”¨æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å­—èŠ‚æ•°ï¼Œ</span></div><div class="line">proxy_connect_timeout 90; <span class="comment">#nginxè·Ÿåç«¯æœåŠ¡å™¨è¿æ¥è¶…æ—¶æ—¶é—´(ä»£ç†è¿æ¥è¶…æ—¶)</span></div><div class="line">proxy_send_timeout 90; <span class="comment">#åç«¯æœåŠ¡å™¨æ•°æ®å›ä¼ æ—¶é—´(ä»£ç†å‘é€è¶…æ—¶)</span></div><div class="line">proxy_read_timeout 90; <span class="comment">#è¿æ¥æˆåŠŸåï¼Œåç«¯æœåŠ¡å™¨å“åº”æ—¶é—´(ä»£ç†æ¥æ”¶è¶…æ—¶)</span></div><div class="line">proxy_buffer_size 4k; <span class="comment">#è®¾ç½®ä»£ç†æœåŠ¡å™¨ï¼ˆnginxï¼‰ä¿å­˜ç”¨æˆ·å¤´ä¿¡æ¯çš„ç¼“å†²åŒºå¤§å°</span></div><div class="line">proxy_buffers 4 32k; <span class="comment">#proxy_buffersç¼“å†²åŒºï¼Œç½‘é¡µå¹³å‡åœ¨32kä»¥ä¸‹çš„è®¾ç½®</span></div><div class="line">proxy_busy_buffers_size 64k; <span class="comment">#é«˜è´Ÿè·ä¸‹ç¼“å†²å¤§å°ï¼ˆproxy_buffers*2ï¼‰</span></div><div class="line">proxy_temp_file_write_size 64k;</div><div class="line"><span class="comment">#è®¾å®šç¼“å­˜æ–‡ä»¶å¤¹å¤§å°ï¼Œå¤§äºè¿™ä¸ªå€¼ï¼Œå°†ä»upstreamæœåŠ¡å™¨ä¼ </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#è®¾å®šæŸ¥çœ‹NginxçŠ¶æ€çš„åœ°å€</span></div><div class="line">location /NginxStatus &#123;</div><div class="line">stub_status on;</div><div class="line">access_log on;</div><div class="line">auth_basic <span class="string">"NginxStatus"</span>;</div><div class="line">auth_basic_user_file conf/htpasswd;</div><div class="line"><span class="comment">#htpasswdæ–‡ä»¶çš„å†…å®¹å¯ä»¥ç”¨apacheæä¾›çš„htpasswdå·¥å…·æ¥äº§ç”Ÿã€‚</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#æœ¬åœ°åŠ¨é™åˆ†ç¦»åå‘ä»£ç†é…ç½®</span></div><div class="line"><span class="comment">#æ‰€æœ‰jspçš„é¡µé¢å‡äº¤ç”±tomcatæˆ–resinå¤„ç†</span></div><div class="line">location ~ .(jsp|jspx|<span class="keyword">do</span>)?$ &#123;</div><div class="line">proxy_set_header Host <span class="variable">$host</span>;</div><div class="line">proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line">proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">proxy_pass http://127.0.0.1:8080;</div><div class="line">&#125;</div><div class="line"><span class="comment">#æ‰€æœ‰é™æ€æ–‡ä»¶ç”±nginxç›´æ¥è¯»å–ä¸ç»è¿‡tomcatæˆ–resin</span></div><div class="line">location ~ .*.(htm|html|gif|jpg|jpeg|png|bmp|swf|ioc|rar|zip|txt|flv|mid|doc|ppt|pdf|xls|mp3|wma)$</div><div class="line">&#123; expires 15d; &#125;</div><div class="line">location ~ .*.(js|css)?$</div><div class="line">&#123; expires 1h; &#125;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

	

	

</article>




	<article>
	
		<h1><a href="/2016/05/23/WebæœåŠ¡æŠ€æœ¯/Nginx/Nginx+Tomcatå®ç°è´Ÿè½½å‡è¡¡è®¾ç½®è®¿é—®æ§åˆ¶/">Nginx+Tomcatå®ç°è´Ÿè½½å‡è¡¡è®¾ç½®è®¿é—®æ§åˆ¶</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-05-23</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/nginx/">nginx</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Nginx/">Nginx</a> <a class="article__tag-link" href="/tags/Web-Service/">Web Service</a>
			</span>
		
	</div>

	

	
		<h3 id="Nginx-Tomcatå®ç°è´Ÿè½½å‡è¡¡è®¾ç½®è®¿é—®æ§åˆ¶"><a href="#Nginx-Tomcatå®ç°è´Ÿè½½å‡è¡¡è®¾ç½®è®¿é—®æ§åˆ¶" class="headerlink" title="Nginx+Tomcatå®ç°è´Ÿè½½å‡è¡¡è®¾ç½®è®¿é—®æ§åˆ¶"></a>Nginx+Tomcatå®ç°è´Ÿè½½å‡è¡¡è®¾ç½®è®¿é—®æ§åˆ¶</h3><h3 id="ä¸€ã€ç¯å¢ƒå‡†å¤‡"><a href="#ä¸€ã€ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ä¸€ã€ç¯å¢ƒå‡†å¤‡"></a>ä¸€ã€ç¯å¢ƒå‡†å¤‡</h3><ul>
<li>Tomcat1ï¼š10.11.155.26</li>
<li>Tomcat2ï¼š10.11.155.41</li>
<li><p>Nginxï¼š192.168.31.154 </p>
<ul>
<li>åœ¨26å’Œ41ä¸Šåˆ†åˆ«éƒ¨ç½²ç›¸åŒçš„Tomcatç¨‹åºï¼Œä¿®æ”¹index.jspé¡µé¢ï¼ŒæŠŠå†…å®¹æ”¹ä¸ºå„è‡ªçš„IPåœ°å€.</li>
</ul>
</li>
</ul>
<h3 id="äºŒã€ä¿®æ”¹é…ç½®æ–‡ä»¶nginx-conf"><a href="#äºŒã€ä¿®æ”¹é…ç½®æ–‡ä»¶nginx-conf" class="headerlink" title="äºŒã€ä¿®æ”¹é…ç½®æ–‡ä»¶nginx.conf"></a>äºŒã€ä¿®æ”¹é…ç½®æ–‡ä»¶nginx.conf</h3><p>Nginxè´Ÿè½½å‡è¡¡ï¼Œå…¶å®ä¸»è¦å°±æ˜¯ç”¨upstreamã€serveræŒ‡ä»¤ï¼Œå†é…ä»¥æƒé‡ç­‰ç­‰å‚æ•°ã€‚å¦‚æœä¸ºäº†è®©nginxæ”¯æŒsessionå…±äº«ï¼Œè¿˜éœ€è¦é¢å¤–å¢åŠ ä¸€ä¸ªæ¨¡å—ã€‚</p>
<p>ä¸€ã€Nginxè´Ÿè½½å‡è¡¡</p>
<p>åœ¨http{â€¦}ä¸­é…ç½®ä¸€ä¸ªupstream{â€¦}ï¼Œå‚è€ƒå¦‚ä¸‹ï¼š<br>å¼•ç”¨</p>
<pre><code>upstream tomcat-account {
    server 10.11.155.26:8080 weight=1;    
    server 10.11.155.41:8080 weight=1;
}
</code></pre><p>æ¥ç€ä¿®æ”¹locationèŠ‚ç‚¹ï¼Œé…ç½®ä»£ç†ï¼š</p>
<p>å¼•ç”¨</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  10001.test.intranet;</div><div class="line">        location / &#123;</div><div class="line">           index        index.html index.php index.jsp index.htm;</div><div class="line">           proxy_pass           http://tomcat-account;</div><div class="line">           proxy_ignore_client_abort on;</div><div class="line">           proxy_redirect               off;</div><div class="line">           proxy_set_header     Host    <span class="variable">$host</span>;</div><div class="line">           proxy_set_header     X-Real-IP       <span class="variable">$remote_addr</span>;</div><div class="line">           proxy_set_header     X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">```  </div><div class="line">  </div><div class="line">è¿™é‡Œå¯ä»¥å†™è‡ªå·±çš„å†…ç½‘åŸŸåä¹Ÿå¯ä»¥å†™IP.</div><div class="line">å½“è®¿é—®æ ¹è·¯å¾„æ—¶ï¼Œä¼šè½®æ’­è·¯ç”±åˆ°ä¸¤å°æœåŠ¡å™¨ä¸Šï¼Œè‡³äºåç«¯æœåŠ¡å™¨æ˜¯tomcatè¿˜æ˜¯jettyä¹‹ç±»çš„ï¼Œéƒ½æ— æ‰€è°“ï¼Œç…§è‘«èŠ¦ç”»ç“¢å°±æ˜¯äº†ã€‚</div><div class="line"></div><div class="line">å½“ç„¶ï¼Œæœ‰çš„æœºå™¨æ€§èƒ½å¥½ï¼Œæˆ–è€…è´Ÿè½½ä½ï¼Œå¯ä»¥æ‰¿æ‹…é«˜è´Ÿè·è®¿é—®é‡ï¼Œå¯ä»¥é€šè¿‡æƒé‡ï¼ˆweightï¼‰ï¼Œæå‡è®¿é—®é¢‘ç‡ã€‚æ•°å€¼è¶Šé«˜ï¼Œè¢«åˆ†é…åˆ°çš„è¯·æ±‚æ•°è¶Šå¤šã€‚</div><div class="line"></div><div class="line"><span class="comment">#### 1ã€weightï¼ˆæƒé‡ï¼‰</span></div><div class="line">æŒ‡å®šè½®è¯¢å‡ ç‡ï¼Œweightå’Œè®¿é—®æ¯”ç‡æˆæ­£æ¯”ï¼Œç”¨äºåç«¯æœåŠ¡å™¨æ€§èƒ½ä¸å‡çš„æƒ…å†µã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œ10.0.0.88çš„è®¿é—®æ¯”ç‡è¦æ¯”10.0.0.77çš„è®¿é—®æ¯”ç‡é«˜ä¸€å€ã€‚</div><div class="line"></div><div class="line">```bash</div><div class="line">upstream linuxidc&#123; </div><div class="line">    server 10.11.155.26 weight=5; </div><div class="line">    server 10.11.155.41 weight=10; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2ã€ip-hashï¼ˆè®¿é—®ipï¼‰"><a href="#2ã€ip-hashï¼ˆè®¿é—®ipï¼‰" class="headerlink" title="2ã€ip_hashï¼ˆè®¿é—®ipï¼‰"></a>2ã€ip_hashï¼ˆè®¿é—®ipï¼‰</h4><p>æ¯ä¸ªè¯·æ±‚æŒ‰è®¿é—®ipçš„hashç»“æœåˆ†é…ï¼Œè¿™æ ·æ¯ä¸ªè®¿å®¢å›ºå®šè®¿é—®ä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œå¯ä»¥è§£å†³sessionçš„é—®é¢˜ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream favresin&#123; </div><div class="line">   ip_hash; </div><div class="line">   server 10.11.155.26:8080; </div><div class="line">   server 10.11.155.41:8080; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="3ã€fairï¼ˆç¬¬ä¸‰æ–¹ï¼‰"><a href="#3ã€fairï¼ˆç¬¬ä¸‰æ–¹ï¼‰" class="headerlink" title="3ã€fairï¼ˆç¬¬ä¸‰æ–¹ï¼‰"></a>3ã€fairï¼ˆç¬¬ä¸‰æ–¹ï¼‰</h4><p>æŒ‰åç«¯æœåŠ¡å™¨çš„å“åº”æ—¶é—´æ¥åˆ†é…è¯·æ±‚ï¼Œå“åº”æ—¶é—´çŸ­çš„ä¼˜å…ˆåˆ†é…ã€‚ä¸weightåˆ†é…ç­–ç•¥ç±»ä¼¼ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream favresin&#123;      </div><div class="line">    server 10.11.155.26:8080; </div><div class="line">    server 10.11.155.41:8080; </div><div class="line">    fair; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>serveræŒ‡ä»¤å‚æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- weight   â€”â€”æƒé‡ï¼Œæ•°å€¼è¶Šå¤§ï¼Œåˆ†å¾—çš„è¯·æ±‚æ•°å°±è¶Šå¤šï¼Œé»˜è®¤å€¼ä¸º1ã€‚</div><div class="line">- max_fails â€”â€”å¯¹è®¿é—®å¤±è´¥çš„åç«¯æœåŠ¡å™¨å°è¯•è®¿é—®çš„æ¬¡æ•°ã€‚é»˜è®¤å€¼ä¸º1ï¼Œå½“è®¾ç½®ä¸º0æ—¶å°†å…³é—­æ£€æŸ¥ã€‚</div><div class="line">- fail_timeoutâ€”â€”å¤±æ•ˆè¶…æ—¶æ—¶é—´ï¼Œå½“å¤šæ¬¡è®¿é—®å¤±è´¥åï¼Œå¯¹è¯¥èŠ‚ç‚¹æš‚åœè®¿é—®ã€‚</div><div class="line">- downâ€”â€”æ ‡è®°æœåŠ¡å™¨ä¸ºæ°¸ä¹…ç¦»çº¿çŠ¶æ€ï¼Œç”¨äºip_hashæŒ‡ä»¤ã€‚</div><div class="line">- backupâ€”â€”ä»…å½“ébackupæœåŠ¡å™¨å…¨éƒ¨å®•æœºæˆ–ç¹å¿™æ—¶å¯ç”¨ã€‚</div></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼Œå¯ä»¥è¿™æ ·é…ç½®ï¼š</p>
<p>å¼•ç”¨</p>
<pre><code>upstream tomcat {
    server 10.11.155.26:8080 weight=5;
    server 10.11.155.41:8080 weight=10;
}
</code></pre><p>åè€…åˆ†å¾—çš„è¯·æ±‚æ•°å°±ä¼šè¾ƒé«˜ã€‚</p>
<h3 id="è¯¦ç»†ç‚¹çš„è´Ÿè½½å‡è¡¡é…ç½®nginx-conf"><a href="#è¯¦ç»†ç‚¹çš„è´Ÿè½½å‡è¡¡é…ç½®nginx-conf" class="headerlink" title="è¯¦ç»†ç‚¹çš„è´Ÿè½½å‡è¡¡é…ç½®nginx.conf:"></a>è¯¦ç»†ç‚¹çš„è´Ÿè½½å‡è¡¡é…ç½®nginx.conf:</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="attribute">user</span>  www;</div><div class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="comment">#error_log  logs/error.log;</span></div><div class="line"><span class="comment">#error_log  logs/error.log  notice;</span></div><div class="line"><span class="comment">#error_log  logs/error.log  info;</span></div><div class="line"><span class="attribute">error_log</span>  /opt/logs/nginx/error.log  <span class="literal">crit</span>;</div><div class="line"></div><div class="line"><span class="comment"># pid        /usr/local/nginx/nginx.pid;</span></div><div class="line"><span class="attribute">pid</span>         /var/run/nginx.pid;</div><div class="line"></div><div class="line"><span class="attribute">worker_rlimit_nofile</span> <span class="number">1024</span>;</div><div class="line"></div><div class="line"><span class="section">events</span> &#123;</div><div class="line">    <span class="attribute">use</span> <span class="literal">epoll</span>;</div><div class="line">    <span class="attribute">worker_connections</span>  <span class="number">65535</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#è®¾å®šhttpæœåŠ¡å™¨ï¼Œåˆ©ç”¨å®ƒçš„åå‘ä»£ç†åŠŸèƒ½æä¾›è´Ÿè½½å‡è¡¡æ”¯æŒ</span></div><div class="line"><span class="section">http</span> &#123;</div><div class="line"></div><div class="line">    <span class="comment">#è®¾å®šmimeç±»å‹,ç±»å‹ç”±mime.typeæ–‡ä»¶å®šä¹‰</span></div><div class="line">    <span class="attribute">include</span>             /etc/nginx/mime.types;</div><div class="line">    <span class="attribute">default_type</span>    application/octet-stream;</div><div class="line">    </div><div class="line"> <span class="comment">#access_log  logs/access.log  main;</span></div><div class="line">    <span class="attribute">server_names_hash_bucket_size</span> <span class="number">128</span>;</div><div class="line">    <span class="attribute">client_header_buffer_size</span> <span class="number">32k</span>;</div><div class="line">    <span class="attribute">large_client_header_buffers</span> <span class="number">4</span> <span class="number">32k</span>;</div><div class="line"></div><div class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</div><div class="line">    <span class="attribute">tcp_nopush</span>  <span class="literal">on</span>;</div><div class="line">    <span class="attribute">tcp_nodelay</span> <span class="literal">on</span>;</div><div class="line"></div><div class="line">    <span class="comment">#keepalive_timeout  0;</span></div><div class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</div><div class="line"></div><div class="line">    <span class="comment">#gzip  on;</span></div><div class="line">    <span class="attribute">log_format</span> access <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></div><div class="line">                      <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></div><div class="line">                      <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">#è®¾å®šæ—¥å¿—æ ¼å¼</span></div><div class="line">    <span class="attribute">access_log</span>        /var/log/nginx/access.log;</div><div class="line"></div><div class="line">  <span class="section">server</span> &#123;</div><div class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</div><div class="line">        <span class="attribute">server_name</span>  localhost;</div><div class="line"></div><div class="line">        <span class="attribute">location</span> / &#123;</div><div class="line">            <span class="attribute">root</span>   html;</div><div class="line">            <span class="attribute">index</span>  index.html index.htm;</div><div class="line">        <span class="attribute">limit_req</span>  zone=one;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</div><div class="line">        <span class="attribute">location</span> = /50x.html &#123;</div><div class="line">            <span class="attribute">root</span>   html;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">#çœç•¥ä¸Šæ–‡æœ‰çš„ä¸€äº›é…ç½®èŠ‚ç‚¹</span></div><div class="line">    <span class="comment">#ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</span></div><div class="line"></div><div class="line">    <span class="comment">#è®¾å®šè´Ÿè½½å‡è¡¡çš„æœåŠ¡å™¨åˆ—è¡¨</span></div><div class="line">    <span class="attribute">upstream</span> tomcat-account &#123;</div><div class="line">        <span class="comment">#weigthå‚æ•°è¡¨ç¤ºæƒå€¼ï¼Œæƒå€¼è¶Šé«˜è¢«åˆ†é…åˆ°çš„å‡ ç‡è¶Šå¤§</span></div><div class="line">        <span class="attribute">server</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">8</span>.1x:<span class="number">3128</span> weight=<span class="number">5</span>;</div><div class="line">        <span class="comment">#æœ¬æœºä¸Šçš„Squidå¼€å¯3128ç«¯å£,ä¸æ˜¯å¿…é¡»è¦squid</span></div><div class="line">        <span class="attribute">server</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">8</span>.2x:<span class="number">80</span>    weight=<span class="number">1</span>;</div><div class="line">        <span class="attribute">server</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">8</span>.3x:<span class="number">80</span>    weight=<span class="number">6</span>;</div><div class="line">    &#125;</div><div class="line">        </div><div class="line">    <span class="attribute">upstream</span> mysvr2 &#123;</div><div class="line">        <span class="comment">#weigthå‚æ•°è¡¨ç¤ºæƒå€¼ï¼Œæƒå€¼è¶Šé«˜è¢«åˆ†é…åˆ°çš„å‡ ç‡è¶Šå¤§</span></div><div class="line">        <span class="attribute">server</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">8</span>.x:<span class="number">80</span>    weight=<span class="number">1</span>;</div><div class="line">        <span class="attribute">server</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">8</span>.x:<span class="number">80</span>    weight=<span class="number">6</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">#ç¬¬ä¸€ä¸ªè™šæ‹ŸæœåŠ¡å™¨</span></div><div class="line">    <span class="section">server</span> &#123;</div><div class="line">        <span class="comment">#ä¾¦å¬192.168.8.xçš„80ç«¯å£</span></div><div class="line">        <span class="attribute">listen</span>             <span class="number">80</span>;</div><div class="line">        <span class="attribute">server_name</span>    <span class="number">192</span>.<span class="number">168</span>.<span class="number">8</span>.x;</div><div class="line"></div><div class="line">        <span class="comment">#å¯¹aspxåç¼€çš„è¿›è¡Œè´Ÿè½½å‡è¡¡è¯·æ±‚</span></div><div class="line">        <span class="attribute">location</span> <span class="regexp">~ .*.aspx$</span> &#123;</div><div class="line">            <span class="comment">#å®šä¹‰æœåŠ¡å™¨çš„é»˜è®¤ç½‘ç«™æ ¹ç›®å½•ä½ç½®</span></div><div class="line">            <span class="attribute">root</span>     /root; </div><div class="line">            <span class="comment">#å®šä¹‰é¦–é¡µç´¢å¼•æ–‡ä»¶çš„åç§°</span></div><div class="line">            <span class="attribute">index</span> index.php index.html index.htm;</div><div class="line">            </div><div class="line">            <span class="comment">#è¯·æ±‚è½¬å‘mysvr å®šä¹‰çš„æœåŠ¡å™¨åˆ—è¡¨</span></div><div class="line">            <span class="attribute">proxy_pass</span>   http://tomcat-account;</div><div class="line"></div><div class="line">            <span class="comment">#ä»¥ä¸‹æ˜¯ä¸€äº›åå‘ä»£ç†çš„é…ç½®å¯åˆ é™¤.æ‰€ä»¥å¯ä»¥æŒ‰nginx+tomcat åšè´Ÿè½½å‡è¡¡å³å¯ã€‚</span></div><div class="line"></div><div class="line">            <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</div><div class="line"></div><div class="line">            <span class="comment">#åç«¯çš„WebæœåŠ¡å™¨å¯ä»¥é€šè¿‡X-Forwarded-Forè·å–ç”¨æˆ·çœŸå®IP</span></div><div class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</div><div class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line"></div><div class="line">            <span class="comment">#å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•°</span></div><div class="line">            <span class="attribute">client_max_body_size</span> <span class="number">10m</span>; </div><div class="line"></div><div class="line">            <span class="comment">#ç¼“å†²åŒºä»£ç†ç¼“å†²ç”¨æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å­—èŠ‚æ•°ï¼Œ</span></div><div class="line">            <span class="attribute">client_body_buffer_size</span> <span class="number">128k</span>;</div><div class="line"></div><div class="line">            <span class="comment">#nginxè·Ÿåç«¯æœåŠ¡å™¨è¿æ¥è¶…æ—¶æ—¶é—´(ä»£ç†è¿æ¥è¶…æ—¶)</span></div><div class="line">            <span class="attribute">proxy_connect_timeout</span> <span class="number">90</span>;</div><div class="line"></div><div class="line">            <span class="comment">#è¿æ¥æˆåŠŸåï¼Œåç«¯æœåŠ¡å™¨å“åº”æ—¶é—´(ä»£ç†æ¥æ”¶è¶…æ—¶)</span></div><div class="line">            <span class="attribute">proxy_read_timeout</span> <span class="number">90</span>;</div><div class="line"></div><div class="line">            <span class="comment">#è®¾ç½®ä»£ç†æœåŠ¡å™¨ï¼ˆnginxï¼‰ä¿å­˜ç”¨æˆ·å¤´ä¿¡æ¯çš„ç¼“å†²åŒºå¤§å°</span></div><div class="line">            <span class="attribute">proxy_buffer_size</span> <span class="number">4k</span>;</div><div class="line"></div><div class="line">            <span class="comment">#proxy_buffersç¼“å†²åŒºï¼Œç½‘é¡µå¹³å‡åœ¨32kä»¥ä¸‹çš„è¯ï¼Œè¿™æ ·è®¾ç½®</span></div><div class="line">            <span class="attribute">proxy_buffers</span> <span class="number">4</span> <span class="number">32k</span>;</div><div class="line"></div><div class="line">            <span class="comment">#é«˜è´Ÿè·ä¸‹ç¼“å†²å¤§å°ï¼ˆproxy_buffers*2ï¼‰</span></div><div class="line">            <span class="attribute">proxy_busy_buffers_size</span> <span class="number">64k</span>; </div><div class="line"></div><div class="line">            <span class="comment">#è®¾å®šç¼“å­˜æ–‡ä»¶å¤¹å¤§å°ï¼Œå¤§äºè¿™ä¸ªå€¼ï¼Œå°†ä»upstreamæœåŠ¡å™¨ä¼ </span></div><div class="line">            <span class="attribute">proxy_temp_file_write_size</span> <span class="number">64k</span>;    </div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å¸¸ç”¨æŒ‡ä»¤è¯´æ˜"><a href="#å¸¸ç”¨æŒ‡ä»¤è¯´æ˜" class="headerlink" title="å¸¸ç”¨æŒ‡ä»¤è¯´æ˜"></a>å¸¸ç”¨æŒ‡ä»¤è¯´æ˜</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line">nginxåœ¨è¿è¡Œæ—¶ä¸å…·ä½“ä¸šåŠ¡åŠŸèƒ½ï¼ˆæ¯”å¦‚httpæœåŠ¡æˆ–è€…emailæœåŠ¡ä»£ç†ï¼‰æ— å…³çš„ä¸€äº›å‚æ•°ï¼Œæ¯”å¦‚å·¥ä½œè¿›ç¨‹æ•°ï¼Œè¿è¡Œçš„èº«ä»½ç­‰ã€‚</div><div class="line"></div><div class="line">woker_processes 2</div><div class="line">åœ¨é…ç½®æ–‡ä»¶çš„é¡¶çº§mainéƒ¨åˆ†ï¼Œworkerè§’è‰²çš„å·¥ä½œè¿›ç¨‹çš„ä¸ªæ•°ï¼Œmasterè¿›ç¨‹æ˜¯æ¥æ”¶å¹¶åˆ†é…è¯·æ±‚ç»™workerå¤„ç†ã€‚è¿™ä¸ªæ•°å€¼ç®€å•ä¸€ç‚¹å¯ä»¥è®¾ç½®ä¸ºcpuçš„æ ¸æ•°grep ^processor /proc/cpuinfo | wc <span class="_">-l</span>ï¼Œä¹Ÿæ˜¯ auto å€¼ï¼Œå¦‚æœå¼€å¯äº†sslå’Œgzipæ›´åº”è¯¥è®¾ç½®æˆä¸é€»è¾‘CPUæ•°é‡ä¸€æ ·ç”šè‡³ä¸º2å€ï¼Œå¯ä»¥å‡å°‘I/Oæ“ä½œã€‚å¦‚æœnginxæœåŠ¡å™¨è¿˜æœ‰å…¶å®ƒæœåŠ¡ï¼Œå¯ä»¥è€ƒè™‘é€‚å½“å‡å°‘ã€‚</div><div class="line"></div><div class="line">worker_cpu_affinity</div><div class="line">ä¹Ÿæ˜¯å†™åœ¨mainéƒ¨åˆ†ã€‚åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œé€šè¿‡è®¾ç½®cpuç²˜æ€§æ¥é™ä½ç”±äºå¤šCPUæ ¸åˆ‡æ¢é€ æˆçš„å¯„å­˜å™¨ç­‰ç°åœºé‡å»ºå¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚å¦‚worker_cpu_affinity 0001 0010 0100 1000; ï¼ˆå››æ ¸ï¼‰ã€‚</div><div class="line"></div><div class="line">worker_connections 2048</div><div class="line">å†™åœ¨eventséƒ¨åˆ†ã€‚æ¯ä¸€ä¸ªworkerè¿›ç¨‹èƒ½å¹¶å‘å¤„ç†ï¼ˆå‘èµ·ï¼‰çš„æœ€å¤§è¿æ¥æ•°ï¼ˆåŒ…å«ä¸å®¢æˆ·ç«¯æˆ–åç«¯è¢«ä»£ç†æœåŠ¡å™¨é—´ç­‰æ‰€æœ‰è¿æ¥æ•°ï¼‰ã€‚nginxä½œä¸ºåå‘ä»£ç†æœåŠ¡å™¨ï¼Œè®¡ç®—å…¬å¼ æœ€å¤§è¿æ¥æ•° = worker_processes * worker_connections/4ï¼Œæ‰€ä»¥è¿™é‡Œå®¢æˆ·ç«¯æœ€å¤§è¿æ¥æ•°æ˜¯1024ï¼Œè¿™ä¸ªå¯ä»¥å¢åˆ°åˆ°8192éƒ½æ²¡å…³ç³»ï¼Œçœ‹æƒ…å†µè€Œå®šï¼Œä½†ä¸èƒ½è¶…è¿‡åé¢çš„worker_rlimit_nofileã€‚å½“nginxä½œä¸ºhttpæœåŠ¡å™¨æ—¶ï¼Œè®¡ç®—å…¬å¼é‡Œé¢æ˜¯é™¤ä»¥2ã€‚</div><div class="line"></div><div class="line">worker_rlimit_nofile 10240</div><div class="line">å†™åœ¨mainéƒ¨åˆ†ã€‚é»˜è®¤æ˜¯æ²¡æœ‰è®¾ç½®ï¼Œå¯ä»¥é™åˆ¶ä¸ºæ“ä½œç³»ç»Ÿæœ€å¤§çš„é™åˆ¶65535ã€‚</div><div class="line"></div><div class="line">use epoll</div><div class="line">å†™åœ¨eventséƒ¨åˆ†ã€‚åœ¨Linuxæ“ä½œç³»ç»Ÿä¸‹ï¼Œnginxé»˜è®¤ä½¿ç”¨epolläº‹ä»¶æ¨¡å‹ï¼Œå¾—ç›Šäºæ­¤ï¼Œnginxåœ¨Linuxæ“ä½œç³»ç»Ÿä¸‹æ•ˆç‡ç›¸å½“é«˜ã€‚åŒæ—¶Nginxåœ¨OpenBSDæˆ–FreeBSDæ“ä½œç³»ç»Ÿä¸Šé‡‡ç”¨ç±»ä¼¼äºepollçš„é«˜æ•ˆäº‹ä»¶æ¨¡å‹kqueueã€‚åœ¨æ“ä½œç³»ç»Ÿä¸æ”¯æŒè¿™äº›é«˜æ•ˆæ¨¡å‹æ—¶æ‰ä½¿ç”¨selectã€‚</div><div class="line"></div><div class="line">2.2.2 httpæœåŠ¡å™¨</div><div class="line"></div><div class="line">ä¸æä¾›httpæœåŠ¡ç›¸å…³çš„ä¸€äº›é…ç½®å‚æ•°ã€‚ä¾‹å¦‚ï¼šæ˜¯å¦ä½¿ç”¨keepaliveå•Šï¼Œæ˜¯å¦ä½¿ç”¨gzipè¿›è¡Œå‹ç¼©ç­‰ã€‚</div><div class="line"></div><div class="line">sendfile on</div><div class="line">å¼€å¯é«˜æ•ˆæ–‡ä»¶ä¼ è¾“æ¨¡å¼ï¼ŒsendfileæŒ‡ä»¤æŒ‡å®šnginxæ˜¯å¦è°ƒç”¨sendfileå‡½æ•°æ¥è¾“å‡ºæ–‡ä»¶ï¼Œå‡å°‘ç”¨æˆ·ç©ºé—´åˆ°å†…æ ¸ç©ºé—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚å¯¹äºæ™®é€šåº”ç”¨è®¾ä¸º onï¼Œå¦‚æœç”¨æ¥è¿›è¡Œä¸‹è½½ç­‰åº”ç”¨ç£ç›˜IOé‡è´Ÿè½½åº”ç”¨ï¼Œå¯è®¾ç½®ä¸ºoffï¼Œä»¥å¹³è¡¡ç£ç›˜ä¸ç½‘ç»œI/Oå¤„ç†é€Ÿåº¦ï¼Œé™ä½ç³»ç»Ÿçš„è´Ÿè½½ã€‚</div><div class="line"></div><div class="line">keepalive_timeout 65 : é•¿è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ˜¯ç§’ï¼Œè¿™ä¸ªå‚æ•°å¾ˆæ•æ„Ÿï¼Œæ¶‰åŠæµè§ˆå™¨çš„ç§ç±»ã€åç«¯æœåŠ¡å™¨çš„è¶…æ—¶è®¾ç½®ã€æ“ä½œç³»ç»Ÿçš„è®¾ç½®ï¼Œå¯ä»¥å¦å¤–èµ·ä¸€ç‰‡æ–‡ç« äº†ã€‚é•¿è¿æ¥è¯·æ±‚å¤§é‡å°æ–‡ä»¶çš„æ—¶å€™ï¼Œå¯ä»¥å‡å°‘é‡å»ºè¿æ¥çš„å¼€é”€ï¼Œä½†å‡å¦‚æœ‰å¤§æ–‡ä»¶ä¸Šä¼ ï¼Œ65så†…æ²¡ä¸Šä¼ å®Œæˆä¼šå¯¼è‡´å¤±è´¥ã€‚å¦‚æœè®¾ç½®æ—¶é—´è¿‡é•¿ï¼Œç”¨æˆ·åˆå¤šï¼Œé•¿æ—¶é—´ä¿æŒè¿æ¥ä¼šå ç”¨å¤§é‡èµ„æºã€‚</div><div class="line"></div><div class="line">send_timeout : ç”¨äºæŒ‡å®šå“åº”å®¢æˆ·ç«¯çš„è¶…æ—¶æ—¶é—´ã€‚è¿™ä¸ªè¶…æ—¶ä»…é™äºä¸¤ä¸ªè¿æ¥æ´»åŠ¨ä¹‹é—´çš„æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œå®¢æˆ·ç«¯æ²¡æœ‰ä»»ä½•æ´»åŠ¨ï¼ŒNginxå°†ä¼šå…³é—­è¿æ¥ã€‚</div><div class="line"></div><div class="line">client_max_body_size 10m</div><div class="line">å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•°ã€‚å¦‚æœæœ‰ä¸Šä¼ è¾ƒå¤§æ–‡ä»¶ï¼Œè¯·è®¾ç½®å®ƒçš„é™åˆ¶å€¼</div><div class="line"></div><div class="line">client_body_buffer_size 128k</div><div class="line">ç¼“å†²åŒºä»£ç†ç¼“å†²ç”¨æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å­—èŠ‚æ•°</div><div class="line">æ¨¡å—http_proxyï¼š</div><div class="line">è¿™ä¸ªæ¨¡å—å®ç°çš„æ˜¯nginxä½œä¸ºåå‘ä»£ç†æœåŠ¡å™¨çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç¼“å­˜åŠŸèƒ½ï¼ˆå¦è§æ–‡ç« ï¼‰</div><div class="line"></div><div class="line">proxy_connect_timeout 60</div><div class="line">nginxè·Ÿåç«¯æœåŠ¡å™¨è¿æ¥è¶…æ—¶æ—¶é—´(ä»£ç†è¿æ¥è¶…æ—¶)</div><div class="line">proxy_read_timeout 60</div><div class="line">è¿æ¥æˆåŠŸåï¼Œä¸åç«¯æœåŠ¡å™¨ä¸¤ä¸ªæˆåŠŸçš„å“åº”æ“ä½œä¹‹é—´è¶…æ—¶æ—¶é—´(ä»£ç†æ¥æ”¶è¶…æ—¶)</div><div class="line"></div><div class="line">proxy_buffer_size 4k</div><div class="line">è®¾ç½®ä»£ç†æœåŠ¡å™¨ï¼ˆnginxï¼‰ä»åç«¯realserverè¯»å–å¹¶ä¿å­˜ç”¨æˆ·å¤´ä¿¡æ¯çš„ç¼“å†²åŒºå¤§å°ï¼Œé»˜è®¤ä¸proxy_bufferså¤§å°ç›¸åŒï¼Œå…¶å®å¯ä»¥å°†è¿™ä¸ªæŒ‡ä»¤å€¼è®¾çš„å°ä¸€ç‚¹</div><div class="line"></div><div class="line">proxy_buffers 4 32k</div><div class="line">proxy_buffersç¼“å†²åŒºï¼Œnginxé’ˆå¯¹å•ä¸ªè¿æ¥ç¼“å­˜æ¥è‡ªåç«¯realserverçš„å“åº”ï¼Œç½‘é¡µå¹³å‡åœ¨32kä»¥ä¸‹çš„è¯ï¼Œè¿™æ ·è®¾ç½®</div><div class="line"></div><div class="line">proxy_busy_buffers_size 64k</div><div class="line">é«˜è´Ÿè·ä¸‹ç¼“å†²å¤§å°ï¼ˆproxy_buffers*2ï¼‰</div><div class="line"></div><div class="line">proxy_max_temp_file_size</div><div class="line">å½“ proxy_buffers æ”¾ä¸ä¸‹åç«¯æœåŠ¡å™¨çš„å“åº”å†…å®¹æ—¶ï¼Œä¼šå°†ä¸€éƒ¨åˆ†ä¿å­˜åˆ°ç¡¬ç›˜çš„ä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œè¿™ä¸ªå€¼ç”¨æ¥è®¾ç½®æœ€å¤§ä¸´æ—¶æ–‡ä»¶å¤§å°ï¼Œé»˜è®¤1024Mï¼Œå®ƒä¸ proxy_cache æ²¡æœ‰å…³ç³»ã€‚å¤§äºè¿™ä¸ªå€¼ï¼Œå°†ä»upstreamæœåŠ¡å™¨ä¼ å›ã€‚è®¾ç½®ä¸º0ç¦ç”¨ã€‚</div><div class="line"></div><div class="line">proxy_temp_file_write_size 64k</div><div class="line">å½“ç¼“å­˜è¢«ä»£ç†çš„æœåŠ¡å™¨å“åº”åˆ°ä¸´æ—¶æ–‡ä»¶æ—¶ï¼Œè¿™ä¸ªé€‰é¡¹é™åˆ¶æ¯æ¬¡å†™ä¸´æ—¶æ–‡ä»¶çš„å¤§å°ã€‚proxy_temp_pathï¼ˆå¯ä»¥åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼‰æŒ‡å®šå†™åˆ°å“ªé‚£ä¸ªç›®å½•ã€‚</div><div class="line"></div><div class="line">proxy_passï¼Œproxy_redirectè§ location éƒ¨åˆ†ã€‚</div><div class="line"></div><div class="line">æ¨¡å—http_gzipï¼š</div><div class="line"></div><div class="line">gzip on : å¼€å¯gzipå‹ç¼©è¾“å‡ºï¼Œå‡å°‘ç½‘ç»œä¼ è¾“ã€‚</div><div class="line">gzip_min_length 1k ï¼š è®¾ç½®å…è®¸å‹ç¼©çš„é¡µé¢æœ€å°å­—èŠ‚æ•°ï¼Œé¡µé¢å­—èŠ‚æ•°ä»headerå¤´å¾—content-lengthä¸­è¿›è¡Œè·å–ã€‚é»˜è®¤å€¼æ˜¯20ã€‚å»ºè®®è®¾ç½®æˆå¤§äº1kçš„å­—èŠ‚æ•°ï¼Œå°äº1kå¯èƒ½ä¼šè¶Šå‹è¶Šå¤§ã€‚</div><div class="line">gzip_buffers 4 16k ï¼š è®¾ç½®ç³»ç»Ÿè·å–å‡ ä¸ªå•ä½çš„ç¼“å­˜ç”¨äºå­˜å‚¨gzipçš„å‹ç¼©ç»“æœæ•°æ®æµã€‚4 16kä»£è¡¨ä»¥16kä¸ºå•ä½ï¼Œå®‰è£…åŸå§‹æ•°æ®å¤§å°ä»¥16kä¸ºå•ä½çš„4å€ç”³è¯·å†…å­˜ã€‚</div><div class="line">gzip_http_version 1.0 ï¼š ç”¨äºè¯†åˆ« http åè®®çš„ç‰ˆæœ¬ï¼Œæ—©æœŸçš„æµè§ˆå™¨ä¸æ”¯æŒ Gzip å‹ç¼©ï¼Œç”¨æˆ·å°±ä¼šçœ‹åˆ°ä¹±ç ï¼Œæ‰€ä»¥ä¸ºäº†æ”¯æŒå‰æœŸç‰ˆæœ¬åŠ ä¸Šäº†è¿™ä¸ªé€‰é¡¹ï¼Œå¦‚æœä½ ç”¨äº† Nginx çš„åå‘ä»£ç†å¹¶æœŸæœ›ä¹Ÿå¯ç”¨ Gzip å‹ç¼©çš„è¯ï¼Œç”±äºæœ«ç«¯é€šä¿¡æ˜¯ http/1.0ï¼Œæ•…è¯·è®¾ç½®ä¸º 1.0ã€‚</div><div class="line">gzip_comp_level 6 ï¼š gzipå‹ç¼©æ¯”ï¼Œ1å‹ç¼©æ¯”æœ€å°å¤„ç†é€Ÿåº¦æœ€å¿«ï¼Œ9å‹ç¼©æ¯”æœ€å¤§ä½†å¤„ç†é€Ÿåº¦æœ€æ…¢(ä¼ è¾“å¿«ä½†æ¯”è¾ƒæ¶ˆè€—cpu)</div><div class="line">gzip_types ï¼šåŒ¹é…mimeç±»å‹è¿›è¡Œå‹ç¼©ï¼Œæ— è®ºæ˜¯å¦æŒ‡å®š,â€text/htmlâ€ç±»å‹æ€»æ˜¯ä¼šè¢«å‹ç¼©çš„ã€‚</div><div class="line">gzip_proxied any ï¼š Nginxä½œä¸ºåå‘ä»£ç†çš„æ—¶å€™å¯ç”¨ï¼Œå†³å®šå¼€å¯æˆ–è€…å…³é—­åç«¯æœåŠ¡å™¨è¿”å›çš„ç»“æœæ˜¯å¦å‹ç¼©ï¼ŒåŒ¹é…çš„å‰ææ˜¯åç«¯æœåŠ¡å™¨å¿…é¡»è¦è¿”å›åŒ…å«â€Viaâ€çš„ headerå¤´ã€‚</div><div class="line">gzip_vary on ï¼š å’Œhttpå¤´æœ‰å…³ç³»ï¼Œä¼šåœ¨å“åº”å¤´åŠ ä¸ª Vary: Accept-Encoding ï¼Œå¯ä»¥è®©å‰ç«¯çš„ç¼“å­˜æœåŠ¡å™¨ç¼“å­˜ç»è¿‡gzipå‹ç¼©çš„é¡µé¢ï¼Œä¾‹å¦‚ï¼Œç”¨Squidç¼“å­˜ç»è¿‡Nginxå‹ç¼©çš„æ•°æ®ã€‚ã€‚</div><div class="line">2.2.3 serverè™šæ‹Ÿä¸»æœº</div><div class="line"></div><div class="line">httpæœåŠ¡ä¸Šæ”¯æŒè‹¥å¹²è™šæ‹Ÿä¸»æœºã€‚æ¯ä¸ªè™šæ‹Ÿä¸»æœºä¸€ä¸ªå¯¹åº”çš„serveré…ç½®é¡¹ï¼Œé…ç½®é¡¹é‡Œé¢åŒ…å«è¯¥è™šæ‹Ÿä¸»æœºç›¸å…³çš„é…ç½®ã€‚åœ¨æä¾›mailæœåŠ¡çš„ä»£ç†æ—¶ï¼Œä¹Ÿå¯ä»¥å»ºç«‹è‹¥å¹²serverã€‚æ¯ä¸ªserveré€šè¿‡ç›‘å¬åœ°å€æˆ–ç«¯å£æ¥åŒºåˆ†ã€‚</div><div class="line"></div><div class="line">listen</div><div class="line">ç›‘å¬ç«¯å£ï¼Œé»˜è®¤80ï¼Œå°äº1024çš„è¦ä»¥rootå¯åŠ¨ã€‚å¯ä»¥ä¸ºlisten *:80ã€listen 127.0.0.1:80ç­‰å½¢å¼ã€‚</div><div class="line"></div><div class="line">server_name</div><div class="line">æœåŠ¡å™¨åï¼Œå¦‚localhostã€www.example.comï¼Œå¯ä»¥é€šè¿‡æ­£åˆ™åŒ¹é…ã€‚</div><div class="line"></div><div class="line">æ¨¡å—http_stream</div><div class="line">è¿™ä¸ªæ¨¡å—é€šè¿‡ä¸€ä¸ªç®€å•çš„è°ƒåº¦ç®—æ³•æ¥å®ç°å®¢æˆ·ç«¯IPåˆ°åç«¯æœåŠ¡å™¨çš„è´Ÿè½½å‡è¡¡ï¼Œupstreamåæ¥è´Ÿè½½å‡è¡¡å™¨çš„åå­—ï¼Œåç«¯realserverä»¥ host:port options; æ–¹å¼ç»„ç»‡åœ¨ &#123;&#125; ä¸­ã€‚å¦‚æœåç«¯è¢«ä»£ç†çš„åªæœ‰ä¸€å°ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å†™åœ¨ proxy_pass ã€‚</div><div class="line"></div><div class="line">2.2.4 location</div><div class="line"></div><div class="line">httpæœåŠ¡ä¸­ï¼ŒæŸäº›ç‰¹å®šçš„URLå¯¹åº”çš„ä¸€ç³»åˆ—é…ç½®é¡¹ã€‚</div><div class="line"></div><div class="line">root /var/www/html</div><div class="line">å®šä¹‰æœåŠ¡å™¨çš„é»˜è®¤ç½‘ç«™æ ¹ç›®å½•ä½ç½®ã€‚å¦‚æœlocationURLåŒ¹é…çš„æ˜¯å­ç›®å½•æˆ–æ–‡ä»¶ï¼Œrootæ²¡ä»€ä¹ˆä½œç”¨ï¼Œä¸€èˆ¬æ”¾åœ¨serveræŒ‡ä»¤é‡Œé¢æˆ–/ä¸‹ã€‚</div><div class="line"></div><div class="line">index index.jsp index.html index.htm</div><div class="line">å®šä¹‰è·¯å¾„ä¸‹é»˜è®¤è®¿é—®çš„æ–‡ä»¶åï¼Œä¸€èˆ¬è·Ÿç€rootæ”¾</div><div class="line"></div><div class="line">proxy_pass http:/backend</div><div class="line">è¯·æ±‚è½¬å‘backendå®šä¹‰çš„æœåŠ¡å™¨åˆ—è¡¨ï¼Œå³åå‘ä»£ç†ï¼Œå¯¹åº”upstreamè´Ÿè½½å‡è¡¡å™¨ã€‚ä¹Ÿå¯ä»¥proxy_pass http://ip:portã€‚</div><div class="line"></div><div class="line">proxy_redirect off;</div><div class="line">proxy_set_header Host <span class="variable">$host</span>;</div><div class="line">proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line">proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">è¿™å››ä¸ªæš‚ä¸”è¿™æ ·è®¾ï¼Œå¦‚æœæ·±ç©¶çš„è¯ï¼Œæ¯ä¸€ä¸ªéƒ½æ¶‰åŠåˆ°å¾ˆå¤æ‚çš„å†…å®¹ï¼Œä¹Ÿå°†é€šè¿‡å¦ä¸€ç¯‡æ–‡ç« æ¥è§£è¯»ã€‚</div></pre></td></tr></table></figure>
<h3 id="è¿™é‡Œæˆ‘è´´å‡ºæˆ‘å…¬å¸ç°åœ¨Nginxå•èŠ‚ç‚¹è´Ÿè½½å‡è¡¡ä»£ç†å¯ä»¥ä½¿ç”¨ä¸‹é¢æ ¼å¼ï¼š"><a href="#è¿™é‡Œæˆ‘è´´å‡ºæˆ‘å…¬å¸ç°åœ¨Nginxå•èŠ‚ç‚¹è´Ÿè½½å‡è¡¡ä»£ç†å¯ä»¥ä½¿ç”¨ä¸‹é¢æ ¼å¼ï¼š" class="headerlink" title="è¿™é‡Œæˆ‘è´´å‡ºæˆ‘å…¬å¸ç°åœ¨Nginxå•èŠ‚ç‚¹è´Ÿè½½å‡è¡¡ä»£ç†å¯ä»¥ä½¿ç”¨ä¸‹é¢æ ¼å¼ï¼š"></a>è¿™é‡Œæˆ‘è´´å‡ºæˆ‘å…¬å¸ç°åœ¨Nginxå•èŠ‚ç‚¹è´Ÿè½½å‡è¡¡ä»£ç†å¯ä»¥ä½¿ç”¨ä¸‹é¢æ ¼å¼ï¼š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    include       mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line"></div><div class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></div><div class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></div><div class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</div><div class="line">    access_log /var/<span class="built_in">log</span>/nginx/access.log;</div><div class="line"></div><div class="line">    sendfile        on;</div><div class="line">    <span class="comment">#tcp_nopush     on;</span></div><div class="line">    <span class="comment">#keepalive_timeout  0;</span></div><div class="line">    keepalive_timeout  65;</div><div class="line">    <span class="comment">#gzip  on;</span></div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  localhost;</div><div class="line">        location / &#123;</div><div class="line">            root   html;</div><div class="line">            index  index.html index.htm;</div><div class="line">        &#125;</div><div class="line">        error_page   500 502 503 504  /50x.html;</div><div class="line">        location = /50x.html &#123;</div><div class="line">            root   html;</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line">  upstream sentry &#123;</div><div class="line">        server  120.26.164.217:9000 weight=1;</div><div class="line"></div><div class="line"> &#125;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  sentdy.ihaozhuo.com;</div><div class="line">        location / &#123;</div><div class="line">           index        index.html index.php index.jsp index.htm;</div><div class="line">           proxy_pass           http://sentry;</div><div class="line">           proxy_ignore_client_abort on;</div><div class="line">           proxy_redirect               off;</div><div class="line">           proxy_set_header     Host    <span class="variable">$host</span>;</div><div class="line">           proxy_set_header     X-Real-IP       <span class="variable">$remote_addr</span>;</div><div class="line">           proxy_set_header     X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="è®¿é—®æ§åˆ¶-allow-deny"><a href="#è®¿é—®æ§åˆ¶-allow-deny" class="headerlink" title="è®¿é—®æ§åˆ¶ allow/deny"></a>è®¿é—®æ§åˆ¶ allow/deny</h3><p>Nginx çš„è®¿é—®æ§åˆ¶æ¨¡å—é»˜è®¤å°±ä¼šå®‰è£…ï¼Œè€Œä¸”å†™æ³•ä¹Ÿéå¸¸ç®€å•ï¼Œå¯ä»¥åˆ†åˆ«æœ‰å¤šä¸ªallow,denyï¼Œå…è®¸æˆ–ç¦æ­¢æŸä¸ªipæˆ–ipæ®µè®¿é—®ï¼Œä¾æ¬¡æ»¡è¶³ä»»ä½•ä¸€ä¸ªè§„åˆ™å°±åœæ­¢å¾€ä¸‹åŒ¹é…ã€‚å¦‚ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">location /nginx-status &#123;</div><div class="line">  stub_status on;</div><div class="line">  access_log off;</div><div class="line"><span class="comment">#  auth_basic   "NginxStatus";</span></div><div class="line"><span class="comment">#  auth_basic_user_file   /usr/local/nginx-1.6/htpasswd;</span></div><div class="line"></div><div class="line">  allow 192.168.1.100;</div><div class="line">  allow 172.29.73.0/24;</div><div class="line">  deny all;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä¹Ÿå¸¸ç”¨ httpd-devel å·¥å…·çš„ htpasswd æ¥ä¸ºè®¿é—®çš„è·¯å¾„è®¾ç½®ç™»å½•å¯†ç ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment"># htpasswd -c htpasswd admin</span></div><div class="line">New passwd:</div><div class="line">Re-type new password:</div><div class="line">Adding password <span class="keyword">for</span> user admin</div><div class="line"></div><div class="line"><span class="comment"># htpasswd htpasswd admin    //ä¿®æ”¹adminå¯†ç </span></div><div class="line"><span class="comment"># htpasswd htpasswd sean    //å¤šæ·»åŠ ä¸€ä¸ªè®¤è¯ç”¨æˆ·</span></div><div class="line">è¿™æ ·å°±ç”Ÿæˆäº†é»˜è®¤ä½¿ç”¨CRYPTåŠ å¯†çš„å¯†ç æ–‡ä»¶ã€‚æ‰“å¼€ä¸Šé¢nginx-statusçš„ä¸¤è¡Œæ³¨é‡Šï¼Œé‡å¯nginxç”Ÿæ•ˆã€‚</div></pre></td></tr></table></figure>
<p>å‚è€ƒ</p>
<ul>
<li><a href="http://liuqunying.blog.51cto.com/3984207/1420556" target="_blank" rel="external">http://liuqunying.blog.51cto.com/3984207/1420556</a></li>
<li><a href="http://nginx.org/en/docs/ngx_core_module.html#worker_cpu_affinity" target="_blank" rel="external">http://nginx.org/en/docs/ngx_core_module.html#worker_cpu_affinity</a></li>
<li><a href="http://wiki.nginx.org/HttpCoreModule#sendfile" target="_blank" rel="external">http://wiki.nginx.org/HttpCoreModule#sendfile</a></li>
</ul>

	

	

</article>




	<article>
	
		<h1><a href="/2016/05/22/WebæœåŠ¡æŠ€æœ¯/Nginx/Nginx+Keepalivedå®ç°é«˜å¯ç”¨Webè´Ÿè½½å‡è¡¡ /">Nginx+Keepalivedå®ç°é«˜å¯ç”¨Webè´Ÿè½½å‡è¡¡</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-05-22</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/nginx/">nginx</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Nginx/">Nginx</a> <a class="article__tag-link" href="/tags/Web-Service/">Web Service</a>
			</span>
		
	</div>

	

	
		<h2 id="Nginx-Keepalivedå®ç°é«˜å¯ç”¨Webè´Ÿè½½å‡è¡¡"><a href="#Nginx-Keepalivedå®ç°é«˜å¯ç”¨Webè´Ÿè½½å‡è¡¡" class="headerlink" title="Nginx+Keepalivedå®ç°é«˜å¯ç”¨Webè´Ÿè½½å‡è¡¡"></a>Nginx+Keepalivedå®ç°é«˜å¯ç”¨Webè´Ÿè½½å‡è¡¡</h2><h2 id="ä¸€ã€éœ€æ±‚åœºæ™¯ï¼š"><a href="#ä¸€ã€éœ€æ±‚åœºæ™¯ï¼š" class="headerlink" title="ä¸€ã€éœ€æ±‚åœºæ™¯ï¼š"></a>ä¸€ã€éœ€æ±‚åœºæ™¯ï¼š</h2><p>é€šè¿‡ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« ï¼š</p>
<p>Nginx+Tomcatå®ç°è´Ÿè½½å‡è¡¡,æˆ‘ä»¬å·²ç»èƒ½é€šè¿‡Nginxæ¥å®ç°Tomcatåº”ç”¨çš„è´Ÿè½½å‡è¡¡ï¼Œä½†æ˜¯å•ä¸ªçš„Nginxä¼šå­˜åœ¨å•ç‚¹éšæ‚£ï¼Œå¦‚æœNginxæŒ‚æ‰ï¼Œé‚£ä¹ˆå…¨éƒ¨çš„Tomcatåº”ç”¨éƒ½å°†å˜å¾—ä¸å¯ç”¨ï¼Œæ‰€ä»¥å®ç°Nginxçš„é«˜å¯ç”¨æ˜¯å¿…ä¸å¯å°‘çš„ä¸€æ­¥ã€‚</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/Nginx1.png" alt=""></figure></p>
<h3 id="äºŒã€è¯´æ˜"><a href="#äºŒã€è¯´æ˜" class="headerlink" title="äºŒã€è¯´æ˜"></a>äºŒã€è¯´æ˜</h3><ul>
<li>é«˜å¯ç”¨ HAï¼ˆHigh Availabilityï¼‰ï¼Œç®€å•è®²å°±æ˜¯ï¼šæˆ‘æŸä¸ªåº”ç”¨æŒ‚äº†ï¼Œè‡ªåŠ¨æœ‰å¦å¤–åº”ç”¨èµ·æ¥æ¥ç€æ‰›ç€ï¼Œè‡´ä½¿æ•´ä¸ªæœåŠ¡å¯¹å¤–æ¥çœ‹æ˜¯æ²¡æœ‰ä¸­æ–­è¿‡çš„ã€‚è¿™é‡Œçš„é‡ç‚¹å°±æ˜¯ä¸ä¸­æ–­ï¼Œè‡´ä½¿å…¬å¸æ•´ä¸ªä¸šåŠ¡èƒ½ä¸æ–­è¿›è¡Œä¸­ï¼ŒæŠŠå½±å“å‡åˆ°æœ€å°ï¼Œèµšå¾—æ›´å¤šã€‚</li>
<li><p>å› ä¸ºè¦ä¸ä¸­æ–­ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°äº† Keepalivedã€‚Keepalived ä¸€èˆ¬ä¸ä¼šå•ç‹¬ä½¿ç”¨ï¼ŒåŸºæœ¬éƒ½æ˜¯è·Ÿè´Ÿè½½å‡è¡¡è½¯ä»¶ï¼ˆLVSã€HAProxyã€Nginxï¼‰ä¸€èµ·å·¥ä½œæ¥è¾¾åˆ°é›†ç¾¤çš„é«˜å¯ç”¨æ•ˆæœã€‚</p>
</li>
<li><p>Keepalived æœ‰åŒä¸»ã€ä¸»å¤‡æ–¹æ¡ˆ</p>
</li>
<li>å¸¸ç”¨è¯ï¼š<ul>
<li>å¿ƒè·³ï¼šMaster ä¼šä¸»åŠ¨ç»™ Backup å‘é€å¿ƒè·³æ£€æµ‹åŒ…ä»¥åŠå¯¹å¤–çš„ç½‘ç»œåŠŸèƒ½ï¼Œè€Œ Backup è´Ÿè´£æ¥æ”¶ Master çš„å¿ƒè·³æ£€æµ‹åŒ…ï¼Œéšæ—¶å‡†å¤‡æ¥ç®¡ä¸»æœºã€‚ä¸ºä»€ä¹ˆå«å¿ƒè·³ä¸çŸ¥é“ï¼Œä½†æ˜¯æŒºå½¢è±¡çš„ï¼Œå¿ƒè·³åŒæ­¥ã€‚</li>
<li>é€‰ä¸¾ï¼šKeepalived é…ç½®çš„æ—¶å€™å¯ä»¥æŒ‡å®šå„å°ä¸»æœºä¼˜å…ˆçº§ï¼ŒMaster æŒ‚äº†ï¼Œå„å° Backup è¦é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„ Masterã€‚</li>
</ul>
</li>
<li>Keepalived<ul>
<li>å®˜ç½‘ï¼š<a href="http://www.keepalived.org/" target="_blank" rel="external">http://www.keepalived.org/</a></li>
<li>å®˜ç½‘ä¸‹è½½ï¼š<a href="http://www.keepalived.org/download.html" target="_blank" rel="external">http://www.keepalived.org/download.html</a></li>
<li>å®˜ç½‘æ–‡æ¡£ï¼š<a href="http://www.keepalived.org/documentation.html" target="_blank" rel="external">http://www.keepalived.org/documentation.html</a></li>
</ul>
</li>
</ul>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/Nginx1.png" alt=""></figure></p>
<h3 id="ä¸‰ã€æ­å»º"><a href="#ä¸‰ã€æ­å»º" class="headerlink" title="ä¸‰ã€æ­å»º"></a>ä¸‰ã€æ­å»º</h3><ul>
<li><p>è½¯ä»¶ç‰ˆæœ¬ï¼š</p>
<ul>
<li>Nginxï¼š<strong>1.8.1</strong></li>
<li>Keepalivedï¼š<strong>1.2.20</strong></li>
<li>JDKï¼š<strong>8u72</strong></li>
<li>Tomcatï¼š<strong>8.0.32</strong></li>
</ul>
</li>
<li><p>éƒ¨ç½²ç¯å¢ƒï¼ˆä¸‹æ–‡ä¸­ä»¥ç¬¬å‡ å°æ¥ä»£è¡¨è¿™äº›ä¸»æœºï¼‰ï¼š</p>
<ul>
<li>è™šæ‹Ÿ IPï¼ˆVIPï¼‰ï¼š192.168.1.50</li>
<li>ç¬¬ä¸€å°ä¸»æœºï¼šNginx 1 + Keepalived 1 == 192.168.1.120ï¼ˆMasterï¼‰</li>
<li>ç¬¬äºŒå°ä¸»æœºï¼šNginx 2 + Keepalived 2 == 192.168.1.121ï¼ˆBackup)</li>
<li>ç¬¬ä¸‰å°ä¸»æœºï¼šTomcat 1 == 192.168.1.122ï¼ˆWeb 1ï¼‰</li>
<li>ç¬¬å››å°ä¸»æœºï¼šTomcat 2 == 192.168.1.123ï¼ˆWeb 2ï¼‰</li>
</ul>
</li>
</ul>
<ul>
<li>æ‰€æœ‰æœºå­è¿›è¡Œæ—¶é—´æ ¡å‡†ï¼š<a href="NTP.md">NTPï¼ˆNetwork Time Protocolï¼‰ä»‹ç»</a></li>
<li>ç¬¬ä¸‰ã€ç¬¬å››å°ä¸»æœºéƒ¨ç½²ï¼š<ul>
<li>JDK çš„å®‰è£…ï¼š<a href="JDK-Install.md">JDK å®‰è£…</a></li>
<li>Tomcat çš„å®‰è£…ï¼š<a href="Tomcat-Install-And-Settings.md">Tomcat å®‰è£…å’Œé…ç½®ã€ä¼˜åŒ–</a></li>
</ul>
</li>
<li>ç¬¬ä¸€ã€äºŒå°ä¸»æœºéƒ¨ç½²ï¼ˆä¸¤å°éƒ¨ç½²å†…å®¹ä¸€æ ·ï¼‰ï¼š<ul>
<li>Nginx çš„å®‰è£…ï¼š<a href="Nginx-Install-And-Settings.md">Nginx å®‰è£…å’Œé…ç½®</a></li>
</ul>
</li>
</ul>
<h4 id="å››ã€Keepalivedå®‰è£…"><a href="#å››ã€Keepalivedå®‰è£…" class="headerlink" title="å››ã€Keepalivedå®‰è£…"></a>å››ã€Keepalivedå®‰è£…</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">å®‰è£…ä¾èµ–ï¼š</div><div class="line"><span class="comment"># sudo yum install -y gcc openssl-devel popt-devel</span></div><div class="line"></div><div class="line">ä¸Šä¼ æˆ–ä¸‹è½½ keepalived &amp; è§£å‹åŒ…ï¼š<span class="built_in">cd</span> /opt/setups/; </div><div class="line"><span class="comment"># tar zxvf keepalived-1.2.20.tar.gz</span></div><div class="line"></div><div class="line">ç¼–è¯‘ï¼š</div><div class="line"><span class="comment"># cd /opt/setups/keepalived-1.2.20 ; </span></div><div class="line"><span class="comment"># ./configure --prefix=/usr/local/keepalived</span></div><div class="line"></div><div class="line">ç¼–è¯‘å®‰è£…ï¼š</div><div class="line"><span class="comment"># make &amp;&amp; make install</span></div><div class="line"></div><div class="line">Keepalived è®¾ç½®æœåŠ¡å’Œéšæœºå¯åŠ¨å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°å¯åŠ¨è„šæœ¬ç›®å½•ï¼š</div><div class="line"><span class="comment"># cp /usr/program/keepalived/etc/rc.d/init.d/keepalived /etc/init.d/keepalived</span></div><div class="line"><span class="comment"># cp /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/</span></div><div class="line"><span class="comment"># ln -s /usr/local/sbin/keepalived /usr/sbin/</span></div><div class="line"><span class="comment"># ln -s /usr/local/keepalived/sbin/keepalived /sbin/</span></div><div class="line"></div><div class="line">è®¾ç½®keepalivedæœåŠ¡å¼€æœºå¯åŠ¨ï¼š </div><div class="line"><span class="comment"># chkconfig keepalived on</span></div><div class="line"></div><div class="line">å¢åŠ æƒé™</div><div class="line"><span class="comment"># chmod +x /etc/init.d/keepalived</span></div></pre></td></tr></table></figure>
<h3 id="Keepalived-é…ç½®"><a href="#Keepalived-é…ç½®" class="headerlink" title="Keepalived é…ç½®"></a>Keepalived é…ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">æ·»åŠ ç¯å¢ƒå˜é‡ï¼švim /etc/profile</div><div class="line">KEEPALIVED_HOME=/usr/<span class="built_in">local</span>/keepalived</div><div class="line">PATH=<span class="variable">$PATH</span>:<span class="variable">$KEEPALIVED_HOME</span>/sbin</div><div class="line"><span class="built_in">export</span> KEEPALIVED_HOME</div><div class="line"><span class="built_in">export</span> PATH</div></pre></td></tr></table></figure>
<ul>
<li>åˆ·æ–°ç¯å¢ƒå˜é‡ï¼š<code>source /etc/profile</code></li>
<li>æ£€æµ‹ç¯å¢ƒå˜é‡ï¼š<code>keepalived -v</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">vim /usr/<span class="built_in">local</span>/keepalived/etc/sysconfig/keepalived</div><div class="line">æŠŠ 14 è¡Œçš„ï¼šKEEPALIVED_OPTIONS=<span class="string">"-D"</span>ï¼Œæ”¹ä¸ºï¼š</div><div class="line">KEEPALIVED_OPTIONS=<span class="string">"-D -f /usr/local/keepalived/etc/keepalived/keepalived.conf"</span></div></pre></td></tr></table></figure>
<p>ç¬¬ä¸€ã€äºŒå°ä¸»æœºé…ç½®ï¼ˆä¸¤å°åœ¨ Keepalived é…ç½®ä¸Šç¨å¾®æœ‰ä¸ä¸€æ ·ï¼‰ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">å¥åº·ç›‘æµ‹è„šæœ¬ï¼ˆæˆ‘ä¸ªäººæ”¾åœ¨ï¼š/opt/bash ç›®å½•ä¸‹ï¼‰ï¼š[nginx_check.sh](Keepalived-Settings/nginx_check.sh)</div><div class="line"></div><div class="line">å¥åº·ç›‘æµ‹è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™ï¼š</div><div class="line">chmod 755 /opt/bash/nginx_check.sh</div><div class="line"></div><div class="line">è¿è¡Œç›‘æµ‹è„šæœ¬ï¼Œçœ‹ä¸‹æ˜¯å¦æœ‰é—®é¢˜ï¼š</div><div class="line">sh /opt/bash/nginx_check.shï¼Œå¦‚æœæ²¡æœ‰æŠ¥é”™ï¼Œåˆ™è¡¨ç¤ºæ”¹è„šæœ¬æ²¡æœ‰é—®é¢˜.</div><div class="line"></div><div class="line">è¿™ä¸ªè„šæœ¬å¾ˆé‡è¦ï¼Œå¦‚æœè„šæœ¬æ²¡æ³•ç”¨ï¼Œåœ¨å¯ç”¨ Keepalived çš„æ—¶å€™å¯èƒ½ä¼šæŠ¥ï¼šKeepalived_vrrp[5684]: pid 5959 exited with status 1</div></pre></td></tr></table></figure>
<p>nginx é…ç½®ï¼ˆä¸¤å°ä¸€æ ·é…ç½®ï¼‰ï¼š</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</div><div class="line">   </div><div class="line">   <span class="section">events</span> &#123;</div><div class="line">       <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="section">http</span> &#123;</div><div class="line">       <span class="attribute">include</span>       mime.types;</div><div class="line">       <span class="attribute">default_type</span>  application/octet-stream;</div><div class="line">   </div><div class="line">       <span class="attribute">sendfile</span>        <span class="literal">on</span>;</div><div class="line">       <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</div><div class="line">       </div><div class="line">       <span class="comment"># ï¼ˆé‡ç‚¹ï¼‰</span></div><div class="line">       <span class="attribute">upstream</span> tomcatCluster &#123;</div><div class="line">           <span class="attribute">server</span> <span class="number">192.168.1.122:8080</span> weight=<span class="number">1</span>;</div><div class="line">           <span class="attribute">server</span> <span class="number">192.168.1.123:8080</span> weight=<span class="number">1</span>;</div><div class="line">       &#125;</div><div class="line">       </div><div class="line">       <span class="comment"># ï¼ˆé‡ç‚¹ï¼‰</span></div><div class="line">       <span class="section">server</span> &#123;</div><div class="line">           <span class="attribute">listen</span>       <span class="number">80</span>;</div><div class="line">           <span class="attribute">server_name</span>  <span class="number">192.168.1.50</span>;</div><div class="line">   </div><div class="line">           <span class="attribute">location</span> / &#123;</div><div class="line">               <span class="attribute">proxy_pass</span>   http://tomcatCluster;</div><div class="line">               <span class="attribute">index</span>  index.html index.htm;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="4-1-ä¿®æ”¹keepalivedé…ç½®æ–‡ä»¶"><a href="#4-1-ä¿®æ”¹keepalivedé…ç½®æ–‡ä»¶" class="headerlink" title="4.1 ä¿®æ”¹keepalivedé…ç½®æ–‡ä»¶"></a>4.1 ä¿®æ”¹keepalivedé…ç½®æ–‡ä»¶</h3><p>cat /etc/init.d/keepalived</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">! Configuration File <span class="keyword">for</span> keepalivedglobal_defs &#123;</div><div class="line">keepalived è‡ªå¸¦çš„é‚®ä»¶æé†’éœ€è¦å¼€å¯ sendmail æœåŠ¡ã€‚å»ºè®®ç”¨ç‹¬ç«‹çš„ç›‘æ§æˆ–ç¬¬ä¸‰æ–¹ SMTP</div><div class="line">router_id edu-proxy-01 <span class="comment">## æ ‡è¯†æœ¬èŠ‚ç‚¹çš„å­—æ¡ä¸²,é€šå¸¸ä¸º hostname &#125;</span></div><div class="line"></div><div class="line">keepalived ä¼šå®šæ—¶æ‰§è¡Œè„šæœ¬å¹¶å¯¹è„šæœ¬æ‰§è¡Œçš„ç»“æœè¿›è¡Œåˆ†æ,åŠ¨æ€è°ƒæ•´ vrrp_instance çš„ä¼˜å…ˆçº§ã€‚å¦‚æœ è„šæœ¬æ‰§è¡Œç»“æœä¸º 0,å¹¶ä¸” weight é…ç½®çš„å€¼å¤§äº 0,åˆ™ä¼˜å…ˆçº§ç›¸åº”çš„å¢åŠ ã€‚å¦‚æœè„šæœ¬æ‰§è¡Œç»“æœé 0,å¹¶ä¸” weight é…ç½®çš„å€¼å°äº 0,åˆ™ä¼˜å…ˆçº§ç›¸åº”çš„å‡å°‘ã€‚å…¶ä»–æƒ…å†µ,ç»´æŒåŸæœ¬é…ç½®çš„ä¼˜å…ˆçº§,å³é…ç½®æ–‡ä»¶ä¸­ priority å¯¹åº” çš„å€¼ã€‚</div><div class="line"></div><div class="line">vrrp_script chk_nginx &#123;script <span class="string">"/etc/keepalived/nginx_check.sh"</span> </div><div class="line"></div><div class="line">interval 2 <span class="comment">## æ£€æµ‹æ—¶é—´é—´éš”weight -20 ## å¦‚æœæ¡ä»¶æˆç«‹,æƒé‡-20&#125;</span></div><div class="line">æ£€æµ‹ nginx çŠ¶æ€çš„è„šæœ¬è·¯å¾„</div><div class="line">å®šä¹‰è™šæ‹Ÿè·¯ç”±,VI_1 ä¸ºè™šæ‹Ÿè·¯ç”±çš„æ ‡ç¤ºç¬¦,è‡ªå·±å®šä¹‰åç§°</div><div class="line"></div><div class="line">vrrp_instance VI_1 &#123;state MASTER </div><div class="line"></div><div class="line"><span class="comment">## ä¸»èŠ‚ç‚¹ä¸º MASTER,å¯¹åº”çš„å¤‡ä»½èŠ‚ç‚¹ä¸º BACKUPinterface eth1 </span></div><div class="line"><span class="comment">## ç»‘å®šè™šæ‹Ÿ IP çš„ç½‘ç»œæ¥å£,ä¸æœ¬æœº IP åœ°å€æ‰€åœ¨çš„ç½‘ç»œæ¥å£ç›¸åŒ,æˆ‘çš„æ˜¯ eth1 virtual_router_id 51 </span></div><div class="line"><span class="comment">## è™šæ‹Ÿè·¯ç”±çš„ ID å·,ä¸¤ä¸ªèŠ‚ç‚¹è®¾ç½®å¿…é¡»ä¸€æ ·,å¯é€‰ IP æœ€åä¸€æ®µä½¿ç”¨, ç›¸åŒçš„ VRID ä¸ºä¸€ä¸ªç»„,ä»–å°†å†³å®šå¤šæ’­çš„ MAC åœ°å€ï¼Œeth1å€¼çš„è·å–å¯ä»¥åœ¨æœºå™¨ä¸Šæ‰§è¡Œifconfigå‘½ä»¤å¾—åˆ°mcast_src_ip 192.168.1.51</span></div><div class="line"><span class="comment">## æœ¬æœº IP åœ°å€priority 100 </span></div><div class="line"><span class="comment">## èŠ‚ç‚¹ä¼˜å…ˆçº§,å€¼èŒƒå›´ 0-254,MASTER è¦æ¯” BACKUP é«˜ nopreempt </span></div><div class="line"><span class="comment">## ä¼˜å…ˆçº§é«˜çš„è®¾ç½® nopreempt è§£å†³å¼‚å¸¸æ¢å¤åå†æ¬¡æŠ¢å çš„é—®é¢˜ advert_int 1 </span></div><div class="line"><span class="comment">## ç»„æ’­ä¿¡æ¯å‘é€é—´éš”,ä¸¤ä¸ªèŠ‚ç‚¹è®¾ç½®å¿…é¡»ä¸€æ ·,é»˜è®¤ 1s </span></div><div class="line"><span class="comment">## è®¾ç½®éªŒè¯ä¿¡æ¯,ä¸¤ä¸ªèŠ‚ç‚¹å¿…é¡»ä¸€è‡´authentication &#123; auth_type PASSauth_pass 1111 </span></div><div class="line"><span class="comment">## çœŸå®ç”Ÿäº§,æŒ‰éœ€æ±‚å¯¹åº”è¯¥è¿‡æ¥ &#125;</span></div><div class="line">å°† track_script å—åŠ å…¥ instance é…ç½®å—.</div><div class="line">track_script &#123;chk_nginx </div><div class="line"><span class="comment">## æ‰§è¡Œ Nginx ç›‘æ§çš„æœåŠ¡&#125;</span></div><div class="line">è™šæ‹Ÿ IP æ± , ä¸¤ä¸ªèŠ‚ç‚¹è®¾ç½®å¿…é¡»ä¸€æ ·</div><div class="line">virtual_ipaddress &#123;192.168.1.50 </div><div class="line"><span class="comment">## è™šæ‹Ÿ ip,å¯ä»¥å®šä¹‰å¤šä¸ª&#125; &#125;</span></div></pre></td></tr></table></figure>
<p>Keepalived é…ç½®æ–‡ä»¶ç¼–è¾‘ï¼ˆç¬¬ä¸€ã€äºŒå°é…ç½®ç¨å¾®ä¸åŒï¼Œä¸åŒç‚¹å…·ä½“çœ‹ä¸‹é¢é‡ç‚¹è¯´æ˜ï¼‰</p>
<p>ç¼–è¾‘ï¼š<code>vim /usr/local/keepalived/etc/keepalived/keepalived.conf</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">! Configuration File for keepalived   </div><div class="line">    # å…¨å±€é…ç½®</div><div class="line">    global_defs &#123;</div><div class="line">    # é‚®ç®±é€šçŸ¥é…ç½®ï¼Œkeepalived åœ¨å‘ç”Ÿåˆ‡æ¢æ—¶éœ€è¦å‘é€ email åˆ°çš„å¯¹è±¡ï¼Œä¸€è¡Œä¸€ä¸ª</div><div class="line">    	notification_email &#123;</div><div class="line">    	#acassen@firewall.loc</div><div class="line">    	#failover@firewall.loc</div><div class="line">    	#sysadmin@firewall.loc</div><div class="line">    	&#125;</div><div class="line">    	# æŒ‡å®šå‘ä»¶äºº</div><div class="line">    	#notification_email_from Alexandre.Cassen@firewall.loc</div><div class="line">    	# æŒ‡å®šsmtpæœåŠ¡å™¨åœ°å€</div><div class="line">    	#smtp_server 192.168.200.1</div><div class="line">    	# æŒ‡å®šsmtpè¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•ä½ç§’</div><div class="line">    	#smtp_connect_timeout 30</div><div class="line">    	</div><div class="line">    	router_id LVS_DEVEL</div><div class="line">    	vrrp_skip_check_adv_addr</div><div class="line">    	vrrp_strict</div><div class="line">&#125;</div><div class="line">    </div><div class="line">    # ï¼ˆé‡ç‚¹ï¼‰è„šæœ¬ç›‘æ§å®ç°</div><div class="line">    vrrp_script check_nginx &#123;</div><div class="line">    # è¿è¡Œè„šæœ¬</div><div class="line">    	script "/opt/bash/nginx_check.sh"</div><div class="line">    # æ—¶é—´é—´éš”ï¼Œ2ç§’</div><div class="line">    interval 2</div><div class="line">    # æƒé‡</div><div class="line">    weight 2</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    vrrp_instance VI_1 &#123;</div><div class="line">    # ï¼ˆé‡ç‚¹ï¼‰Backup æœºå­è¿™é‡Œæ˜¯è®¾ç½®ä¸ºï¼šBACKUP</div><div class="line">    state MASTER</div><div class="line">    interface eth0</div><div class="line">    virtual_router_id 51</div><div class="line">    # ï¼ˆé‡ç‚¹ï¼‰Backup æœºå­è¦å°äºå½“å‰ Master è®¾ç½®çš„ 100ï¼Œå»ºè®®è®¾ç½®ä¸º 99</div><div class="line">    priority 100</div><div class="line">    # Master ä¸ Backup è´Ÿè½½å‡è¡¡å™¨ä¹‹é—´åŒæ­¥æ£€æŸ¥çš„æ—¶é—´é—´éš”ï¼Œå•ä½æ˜¯ç§’</div><div class="line">    advert_int 1</div><div class="line">    authentication &#123;</div><div class="line">    auth_type PASS</div><div class="line">    auth_pass 1111</div><div class="line">    &#125;</div><div class="line">    	</div><div class="line">    	# ï¼ˆé‡ç‚¹ï¼‰é…ç½®è™šæ‹Ÿ IP åœ°å€ï¼Œå¦‚æœæœ‰å¤šä¸ªåˆ™ä¸€è¡Œä¸€ä¸ª</div><div class="line">    	virtual_ipaddress &#123;</div><div class="line">    		192.168.1.50</div><div class="line">    	&#125;</div><div class="line">    	</div><div class="line">    	# ï¼ˆé‡ç‚¹ï¼‰è„šæœ¬ç›‘æ§è°ƒç”¨</div><div class="line">    	track_script &#123;</div><div class="line">    		check_nginx</div><div class="line">    	&#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="é™„å½•ï¼š"><a href="#é™„å½•ï¼š" class="headerlink" title="é™„å½•ï¼š"></a>é™„å½•ï¼š</h3><p>192.168.31.146ï¼ˆMASTERèŠ‚ç‚¹ï¼‰çš„keepalived.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">! Configuration File <span class="keyword">for</span> keepalived</div><div class="line">global_defs &#123;</div><div class="line">   router_id dreyer-zk-03</div><div class="line">&#125;</div><div class="line">vrrp_script chk_nginx &#123;</div><div class="line">    script <span class="string">"/etc/keepalived/nginx_check.sh"</span></div><div class="line">    interval 2</div><div class="line">    weight -20</div><div class="line">&#125;</div><div class="line">vrrp_instance VI_1 &#123;</div><div class="line">    state MASTER</div><div class="line">    interface eth0</div><div class="line">    virtual_router_id 146</div><div class="line">    mcast_src_ip 192.168.1.120</div><div class="line">    priority 100</div><div class="line">    nopreempt</div><div class="line">    advert_int 1</div><div class="line">    authentication &#123;</div><div class="line">        auth_type PASS</div><div class="line">        auth_pass 1111</div><div class="line">    &#125;</div><div class="line">    track_script &#123;</div><div class="line">        chk_nginx</div><div class="line">    &#125;</div><div class="line">    virtual_ipaddress &#123;</div><div class="line">        192.168.31.111</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>192.168.31.154ï¼ˆBACKUPèŠ‚ç‚¹ï¼‰çš„keepalived.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">! Configuration File <span class="keyword">for</span> keepalived</div><div class="line">global_defs &#123;</div><div class="line">   router_id dreyer-zk-01</div><div class="line">&#125;</div><div class="line">vrrp_script chk_nginx &#123;</div><div class="line">    script <span class="string">"/etc/keepalived/nginx_check.sh"</span></div><div class="line">    interval 2</div><div class="line">    weight -20</div><div class="line">&#125;</div><div class="line">vrrp_instance VI_1 &#123;</div><div class="line">    state BACKUP</div><div class="line">    interface eth0</div><div class="line">    virtual_router_id 146</div><div class="line">    mcast_src_ip 192.168.1.121</div><div class="line">    priority 90</div><div class="line">    advert_int 1</div><div class="line">    authentication &#123;</div><div class="line">        auth_type PASS</div><div class="line">        auth_pass 1111</div><div class="line">    &#125;</div><div class="line">    track_script &#123;</div><div class="line">        chk_nginx</div><div class="line">    &#125;</div><div class="line">    virtual_ipaddress &#123;</div><div class="line">        192.168.31.111</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="nginx-check-shï¼ˆNginxçŠ¶æ€æ£€æµ‹è„šæœ¬ï¼‰"><a href="#nginx-check-shï¼ˆNginxçŠ¶æ€æ£€æµ‹è„šæœ¬ï¼‰" class="headerlink" title="nginx_check.shï¼ˆNginxçŠ¶æ€æ£€æµ‹è„šæœ¬ï¼‰"></a>nginx_check.shï¼ˆNginxçŠ¶æ€æ£€æµ‹è„šæœ¬ï¼‰</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">A=ps -C nginx â€“no-header |wc -lif [ <span class="variable">$A</span> <span class="_">-eq</span> 0 ];<span class="keyword">then</span></div><div class="line">    /usr/<span class="built_in">local</span>/nginx/sbin/nginx</div><div class="line">    sleep 2</div><div class="line">    <span class="keyword">if</span> [ps -C nginx --no-header |wc <span class="_">-l</span><span class="_">-eq</span> 0 ];<span class="keyword">then</span></div><div class="line">        killall keepalived</div><div class="line">    <span class="keyword">fi</span></div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure>
<p>è„šæœ¬å¤§æ„ä¸ºï¼šæ£€æŸ¥æ˜¯å¦æœ‰nginxè¿›ç¨‹ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆå°±å¯åŠ¨nginxï¼Œå¯åŠ¨åç¡çœ 2ç§’ï¼Œå†æ£€æŸ¥æ˜¯å¦æœ‰nginxçš„è¿›ç¨‹ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œé‚£ä¹ˆå°±æ€æ‰keepalivedçš„å…¨éƒ¨è¿›ç¨‹ï¼ˆæ€æ‰è¿›ç¨‹åkeepalivedæ‰èƒ½è¿›è¡Œé‡æ–°é€‰ä¸¾ï¼‰</p>
<h3 id="å¯åŠ¨å„è‡ªæœåŠ¡"><a href="#å¯åŠ¨å„è‡ªæœåŠ¡" class="headerlink" title="å¯åŠ¨å„è‡ªæœåŠ¡"></a>å¯åŠ¨å„è‡ªæœåŠ¡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">å››å°æœºå­éƒ½åœæ‰é˜²ç«å¢™ï¼šservice iptables stop</div><div class="line"></div><div class="line">å…ˆå¯åŠ¨ä¸¤å° Tomcatï¼š</div><div class="line"></div><div class="line">sh /usr/program/tomcat8/bin/startup.sh </div><div class="line">tail -200f /usr/program/tomcat8/logs/catalina.out</div><div class="line"></div><div class="line">æ£€æŸ¥ä¸¤å° Tomcat æ˜¯å¦å¯ä»¥å•ç‹¬è®¿é—®ï¼Œæœ€å¥½ç»™é¦–é¡µåŠ ä¸Šä¸åŒæ ‡è¯†ï¼Œå¥½æ–¹ä¾¿ç­‰ä¸‹ç¡®è®¤æ˜¯å¦æœ‰è´Ÿè½½.</div><div class="line">    </div><div class="line">   http://192.168.1.122:8080</div><div class="line">	 http://192.168.1.123:8080</div><div class="line"></div><div class="line">å¯åŠ¨ä¸¤å° Nginx æœåŠ¡ï¼š/usr/<span class="built_in">local</span>/nginx/sbin/nginx </div><div class="line">å¯åŠ¨ä¸¤å° Keepalived æœåŠ¡ï¼šservice keepalived start</div><div class="line"></div><div class="line">æŸ¥çœ‹ Master å’Œ Backup ä¸¤å°ä¸»æœºçš„å¯¹åº”æ—¥å¿—ï¼š</div><div class="line">tail <span class="_">-f</span> /var/<span class="built_in">log</span>/messages</div></pre></td></tr></table></figure>
<h3 id="é«˜å¯ç”¨æµ‹è¯•"><a href="#é«˜å¯ç”¨æµ‹è¯•" class="headerlink" title="é«˜å¯ç”¨æµ‹è¯•"></a>é«˜å¯ç”¨æµ‹è¯•</h3><h3 id="æ¨¡æ‹Ÿ-Keepalived-æŒ‚æ‰"><a href="#æ¨¡æ‹Ÿ-Keepalived-æŒ‚æ‰" class="headerlink" title="æ¨¡æ‹Ÿ Keepalived æŒ‚æ‰"></a>æ¨¡æ‹Ÿ Keepalived æŒ‚æ‰</h3><p>å…³é—­Masterä¸»æœºçš„Keepalivedï¼ŒæŸ¥çœ‹ <code>Master</code> å’Œ <code>Backup</code>ä¸¤å°ä¸»æœºçš„å¯¹åº”æ—¥å¿—ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tail <span class="_">-f</span> /var/<span class="built_in">log</span>/messages</div></pre></td></tr></table></figure>
<p>å…³é—­æœåŠ¡ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service keepalived stop</div></pre></td></tr></table></figure>
<p>å¦‚æœç¬¬äºŒå°æœºæ¥ç®¡äº†ï¼Œåˆ™è¡¨ç¤ºæˆåŠŸ<br>é‡æ–°å¼€å¯ Master ä¸»æœºçš„ Keepalivedï¼ŒæŸ¥çœ‹ Master å’Œ Backup ä¸¤å°ä¸»æœºçš„å¯¹åº”æ—¥å¿—ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tail <span class="_">-f</span> /var/<span class="built_in">log</span>/messages</div></pre></td></tr></table></figure>
<p>é‡å¯æœåŠ¡ï¼š<code>service keepalived restart</code></p>
<ul>
<li>å¦‚æœç¬¬ä¸€å°æœºé‡æ–°æ¥ç®¡äº†ï¼Œåˆ™è¡¨ç¤ºæˆåŠŸ</li>
<li>æ¨¡æ‹Ÿ Nginx æŒ‚æ‰</li>
<li>å…³é—­ Master ä¸»æœºçš„ Nginxï¼ŒæŸ¥çœ‹ Master å’Œ Backup ä¸¤å°ä¸»æœºçš„å¯¹åº”æ—¥å¿—ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tail <span class="_">-f</span> /var/<span class="built_in">log</span>/messages</div></pre></td></tr></table></figure>
<p>å…³é—­æœåŠ¡ï¼š<code>/usr/local/nginx/sbin/nginx -s stop</code><br>å¦‚æœç¬¬äºŒå°æœºæ¥ç®¡äº†ï¼Œåˆ™è¡¨ç¤ºæˆåŠŸ<br>é‡æ–°å¼€å¯ Master ä¸»æœºçš„ Nginxï¼ŒæŸ¥çœ‹ Master å’Œ Backup ä¸¤å°ä¸»æœºçš„å¯¹åº”æ—¥å¿—ï¼š </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tail -f /var/log/messages</div></pre></td></tr></table></figure>
<ul>
<li>é‡å¯ Nginx æœåŠ¡ï¼š<code>/usr/local/nginx/sbin/nginx -s reload</code></li>
<li>é‡å¯ Keepalived æœåŠ¡ï¼š<code>service keepalived restart</code></li>
<li>å¦‚æœç¬¬ä¸€å°æœºé‡æ–°æ¥ç®¡äº†ï¼Œåˆ™è¡¨ç¤ºæˆåŠŸ</li>
<li>å¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ï¼Œæ”¹ä¸ºåŒä¸»çƒ­å¤‡ï¼Œç›‘æ§è„šæœ¬ä¸Šå¸¦æœ‰è‡ªå¯åŠ¨ç›¸å…³ç»†èŠ‚ï¼Œåç»­å†è¿›è¡Œã€‚</li>
<li><p>æ—¥å¿—ä¸­å¸¸ç”¨çš„å‡ å¥è¯è§£é‡Šï¼š</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- `Entering to MASTER STATE`ï¼Œå˜æˆ Master çŠ¶æ€</div><div class="line">	- `Netlink reflector reports IP 192.168.1.50 added`ï¼Œä¸€èˆ¬å˜ä¸º Master çŠ¶æ€ï¼Œéƒ½è¦é‡æ–°åŠ å…¥è™šæ‹Ÿ IPï¼Œä¸€èˆ¬å«æ³•å«åšï¼šè™šæ‹Ÿ IP é‡æ–°æ¼‚ç§»åˆ° Master æœºå­ä¸Š</div><div class="line">- `Entering BACKUP STATE`ï¼Œå˜æˆ Backup çŠ¶æ€</div><div class="line">	- `Netlink reflector reports IP 192.168.1.50 removed`ï¼Œä¸€èˆ¬å˜ä¸º Backup çŠ¶æ€ï¼Œéƒ½è¦ç§»å‡ºè™šæ‹Ÿ IPï¼Œä¸€èˆ¬å«æ³•å«åšï¼šè™šæ‹Ÿ IP é‡æ–°æ¼‚ç§»åˆ° Master æœºå­ä¸Š</div><div class="line">- `VRRP_Script(check_nginx) succeeded`ï¼Œç›‘æ§è„šæœ¬æ‰§è¡ŒæˆåŠŸ</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="èµ„æ–™"><a href="#èµ„æ–™" class="headerlink" title="èµ„æ–™"></a>èµ„æ–™</h2><ul>
<li><a href="http://xutaibao.blog.51cto.com/7482722/1669123" target="_blank" rel="external">http://xutaibao.blog.51cto.com/7482722/1669123</a></li>
<li><a href="https://m.oschina.net/blog/301710" target="_blank" rel="external">https://m.oschina.net/blog/301710</a></li>
<li><a href="http://blog.csdn.net/u010028869/article/details/50612571" target="_blank" rel="external">http://blog.csdn.net/u010028869/article/details/50612571</a></li>
<li><a href="http://blog.csdn.net/wanglei_storage/article/details/51175418" target="_blank" rel="external">http://blog.csdn.net/wanglei_storage/article/details/51175418</a></li>
</ul>

	

	

</article>




	<article>
	
		<h1><a href="/2016/04/05/WebæœåŠ¡æŠ€æœ¯/Nginx/Nginx å®‰å…¨&amp;ä¼˜åŒ–&amp;æ—¥å¿—è¾“å‡ºè§„èŒƒè¯¦ç»†é…ç½®/">Nginx å®‰å…¨&amp;ä¼˜åŒ–&amp;æ—¥å¿—è¾“å‡ºè§„èŒƒè¯¦ç»†é…ç½®</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-04-05</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/Nginx/">Nginx</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Nginx/">Nginx</a> <a class="article__tag-link" href="/tags/Web-Service/">Web Service</a>
			</span>
		
	</div>

	

	
		<p>##1.Nginxæ—¥å¿—å®¡è®¡</p>
<h4 id="â‘ -å‚è€ƒé…ç½®æ“ä½œ"><a href="#â‘ -å‚è€ƒé…ç½®æ“ä½œ" class="headerlink" title="â‘  å‚è€ƒé…ç½®æ“ä½œ"></a>â‘  å‚è€ƒé…ç½®æ“ä½œ</h4><p><strong>(1)ç¼–è¾‘ nginx.conf é…ç½®æ–‡ä»¶</strong></p>
<p>å°† error_log å‰çš„â€œ#â€å»æ‰ï¼Œè®°å½•é”™è¯¯æ—¥å¿—<br>å°† access_log å‰çš„â€œ#â€å»æ‰ï¼Œè®°å½•è®¿é—®æ—¥å¿—<br>(2)è®¾ç½® access_logï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">log_format formatname <span class="string">'$remote_addr - $remote_user [$time_local] '</span></div><div class="line"><span class="string">' "$request" $status $body_bytes_sent "$http_referer" '</span></div><div class="line"><span class="string">' "$http_user_agent" "$http_x_forwarded_for"'</span>; access_log</div><div class="line">logs/access.log formantname;      <span class="comment">#formatname æ˜¯è®¾ç½®é…ç½®æ–‡ä»¶æ ¼å¼çš„åç§°</span></div></pre></td></tr></table></figure>
<h4 id="â‘¡-å¤‡æ³¨äº‹é¡¹"><a href="#â‘¡-å¤‡æ³¨äº‹é¡¹" class="headerlink" title="â‘¡  å¤‡æ³¨äº‹é¡¹"></a>â‘¡  å¤‡æ³¨äº‹é¡¹</h4><p>æŸ¥çœ‹ nginx.conf é…ç½®æ–‡ä»¶ä¸­ï¼Œerror_logã€access_log å‰çš„â€œ#â€æ˜¯å¦å»æ‰<br>0x02 æœåŠ¡<br>1  é™åˆ¶ IP è®¿é—®<br>å¯¹ç½‘ç«™æˆ–æ•æ„Ÿç›®å½•çš„è®¿é—® IP è¿›è¡Œé™åˆ¶<br>â‘  å‚è€ƒé…ç½®æ“ä½œ<br>(1)ä¿®æ”¹é…ç½®æ–‡ä»¶</p>
<pre><code>vi /usr/local/nginx/conf/nginx.conf
</code></pre><p>å…·ä½“è®¾ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">deny 192.168.1.1; <span class="comment">#æ‹’ç» IP</span></div><div class="line">allow 192.168.1.0/24; <span class="comment">#å…è®¸ IP</span></div><div class="line">allow 10.1.1.0/16; <span class="comment">#å…è®¸ IP</span></div><div class="line">deny all; <span class="comment">#æ‹’ç»å…¶ä»–æ‰€æœ‰ IP</span></div></pre></td></tr></table></figure>
<p><strong>(2)é‡æ–°å¯åŠ¨ nginx æœåŠ¡</strong></p>
<p>â‘¡ å¤‡æ³¨äº‹é¡¹<br>æ ¹æ®åº”ç”¨åœºæ™¯ï¼Œè®¾ç½®åˆé€‚çš„ IP åœ°å€ï¼Œæ£€æŸ¥é…ç½®æ–‡ä»¶  <code>#more /usr/local/nginx/conf/nginx.conf</code>ä¸­çš„ </p>
<h2 id="2-æ§åˆ¶è¶…æ—¶æ—¶é—´"><a href="#2-æ§åˆ¶è¶…æ—¶æ—¶é—´" class="headerlink" title="2.æ§åˆ¶è¶…æ—¶æ—¶é—´"></a>2.æ§åˆ¶è¶…æ—¶æ—¶é—´</h2><p>æ§åˆ¶è¶…æ—¶æ—¶é—´ï¼Œæé«˜æœåŠ¡å™¨æ€§èƒ½ï¼Œé™ä½å®¢æˆ·ç«¯çš„ç­‰å¾…æ—¶é—´</p>
<h4 id="â‘ -å»ºè®®é…ç½®"><a href="#â‘ -å»ºè®®é…ç½®" class="headerlink" title="â‘  å»ºè®®é…ç½®"></a>â‘  å»ºè®®é…ç½®</h4><p><strong>(1)ä¿®æ”¹é…ç½®æ–‡ä»¶</strong></p>
<pre><code>vim /usr/local/nginx/conf/nginx.conf
</code></pre><p>å…·ä½“è®¾ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">client_body_timeout 10; <span class="comment">#è®¾ç½®å®¢æˆ·ç«¯è¯·æ±‚ä¸»ä½“è¯»å–è¶…æ—¶æ—¶é—´</span></div><div class="line">client_header_timeout 10; <span class="comment">#è®¾ç½®å®¢æˆ·ç«¯è¯·æ±‚å¤´è¯»å–è¶…æ—¶æ—¶é—´</span></div><div class="line">keepalive_timeout 5 5; <span class="comment">#ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šå®¢æˆ·ç«¯è¿æ¥ä¿æŒæ´»åŠ¨çš„è¶…æ—¶æ—¶é—´ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å¯é€‰çš„ï¼Œå®ƒæŒ‡å®šäº†æ¶ˆæ¯å¤´ä¿æŒæ´»åŠ¨çš„æœ‰æ•ˆæ—¶é—´</span></div><div class="line">send_timeout 10; <span class="comment">#æŒ‡å®šå“åº”å®¢æˆ·ç«¯çš„è¶…æ—¶æ—¶é—´</span></div><div class="line">(2)é‡æ–°å¯åŠ¨ nginx æœåŠ¡</div><div class="line">â‘¡ å¤‡æ³¨äº‹é¡¹</div><div class="line">éœ€è¦æ ¹æ®åº”ç”¨åœºæ™¯çš„éœ€è¦é€‰æ‹©åˆé€‚çš„å‚æ•°å€¼ã€‚</div><div class="line">1 ã€ç¬¦åˆæ€§åˆ¤å®šä¾æ®</div><div class="line">è¶…æ—¶åï¼ŒæœåŠ¡å™¨è¿”å›ç›¸åº”çš„æ¶ˆæ¯ã€‚</div><div class="line">2 ã€å‚è€ƒæ£€æµ‹æ–¹æ³•</div><div class="line">æ£€æŸ¥é…ç½®æ–‡ä»¶   <span class="comment">#more /usr/local/nginx/conf/nginx.conf</span></div><div class="line">3  ä¸‹è½½é™åˆ¶å¹¶å‘å’Œé€Ÿåº¦</div><div class="line">é™åˆ¶å®¢æˆ·ç«¯ä¸‹è½½é€Ÿåº¦ï¼Œä¿è¯æœåŠ¡å™¨è´Ÿè½½æ­£å¸¸</div><div class="line">â‘  å»ºè®®é…ç½®</div><div class="line">ä¾‹å¦‚ç½‘ç«™å­˜æ”¾è·¯å¾„ä¸º/usr/<span class="built_in">local</span>/nsfocus/ ï¼ŒæœåŠ¡å™¨åç§°ä¸ºï¼šdown.nsfocus.com</div><div class="line">(1)ä¿®æ”¹é…ç½®æ–‡ä»¶</div><div class="line"><span class="comment">#vi /usr/local/nginx/conf/nginx.conf</span></div><div class="line">å…·ä½“è®¾ç½®å¦‚ä¸‹ï¼š</div><div class="line">limit_zone one <span class="variable">$binary_remote_addr</span> 10m;</div><div class="line">server</div><div class="line">&#123;</div><div class="line">listen 80;</div><div class="line">server_name down.nsfocus.com;</div><div class="line">index index.html index.htm index.PHP;</div><div class="line">oot /usr/<span class="built_in">local</span>/nsfocus;</div><div class="line"><span class="comment">#Zone limit;</span></div><div class="line">location / &#123;</div><div class="line">limit_conn one 1;</div><div class="line">limit_rate 20k;</div><div class="line">&#125;</div><div class="line">.....</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>(2)é‡æ–°å¯åŠ¨ nginx æœåŠ¡</strong></p>
<p>ä¸‹è½½æ—¶ï¼Œä¸ä¼šè¶…è¿‡è®¾è®¡çš„å¹¶å‘è¿æ¥æ•°å’Œé€Ÿåº¦é™åˆ¶ï¼ŒåŒæ—¶æ£€æŸ¥ nginx.conf æ–‡ä»¶ä¸­çš„é…ç½®</p>
<blockquote>
<p>å…¶ä»–äº‹é¡¹</p>
</blockquote>
<h2 id="3-å¸è½½ä¸éœ€è¦çš„æ¨¡å—"><a href="#3-å¸è½½ä¸éœ€è¦çš„æ¨¡å—" class="headerlink" title="3.å¸è½½ä¸éœ€è¦çš„æ¨¡å—"></a>3.å¸è½½ä¸éœ€è¦çš„æ¨¡å—</h2><p>å¸è½½ä¸éœ€è¦çš„ nginx æ¨¡å—, æœ€å¤§é™åº¦åœ°å°† nginx åŠ è½½çš„æ¨¡å—æœ€å°åŒ–</p>
<h4 id="â‘ -å»ºè®®é…ç½®-1"><a href="#â‘ -å»ºè®®é…ç½®-1" class="headerlink" title="â‘  å»ºè®®é…ç½®"></a>â‘  å»ºè®®é…ç½®</h4><p><strong>(1)æ£€æŸ¥éœ€è¦ç¦ç”¨çš„æ¨¡å—</strong></p>
<p>åœ¨ç¼–è¯‘ nginx æœåŠ¡å™¨æ—¶ï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹å“ªäº›æ¨¡å—åº”è¯¥å¯ç”¨ï¼Œå“ªäº›æ¨¡åº”<br>è¯¥ç¦ç”¨ï¼š</p>
<pre><code># ./configure --help | less
</code></pre><p>ä¸€æ—¦å¤„é€‰äº†è¦ç¦ç”¨çš„æ¨¡å—ï¼Œéœ€è¦ä¸ç›¸å…³äººå‘˜æ²Ÿé€šç¡®è®¤ï¼Œå¹¶ç»è¿‡æµ‹è¯•ä¸å½±å“ä¸š<br>åŠ¡è¿è¡Œã€‚</p>
<p><strong>(2)ä¾‹å¦‚ï¼Œè¦ç¦ç”¨ autoindex å’Œ SSI æ¨¡å—ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ./configure --without-http_autoindex_module --without-http_ssi_module</span></div><div class="line"><span class="comment"># make</span></div><div class="line"><span class="comment"># make install</span></div></pre></td></tr></table></figure>
<h4 id="â‘¡-å¤‡æ³¨äº‹é¡¹-1"><a href="#â‘¡-å¤‡æ³¨äº‹é¡¹-1" class="headerlink" title="â‘¡ å¤‡æ³¨äº‹é¡¹"></a>â‘¡ å¤‡æ³¨äº‹é¡¹</h4><p>Nginx ä¸åŒ…å«ä¸å¿…è¦çš„æ¨¡å—æˆ–è€…è¾“å…¥ ./configure â€“help | less è¿›è¡Œæ£€æŸ¥</p>
<p>##4.é˜²ç›—é“¾è®¾ç½®<br>é˜²æ­¢å…¶ä»–ç½‘ç«™ç›—é“¾æœ¬ç½‘ç«™èµ„æº</p>
<h4 id="â‘ -å»ºè®®é…ç½®-2"><a href="#â‘ -å»ºè®®é…ç½®-2" class="headerlink" title="â‘  å»ºè®®é…ç½®"></a>â‘  å»ºè®®é…ç½®</h4><p><strong>(1)ä¿®æ”¹é…ç½®æ–‡ä»¶</strong></p>
<pre><code>#vi /usr/local/nginx/conf/nginx.conf
</code></pre><p>å…·ä½“è®¾ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">location ~* ^.+\.(gif|jpg|png|swf|flv|rar|zip)$ &#123;</div><div class="line">valid_referers none blocked server_names *.nsfocus.com</div><div class="line">http://localhost baidu.com;</div><div class="line"><span class="keyword">if</span> (<span class="variable">$invalid_referer</span>) &#123;</div><div class="line">rewrite ^/ [img]http://www.ihaozhuo.com/images/default/logo.gif[/img];</div><div class="line"><span class="comment"># return 403;</span></div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ ¹æ®åº”ç”¨åœºæ™¯ï¼Œè®¾ç½®åˆé€‚çš„åŸŸå<br>(2)Nginx -t æ£€æŸ¥é…ç½®æ˜¯å¦æœ‰æ²¡æœ‰é—®é¢˜ã€‚ é‡æ–°å¯åŠ¨ nginx æœåŠ¡</p>
<h4 id="â‘¡-å¤‡æ³¨äº‹é¡¹-2"><a href="#â‘¡-å¤‡æ³¨äº‹é¡¹-2" class="headerlink" title="â‘¡ å¤‡æ³¨äº‹é¡¹"></a>â‘¡ å¤‡æ³¨äº‹é¡¹</h4><p>ä»éæ³•ç½‘ç«™è®¿é—®æ‰€ä¿æŠ¤çš„èµ„æºï¼Œå‡ºç°è®¾ç½®çš„é¡µé¢ã€‚åŒæ—¶æ£€æŸ¥é…ç½®æ–‡ä»¶ <code>#more /usr/local/nginx/conf/nginx.conf</code></p>
<p>##5.è‡ªå®šä¹‰é”™è¯¯ä¿¡æ¯<br>1)ä¿®æ”¹ src/http/ngx_http_special_response.cï¼Œè‡ªå·±å®šåˆ¶é”™è¯¯ä¿¡æ¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## messages with just a carriage return.</span></div><div class="line">static char ngx_http_error_400_page[] = CRLF;</div><div class="line">static char ngx_http_error_404_page[] = CRLF;</div><div class="line">static char ngx_http_error_413_page[] = CRLF;</div><div class="line">static char ngx_http_error_502_page[] = CRLF;</div><div class="line">static char ngx_http_error_504_page[] = CRLF;</div><div class="line">å¸¸è§é”™è¯¯ï¼š</div><div class="line">400 bad request</div><div class="line">404 NOT FOUND</div><div class="line">413 Request Entity Too Large</div><div class="line">502 Bad Gateway</div><div class="line">504 Gateway Time-out</div></pre></td></tr></table></figure>
<p>(2)é‡æ–°å¯åŠ¨ nginx æœåŠ¡</p>
<h4 id="â‘¡-å¤‡æ³¨äº‹é¡¹-3"><a href="#â‘¡-å¤‡æ³¨äº‹é¡¹-3" class="headerlink" title="â‘¡ å¤‡æ³¨äº‹é¡¹"></a>â‘¡ å¤‡æ³¨äº‹é¡¹</h4><p>URL åœ°å€æ ä¸­è¾“å…¥ <a href="http://ip:8800/manager12345ï¼Œè®¿é—®å‡ºé”™æ—¶ï¼Œè¿”å›è‡ªå®šä¹‰çš„é”™è¯¯é¡µé¢" target="_blank" rel="external">http://ip:8800/manager12345ï¼Œè®¿é—®å‡ºé”™æ—¶ï¼Œè¿”å›è‡ªå®šä¹‰çš„é”™è¯¯é¡µé¢</a></p>
<h2 id="6-éšè—-nginx-æœåŠ¡ä¿¡æ¯å¤´"><a href="#6-éšè—-nginx-æœåŠ¡ä¿¡æ¯å¤´" class="headerlink" title="6.éšè— nginx æœåŠ¡ä¿¡æ¯å¤´"></a>6.éšè— nginx æœåŠ¡ä¿¡æ¯å¤´</h2><h4 id="â‘ -å»ºè®®é…ç½®-3"><a href="#â‘ -å»ºè®®é…ç½®-3" class="headerlink" title="â‘  å»ºè®®é…ç½®"></a>â‘  å»ºè®®é…ç½®</h4><p>ä¿®æ”¹ nginxè§£å‹è·¯å¾„<code>/src/http/ngx_http_header_filter_module.c</code>æ–‡ä»¶çš„ç¬¬48<br>å’Œ 49 è¡Œå†…å®¹ï¼Œè‡ªå®šä¹‰å¤´ä¿¡æ¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">static char ngx_http_server_string[] = â€œServer:XXXXX.comâ€ CRLF;</div><div class="line">static char ngx_http_server_full_string[] = â€œServer:XXXXX.comâ€ CRLF;</div></pre></td></tr></table></figure>
<p>æ·»åŠ å¦‚ä¸‹ä»£ç åˆ° <code>nginx.conf</code>é…ç½®æ–‡ä»¶ï¼Œç¦æ­¢é”™è¯¯é¡µé¢ä¸­æ˜¾ç¤º nginx ç‰ˆæœ¬å·ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">server_tokens off</div></pre></td></tr></table></figure>
<h4 id="â‘¡-å¤‡æ³¨äº‹é¡¹-4"><a href="#â‘¡-å¤‡æ³¨äº‹é¡¹-4" class="headerlink" title="â‘¡ å¤‡æ³¨äº‹é¡¹"></a>â‘¡ å¤‡æ³¨äº‹é¡¹</h4><p>æœåŠ¡ä¿¡æ¯å¤´æ˜¾ç¤ºè®¾ç½®çš„å†…å®¹ï¼Œæ£€æŸ¥ http æœåŠ¡ä¿¡æ¯å¤´å†…å®¹</p>
<h2 id="6-è¡¥ä¸æ›´æ–°"><a href="#6-è¡¥ä¸æ›´æ–°" class="headerlink" title="6.è¡¥ä¸æ›´æ–°"></a>6.è¡¥ä¸æ›´æ–°</h2><p>å®‰è£…ç³»ç»Ÿè¡¥ä¸ï¼Œä¿®è¡¥æ¼æ´</p>
<p><strong>1.å‚è€ƒé…ç½®æ“ä½œ</strong><br>æ‰‹åŠ¨å®‰è£…è¡¥ä¸æˆ–å®‰è£…æœ€æ–°ç‰ˆæœ¬è½¯ä»¶ï¼Œæ‰€å®‰è£…çš„è¡¥ä¸ï¼Œåº”é¦–å…ˆåœ¨ç»è¿‡æµ‹è¯•éªŒè¯ï¼›å®‰è£…å‰ï¼Œè¦åšå¥½æ•°æ®å¤‡ä»½ã€‚<br><strong>2.æŸ¥çœ‹ç‰ˆæœ¬å’Œç¼–è¯‘å™¨ä¿¡æ¯</strong></p>

	

	

</article>




	<article>
	
		<h1><a href="/2016/04/02/WebæœåŠ¡æŠ€æœ¯/Nginx/http response code 301 å’Œ 302åˆ†ææ€»ç»“/">Http response code 301 å’Œ 302åˆ†ææ€»ç»“</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-04-02</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/Nginx/">Nginx</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Nginx/">Nginx</a> <a class="article__tag-link" href="/tags/Web-Service/">Web Service</a>
			</span>
		
	</div>

	

	
		<h3 id="http-response-code-301-å’Œ-302-äº†è§£å¤šå°‘å‘¢ã€‚"><a href="#http-response-code-301-å’Œ-302-äº†è§£å¤šå°‘å‘¢ã€‚" class="headerlink" title="http response code 301 å’Œ 302 äº†è§£å¤šå°‘å‘¢ã€‚"></a>http response code 301 å’Œ 302 äº†è§£å¤šå°‘å‘¢ã€‚</h3><h4 id="ä¸€ï¼å®˜æ–¹è¯´æ³•"><a href="#ä¸€ï¼å®˜æ–¹è¯´æ³•" class="headerlink" title="ä¸€ï¼å®˜æ–¹è¯´æ³•"></a>ä¸€ï¼å®˜æ–¹è¯´æ³•</h4><p>æœ€è¿‘Nginxè®¿é—®å‡ºç°301å’Œ302è¿™é‡Œå°±å¯¹301 302è®¤çœŸåšäº†ä¸€æ¬¡æ€»ç»“ã€‚</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="number">301</span>ï¼Œ<span class="number">302</span> éƒ½æ˜¯HTTPçŠ¶æ€çš„ç¼–ç ï¼Œéƒ½ä»£è¡¨ç€æŸä¸ªURLå‘ç”Ÿäº†è½¬ç§»ï¼Œä¸åŒä¹‹å¤„åœ¨äºï¼š </div><div class="line"><span class="symbol">301 </span>redirect: <span class="number">301</span> ä»£è¡¨æ°¸ä¹…æ€§è½¬ç§»(Permanently Moved)ã€‚</div><div class="line"><span class="symbol">302 </span>redirect: <span class="number">302</span> ä»£è¡¨æš‚æ—¶æ€§è½¬ç§»(Temporarily Moved )ã€‚</div></pre></td></tr></table></figure>
<p>è¿™æ˜¯å¾ˆå®˜æ–¹çš„è¯´æ³•ï¼Œé‚£ä¹ˆå®ƒä»¬çš„åŒºåˆ«åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<h4 id="äºŒï¼ç°å®ä¸­çš„å·®å¼‚"><a href="#äºŒï¼ç°å®ä¸­çš„å·®å¼‚" class="headerlink" title="äºŒï¼ç°å®ä¸­çš„å·®å¼‚"></a>äºŒï¼ç°å®ä¸­çš„å·®å¼‚</h4><ul>
<li><p>å¯¹äºç”¨æˆ·301ï¼Œ302å¯¹ç”¨æˆ·æ¥è¯´æ²¡æœ‰åŒºåˆ«ï¼Œä»–ä»¬çœ‹åˆ°æ•ˆæœåªæ˜¯ä¸€ä¸ªè·³è½¬ï¼Œæµè§ˆå™¨ä¸­æ—§çš„URLå˜æˆäº†æ–°çš„URLã€‚é¡µé¢è·³åˆ°äº†è¿™ä¸ªæ–°çš„urlæŒ‡å‘çš„åœ°æ–¹ã€‚</p>
</li>
<li><p>å¯¹äºå¼•æ“åŠç«™é•¿</p>
</li>
<li><p>302</p>
</li>
</ul>
<p>302è½¬å‘å¯èƒ½ä¼šæœ‰URLè§„èŒƒåŒ–åŠç½‘å€åŠ«æŒçš„é—®é¢˜ã€‚å¯èƒ½è¢«æœç´¢å¼•æ“åˆ¤ä¸ºå¯ç–‘è½¬å‘ï¼Œç”šè‡³è®¤ä¸ºæ˜¯ä½œå¼Šã€‚<br>ç½‘å€è§„èŒƒåŒ–</p>
<p>è¯·å‚è§ï¼š<a href="http://www.chinamyhosting.com/seoblog/2006/04/10/url-canonicalization/" target="_blank" rel="external">ç½‘å€åŠ«æŒ</a></p>
<p>302é‡å®šå‘å’Œç½‘å€åŠ«æŒï¼ˆURL hijackingï¼‰æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿè¿™è¦ä»æœç´¢å¼•æ“å¦‚ä½•å¤„ç†302è½¬å‘è¯´èµ·ã€‚</p>
<p>ä»å®šä¹‰æ¥è¯´ï¼Œä»ç½‘å€Aåšä¸€ä¸ª302é‡å®šå‘åˆ°ç½‘å€Bæ—¶ï¼Œä¸»æœºæœåŠ¡å™¨çš„éšå«æ„æ€æ˜¯ç½‘å€Aéšæ—¶æœ‰å¯èƒ½æ”¹ä¸»æ„ï¼Œé‡æ–°æ˜¾ç¤ºæœ¬èº«çš„å†…å®¹æˆ–è½¬å‘å…¶ä»–çš„åœ°æ–¹ã€‚å¤§éƒ¨åˆ†çš„æœç´¢å¼•æ“åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå½“æ”¶åˆ°302é‡å®šå‘æ—¶ï¼Œä¸€èˆ¬åªè¦å»æŠ“å–ç›®æ ‡ç½‘å€å°±å¯ä»¥äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ç½‘å€Bã€‚<br>å®é™…ä¸Šå¦‚æœæœç´¢å¼•æ“åœ¨é‡åˆ°302è½¬å‘æ—¶ï¼Œç™¾åˆ†ä¹‹ç™¾çš„éƒ½æŠ“å–ç›®æ ‡ç½‘å€Bçš„è¯ï¼Œå°±ä¸ç”¨æ‹…å¿ƒç½‘å€URLåŠ«æŒäº†ã€‚é—®é¢˜å°±åœ¨äºï¼Œæœ‰çš„æ—¶å€™æœç´¢å¼•æ“ï¼Œå°¤å…¶æ˜¯Googleï¼Œå¹¶ä¸èƒ½æ€»æ˜¯æŠ“å–ç›®æ ‡ç½‘å€ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæ¯”å¦‚è¯´ï¼Œæœ‰çš„æ—¶å€™Aç½‘å€å¾ˆçŸ­ï¼Œä½†æ˜¯å®ƒåšäº†ä¸€ä¸ª302é‡å®šå‘åˆ°Bç½‘å€ï¼Œè€ŒBç½‘å€æ˜¯ä¸€ä¸ªå¾ˆé•¿çš„ä¹±ä¸ƒå…«ç³Ÿçš„URLç½‘å€ï¼Œç”šè‡³è¿˜æœ‰å¯èƒ½åŒ…å«ä¸€äº›é—®å·ä¹‹ç±»çš„å‚æ•°ã€‚å¾ˆè‡ªç„¶çš„ï¼ŒAç½‘å€æ›´åŠ ç”¨æˆ·å‹å¥½ï¼Œè€ŒBç½‘å€æ—¢éš¾çœ‹ï¼Œåˆä¸ç”¨æˆ·å‹å¥½ã€‚è¿™æ—¶Googleå¾ˆæœ‰å¯èƒ½ä¼šä»ç„¶æ˜¾ç¤ºç½‘å€Aã€‚<br>ç”±äºæœç´¢å¼•æ“æ’åç®—æ³•åªæ˜¯ç¨‹åºè€Œä¸æ˜¯äººï¼Œåœ¨é‡åˆ°302é‡å®šå‘çš„æ—¶å€™ï¼Œå¹¶ä¸èƒ½åƒäººä¸€æ ·çš„å»å‡†ç¡®åˆ¤å®šå“ªä¸€ä¸ªç½‘å€æ›´é€‚å½“ï¼Œè¿™å°±é€ æˆäº†ç½‘å€URLåŠ«æŒçš„å¯èƒ½æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªä¸é“å¾·çš„äººåœ¨ä»–è‡ªå·±çš„ç½‘å€Aåšä¸€ä¸ª302é‡å®šå‘åˆ°ä½ çš„ç½‘å€Bï¼Œå‡ºäºæŸç§åŸå› ï¼Œ Googleæœç´¢ç»“æœæ‰€æ˜¾ç¤ºçš„ä»ç„¶æ˜¯ç½‘å€Aï¼Œä½†æ˜¯æ‰€ç”¨çš„ç½‘é¡µå†…å®¹å´æ˜¯ä½ çš„ç½‘å€Bä¸Šçš„å†…å®¹ï¼Œè¿™ç§æƒ…å†µå°±å«åšç½‘å€URLåŠ«æŒã€‚ä½ è¾›è¾›è‹¦è‹¦æ‰€å†™çš„å†…å®¹å°±è¿™æ ·è¢«åˆ«äººå·èµ°äº†ã€‚</p>
<p>301</p>
<p> å½“ç½‘é¡µAç”¨301é‡å®šå‘è½¬åˆ°ç½‘é¡µBæ—¶ï¼Œæœç´¢å¼•æ“å¯ä»¥è‚¯å®šç½‘é¡µAæ°¸ä¹…çš„æ”¹å˜ä½ç½®ï¼Œæˆ–è€…è¯´å®é™…ä¸Šä¸å­˜åœ¨äº†ï¼Œæœç´¢å¼•æ“å°±ä¼šæŠŠç½‘é¡µBå½“ä½œå”¯ä¸€æœ‰æ•ˆç›®æ ‡ã€‚<br>301çš„å¥½å¤„æ˜¯:</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ç¬¬ä¸€ï¼Œ æ²¡æœ‰ç½‘å€è§„èŒƒåŒ–é—®é¢˜ã€‚</div><div class="line">ç¬¬äºŒï¼Œ ä¹Ÿå¾ˆé‡è¦çš„ï¼Œç½‘é¡µ<span class="keyword">A</span>çš„PRç½‘é¡µçº§åˆ«ä¼šä¼ åˆ°ç½‘é¡µBã€‚</div></pre></td></tr></table></figure>
<h4 id="ä¸‰ï¼Apacheä¸­å®ç°301ã€302"><a href="#ä¸‰ï¼Apacheä¸­å®ç°301ã€302" class="headerlink" title="ä¸‰ï¼Apacheä¸­å®ç°301ã€302"></a>ä¸‰ï¼Apacheä¸­å®ç°301ã€302</h4><ul>
<li>æ–¹æ³•ä¸€ï¼Œurl rewriteï¼Œmod_rewrite</li>
</ul>
<p>[plain] </p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">view</span> plain <span class="keyword">copy</span></div><div class="line">Rewriteengine <span class="keyword">on</span>  </div><div class="line">RewriteCond %&#123;HTTP_HOST&#125; ^cmp.soso.<span class="keyword">com</span> [NC]  </div><div class="line">RewriteRule ^/js/(.*) http://www.soso.<span class="keyword">com</span>/js/$<span class="number">1</span>  [R=<span class="number">301</span>]  </div><div class="line">ServerName cmp.soso.<span class="keyword">com</span></div></pre></td></tr></table></figure>
<p>å°†cmp.soso.comä¸­jsç›®å½•çš„ä¸‹æ‰€æœ‰è®¿é—®é‡å®šå‘åˆ°<a href="http://www.soso.com/js/ï¼ŒæŒ‡å®šè·³è½¬è¿”å›ç ä¸º301ã€‚" target="_blank" rel="external">http://www.soso.com/js/ï¼ŒæŒ‡å®šè·³è½¬è¿”å›ç ä¸º301ã€‚</a><br>å¯¹äº[R=301]çš„è¯¦è§£ï¼š<br>â€˜redirect|R [=code]â€™ (å¼ºåˆ¶é‡å®šå‘ redirect)<br>ä»¥<a href="http://thishost[:thisport]/(ä½¿æ–°çš„URLæˆä¸ºä¸€ä¸ªURI" target="_blank" rel="external">http://thishost[:thisport]/(ä½¿æ–°çš„URLæˆä¸ºä¸€ä¸ªURI</a>) ä¸ºå‰ç¼€çš„Substitutionå¯ä»¥å¼ºåˆ¶æ€§æ‰§è¡Œä¸€ä¸ªå¤–éƒ¨é‡å®šå‘ã€‚ å¦‚æœcodeæ²¡æœ‰æŒ‡å®šï¼Œåˆ™äº§ç”Ÿä¸€ä¸ªHTTPå“åº”ä»£ç 302(ä¸´æ—¶æ€§ç§»åŠ¨)ã€‚ å¦‚æœéœ€è¦ä½¿ç”¨åœ¨300-400èŒƒå›´å†…çš„å…¶ä»–å“åº”ä»£ç ï¼Œåªéœ€åœ¨æ­¤æŒ‡å®šè¿™ä¸ªæ•°å€¼å³å¯ï¼Œ å¦å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ä¸‹åˆ—ç¬¦å·åç§°ä¹‹ä¸€: temp (é»˜è®¤çš„), permanent, seeother. ç”¨å®ƒå¯ä»¥æŠŠè§„èŒƒåŒ–çš„URLåé¦ˆç»™å®¢æˆ·ç«¯ï¼Œå¦‚,<code>é‡å†™``/~&#39;&#39;ä¸º ``/u/&#39;&#39;ï¼Œæˆ–å¯¹/u/useråŠ ä¸Šæ–œæ </code>ï¼Œç­‰ç­‰ã€‚</p>
<p>æ³¨æ„: åœ¨ä½¿ç”¨è¿™ä¸ªæ ‡è®°æ—¶ï¼Œå¿…é¡»ç¡®ä¿è¯¥æ›¿æ¢å­—æ®µæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„URL! å¦åˆ™ï¼Œå®ƒä¼šæŒ‡å‘ä¸€ä¸ªæ— æ•ˆçš„ä½ç½®! å¹¶ä¸”è¦è®°ä½ï¼Œæ­¤æ ‡è®°æœ¬èº«åªæ˜¯å¯¹URLåŠ ä¸Š <a href="http://thishost[:thisport]/çš„å‰ç¼€ï¼Œ`é‡å†™æ“ä½œä»ç„¶ä¼šç»§ç»­`ã€‚" target="_blank" rel="external">http://thishost[:thisport]/çš„å‰ç¼€ï¼Œ`é‡å†™æ“ä½œä»ç„¶ä¼šç»§ç»­`ã€‚</a> é€šå¸¸ï¼Œä½ ä¼šå¸Œæœ›åœæ­¢é‡å†™æ“ä½œè€Œç«‹å³é‡å®šå‘ï¼Œåˆ™è¿˜éœ€è¦ä½¿ç”¨â€™Lâ€™æ ‡è®°.</p>
<ul>
<li>æ–¹æ³•äºŒ Redirect ï¼Œæ¶‰åŠæ¨¡å—ï¼šmod_alias</li>
</ul>
<p>ä¾‹ï¼š</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[plain] view plain copy</div><div class="line"><span class="params">&lt;VirtualHost <span class="number">10.1</span><span class="number">.146</span><span class="number">.163</span>:<span class="number">80</span>&gt;</span>  </div><div class="line">   DocumentRoot <span class="meta-keyword">/home/</span>qmhball<span class="meta-keyword">/web/</span>mybranches/stat_3276<span class="meta-keyword">/oa/</span>  </div><div class="line">   ServerName oalogin.com  </div><div class="line">   Redirect <span class="number">301</span> /login.php http:<span class="comment">//www.soso.com  </span></div><div class="line"><span class="params">&lt;/VirtualHost&gt;</span></div></pre></td></tr></table></figure>
<p>å°†oalogin.comä¸‹å¯¹login.phpçš„è®¿é—®é‡å®šå‘åˆ°<a href="http://www.soso.comï¼Œè¿”å›ç 301ã€‚" target="_blank" rel="external">http://www.soso.comï¼Œè¿”å›ç 301ã€‚</a><br>å¦‚æœæ²¡æœ‰æŒ‡å®šredirectçš„è¿”å›å‚æ•°ï¼ˆä¾‹ä¸­çš„301ï¼‰ï¼Œåˆ™é»˜è®¤é‡å®šå‘æ˜¯â€ä¸´æ—¶æ€§çš„â€(HTTP status 302)ã€‚</p>

	

	

</article>




	<article>
	
		<h1><a href="/2016/03/29/WebæœåŠ¡æŠ€æœ¯/Nginx/nginxåŸºç¡€ç¯‡-æ—¥å¿—ç®¡ç†å’Œåˆ‡å‰²/">NginxåŸºç¡€ç¯‡-æ—¥å¿—ç®¡ç†å’Œåˆ‡å‰²</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-03-29</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/Nginx/">Nginx</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Nginx/">Nginx</a> <a class="article__tag-link" href="/tags/Web-Service/">Web Service</a>
			</span>
		
	</div>

	

	
		<h2 id="å‰è¨€ï¼š"><a href="#å‰è¨€ï¼š" class="headerlink" title="å‰è¨€ï¼š"></a>å‰è¨€ï¼š</h2><p>å…¬å¸æ—¥å¿—æŸ¥çœ‹æœ‰æ—¶å€™ä¸å¤ªè§„èŒƒï¼Œå®˜ç½‘webæœåŠ¡æ—¥å¿—è¿™è¾¹æ•´ç†äº†ä¸‹Nginxæ—¥å¿—è¾“å‡ºä¼˜åŒ–ã€‚ </p>
<h2 id="ä¸€ã€æ—¥å¿—åˆ†ç±»"><a href="#ä¸€ã€æ—¥å¿—åˆ†ç±»" class="headerlink" title="ä¸€ã€æ—¥å¿—åˆ†ç±»"></a>ä¸€ã€æ—¥å¿—åˆ†ç±»</h2><p>Nginxæ—¥å¿—ä¸»è¦åˆ†ä¸ºä¸¤ç§ï¼Œè®¿é—®æ—¥å¿—å’Œé”™è¯¯æ—¥å¿—ã€‚ä¸¤ç§æ—¥å¿—å¯ä»¥åœ¨httpå’Œserveræ¨¡å—ä¸­é…ç½®ï¼Œnginxæœ‰ä¸€ä¸ªéå¸¸çµæ´»çš„æ—¥å¿—è®°å½•æ¨¡å¼ã€‚æ¯ä¸ªçº§åˆ«çš„é…ç½®å¯ä»¥æœ‰å„è‡ªç‹¬ç«‹çš„è®¿é—®æ—¥å¿—ã€‚æ—¥å¿—æ ¼å¼é€šè¿‡log_formatå‘½ä»¤æ¥å®šä¹‰</p>
<h3 id="1ã€è®¿é—®æ—¥å¿—"><a href="#1ã€è®¿é—®æ—¥å¿—" class="headerlink" title="1ã€è®¿é—®æ—¥å¿—"></a>1ã€è®¿é—®æ—¥å¿—</h3><p>è®¿é—®æ—¥å¿—ä¸»è¦è®°å½•å®¢æˆ·ç«¯è®¿é—®Nginxçš„æ¯ä¸€ä¸ªè¯·æ±‚<code>log_format</code>ç”¨æ¥è®¾ç½®æ—¥å¿—æ ¼å¼ï¼Œåªèƒ½åœ¨httpæ¨¡å—ä¸‹è®¾ç½® log_format name   name(æ ¼å¼åç§°)   type(æ ¼å¼æ ·å¼)</p>
<p>ä¸‹é¢æ˜¯é»˜è®¤çš„nginxæ—¥å¿—æ ¼å¼ï¼š</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">log_format</span>  main  <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>]"<span class="variable">$request</span>" '</span></div><div class="line">                      <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span>"<span class="variable">$http_referer</span>" '</span></div><div class="line">                     <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</div></pre></td></tr></table></figure>
<p>å­—æ®µå«ä¹‰ï¼š</p>
<pre><code>  $remote_addrè¿œç¨‹å®¢æˆ·ç«¯çš„IPåœ°å€ã€‚
  $remote_userè¿œç¨‹å®¢æˆ·ç«¯ç”¨æˆ·åç§°ï¼Œå¦‚æœç½‘ç«™è®¾ç½®äº†ç”¨æˆ·éªŒè¯çš„è¯å°±ä¼šæœ‰ï¼Œå¦åˆ™ç©ºç™½
  [$time_local]è®¿é—®çš„æ—¶é—´ä¸æ—¶åŒºæ¯”å¦‚18/Jul/2012:17:00:01+0800æ—¶é—´ä¿¡æ¯æœ€åçš„&quot;+0800&quot;è¡¨ç¤ºæœåŠ¡å™¨æ‰€å¤„æ—¶åŒºä½äºUTCä¹‹åçš„8å°æ—¶ã€‚
  $requestè®°å½•è¯·æ±‚çš„urlå’Œhttpåè®®
  $statusè®°å½•è¯·æ±‚è¿”å›çš„httpçŠ¶æ€ç .
  $body_bytes_sentè®°å½•å‘é€ç»™å®¢æˆ·ç«¯çš„æ–‡ä»¶ä¸»ä½“å†…å®¹çš„å¤§å°
  $http_refererè®°å½• è®°å½•ä»å“ªä¸ªé¡µé¢é“¾æ¥è®¿é—®è¿‡æ¥çš„ã€‚
  $http_user_agentè®°å½•å®¢æˆ·ç«¯æµè§ˆå™¨ä¿¡æ¯
  $http_x_forwarded_forå®¢æˆ·ç«¯çš„çœŸå®ipã€‚å½“nginxå‰é¢æœ‰ä»£ç†æœåŠ¡å™¨æ—¶ï¼Œ$remote_addrè·å–åˆ°çš„åªèƒ½æ˜¯nginxä¸Šä¸€çº§çš„IPï¼Œè€Œåå‘ä»£ç†æœåŠ¡å™¨åœ¨è½¬å‘è¯·æ±‚çš„httpå¤´ä¿¡æ¯ä¸­å¯ä»¥å¢åŠ x_forwarded_forä¿¡æ¯ç”¨ä»¥è®°å½•åŸæœ‰å®¢æˆ·ç«¯çš„IPåœ°å€å’ŒåŸæ¥å®¢æˆ·ç«¯çš„è¯·æ±‚çš„æœåŠ¡å™¨åœ°å€ï¼Œ$http_x_forwarded_forå‚æ•°å°±æ˜¯æ‰¿æ¥ä¸Šä¸€çº§ä¼ é€’çš„å®¢æˆ·ç«¯IPå‚æ•°ã€‚ä»è€Œå°±è·å–åˆ°äº†å®¢æˆ·ç«¯çš„çœŸå®IPã€‚



access_log æŒ‡ä»¤ç”¨æ¥æŒ‡å®šæ—¥å¿—æ–‡ä»¶çš„å­˜æ”¾è·¯å¾„ï¼Œå¯ä»¥åœ¨httpã€serverã€locationä¸­è®¾ç½®
  ä¸¾ä¾‹è¯´æ˜å¦‚ä¸‹
  access_log  logs/access.log  main;
  å¦‚æœæƒ³å…³é—­æ—¥å¿—å¯ä»¥å¦‚ä¸‹
  access_log off;
</code></pre><h3 id="2ã€é”™è¯¯æ—¥å¿—"><a href="#2ã€é”™è¯¯æ—¥å¿—" class="headerlink" title="2ã€é”™è¯¯æ—¥å¿—"></a>2ã€é”™è¯¯æ—¥å¿—</h3><p>é”™è¯¯æ—¥å¿—ä¸»è¦è®°å½•å®¢æˆ·ç«¯è®¿é—®Nginxå‡ºé”™æ—¶çš„æ—¥å¿—æ ¼å¼ï¼Œä¸æ”¯æŒè‡ªå®šä¹‰ã€‚<br>ç”±æŒ‡ä»¤error_logæ¥æŒ‡å®šå…·ä½“æ ¼å¼å¦‚ä¸‹</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">error_log</span>  path(å­˜æ”¾è·¯å¾„)  level(æ—¥å¿—ç­‰çº§)ã€<span class="literal">debug</span> | <span class="literal">info</span> | <span class="literal">notice</span> | <span class="literal">warn</span> | <span class="literal">error</span> |<span class="literal">crit</span>ã€‘</div></pre></td></tr></table></figure>
<p>å¦‚æœä¸æŒ‡å®šè·¯å¾„çš„è¯é»˜è®¤æ˜¯åœ¨logsä¸‹ã€‚</p>
<h3 id="3-ç”Ÿäº§ç¯å¢ƒä¸‹å¸¸ç”¨çš„æ—¥å¿—æ ¼å¼ï¼š"><a href="#3-ç”Ÿäº§ç¯å¢ƒä¸‹å¸¸ç”¨çš„æ—¥å¿—æ ¼å¼ï¼š" class="headerlink" title="3.ç”Ÿäº§ç¯å¢ƒä¸‹å¸¸ç”¨çš„æ—¥å¿—æ ¼å¼ï¼š"></a>3.ç”Ÿäº§ç¯å¢ƒä¸‹å¸¸ç”¨çš„æ—¥å¿—æ ¼å¼ï¼š</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">log_format</span>  main  <span class="string">'<span class="variable">$http_host</span>-<span class="variable">$http_x_forwarded_for</span>  <span class="variable">$&#123;request_time&#125;</span>s- [<span class="variable">$time_local</span>] "<span class="variable">$request</span>"'</span></div><div class="line">                      <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span>"<span class="variable">$http_referer</span>" "<span class="variable">$http_user_agent</span>" <span class="variable">$remote_addr</span> '</span> ;</div></pre></td></tr></table></figure>
<h2 id="äºŒã€æ—¥å¿—ç®¡ç†"><a href="#äºŒã€æ—¥å¿—ç®¡ç†" class="headerlink" title="äºŒã€æ—¥å¿—ç®¡ç†"></a>äºŒã€æ—¥å¿—ç®¡ç†</h2><p>1.nginxæ—¥å¿—åˆ‡å‰²</p>
<p>å®ç°æ€è·¯ï¼šæ¯å¤©å®šæ—¶æŠŠæ—¥å¿—ç§»åŠ¨åˆ°å¤‡ä»½ç›®å½•ï¼Œç„¶åé‡æ–°reloadæˆ–è€…restartã€‚è¿™æ ·ä¼šåœ¨åŸæ¥çš„logsä¸‹ç”Ÿæˆæ–°çš„æ—¥å¿—æ–‡ä»¶ã€‚(æç¤ºï¼šå½“æ—¥å¿—æ–‡ä»¶è¢«ç§»åŠ¨åˆ°å¤‡ä»½ç›®å½•åï¼Œåœ¨æ²¡æœ‰restartçš„ä¹‹å‰ï¼Œnginxä¾ç„¶ä¼šå‘åŸæ¥çš„æ—¥å¿—æ–‡ä»¶ä¸­è®°å½•è®¿é—®è¯·æ±‚ï¼Œåªæœ‰ç­‰restartçš„ä¹‹åç”Ÿæˆäº†æ–°æ–‡ä»¶ï¼Œæ‰é‡æ–°è®°å½•åˆ°æ–°çš„æ—¥å¿—æ–‡ä»¶ä¸­)<br>å®ç°è„šæœ¬ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">#created by yangc</span></div><div class="line">  </div><div class="line"><span class="comment">#Log Dir</span></div><div class="line">DIR_LOG=<span class="string">"/var/log/nginx/"</span></div><div class="line">weblog=(</div><div class="line">weixin1.ihaozhuo.com</div><div class="line">)</div><div class="line">DATE=`date <span class="_">-d</span><span class="string">"yesterday"</span> +<span class="string">"%Y%m%d"</span>`</div><div class="line">  </div><div class="line"><span class="keyword">if</span> [ ! <span class="_">-d</span><span class="string">"<span class="variable">$&#123;DIR_LOG&#125;</span>/cut_log/<span class="variable">$&#123;DATE&#125;</span>"</span> ];<span class="keyword">then</span></div><div class="line">   mkdir -p <span class="variable">$&#123;DIR_LOG&#125;</span>/cut_log/<span class="variable">$&#123;DATE&#125;</span></div><div class="line"><span class="keyword">fi</span></div><div class="line">DIR=<span class="string">"<span class="variable">$&#123;DIR_LOG&#125;</span>/cut_log/<span class="variable">$&#123;DATE&#125;</span>"</span>                                                                 </div><div class="line">NGINX_LOG=<span class="string">"<span class="variable">$&#123;DIR_LOG&#125;</span>/current"</span></div><div class="line">  </div><div class="line"><span class="keyword">for</span>  <span class="built_in">log</span> <span class="keyword">in</span> <span class="variable">$&#123;weblog[@]&#125;</span>; <span class="keyword">do</span></div><div class="line">mv <span class="variable">$&#123;NGINX_LOG&#125;</span>/<span class="variable">$log</span> <span class="variable">$DIR</span></div><div class="line"><span class="keyword">done</span></div><div class="line">  </div><div class="line"><span class="built_in">kill</span> -USR1 `cat /usr/<span class="built_in">local</span>/nginx/logs/nginx.pid`</div><div class="line">sleep 130</div><div class="line">find <span class="variable">$&#123;DIR_LOG&#125;</span>/cut_log/* -typed -mtime +7 -exec rm -rf &#123;&#125; \;</div><div class="line">sleep 130</div></pre></td></tr></table></figure>
<p>2.nginxä¸è®°å½•æŸäº›æ–‡ä»¶æˆ–ç›®å½•çš„è®¿é—®æ—¥å¿—<br>æ–¹æ³•ï¼šå…ˆç”¨location å®šä¹‰ä¸è®°å½•æ—¥å¿—çš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œç„¶ååœ¨å…¶ä¸‹é¢ç”¨ access_log off; è¿›è¡Œå…³é—­æ—¥å¿—å³å¯<br>ä¾‹å¦‚ï¼š</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">location</span> <span class="title">~*.\checkstatus</span>.html &#123;</div><div class="line">       access_logoff;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

	

	

</article>




	<article>
	
		<h1><a href="/2016/03/29/WebæœåŠ¡æŠ€æœ¯/Nginx/NginxåŸºç¡€ç¯‡-Nginx.confé…ç½®æ–‡ä»¶è¯¦è§£/">NginxåŸºç¡€ç¯‡-Nginx.confé…ç½®æ–‡ä»¶è¯¦è§£</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-03-29</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/Nginx/">Nginx</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Nginx/">Nginx</a> <a class="article__tag-link" href="/tags/Web-Service/">Web Service</a>
			</span>
		
	</div>

	

	
		<h1 id="Nginx-confé…ç½®æ–‡ä»¶è¯¦è§£"><a href="#Nginx-confé…ç½®æ–‡ä»¶è¯¦è§£" class="headerlink" title="Nginx.confé…ç½®æ–‡ä»¶è¯¦è§£"></a>Nginx.confé…ç½®æ–‡ä»¶è¯¦è§£</h1><p>Nginxé…ç½®æ–‡ä»¶ä¸»è¦åˆ†æˆå››éƒ¨åˆ†ï¼šmainï¼ˆå…¨å±€è®¾ç½®ï¼‰ã€serverï¼ˆä¸»æœºè®¾ç½®ï¼‰ã€upstreamï¼ˆä¸Šæ¸¸æœåŠ¡å™¨è®¾ç½®ï¼Œä¸»è¦ä¸ºåå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ç›¸å…³é…ç½®ï¼‰å’Œ locationï¼ˆURLåŒ¹é…ç‰¹å®šä½ç½®åçš„è®¾ç½®ï¼‰ï¼Œæ¯éƒ¨åˆ†åŒ…å«è‹¥å¹²ä¸ªæŒ‡ä»¤ã€‚mainéƒ¨åˆ†è®¾ç½®çš„æŒ‡ä»¤å°†å½±å“å…¶å®ƒæ‰€æœ‰éƒ¨åˆ†çš„è®¾ç½®ï¼›serveréƒ¨åˆ†çš„æŒ‡ä»¤ä¸»è¦ç”¨äºæŒ‡å®šè™šæ‹Ÿä¸»æœºåŸŸåã€IPå’Œç«¯å£ï¼›upstreamçš„æŒ‡ä»¤ç”¨äºè®¾ç½®ä¸€ç³»åˆ—çš„åç«¯æœåŠ¡å™¨ï¼Œè®¾ç½®åå‘ä»£ç†åŠåç«¯æœåŠ¡å™¨çš„è´Ÿè½½å‡è¡¡ï¼›locationéƒ¨åˆ†ç”¨äºåŒ¹é…ç½‘é¡µä½ç½®ï¼ˆæ¯”å¦‚ï¼Œæ ¹ç›®å½•â€œ/â€,â€œ/imagesâ€,ç­‰ç­‰ï¼‰ã€‚ä»–ä»¬ä¹‹é—´çš„å…³ç³»å¼ï¼šserverç»§æ‰¿mainï¼Œlocationç»§æ‰¿serverï¼›upstreamæ—¢ä¸ä¼šç»§æ‰¿æŒ‡ä»¤ä¹Ÿä¸ä¼šè¢«ç»§æ‰¿ã€‚å®ƒæœ‰è‡ªå·±çš„ç‰¹æ®ŠæŒ‡ä»¤ï¼Œä¸éœ€è¦åœ¨å…¶ä»–åœ°æ–¹çš„åº”ç”¨ã€‚</p>
<p>å½“å‰nginxæ”¯æŒçš„å‡ ä¸ªæŒ‡ä»¤ä¸Šä¸‹æ–‡ï¼š</p>
<p>2.1 é€šç”¨<br>ä¸‹é¢çš„nginx.confç®€å•çš„å®ç°nginxåœ¨å‰ç«¯åšåå‘ä»£ç†æœåŠ¡å™¨çš„ä¾‹å­ï¼Œå¤„ç†jsã€pngç­‰é™æ€æ–‡ä»¶ï¼Œjspç­‰åŠ¨æ€è¯·æ±‚è½¬å‘åˆ°å…¶å®ƒæœåŠ¡å™¨tomcatï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#å®šä¹‰Nginxè¿è¡Œçš„ç”¨æˆ·å’Œç”¨æˆ·</span></div><div class="line">user www www;</div><div class="line"></div><div class="line"><span class="comment">#nginxè¿›ç¨‹æ•°ï¼Œå»ºè®®è®¾ç½®ä¸ºç­‰äºCPUæ€»æ ¸å¿ƒæ•°ã€‚è¿™é‡Œæˆ‘æœåŠ¡å™¨4æ ¸</span></div><div class="line">worker_processes 4;</div><div class="line"></div><div class="line"><span class="comment">#ä¸€ä¸ª1æ ¸CPUå¯¹åº”ä¸€ä¸ªè¿›ç¨‹æ•°ç®¡ç†ã€‚è¿™æ ·èƒ½å¾ˆå¥½åˆ†é…èµ„æºã€‚</span></div><div class="line"></div><div class="line">worker_cpu_affinity 00000001 00000010 00000100 00001000; </div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#å…¨å±€é”™è¯¯æ—¥å¿—å®šä¹‰ç±»å‹ï¼Œ[ debug | info | notice | warn | error | crit ]</span></div><div class="line">error_log /var/<span class="built_in">log</span>/nginx/error.log info;</div><div class="line"></div><div class="line"><span class="comment">#è¿›ç¨‹æ–‡ä»¶</span></div><div class="line">pid /var/run/nginx.pid;</div><div class="line"></div><div class="line"><span class="comment">#ä¸€ä¸ªnginxè¿›ç¨‹æ‰“å¼€çš„æœ€å¤šæ–‡ä»¶æè¿°ç¬¦æ•°ç›®ï¼Œç†è®ºå€¼åº”è¯¥æ˜¯æœ€å¤šæ‰“å¼€æ–‡ä»¶æ•°ï¼ˆç³»ç»Ÿçš„å€¼ulimit -nï¼‰ä¸nginxè¿›ç¨‹æ•°ç›¸é™¤ï¼Œä½†æ˜¯nginxåˆ†é…è¯·æ±‚å¹¶ä¸å‡åŒ€ï¼Œæ‰€ä»¥å»ºè®®ä¸ulimit -nçš„å€¼ä¿æŒä¸€è‡´ã€‚</span></div><div class="line">worker_rlimit_nofile 65535;</div><div class="line"></div><div class="line"><span class="comment">#å·¥ä½œæ¨¡å¼ä¸è¿æ¥æ•°ä¸Šé™</span></div><div class="line">events</div><div class="line">&#123;</div><div class="line"><span class="comment">#å‚è€ƒäº‹ä»¶æ¨¡å‹ï¼Œuse [ kqueue | rtsig | epoll | /dev/poll | select | poll ]; epollæ¨¡å‹æ˜¯Linux 2.6ä»¥ä¸Šç‰ˆæœ¬å†…æ ¸ä¸­çš„é«˜æ€§èƒ½ç½‘ç»œI/Oæ¨¡å‹ï¼Œå¦‚æœè·‘åœ¨FreeBSDä¸Šé¢ï¼Œå°±ç”¨kqueueæ¨¡å‹ã€‚</span></div><div class="line">use epoll;</div><div class="line"><span class="comment">#å•ä¸ªè¿›ç¨‹æœ€å¤§è¿æ¥æ•°ï¼ˆæœ€å¤§è¿æ¥æ•°=è¿æ¥æ•°*è¿›ç¨‹æ•°ï¼‰</span></div><div class="line">worker_connections 65535;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#è®¾å®šhttpæœåŠ¡å™¨</span></div><div class="line">http</div><div class="line">&#123;</div><div class="line">include mime.types; <span class="comment">#æ–‡ä»¶æ‰©å±•åä¸æ–‡ä»¶ç±»å‹æ˜ å°„è¡¨</span></div><div class="line">default_type application/octet-stream; <span class="comment">#é»˜è®¤æ–‡ä»¶ç±»å‹</span></div><div class="line">include /usr/<span class="built_in">local</span>/nginx/conf/proxy.conf;  </div><div class="line"><span class="comment">#charset utf-8; #é»˜è®¤ç¼–ç </span></div><div class="line"></div><div class="line"><span class="comment"># log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span></div><div class="line"><span class="comment">#                      '$status $body_bytes_sent "$http_referer" '</span></div><div class="line"><span class="comment">#                      '"$http_user_agent" "$http_x_forwarded_for"';</span></div><div class="line"><span class="comment"># é»˜è®¤çš„nginxæ—¥å¿—æ ¼å¼                    </span></div><div class="line"></div><div class="line">server_names_hash_bucket_size 128; <span class="comment">#æœåŠ¡å™¨åå­—çš„hashè¡¨å¤§å°</span></div><div class="line">client_header_buffer_size 32k; <span class="comment">#ä¸Šä¼ æ–‡ä»¶å¤§å°é™åˆ¶</span></div><div class="line">large_client_header_buffers 4 64k; <span class="comment">#è®¾å®šè¯·æ±‚ç¼“</span></div><div class="line">client_max_body_size 8m; <span class="comment">#è®¾å®šè¯·æ±‚ç¼“</span></div><div class="line">sendfile on; <span class="comment">#å¼€å¯é«˜æ•ˆæ–‡ä»¶ä¼ è¾“æ¨¡å¼ï¼ŒsendfileæŒ‡ä»¤æŒ‡å®šnginxæ˜¯å¦è°ƒç”¨sendfileå‡½æ•°æ¥è¾“å‡ºæ–‡ä»¶ï¼Œå¯¹äºæ™®é€šåº”ç”¨è®¾ä¸º onï¼Œå¦‚æœç”¨æ¥è¿›è¡Œä¸‹è½½ç­‰åº”ç”¨ç£ç›˜IOé‡è´Ÿè½½åº”ç”¨ï¼Œå¯è®¾ç½®ä¸ºoffï¼Œä»¥å¹³è¡¡ç£ç›˜ä¸ç½‘ç»œI/Oå¤„ç†é€Ÿåº¦ï¼Œé™ä½ç³»ç»Ÿçš„è´Ÿè½½ã€‚æ³¨æ„ï¼šå¦‚æœå›¾ç‰‡æ˜¾ç¤ºä¸æ­£å¸¸æŠŠè¿™ä¸ªæ”¹æˆoffã€‚</span></div><div class="line">autoindex on; <span class="comment">#å¼€å¯ç›®å½•åˆ—è¡¨è®¿é—®ï¼Œåˆé€‚ä¸‹è½½æœåŠ¡å™¨ï¼Œé»˜è®¤å…³é—­ã€‚</span></div><div class="line">tcp_nopush on; <span class="comment">#é˜²æ­¢ç½‘ç»œé˜»å¡</span></div><div class="line">tcp_nodelay on; <span class="comment">#é˜²æ­¢ç½‘ç»œé˜»å¡</span></div><div class="line">keepalive_timeout 120; <span class="comment">#é•¿è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ˜¯ç§’</span></div><div class="line"><span class="comment">#keepalive è¶…æ—¶æ—¶é—´ï¼Œå®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯çš„è¿æ¥æŒç»­æœ‰æ•ˆæ—¶é—´å½“å‡ºç°å¯¹æœåŠ¡å™¨åï¼Œç»§ç»­è¯·æ±‚æ—¶keepalive_timeoutåŠŸèƒ½å¯é¿å…å»ºç«‹æˆ–è€…é‡æ–°ã€‚</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#FastCGIç›¸å…³å‚æ•°æ˜¯ä¸ºäº†æ”¹å–„ç½‘ç«™çš„æ€§èƒ½ï¼šå‡å°‘èµ„æºå ç”¨ï¼Œæé«˜è®¿é—®é€Ÿåº¦ã€‚ä¸‹é¢å‚æ•°çœ‹å­—é¢æ„æ€éƒ½èƒ½ç†è§£ã€‚</span></div><div class="line">fastcgi_connect_timeout 300;</div><div class="line">fastcgi_send_timeout 300;</div><div class="line">fastcgi_read_timeout 300;</div><div class="line">fastcgi_buffer_size 64k;</div><div class="line">fastcgi_buffers 4 64k;</div><div class="line">fastcgi_busy_buffers_size 128k;</div><div class="line">fastcgi_temp_file_write_size 128k;</div><div class="line"></div><div class="line"><span class="comment">#gzipæ¨¡å—è®¾ç½®</span></div><div class="line">gzip on; <span class="comment">#å¼€å¯gzipå‹ç¼©è¾“å‡º</span></div><div class="line">gzip_min_length 1k; <span class="comment">#æœ€å°å‹ç¼©æ–‡ä»¶å¤§å°</span></div><div class="line">gzip_buffers 4 16k; <span class="comment">#å‹ç¼©ç¼“å†²åŒº</span></div><div class="line">gzip_http_version 1.0; <span class="comment">#å‹ç¼©ç‰ˆæœ¬ï¼ˆé»˜è®¤1.1ï¼Œå‰ç«¯å¦‚æœæ˜¯squid2.5è¯·ä½¿ç”¨1.0ï¼‰</span></div><div class="line">gzip_comp_level 2; <span class="comment">#å‹ç¼©ç­‰çº§</span></div><div class="line">gzip_types text/plain application/x-javascript text/css application/xml;</div><div class="line"><span class="comment">#å‹ç¼©ç±»å‹ï¼Œé»˜è®¤å°±å·²ç»åŒ…å«text/htmlï¼Œæ‰€ä»¥ä¸‹é¢å°±ä¸ç”¨å†å†™äº†ï¼Œå†™ä¸Šå»ä¹Ÿä¸ä¼šæœ‰é—®é¢˜ï¼Œä½†æ˜¯ä¼šæœ‰ä¸€ä¸ªwarnã€‚</span></div><div class="line">gzip_vary on;</div><div class="line"><span class="comment">#limit_zone crawler $binary_remote_addr 10m; #å¼€å¯é™åˆ¶IPè¿æ¥æ•°çš„æ—¶å€™éœ€è¦ä½¿ç”¨</span></div><div class="line"></div><div class="line">upstream blog.yangcvo.com &#123;</div><div class="line"><span class="comment">#upstreamçš„è´Ÿè½½å‡è¡¡ï¼Œweightæ˜¯æƒé‡ï¼Œå¯ä»¥æ ¹æ®æœºå™¨é…ç½®å®šä¹‰æƒé‡ã€‚weigthå‚æ•°è¡¨ç¤ºæƒå€¼ï¼Œæƒå€¼è¶Šé«˜è¢«åˆ†é…åˆ°çš„å‡ ç‡è¶Šå¤§ã€‚</span></div><div class="line">server 192.168.80.121:80 weight=3 max_fails=2 fail_timeout=30s;</div><div class="line">server 192.168.80.122:80 weight=2 max_fails=2 fail_timeout=30s;</div><div class="line">server 192.168.80.123:80 weight=3 max_fails=2 fail_timeout=30s;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#è™šæ‹Ÿä¸»æœºçš„é…ç½®</span></div><div class="line">server</div><div class="line">&#123;</div><div class="line"><span class="comment">#ç›‘å¬ç«¯å£</span></div><div class="line">listen 80;</div><div class="line"><span class="comment">#åŸŸåå¯ä»¥æœ‰å¤šä¸ªï¼Œç”¨ç©ºæ ¼éš”å¼€</span></div><div class="line">server_name www.yangcvo.com ;   <span class="comment">##(æœåŠ¡å™¨å)</span></div><div class="line">index index.html index.htm index.php;</div><div class="line">root /data/www/ha97; </div><div class="line">location ~ .*\.(php|php5)?$</div><div class="line">&#123;</div><div class="line">fastcgi_pass 127.0.0.1:9000;</div><div class="line">fastcgi_index index.php;</div><div class="line">include fastcgi.conf;</div><div class="line">&#125;</div><div class="line"><span class="comment">#å›¾ç‰‡ç¼“å­˜æ—¶é—´è®¾ç½®</span></div><div class="line">location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$</div><div class="line">&#123;</div><div class="line">expires 10d;</div><div class="line">&#125;</div><div class="line"><span class="comment">#JSå’ŒCSSç¼“å­˜æ—¶é—´è®¾ç½®</span></div><div class="line">location ~ .*\.(js|css)?$</div><div class="line">&#123;</div><div class="line">expires 1h;</div><div class="line">&#125;</div><div class="line"><span class="comment">#æ—¥å¿—æ ¼å¼è®¾å®š</span></div><div class="line">log_format access <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></div><div class="line"><span class="string">'$status $body_bytes_sent "$http_referer" '</span></div><div class="line"><span class="string">'"$http_user_agent" $http_x_forwarded_for'</span>;</div><div class="line"><span class="comment">#å®šä¹‰æœ¬è™šæ‹Ÿä¸»æœºçš„è®¿é—®æ—¥å¿—</span></div><div class="line">access_log /var/<span class="built_in">log</span>/nginx/access.log access;</div><div class="line"></div><div class="line"><span class="comment">#å¯¹ "/" å¯ç”¨åå‘ä»£ç†</span></div><div class="line">location / &#123;</div><div class="line">proxy_pass http://127.0.0.1:88;</div><div class="line">proxy_redirect off;</div><div class="line">proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line"><span class="comment">#åç«¯çš„WebæœåŠ¡å™¨å¯ä»¥é€šè¿‡X-Forwarded-Forè·å–ç”¨æˆ·çœŸå®IP</span></div><div class="line">proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line"><span class="comment">#ä»¥ä¸‹æ˜¯ä¸€äº›åå‘ä»£ç†çš„é…ç½®ï¼Œå¯é€‰ã€‚</span></div><div class="line">proxy_set_header Host <span class="variable">$host</span>;</div><div class="line">client_max_body_size 10m; <span class="comment">#å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•°</span></div><div class="line">client_body_buffer_size 128k; <span class="comment">#ç¼“å†²åŒºä»£ç†ç¼“å†²ç”¨æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å­—èŠ‚æ•°ï¼Œ</span></div><div class="line">proxy_connect_timeout 90; <span class="comment">#nginxè·Ÿåç«¯æœåŠ¡å™¨è¿æ¥è¶…æ—¶æ—¶é—´(ä»£ç†è¿æ¥è¶…æ—¶)</span></div><div class="line">proxy_send_timeout 90; <span class="comment">#åç«¯æœåŠ¡å™¨æ•°æ®å›ä¼ æ—¶é—´(ä»£ç†å‘é€è¶…æ—¶)</span></div><div class="line">proxy_read_timeout 90; <span class="comment">#è¿æ¥æˆåŠŸåï¼Œåç«¯æœåŠ¡å™¨å“åº”æ—¶é—´(ä»£ç†æ¥æ”¶è¶…æ—¶)</span></div><div class="line">proxy_buffer_size 4k; <span class="comment">#è®¾ç½®ä»£ç†æœåŠ¡å™¨ï¼ˆnginxï¼‰ä¿å­˜ç”¨æˆ·å¤´ä¿¡æ¯çš„ç¼“å†²åŒºå¤§å°</span></div><div class="line">proxy_buffers 4 32k; <span class="comment">#proxy_buffersç¼“å†²åŒºï¼Œç½‘é¡µå¹³å‡åœ¨32kä»¥ä¸‹çš„è®¾ç½®</span></div><div class="line">proxy_busy_buffers_size 64k; <span class="comment">#é«˜è´Ÿè·ä¸‹ç¼“å†²å¤§å°ï¼ˆproxy_buffers*2ï¼‰</span></div><div class="line">proxy_temp_file_write_size 64k;</div><div class="line"><span class="comment">#è®¾å®šç¼“å­˜æ–‡ä»¶å¤¹å¤§å°ï¼Œå¤§äºè¿™ä¸ªå€¼ï¼Œå°†ä»upstreamæœåŠ¡å™¨ä¼ </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#è®¾å®šæŸ¥çœ‹NginxçŠ¶æ€çš„åœ°å€</span></div><div class="line">location /NginxStatus &#123;</div><div class="line">stub_status on;</div><div class="line">access_log on;</div><div class="line">auth_basic <span class="string">"NginxStatus"</span>;</div><div class="line">auth_basic_user_file conf/htpasswd;</div><div class="line"><span class="comment">#htpasswdæ–‡ä»¶çš„å†…å®¹å¯ä»¥ç”¨apacheæä¾›çš„htpasswdå·¥å…·æ¥äº§ç”Ÿã€‚</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#æœ¬åœ°åŠ¨é™åˆ†ç¦»åå‘ä»£ç†é…ç½®</span></div><div class="line"><span class="comment">#æ‰€æœ‰jspçš„é¡µé¢å‡äº¤ç”±tomcatæˆ–resinå¤„ç†</span></div><div class="line">location ~ .(jsp|jspx|<span class="keyword">do</span>)?$ &#123;</div><div class="line">proxy_set_header Host <span class="variable">$host</span>;</div><div class="line">proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line">proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">proxy_pass http://127.0.0.1:8080;</div><div class="line">&#125;</div><div class="line"><span class="comment">#æ‰€æœ‰é™æ€æ–‡ä»¶ç”±nginxç›´æ¥è¯»å–ä¸ç»è¿‡tomcatæˆ–resin</span></div><div class="line">location ~ .*.(htm|html|gif|jpg|jpeg|png|bmp|swf|ioc|rar|zip|txt|flv|mid|doc|ppt|pdf|xls|mp3|wma)$</div><div class="line">&#123; expires 15d; &#125;</div><div class="line">location ~ .*.(js|css)?$</div><div class="line">&#123; expires 1h; &#125;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line">user  www www;</div><div class="line">worker_processes  2;</div><div class="line"></div><div class="line">error_log  logs/error.log;</div><div class="line"><span class="comment">#error_log  logs/error.log  notice;</span></div><div class="line"><span class="comment">#error_log  logs/error.log  info;</span></div><div class="line"></div><div class="line">pid        logs/nginx.pid;</div><div class="line"></div><div class="line"></div><div class="line">events &#123;</div><div class="line">    use epoll;</div><div class="line">    worker_connections  65535;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">http &#123;</div><div class="line">    include       mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line">    include /usr/<span class="built_in">local</span>/nginx/conf/proxy.conf;</div><div class="line">    <span class="comment">#log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span></div><div class="line">    <span class="comment">#                  '$status $body_bytes_sent "$http_referer" '</span></div><div class="line">    <span class="comment">#                  '"$http_user_agent" "$http_x_forwarded_for"';</span></div><div class="line"></div><div class="line">    <span class="comment">#access_log  logs/access.log  main;</span></div><div class="line"></div><div class="line">    sendfile        on;</div><div class="line">    <span class="comment"># tcp_nopush     on;</span></div><div class="line"></div><div class="line">    keepalive_timeout  65;</div><div class="line"></div><div class="line">  <span class="comment"># gzipå‹ç¼©åŠŸèƒ½è®¾ç½®</span></div><div class="line">    gzip on;</div><div class="line">    gzip_min_length 1k;</div><div class="line">    gzip_buffers    4 16k;</div><div class="line">    gzip_http_version 1.0;</div><div class="line">    gzip_comp_level 6;</div><div class="line">    gzip_types text/html text/plain text/css text/javascript application/json application/javascript application/x-javascript application/xml;</div><div class="line">    gzip_vary on;</div><div class="line">  </div><div class="line">  <span class="comment"># http_proxy è®¾ç½®</span></div><div class="line">    client_max_body_size   10m;</div><div class="line">    client_body_buffer_size   128k;</div><div class="line">    proxy_connect_timeout   75;</div><div class="line">    proxy_send_timeout   75;</div><div class="line">    proxy_read_timeout   75;</div><div class="line">    proxy_buffer_size   4k;</div><div class="line">    proxy_buffers   4 32k;</div><div class="line">    proxy_busy_buffers_size   64k;</div><div class="line">    proxy_temp_file_write_size  64k;</div><div class="line">    proxy_temp_path   /usr/<span class="built_in">local</span>/nginx/proxy_temp 1 2;</div><div class="line"></div><div class="line">  <span class="comment"># è®¾å®šè´Ÿè½½å‡è¡¡åå°æœåŠ¡å™¨åˆ—è¡¨ </span></div><div class="line">    upstream  backend  &#123; </div><div class="line">              <span class="comment">#ip_hash; </span></div><div class="line">              server   192.168.10.100:8080 max_fails=2 fail_timeout=30s ;  </div><div class="line">              server   192.168.10.101:8080 max_fails=2 fail_timeout=30s ;  </div><div class="line">    &#125;</div><div class="line"></div><div class="line">  <span class="comment"># å¾ˆé‡è¦çš„è™šæ‹Ÿä¸»æœºé…ç½®</span></div><div class="line">    server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  itoatest.example.com;</div><div class="line">        root   /apps/oaapp;</div><div class="line"></div><div class="line">        charset utf-8;</div><div class="line">        access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">        <span class="comment">#å¯¹ / æ‰€æœ‰åšè´Ÿè½½å‡è¡¡+åå‘ä»£ç†</span></div><div class="line">        location / &#123;</div><div class="line">            root   /apps/oaapp;</div><div class="line">            index  index.jsp index.html index.htm;</div><div class="line"></div><div class="line">            proxy_pass        http://backend;  </div><div class="line">            proxy_redirect off;</div><div class="line">            <span class="comment"># åç«¯çš„WebæœåŠ¡å™¨å¯ä»¥é€šè¿‡X-Forwarded-Forè·å–ç”¨æˆ·çœŸå®IP</span></div><div class="line">            proxy_set_header  Host  <span class="variable">$host</span>;</div><div class="line">            proxy_set_header  X-Real-IP  <span class="variable">$remote_addr</span>;  </div><div class="line">            proxy_set_header  X-Forwarded-For  <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;</div><div class="line">            </div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">#é™æ€æ–‡ä»¶ï¼Œnginxè‡ªå·±å¤„ç†ï¼Œä¸å»backendè¯·æ±‚tomcat</span></div><div class="line">        location  ~* /download/ &#123;  </div><div class="line">            root /apps/oa/fs;  </div><div class="line">            </div><div class="line">        &#125;</div><div class="line">        location ~ .*\.(gif|jpg|jpeg|bmp|png|ico|txt|js|css)$   </div><div class="line">        &#123;   </div><div class="line">            root /apps/oaapp;   </div><div class="line">            expires      7d; </div><div class="line">        &#125;</div><div class="line">       	location /nginx_status &#123;</div><div class="line">            stub_status on;</div><div class="line">            access_log off;</div><div class="line">            allow 192.168.10.0/24;</div><div class="line">            deny all;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        location ~ ^/(WEB-INF)/ &#123;   </div><div class="line">            deny all;   </div><div class="line">        &#125;</div><div class="line">        <span class="comment">#error_page  404              /404.html;</span></div><div class="line"></div><div class="line">        <span class="comment"># redirect server error pages to the static page /50x.html</span></div><div class="line">        <span class="comment">#</span></div><div class="line">        error_page   500 502 503 504  /50x.html;</div><div class="line">        location = /50x.html &#123;</div><div class="line">            root   html;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>

	

	

</article>





	<span class="different-posts">ğŸ“– <a href="/page/11">more posts</a> ğŸ“–</span>



	</main>

	<footer class="footer">
	<div class="footer-content">
		
	      <div class="footer__element">
	<h5>Hi there,</h5>
	<p style="text-align:justify;">my name is Yancy, they know me as RadiantğŸ‘ğŸ‘. This blog is about Bi-data and my live.<br> I like ğŸŒ³ğŸŒ³ğŸŒ³</p>
</div>


	    
	      <div class="footer__element">
	<h5>Check out</h5>
	<ul class="footer-links">
		<li class="footer-links__link"><a href="/archives">Archive</a></li>
		
		  <li class="footer-links__link"><a href="/atom.xml">RSS</a></li>
	    
		<li class="footer-links__link"><a href="/about">about page</a></li>
		<li class="footer-links__link"><a href="/tags">Tags</a></li>
		<li class="footer-links__link"><a href="/categories">Categories</a></li>
	</ul>
</div>

	    

		<div class="footer-credit">
			<span>Â© 2019 Yancy | Powered by <a href="http://blog.yancy.cc/">Yancy</a> | Theme <a href="https://github.com/yangcvo">Yancy_GitHub</a></span>
		</div>

	</div>


</footer>



</body>

</html>
