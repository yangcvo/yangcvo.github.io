<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="theme-color" content="#33474d">
	<title>Yancy&#39;s blog</title>
	<link rel="stylesheet" href="/css/style.css" />
	
      <link rel="alternate" href="/atom.xml" title="Yancy&#39;s blog" type="application/atom+xml">
    
</head>

<body>

	<header class="header">
		<nav class="header__nav">
			
				<a href="/" class="header__link">Home</a>
			
				<a href="/tags" class="header__link">Tags</a>
			
				<a href="/archives" class="header__link">ARCHIVES</a>
			
				<a href="/about/About" class="header__link">ABOUT</a>
			
				<a href="http://weibo.com/yangcvo" class="header__link">Weibo</a>
			
				<a href="/atom.xml" class="header__link">RSS</a>
			
		</nav>
		<h1 class="header__title"><a href="/">Yancy&#39;s blog</a></h1>
		<h2 class="header__subtitle">SIMPLICITY IS PREREQUISITE FOR  RELIABILITY</h2>
	</header>

	<main>
		
	<span class="different-posts different-posts_earlier">📖 <a href="/page/8">earlier posts</a> 📖</span>




	<article>
	
		<h1><a href="/2016/03/09/自动化+Jenkins/Ansible/ansible小结(五)常用模块/">Ansible小结 (五) 常用模块</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-03-09</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/automation/">automation</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Ansible/">Ansible</a>
			</span>
		
	</div>

	

	
		<h1 id="ansible命令总结使用："><a href="#ansible命令总结使用：" class="headerlink" title="ansible命令总结使用："></a>ansible命令总结使用：</h1><p>在上一篇中介绍了commands部分模块，本篇承接上篇介绍下常用的模块。根据官方的分类，将模块按功能分类为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">云模块、命令模块、数据库模块、文件模块、资产模块、消息模块、监控模块、网络模块、通知模块、包管理模块、源码控制模块、系统模块、单元模块、web设施模块、windows模块</div></pre></td></tr></table></figure>
<p>具体可以参看<a href="http://docs.ansible.com/list_of_all_modules.html" target="_blank" rel="external">官方页面</a></p>
<p>这里从官方分类的模块里选择<code>最常用的一些模块</code>进行介绍（commands模块上一篇已经介绍，这里不再提）。</p>
<h3 id="一、ping模块"><a href="#一、ping模块" class="headerlink" title="一、ping模块"></a>一、ping模块</h3><h6 id="测试主机是否是通的，用法很简单，不涉及参数："><a href="#测试主机是否是通的，用法很简单，不涉及参数：" class="headerlink" title="测试主机是否是通的，用法很简单，不涉及参数："></a>测试主机是否是通的，用法很简单，不涉及参数：</h6><figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ansible tomcat_B1 -m <span class="built_in">ping</span></div><div class="line"></div><div class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible tomcat_C1 -m ping</span></div><div class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.177</span> | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="二、setup模块"><a href="#二、setup模块" class="headerlink" title="二、setup模块"></a>二、setup模块</h3><p>setup模块，主要用于获取主机信息，在playbooks里经常会用到的一个参数<code>gather_facts</code>就与该模块相关。setup模块下经常使用的一个参数是filter参数，具体使用示例如下（由于输出结果较多，这里只列命令不写结果）：</p>
<h6 id="查看主机内存信息"><a href="#查看主机内存信息" class="headerlink" title="查看主机内存信息"></a>查看主机内存信息</h6><figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible tomcat_C1 -m setup -a <span class="string">'filter=ansible_*_mb'</span></span></div></pre></td></tr></table></figure>
<h6 id="查看地接口为eth0-2的网卡信息"><a href="#查看地接口为eth0-2的网卡信息" class="headerlink" title="查看地接口为eth0-2的网卡信息"></a>查看地接口为eth0-2的网卡信息</h6><figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible tomcat_C1 -m setup -a <span class="string">'filter=ansible_eth[0-2]'</span> </span></div><div class="line">[root<span class="symbol">@ansible</span> ~]<span class="meta"># ansible all -m setup --tree /tmp/facts</span></div></pre></td></tr></table></figure>
<p>  //将所有主机的信息输入到/tmp/facts目录下，每台主机的信息输入到主机名文件中（/etc/ansible/hosts里的主机名）</p>
<h3 id="三、file模块"><a href="#三、file模块" class="headerlink" title="三、file模块"></a>三、file模块</h3><p>file模块主要用于远程主机上的文件操作，file模块包含如下选项： </p>
<ul>
<li>force：需要在两种情况下强制创建软链接，一种是源文件不存在但之后会建立的情况下；另一种是目标软链接已存在,需要先取消之前的软链，然后创建新的软链，有两个选项：yes|no </li>
<li>group：定义文件/目录的属组 </li>
<li>mode：定义文件/目录的权限</li>
<li>owner：定义文件/目录的属主</li>
<li>path：必选项，定义文件/目录的路径</li>
<li>recurse：递归的设置文件的属性，只对目录有效</li>
<li>src：要被链接的源文件的路径，只应用于state=link的情况</li>
<li>dest：被链接到的路径，只应用于state=link的情况 </li>
<li>state：  directory：如果目录不存在，创建目录</li>
<li>file：即使文件不存在，也不会被创建</li>
<li>link：创建软链接</li>
<li>hard：创建硬链接</li>
<li>touch：如果文件不存在，则会创建一个新的文件，如果文件或目录已存在，则更新其最后修改时间</li>
<li>absent：删除目录、文件或者取消链接文件<br>使用示例：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ansible <span class="built_in">test</span> -m file <span class="_">-a</span> <span class="string">"src=/etc/fstab dest=/tmp/fstab state=link"</span></div><div class="line">ansible <span class="built_in">test</span> -m file <span class="_">-a</span> <span class="string">"path=/tmp/fstab state=absent"</span></div><div class="line">ansible <span class="built_in">test</span> -m file <span class="_">-a</span> <span class="string">"path=/tmp/test state=touch"</span></div><div class="line">ansible <span class="built_in">test</span> -m file <span class="_">-a</span> <span class="string">"path=/tmp/test state=directory"</span> ansible <span class="built_in">test</span> -m file <span class="_">-a</span> <span class="string">"path=/tmp/testd state=directory owner=root group=root mode=777"</span></div></pre></td></tr></table></figure>
<h3 id="四、copy模块"><a href="#四、copy模块" class="headerlink" title="四、copy模块"></a>四、copy模块</h3><h5 id="复制文件到远程主机，copy模块包含如下选项："><a href="#复制文件到远程主机，copy模块包含如下选项：" class="headerlink" title="复制文件到远程主机，copy模块包含如下选项："></a>复制文件到远程主机，copy模块包含如下选项：</h5><ul>
<li><code>backup</code>：在覆盖之前将原文件备份，备份文件包含时间信息。有两个选项：yes|no </li>
<li><code>content</code>：用于替代”src”,可以直接设定指定文件的值 </li>
<li><code>dest</code>：必选项。要将源文件复制到的远程主机的绝对路径，如果源文件是一个目录，那么该路径也必须是个目录 </li>
<li><code>directory_mode</code>：递归的设定目录的权限，默认为系统默认权限</li>
<li><code>force</code>：如果目标主机包含该文件，但内容不同，如果设置为yes，则强制覆盖，如果为no，则只有当目标主机的目标位置不存在该文件时，才复制。默认为yes</li>
<li><code>others</code>：所有的file模块里的选项都可以在这里使用</li>
<li><code>src</code>：要复制到远程主机的文件在本地的地址，可以是绝对路径，也可以是相对路径。如果路径是一个目录，它将递归复制。在这种情况下，如果路径使用”/“来结尾，则只复制目录里的内容，如果没有使用”/“来结尾，则包含目录在内的整个内容全部复制，类似于rsync。 </li>
<li><code>validate</code>：The validation command to run before copying into place. The path to the file to validate is passed in via ‘%s’ which must be present as in the visudo example below.</li>
</ul>
<p>示例如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ansible test -m <span class="keyword">copy</span><span class="bash"> <span class="_">-a</span> <span class="string">"src=/srv/myfiles/foo.conf dest=/etc/foo.conf owner=foo group=foo mode=0644"</span></span></div><div class="line">ansible test -m <span class="keyword">copy</span><span class="bash"> <span class="_">-a</span> <span class="string">"src=/mine/ntp.conf dest=/etc/ntp.conf owner=root group=root mode=644 backup=yes"</span></span></div><div class="line">ansible test -m <span class="keyword">copy</span><span class="bash"> <span class="_">-a</span> <span class="string">"src=/mine/sudoers dest=/etc/sudoers validate='visudo -cf %s'"</span></span></div></pre></td></tr></table></figure>
<p>这里在举个例子：</p>
<p>目的：把主控端/opt/目录下面logstash.tar.gz文件拷贝到到指定节点上/srv/下面<br>    命令：<code>ansible cluster1:children -m copy -a &quot;src=/opt/logstash.tar.gz dest=/srv/. owner=root group=root mode=644&quot;</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">root@salt ~]<span class="comment"># ansible cluster1:children -m copy -a "src=/opt/logstash.tar.gz dest=/srv/. 10.47.59.190 | SUCCESS =&gt; &#123;</span></div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>,</div><div class="line">    <span class="string">"checksum"</span>: <span class="string">"9d15ea324f39d08cb379f59ffee9fa7ad2a62ab8"</span>,</div><div class="line">    <span class="string">"dest"</span>: <span class="string">"/srv/./logstash.tar.gz"</span>,</div><div class="line">    <span class="string">"gid"</span>: 0,</div><div class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>,</div><div class="line">    <span class="string">"md5sum"</span>: <span class="string">"c151602e79a336ca363928dea68d2567"</span>,</div><div class="line">    <span class="string">"mode"</span>: <span class="string">"0644"</span>,</div><div class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>,</div><div class="line">    <span class="string">"size"</span>: 84431108,</div><div class="line">    <span class="string">"src"</span>: <span class="string">"/root/.ansible/tmp/ansible-tmp-1483939085.93-201327709717575/source"</span>,</div><div class="line">    <span class="string">"state"</span>: <span class="string">"file"</span>,</div><div class="line">    <span class="string">"uid"</span>: 0</div><div class="line">&#125;</div><div class="line">10.47.106.105 | SUCCESS =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>,</div><div class="line">    <span class="string">"checksum"</span>: <span class="string">"9d15ea324f39d08cb379f59ffee9fa7ad2a62ab8"</span>,</div><div class="line">    <span class="string">"dest"</span>: <span class="string">"/srv/./logstash.tar.gz"</span>,</div><div class="line">    <span class="string">"gid"</span>: 0,</div><div class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>,</div><div class="line">    <span class="string">"md5sum"</span>: <span class="string">"c151602e79a336ca363928dea68d2567"</span>,</div><div class="line">    <span class="string">"mode"</span>: <span class="string">"0644"</span>,</div><div class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>,</div><div class="line">    <span class="string">"size"</span>: 84431108,</div><div class="line">    <span class="string">"src"</span>: <span class="string">"/root/.ansible/tmp/ansible-tmp-1483939088.11-46151538408374/source"</span>,</div><div class="line">    <span class="string">"state"</span>: <span class="string">"file"</span>,</div><div class="line">    <span class="string">"uid"</span>: 0</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="批量控制解压文件"><a href="#批量控制解压文件" class="headerlink" title="批量控制解压文件"></a>批量控制解压文件</h4><p>批量解压命令：</p>
<p><code>ansible cluster1:children -m shell -a  &quot;tar -zxvf /srv/logstash.tar.gz&quot; -C /srv/.</code></p>
<h3 id="五、yum模块"><a href="#五、yum模块" class="headerlink" title="五、yum模块"></a>五、yum模块</h3><h5 id="yum安装使用："><a href="#yum安装使用：" class="headerlink" title="yum安装使用："></a>yum安装使用：</h5><p>使用yum包管理器来管理软件包，其选项有： </p>
<ul>
<li>config_file：yum的配置文件 </li>
<li>disable_gpg_check：关闭gpg_check </li>
<li>disablerepo：不启用某个源 </li>
<li>enablerepo：启用某个源</li>
<li>name：要进行操作的软件包的名字，也可以传递一个url或者一个本地的rpm包的路径<br>state：状态（present，absent，latest）</li>
</ul>
<p>示例如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible tomcat_D1 <span class="_">-s</span> -m yum <span class="_">-a</span> <span class="string">"name=wget state=latest"</span></div></pre></td></tr></table></figure>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/ansible_02.png" alt=""></figure></p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@ansible playbook]# ansible tomcat_D1 -s -<span class="symbol">C</span> -m yum -a <span class="string">"name=kernel state=latest"</span></div><div class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.178</span> | <span class="symbol">SUCCESS</span> =&gt; &#123;</div><div class="line">    <span class="string">"changed"</span>: true,</div><div class="line">    <span class="string">"changes"</span>: &#123;</div><div class="line">        <span class="string">"installed"</span>: [],</div><div class="line">        <span class="string">"updated"</span>: [</div><div class="line">            [</div><div class="line">                <span class="string">"kernel"</span>,</div><div class="line">                <span class="string">"2.6.32-642.4.2.el6.x86_64 from updates"</span></div><div class="line">            ]</div><div class="line">        ]</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"msg"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"rc"</span>: <span class="number">0</span>,</div><div class="line">    <span class="string">"results"</span>: []</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="六-service模块"><a href="#六-service模块" class="headerlink" title="六 service模块"></a>六 service模块</h3><p>用于管理服务 该模块包含如下选项：</p>
<ul>
<li>arguments：给命令行提供一些选项 </li>
<li>enabled：是否开机启动 yes|no name：必选项，服务名称</li>
<li>pattern：定义一个模式，如果通过status指令来查看服务的状态时，没有响应，就会通过ps指令在进程中根据该模式进行查找，如果匹配到，则认为该服务依然在运行</li>
<li>runlevel：运行级别 </li>
<li>sleep：如果执行了restarted，在则stop和start之间沉睡几秒钟 </li>
<li>state：对当前服务执行启动，停止、重启、重新加载等操作（started,stopped,restarted,reloaded） </li>
</ul>
<p>示例如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ansible test -m service -<span class="selector-tag">a</span> <span class="string">"name=httpd state=started enabled=yes"</span> </div><div class="line">ansible test -m service -<span class="selector-tag">a</span> <span class="string">"name=foo pattern=/usr/bin/foo state=started"</span> </div><div class="line">ansible test -m service -<span class="selector-tag">a</span> <span class="string">"name=network state=restarted args=eth0"</span></div><div class="line">ansible cluster2:children -m service -<span class="selector-tag">a</span> <span class="string">"name=logstash pattern=/etc/init.d/logstash state=started"</span></div></pre></td></tr></table></figure>
<p>参考：<a href="http://www.361way.com/ansible-modules/4415.html" target="_blank" rel="external">http://www.361way.com/ansible-modules/4415.html</a></p>
<h3 id="七-shell-模块"><a href="#七-shell-模块" class="headerlink" title="七 shell 模块"></a>七 shell 模块</h3><p>这里我写个例子：</p>
<p>批量更改组的机器的用户名密码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@salt ansible]<span class="comment"># ansible cluster1:children -m shell -a "echo "Ihaozhuo" | passwd --stdin "root" "</span></div><div class="line">10.43.59.190 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">更改用户 root 的密码 。</div><div class="line">passwd： 所有的身份验证令牌已经成功更新。</div><div class="line"></div><div class="line">10.23.2.106 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">更改用户 root 的密码 。</div><div class="line">passwd： 所有的身份验证令牌已经成功更新。</div><div class="line"></div><div class="line">10.23.232.85 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">更改用户 root 的密码 。</div><div class="line">passwd： 所有的身份验证令牌已经成功更新。</div><div class="line"></div><div class="line">10.23.232.131 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">更改用户 root 的密码 。</div><div class="line">passwd： 所有的身份验证令牌已经成功更新。</div></pre></td></tr></table></figure>
<p>查看分组上机器所有端口：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">[root@salt ansible]<span class="comment"># ansible zk1:children -m shell -a "netstat -ntulp"</span></div><div class="line">10.37.238.75 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">Active Internet connections (only servers)</div><div class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</div><div class="line">tcp        0      0 0.0.0.0:2181                0.0.0.0:*                   LISTEN      12497/java</div><div class="line">tcp        0      0 0.0.0.0:56521               0.0.0.0:*                   LISTEN      12497/java</div><div class="line">tcp        0      0 0.0.0.0:22                  0.0.0.0:*                   LISTEN      1251/sshd</div><div class="line">tcp        0      0 0.0.0.0:4888                0.0.0.0:*                   LISTEN      12497/java</div><div class="line">tcp        0      0 127.0.0.1:15770             0.0.0.0:*                   LISTEN      1434/aegis_quartz</div><div class="line">udp        0      0 118.178.240.129:123         0.0.0.0:*                               1262/ntpd</div><div class="line">udp        0      0 10.27.238.75:123            0.0.0.0:*                               1262/ntpd</div><div class="line">udp        0      0 127.0.0.1:123               0.0.0.0:*                               1262/ntpd</div><div class="line">udp        0      0 0.0.0.0:123                 0.0.0.0:*                               1262/ntpd</div><div class="line"></div><div class="line">10.37.100.200 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">Active Internet connections (only servers)</div><div class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</div><div class="line">tcp        0      0 0.0.0.0:58367               0.0.0.0:*                   LISTEN      11232/java</div><div class="line">tcp        0      0 10.47.100.200:10050         0.0.0.0:*                   LISTEN      646/zabbix_agentd</div><div class="line">tcp        0      0 0.0.0.0:2181                0.0.0.0:*                   LISTEN      11232/java</div><div class="line">tcp        0      0 0.0.0.0:22                  0.0.0.0:*                   LISTEN      1243/sshd</div><div class="line">tcp        0      0 0.0.0.0:4888                0.0.0.0:*                   LISTEN      11232/java</div><div class="line">tcp        0      0 127.0.0.1:15770             0.0.0.0:*                   LISTEN      1436/aegis_quartz</div><div class="line">udp        0      0 120.27.152.77:123           0.0.0.0:*                               1254/ntpd</div><div class="line">udp        0      0 10.47.100.200:123           0.0.0.0:*                               1254/ntpd</div><div class="line">udp        0      0 127.0.0.1:123               0.0.0.0:*                               1254/ntpd</div><div class="line">udp        0      0 0.0.0.0:123                 0.0.0.0:*                               1254/ntpd</div></pre></td></tr></table></figure>
<p>shell 模块 可以用的最多。查看目录执行文件等等。</p>
<p>ansible修改线上服务器上的密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">ansible cluster1:children -m shell <span class="_">-a</span> <span class="string">"echo "</span>Ihaozhuo_b3314<span class="string">" | passwd --stdin "</span>root<span class="string">" "</span></div><div class="line"></div><div class="line">ansible cluster2:children -m shell <span class="_">-a</span> <span class="string">"echo "</span>Ihaozhuo_b3314<span class="string">" | passwd --stdin "</span>root<span class="string">" "</span></div><div class="line"></div><div class="line">ansible cluster3:children -m shell <span class="_">-a</span> <span class="string">"echo "</span>Ihaozhuo_b3314<span class="string">" | passwd --stdin "</span>root<span class="string">" "</span></div><div class="line"></div><div class="line">ansible zk1:children -m shell <span class="_">-a</span> <span class="string">"echo "</span>Ihaozhuo_b3314<span class="string">" | passwd --stdin "</span>root<span class="string">" "</span></div><div class="line"></div><div class="line">ansible  kafka1:children -m shell <span class="_">-a</span> <span class="string">"echo "</span>Ihaozhuo_b3314<span class="string">" | passwd --stdin "</span>root<span class="string">" "</span></div><div class="line"></div><div class="line">ansible  es1:children -m shell <span class="_">-a</span> <span class="string">"echo "</span>Ihaozhuo_b3314<span class="string">" | passwd --stdin "</span>root<span class="string">" "</span></div><div class="line"></div><div class="line">ansible  ihaozhuo1:children -m shell <span class="_">-a</span> <span class="string">"echo "</span>Ihaozhuo_b3314<span class="string">" | passwd --stdin "</span>root<span class="string">" "</span></div><div class="line"></div><div class="line">ansible  monitor1:children -m shell <span class="_">-a</span> <span class="string">"echo "</span>Ihaozhuo_b3314<span class="string">" | passwd --stdin "</span>root<span class="string">" "</span></div></pre></td></tr></table></figure>
<h2 id="2、Ansible-总结举例常用模块学习"><a href="#2、Ansible-总结举例常用模块学习" class="headerlink" title="2、Ansible 总结举例常用模块学习"></a>2、Ansible 总结举例常用模块学习</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">shell &gt; ansible-doc <span class="_">-l</span>    <span class="comment"># 列出 Ansible 支持的模块</span></div><div class="line">shell &gt; ansible-doc ping  <span class="comment"># 查看该模块帮助信息</span></div></pre></td></tr></table></figure>
<blockquote>
<p>远程命令模块（ command / raw / script / shell ）</p>
</blockquote>
<p>command 作为 Ansible 的默认模块，可以运行远程权限范围所有的 shell 命令，不支持管道符。</p>
<p>例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shell &gt; ansible Client -m <span class="built_in">command</span> <span class="_">-a</span> <span class="string">"free -m"</span>               <span class="comment"># 查看 Client 分组主机内存使用情况</span></div></pre></td></tr></table></figure>
<p>raw模块 [类似于command模块、支持管道传递]</p>
<p>例：</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible Client -m raw -a <span class="string">"ifconfig eth0 |sed -n 2p |awk '&#123;print \<span class="variable">$2</span>&#125;' |awk -F: '&#123;print \<span class="variable">$2</span>&#125;'"</span></div></pre></td></tr></table></figure>
<p>script 的功能是在远程主机执行主控端存储的 shell 脚本文件，相当于 scp + shell 组合。</p>
<p>例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shell &gt; ansible Client -m script <span class="_">-a</span> <span class="string">"/home/test.sh 12 34"</span>    <span class="comment"># 远程执行本地脚本</span></div></pre></td></tr></table></figure>
<p>shell 的功能是执行远程主机上的 shell 脚本文件，支持管道符。</p>
<p>例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shell &gt; ansible Client -m shell <span class="_">-a</span> <span class="string">"/home/test.sh"</span>           <span class="comment"># 执行远程脚本</span></div></pre></td></tr></table></figure>
<blockquote>
<p>copy 模块（实现主控端向目标主机拷贝文件，类似于 scp 功能）</p>
</blockquote>
<p>例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">shell &gt; ansible Client -m copy <span class="_">-a</span> <span class="string">"src=/home/test.sh desc=/tmp/ owner=root group=root mode=0755"</span>   </div><div class="line"><span class="comment"># 向 Client 组中主机拷贝 test.sh 到 /tmp 下，属主、组为 root ，权限为 0755</span></div></pre></td></tr></table></figure>
<blockquote>
<p>stat 模块（获取远程文件状态信息，atime/ctime/mtime/md5/uid/gid 等信息）</p>
</blockquote>
<p>例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shell &gt; ansible Client -m <span class="built_in">stat</span> <span class="_">-a</span> <span class="string">"path=/etc/syctl.conf"</span></div></pre></td></tr></table></figure>
<blockquote>
<p>get_url 模块（实现在远程主机下载指定 URL 到本地，支持 sha256sum 文件校验）</p>
</blockquote>
<p>例：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">shell</span><span class="bash"> &gt; ansible Client -m get_utl <span class="_">-a</span> <span class="string">"url=http://www.baidu.com dest=/tmp/index.html mode=0440 force=yes"</span></span></div></pre></td></tr></table></figure>
<blockquote>
<p>yum 模块（软件包管理）</p>
</blockquote>
<p>例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shell &gt; ansible Client -m yum <span class="_">-a</span> <span class="string">"name=curl state=latest"</span></div></pre></td></tr></table></figure>
<blockquote>
<p>cron 模块（远程主机 crontab 配置）</p>
</blockquote>
<p>例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">shell &gt; ansible Client -m cron <span class="_">-a</span> <span class="string">"name='check dirs' hour='5,2' job='ls -alh &gt; /dev/null'"</span></div><div class="line"></div><div class="line">效果：</div><div class="line"></div><div class="line"><span class="comment"># Ansible: check dirs</span></div><div class="line">* 5,2 * * * ls -alh &gt; /dev/null</div></pre></td></tr></table></figure>
<blockquote>
<p>mount 模块（远程主机分区挂载）</p>
</blockquote>
<p>例：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">shell</span><span class="bash"> &gt; ansible Client -m mount <span class="_">-a</span> <span class="string">"name=/mnt/data src=/dev/sd0 fstype=ext4 opts=ro state=present"</span></span></div></pre></td></tr></table></figure>
<blockquote>
<p>service 模块（远程主机系统服务管理）</p>
</blockquote>
<p>例：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">shell</span><span class="bash"> &gt; ansible Client -m service <span class="_">-a</span> <span class="string">"name=nginx state=stoped"</span></span></div><div class="line"><span class="keyword">shell</span><span class="bash"> &gt; ansible Client -m service <span class="_">-a</span> <span class="string">"name=nginx state=restarted"</span></span></div><div class="line"><span class="keyword">shell</span><span class="bash"> &gt; ansible Client -m service <span class="_">-a</span> <span class="string">"name=nginx state=reloaded"</span></span></div></pre></td></tr></table></figure>
<blockquote>
<p>user 服务模块（远程主机用户管理）</p>
</blockquote>
<p>例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">shell &gt; ansible Client -m user <span class="_">-a</span> <span class="string">"name=wang comment='user wang'"</span></div><div class="line">shell &gt; ansible Client -m user <span class="_">-a</span> <span class="string">"name=wang state=absent remove=yes"</span>    <span class="comment"># 添加删除用户</span></div></pre></td></tr></table></figure>

	

	

</article>




	<article>
	
		<h1><a href="/2016/03/07/自动化+Jenkins/Ansible/Ansible 小结（一）ansible的安装 /">Ansible 小结（一）ansible的安装</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-03-07</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/automation/">automation</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Ansible/">Ansible</a>
			</span>
		
	</div>

	

	
		<p>上一篇文章记录了解ansible,这篇大概记录下常规使用命令。</p>
<p>这里以CentOS Linux release 7.2.1511 (Core)系统为准。</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/ansible_03.png" alt=""></figure></p>
<h3 id="一、Ansible的安装"><a href="#一、Ansible的安装" class="headerlink" title="一、Ansible的安装"></a>一、Ansible的安装</h3><h4 id="Centos安装"><a href="#Centos安装" class="headerlink" title="Centos安装"></a>Centos安装</h4><p>1、yum源安装</p>
<p>以centos为例，默认在源里没有ansible，不过在fedora epel源里有ansible，配置完epel 源后，可以直接通过yum 进行安装。这里以centos6.8为例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">centos 6</div><div class="line"><span class="comment"># yum install http://mirrors.sohu.com/fedora-epel/6/x86_64/epel-release-6-8.noarch.rpm</span></div><div class="line"></div><div class="line">centos 7</div><div class="line"><span class="comment"># yum install http://mirrors.sohu.com/fedora-epel/7/x86_64/Packages/e/epel-release-7-11.noarch.rpm</span></div><div class="line"><span class="comment"># yum install -y ansible</span></div></pre></td></tr></table></figure>
<h4 id="Ubuntu安装"><a href="#Ubuntu安装" class="headerlink" title="Ubuntu安装"></a>Ubuntu安装</h4><p>2、apt-get安装</p>
<p>在ubuntu及其衍生版中，可以通过增加ppa源进行apt-get安装，具体如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install software-properties-common</span></div><div class="line"><span class="meta">$</span><span class="bash"> sudo apt-add-repository ppa:ansible/ansible</span></div><div class="line"><span class="meta">$</span><span class="bash"> sudo apt-get update</span></div><div class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install ansible</span></div></pre></td></tr></table></figure>
<p>3、源码安装</p>
<p>源码安装需要python2.6以上版本，其依赖模块paramiko、PyYAML、Jinja2、httplib2、simplejson、pycrypto模块，以上模块可以通过pip或easy_install 进行安装，不过本部分既然提到的是源码安装，主要针对的无法上外网的情况下，可以通过pypi 站点搜索以上包，下载后通过python setup.py install 进行安装。</p>
<p>最后通过github或pypi上下载ansible源码包，通过python setup.py install 安装即可。由于安装过程相对简单，这里略过，主要介绍安装后，可能遇到的问题。</p>
<p>a、安装PyYAML时，报错如下：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># python setup.py install</div><div class="line">libyaml is <span class="keyword">not</span> found <span class="keyword">or</span> a compiler error: forcing --without-libyaml</div><div class="line">(<span class="keyword">if</span> libyaml is installed correctly, you may need to</div><div class="line"> specify the <span class="keyword">option</span> --include-dirs <span class="keyword">or</span> uncomment <span class="keyword">and</span></div><div class="line"> modify the <span class="keyword">parameter</span> include_dirs <span class="comment">in setup.cfg)</span></div><div class="line">running <span class="comment">install_lib</span></div><div class="line">running <span class="comment">install_egg_info</span></div><div class="line">Removing /usr/<span class="comment">lib64</span>/python2<span class="number">.6</span>/<span class="comment">site-packages</span>/PyYAML<span class="number">-3.11</span>-py2<span class="number">.6</span>.egg-info</div><div class="line">Writing /<span class="comment">usr</span>/lib64/<span class="comment">python2.6</span>/site-packages/<span class="comment">PyYAML-3.11-py2.6.egg-info</span></div></pre></td></tr></table></figure>
<p>在centos6.8系统中，可以通过<code>yum -y install libyaml</code>包解决，或者从ISO文件中提供该包，通过rpm -ivh进行安装。</p>
<p>###二、Ansible的配置与验证</p>
<p>yum 安装使用默认示例配置文件后，编辑/etc/ansible/hosts文件，通过以下方式验证ansible是否可用：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@docker ~]# cat /etc/ansible/hosts</div><div class="line">[test]</div><div class="line"><span class="number">10.212</span><span class="number">.52</span><span class="number">.252</span> ansible_ssh_user=root ansible_ssh_pass=qwe123.com</div><div class="line"><span class="number">10.212</span><span class="number">.52</span><span class="number">.14</span> ansible_ssh_user=root ansible_ssh_pass=abc123</div><div class="line"><span class="number">10.212</span><span class="number">.52</span><span class="number">.16</span> ansible_ssh_user=root ansible_ssh_pass=<span class="number">91</span>it.org</div></pre></td></tr></table></figure>
<p>以上的配置中，我配置了一个test组，该组下有三台主机，三台都使用root验证，三台的密码分别是361way.com、abc123、91it.org 。</p>
<p>注：后面的用户和密码项是非必须的，在配置key认证的情况下，不使用密码也可以直接操作 。未使用key的，也可以在ansible通过 -k参数在操作前询问手动输入密码。</p>
<p>配置文件就是一般下目录的hosts文件。</p>
<p>在库存中，我们可以定义如下信息：</p>
<ul>
<li>主机地址</li>
<li>主机分组</li>
<li>连接属性（登录名，密码，秘钥，端口等）<br>1，主机地址和分组</li>
</ul>
<p>定义主机地址和名称比较简单：</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">[&lt;主机名&gt;]</span></div><div class="line">&lt;主机 IP&gt;</div></pre></td></tr></table></figure>
<p>定义分组的语法类似，就是在名字后加上:children，成员可以是主机名，也可以是分组名：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[<span class="tag">&lt;<span class="name">分组名</span>&gt;</span>:children]</div><div class="line"><span class="tag">&lt;<span class="name">主机名</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">分组名</span>&gt;</span></div></pre></td></tr></table></figure>
<p>2，连接属性</p>
<p>可以针对SSH连接指定一些参数：</p>
<ul>
<li><code>ansible_ssh_host</code>：主机名。</li>
<li><code>ansible_ssh_port</code>：SSH端口，默认22。</li>
<li><code>ansible_ssh_user</code>：登录用户。</li>
<li><code>ansible_ssh_pass</code>：登陆密码。</li>
<li><code>ansible_ssh_private_key_file</code>：私钥。</li>
</ul>
<p>通过私钥登陆的话，就不要指定登录密码了，主机名也可以忽略。当然，既然是使用私钥登陆，需要你确保已经在各个中主机的authorized_keys里添加了对应的公钥。</p>
<p>3，演示</p>
<p>完整的库存例子如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> -----------------</span></div><div class="line"><span class="meta">#</span><span class="bash"> 首先定义各个主机</span></div><div class="line"><span class="meta">#</span><span class="bash"> -----------------</span></div><div class="line"><span class="meta">#</span><span class="bash">============================01_version=============================<span class="comment">#</span></span></div><div class="line"></div><div class="line">[tomcat-account_01]</div><div class="line">  10.27.232.82</div><div class="line">[tomcat-point_01]</div><div class="line">  10.27.2.12</div><div class="line">[tomcat-system_01]</div><div class="line">   10.27.232.12</div><div class="line"> [tomcat-family_01]</div><div class="line">   10.27.230.63</div><div class="line"> [tomcat-mission_01]</div><div class="line">   10.47.59.12</div><div class="line"> [tomcat-card_01]</div><div class="line">   10.47.74.12</div><div class="line"> [tomcat-check_01]</div><div class="line">   10.47.107.153</div><div class="line">   </div><div class="line"><span class="meta">#</span><span class="bash"> -----------------</span></div><div class="line"><span class="meta">#</span><span class="bash"> 定义分组</span></div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line"><span class="meta">#</span><span class="bash"> 在这里我们定义了三个分组，分别名为：</span></div><div class="line"><span class="meta">#</span><span class="bash">   - cluster1</span></div><div class="line"><span class="meta">#</span><span class="bash">   - light</span></div><div class="line"><span class="meta">#</span><span class="bash">   - starwar</span></div><div class="line"><span class="meta">#</span><span class="bash"> -----------------</span></div><div class="line"></div><div class="line">[cluster1:children]</div><div class="line">tomcat-account_01</div><div class="line">tomcat-point_01</div><div class="line">tomcat-system_01</div><div class="line">tomcat-family_01</div><div class="line">tomcat-mission_01</div><div class="line"></div><div class="line">[light:children]</div><div class="line">tomcat-account_01</div><div class="line">tomcat-point_01</div><div class="line">tomcat-system_01</div><div class="line">tomcat-family_01</div><div class="line">tomcat-mission_01</div><div class="line"></div><div class="line">[starwar:children]</div><div class="line">tomcat-account_01</div><div class="line">tomcat-point_01</div><div class="line">tomcat-system_01</div><div class="line">tomcat-family_01</div><div class="line">tomcat-mission_01</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> -----------------</span></div><div class="line"><span class="meta">#</span><span class="bash"> 给分组定义变量</span></div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line"><span class="meta">#</span><span class="bash"> 这里我们给 starwar 组定义了变量 </span></div><div class="line"><span class="meta">#</span><span class="bash"> -----------------</span></div><div class="line">[cluster1:vars]</div><div class="line">ansible_ssh_port=7525</div><div class="line">ansible_ssh_user=lucas</div><div class="line">ansible_ssh_private_key_file=./ssh/id_rsa</div></pre></td></tr></table></figure>
<p>这里设置分组的时候名字不能与单台机器名称一样。比如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[tomcat-account_01]</div><div class="line">  10.27.232.82</div><div class="line">[tomcat-account_01:children]</div><div class="line">tomcat-account_01</div></pre></td></tr></table></figure>
<p>这里例子是错误的，会提示分组存在。</p>
<p>为了安全和方便在hosts里面就不需要写用户名和密码。<br>做个免秘钥登陆。<br>这里我自己对控制的机器全部做了免秘钥登陆，所以这里只需要这么写：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[redis1]</div><div class="line">192.168.1.173</div><div class="line"></div><div class="line">[redis2]</div><div class="line">192.168.1.174</div><div class="line"></div><div class="line">[tomcat_A1]</div><div class="line">192.168.1.175</div><div class="line"></div><div class="line">[tomcat_B1]</div><div class="line">192.168.1.176</div><div class="line"></div><div class="line">[tomcat_C1]</div><div class="line">192.168.1.177</div><div class="line"></div><div class="line">[tomcat_D1]</div><div class="line">192.168.1.178</div></pre></td></tr></table></figure>
<p>这里是执行脚本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible tomcat_D1 -m shell <span class="_">-a</span> <span class="string">"sh +x  /root/update/shoppingmall.sh"</span></div></pre></td></tr></table></figure>
<p>例子操作查看zk1分组上所有机器端口：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">[root@salt ansible]<span class="comment"># ansible zk1:children -m shell -a "netstat -ntulp"</span></div><div class="line">10.27.238.75 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">Active Internet connections (only servers)</div><div class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</div><div class="line">tcp        0      0 0.0.0.0:2181                0.0.0.0:*                   LISTEN      12497/java</div><div class="line">tcp        0      0 0.0.0.0:56521               0.0.0.0:*                   LISTEN      12497/java</div><div class="line">tcp        0      0 0.0.0.0:22                  0.0.0.0:*                   LISTEN      1251/sshd</div><div class="line">tcp        0      0 0.0.0.0:4888                0.0.0.0:*                   LISTEN      12497/java</div><div class="line">tcp        0      0 127.0.0.1:15770             0.0.0.0:*                   LISTEN      1434/aegis_quartz</div><div class="line">udp        0      0 118.178.240.129:123         0.0.0.0:*                               1262/ntpd</div><div class="line">udp        0      0 10.27.238.75:123            0.0.0.0:*                               1262/ntpd</div><div class="line">udp        0      0 127.0.0.1:123               0.0.0.0:*                               1262/ntpd</div><div class="line">udp        0      0 0.0.0.0:123                 0.0.0.0:*                               1262/ntpd</div><div class="line"></div><div class="line">10.47.100.200 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">Active Internet connections (only servers)</div><div class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</div><div class="line">tcp        0      0 0.0.0.0:58367               0.0.0.0:*                   LISTEN      11232/java</div><div class="line">tcp        0      0 10.47.100.200:10050         0.0.0.0:*                   LISTEN      646/zabbix_agentd</div><div class="line">tcp        0      0 0.0.0.0:2181                0.0.0.0:*                   LISTEN      11232/java</div><div class="line">tcp        0      0 0.0.0.0:22                  0.0.0.0:*                   LISTEN      1243/sshd</div><div class="line">tcp        0      0 0.0.0.0:4888                0.0.0.0:*                   LISTEN      11232/java</div><div class="line">tcp        0      0 127.0.0.1:15770             0.0.0.0:*                   LISTEN      1436/aegis_quartz</div><div class="line">udp        0      0 120.27.152.77:123           0.0.0.0:*                               1254/ntpd</div><div class="line">udp        0      0 10.47.100.200:123           0.0.0.0:*                               1254/ntpd</div><div class="line">udp        0      0 127.0.0.1:123               0.0.0.0:*                               1254/ntpd</div><div class="line">udp        0      0 0.0.0.0:123                 0.0.0.0:*                               1254/ntpd</div></pre></td></tr></table></figure>

	

	

</article>




	<article>
	
		<h1><a href="/2016/03/07/自动化+Jenkins/Ansible/ansible小结（二）ansible架构 /">Ansible小结（二）ansible架构</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-03-07</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/automation/">automation</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Ansible/">Ansible</a>
			</span>
		
	</div>

	

	
		<p>Ansible 是一个模型驱动的配置管理器，支持多节点发布、远程任务执行。默认使用 SSH 进行远程连接。无需在被管理节点上安装附加软件，可使用各种编程语言进行扩展。</p>
<p><figure class="figure"><img src="http://7xrthw.com1.z0.glb.clouddn.com/ansible_01.png" alt=""></figure></p>
<p>上图为ansible的基本架构，从上图可以了解到其由以下部分组成：</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">核心：ansible</div><div class="line">核心模块（Core <span class="keyword">Modules</span>）：这些都是ansible自带的模块 </div><div class="line">扩展模块（Custom <span class="keyword">Modules</span>）：如果核心模块不足以完成某种功能，可以添加扩展模块</div><div class="line">插件（Plugins）：完成模块功能的补充</div><div class="line">剧本（Playbooks）：ansible的任务配置文件，将多个任务定义在剧本中，由ansible自动执行</div><div class="line">连接插件（Connectior Plugins）：ansible基于连接插件连接到各个主机上，虽然ansible是使用ssh连接到各个主机的，但是它还支持其他的连接方法，所以需要有连接插件</div><div class="line">主机群（Host Inventory）：定义ansible管理的主机</div></pre></td></tr></table></figure>
<p>二、ansible工作原理</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> <span class="number">1</span>、管理端支持local 、ssh、zeromq 三种方式连接被管理端，默认使用基于ssh的连接－－－这部分对应基本架构图中的连接模块；</div><div class="line"></div><div class="line"><span class="number">2</span>、可以按应用类型等方式进行Host Inventory（主机群）分类，管理节点通过各类模块实现相应的操作－－－单个模块，单条命令的批量执行，我们可以称之为ad-hoc；</div><div class="line"></div><div class="line"><span class="number">3</span>、管理节点可以通过playbooks 实现多个task的集合实现一类功能，如web服务的安装部署、数据库服务器的批量备份等。playbooks我们可以简单的理解为，系统通过组合多条ad-hoc操作的配置文件 。</div></pre></td></tr></table></figure>
<h2 id="三、ansible的七个命令"><a href="#三、ansible的七个命令" class="headerlink" title="三、ansible的七个命令"></a>三、ansible的七个命令</h2><p>安装完ansible后，发现ansible一共为我们提供了七个指令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ansible</div><div class="line">ansible-doc</div><div class="line">ansible-galaxy</div><div class="line">ansible-lint</div><div class="line">ansible-playbook</div><div class="line">ansible-pull</div><div class="line">ansible-vault</div></pre></td></tr></table></figure>
<p>这里我们只查看usage部分，详细部分可以通过 “指令 -h”  的方式获取。</p>
<h4 id="1、ansible"><a href="#1、ansible" class="headerlink" title="1、ansible"></a>1、ansible</h4><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">[root@docker ~]# ansible -h</div><div class="line">Usage: ansible &lt;host-pattern&gt; [options]</div><div class="line">参数：</div><div class="line">  -<span class="ruby">a <span class="string">'Arguments'</span>, --args=<span class="string">'Arguments'</span> 命令行参数</span></div><div class="line">  -<span class="ruby">m NAME, --<span class="class"><span class="keyword">module</span>-<span class="title">name</span>=<span class="title">NAME</span> 执行模块的名字，默认使用 <span class="title">command</span> 模块，所以如果是只执行单一命令可以不用 -<span class="title">m</span>参数</span></span></div><div class="line">  -<span class="ruby">i PATH, --inventory=PATH 指定库存主机文件的路径,默认为/etc/ansible/hosts.</span></div><div class="line">  -<span class="ruby">u Username， --user=Username 执行用户，使用这个远程用户名而不是当前用户</span></div><div class="line">  -<span class="ruby">U --sud-user=SUDO_User  sudo到哪个用户，默认为 root</span></div><div class="line">  -<span class="ruby">k --ask-pass  登录密码，提示输入SSH密码而不是假设基于密钥的验证</span></div><div class="line">  -<span class="ruby">K --ask-sudo-pass 提示密码使用sudo</span></div><div class="line">  -<span class="ruby">s --sudo sudo运行</span></div><div class="line">  -<span class="ruby">S --su 用 su 命令</span></div><div class="line">  -<span class="ruby">l  --list 显示所支持的所有模块</span></div><div class="line">  -<span class="ruby">s --snippet 指定模块显示剧本片段</span></div><div class="line">  -<span class="ruby">f  --forks=NUM 并行任务数。NUM被指定为一个整数,默认是<span class="number">5</span>。 <span class="comment">#ansible testhosts -a "/sbin/reboot" -f 10 重启testhosts组的所有机器，每次重启10台</span></span></div><div class="line">  -<span class="ruby">-private-key=PRIVATE_KEY_FILE 私钥路径，使用这个文件来验证连接</span></div><div class="line">  -<span class="ruby">v --verbose 详细信息</span></div><div class="line">  all  针对hosts 定义的所有主机执行</div><div class="line">  -<span class="ruby">M MODULE_PATH, --<span class="class"><span class="keyword">module</span>-<span class="title">path</span>=<span class="title">MODULE_PATH</span> 要执行的模块的路径，默认为/<span class="title">usr</span>/<span class="title">share</span>/<span class="title">ansible</span>/</span></span></div><div class="line">  -<span class="ruby">-list-hosts 只打印有哪些主机会执行这个 playbook 文件，不是实际执行该 playbook 文件</span></div><div class="line">  -<span class="ruby">o --one-line 压缩输出，摘要输出.尝试一切都在一行上输出。</span></div><div class="line">  -<span class="ruby">t Directory, --tree=Directory 将内容保存在该输出目录,结果保存在一个文件中在每台主机上。</span></div><div class="line">  -<span class="ruby">B 后台运行超时时间</span></div><div class="line">  -<span class="ruby">P 调查后台程序时间</span></div><div class="line">  -<span class="ruby">T Seconds, --timeout=Seconds 时间，单位秒s</span></div><div class="line">  -<span class="ruby">P NUM, --poll=NUM 调查背景工作每隔数秒。需要- b</span></div><div class="line">  -<span class="ruby">c Connection, --connection=Connection  连接类型使用。可能的选项是paramiko(SSH),SSH和地方。当地主要是用于crontab或启动。</span></div><div class="line">  -<span class="ruby">-tags=TAGS 只执行指定标签的任务    例子<span class="symbol">:ansible-playbook</span> test.yml --tags=copy  只执行标签为copy的那个任务</span></div><div class="line">  -<span class="ruby">-list-hosts 只打印有哪些主机会执行这个 playbook 文件，不是实际执行该 playbook 文件</span></div><div class="line">  -<span class="ruby">-list-tasks 列出所有将被执行的任务</span></div><div class="line">  -<span class="ruby">C, --check 只是测试一下会改变什么内容，不会真正去执行;相反,试图预测一些可能发生的变化</span></div><div class="line">  -<span class="ruby">-syntax-check 执行语法检查的剧本,但不执行它</span></div><div class="line">  -<span class="ruby">l SUBSET, --limit=SUBSET 进一步限制所选主机/组模式  --limit=<span class="number">192.168</span>.<span class="number">0</span>.<span class="number">15</span> 只对这个ip执行</span></div><div class="line">  -<span class="ruby">-skip-tags=SKIP_TAGS 只运行戏剧和任务不匹配这些值的标签  --skip-tags=copy_start</span></div><div class="line">  -<span class="ruby">e EXTRA_VARS, --extra-vars=EXTRA_VARS  额外的变量设置为键=值或YAML / JSON</span></div><div class="line">        #cat update.yml</div><div class="line">        -<span class="ruby">--</span></div><div class="line">        -<span class="ruby"> <span class="symbol">hosts:</span> &#123;&#123; hosts &#125;&#125;</span></div><div class="line">          remote_user: &#123;&#123; user &#125;&#125;</div><div class="line">        ..............</div><div class="line">        #ansible-playbook update.yml --extra-vars "hosts=vipers user=admin"   传递&#123;&#123;hosts&#125;&#125;、&#123;&#123;user&#125;&#125;变量,hosts可以是 ip或组名</div><div class="line">  -<span class="ruby">l,--limit 对指定的 主机/组 执行任务  --limit=<span class="number">192.168</span>.<span class="number">0</span>.<span class="number">10</span>，<span class="number">192.168</span>.<span class="number">0</span>.<span class="number">11</span> 或 -l <span class="number">192.168</span>.<span class="number">0</span>.<span class="number">10</span>，<span class="number">192.168</span>.<span class="number">0</span>.<span class="number">11</span> 只对这个<span class="number">2</span>个ip执行任务</span></div></pre></td></tr></table></figure>
<h4 id="2、ansible-doc"><a href="#2、ansible-doc" class="headerlink" title="2、ansible-doc"></a>2、ansible-doc</h4><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@docker ~]# ansible-doc -h</div><div class="line">Usage: ansible-doc [options] [module...]</div><div class="line"></div><div class="line">Options:</div><div class="line">  -<span class="ruby">h, --help            show this help message <span class="keyword">and</span> exit</span></div><div class="line">  -<span class="ruby">l, --list            List available modules</span></div><div class="line">  -<span class="ruby">M MODULE_PATH, --<span class="class"><span class="keyword">module</span>-<span class="title">path</span>=<span class="title">MODULE_PATH</span></span></span></div><div class="line">                        specify path(s) to module library (default=None)</div><div class="line">  -<span class="ruby">s, --snippet         Show playbook snippet <span class="keyword">for</span> specified <span class="class"><span class="keyword">module</span>(<span class="title">s</span>)</span></span></div><div class="line">  -<span class="ruby">v, --verbose         verbose mode (-vvv <span class="keyword">for</span> more, -vvvv to enable</span></div><div class="line">                        connection debugging)</div><div class="line">  -<span class="ruby">-version             show program<span class="string">'s version number and exit</span></span></div></pre></td></tr></table></figure>
<p>该指令用于查看模块信息，常用参数有两个-l 和 -s ，具体如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//列出所有已安装的模块</div><div class="line"><span class="meta">#</span><span class="bash"> ansible-doc  <span class="_">-l</span></span></div><div class="line">//查看具体某模块的用法，这里如查看command模块</div><div class="line"><span class="meta">#</span><span class="bash"> ansible-doc  <span class="_">-s</span> <span class="built_in">command</span></span></div></pre></td></tr></table></figure>
<h4 id="3、ansible-galaxy"><a href="#3、ansible-galaxy" class="headerlink" title="3、ansible-galaxy"></a>3、ansible-galaxy</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@docker ~]# ansible-galaxy -h</div><div class="line">Usage: ansible-galaxy [<span class="keyword">delete</span>|import|info|init|install|<span class="keyword">list</span>|login|<span class="built_in">remove</span>|<span class="built_in">search</span>|setup] [--<span class="keyword">help</span>] [<span class="keyword">options</span>] ...</div><div class="line"></div><div class="line">Option<span class="variable">s:</span></div><div class="line">  -h, --<span class="keyword">help</span>     show this <span class="keyword">help</span> message <span class="built_in">and</span> <span class="keyword">exit</span></div><div class="line">  -v, --<span class="keyword">verbose</span>  <span class="keyword">verbose</span> <span class="keyword">mode</span> (-vvv <span class="keyword">for</span> more, -vvvv <span class="keyword">to</span> enable connection</div><div class="line">                 debugging)</div><div class="line">  --<span class="keyword">version</span>      show program<span class="string">'s version number and exit</span></div></pre></td></tr></table></figure>
<p>ansible-galaxy 指令用于方便的从<a href="https://galaxy.ansible.com/" target="_blank" rel="external">https://galaxy.ansible.com/</a> 站点下载第三方扩展模块，我们可以形象的理解其类似于centos下的yum、python下的pip或easy_install 。如下示例：</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]# ansible-galaxy install aeriscloud.docker</div><div class="line">-<span class="ruby"> downloading role <span class="string">'docker'</span>, owned by aeriscloud</span></div><div class="line">-<span class="ruby"> downloading role from <span class="symbol">https:</span>/<span class="regexp">/github.com/</span>AerisCloud/ansible-docker/archive/v1.<span class="number">0</span>.<span class="number">0</span>.tar.gz</span></div><div class="line">-<span class="ruby"> extracting aeriscloud.docker to /etc/ansible/roles/aeriscloud.docker</span></div><div class="line">-<span class="ruby"> aeriscloud.docker was installed successfully</span></div></pre></td></tr></table></figure>
<p>这个安装了一个aeriscloud.docker组件，前面aeriscloud是galaxy上创建该模块的用户名，后面对应的是其模块。在实际应用中也可以指定txt或yml 文件进行多个组件的下载安装。这部分可以参看官方文档。</p>
<p>这个安装了一个aeriscloud.docker组件，前面aeriscloud是galaxy上创建该模块的用户名，后面对应的是其模块。在实际应用中也可以指定txt或yml 文件进行多个组件的下载安装。这部分可以参看官方文档。</p>
<h4 id="4、ansible-lint"><a href="#4、ansible-lint" class="headerlink" title="4、ansible-lint"></a>4、ansible-lint</h4><p>ansible-lint是对playbook的语法进行检查的一个工具。用法是ansible-lint playbook.yml 。</p>
<h4 id="5、ansible-playbook"><a href="#5、ansible-playbook" class="headerlink" title="5、ansible-playbook"></a>5、ansible-playbook</h4><p>该指令是使用最多的指令，其通过读取playbook 文件后，执行相应的动作，这个后面会做为一个重点来讲。</p>
<h4 id="6、ansible-pull"><a href="#6、ansible-pull" class="headerlink" title="6、ansible-pull"></a>6、ansible-pull</h4><p>该指令使用需要谈到ansible的另一种模式－－－pull 模式，这和我们平常经常用的push模式刚好相反，其适用于以下场景：你有数量巨大的机器需要配置，即使使用非常高的线程还是要花费很多时间；你要在一个没有网络连接的机器上运行Anisble，比如在启动之后安装。这部分也会单独做一节来讲。</p>
<h4 id="7、ansible-vault"><a href="#7、ansible-vault" class="headerlink" title="7、ansible-vault"></a>7、ansible-vault</h4><p>ansible-vault主要应用于配置文件中含有敏感信息，又不希望他能被人看到，vault可以帮你加密/解密这个配置文件，属高级用法。主要对于playbooks里比如涉及到配置密码或其他变量时，可以通过该指令加密，这样我们通过cat看到的会是一个密码串类的文件，编辑的时候需要输入事先设定的密码才能打开。这种playbook文件在执行时，需要加上 –ask-vault-pass参数，同样需要输入密码后才能正常执行。具体该部分可以参查官方博客。</p>
<h4 id="注：上面七个指令，用的最多的只有两个ansible-和ansible-playbook-，这两个一定要掌握，其他五个属于拓展或高级部分。"><a href="#注：上面七个指令，用的最多的只有两个ansible-和ansible-playbook-，这两个一定要掌握，其他五个属于拓展或高级部分。" class="headerlink" title="注：上面七个指令，用的最多的只有两个ansible 和ansible-playbook ，这两个一定要掌握，其他五个属于拓展或高级部分。"></a>注：上面七个指令，用的最多的只有两个ansible 和ansible-playbook ，这两个一定要掌握，其他五个属于拓展或高级部分。</h4>
	

	

</article>




	<article>
	
		<h1><a href="/2016/03/07/自动化+Jenkins/Ansible/Ansible小结（三）ansible.cfg与默认配置 /">Ansible小结（三）ansible.cfg与默认配置</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-03-07</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/automation/">automation</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Ansible/">Ansible</a>
			</span>
		
	</div>

	

	
		<p>#Ansible小结（四）ansible.cfg与默认配置</p>
<p>Ansible默认安装好后有一个配置文件<code>/etc/ansible/ansible.cfg</code>，该配置文件中定义了ansible的主机的默认配置部分，如默认是否需要输入密码、是否开启sudo认证、action_plugins插件的位置、hosts主机组的位置、是否开启log功能、默认端口、key文件位置等等。</p>
<p>具体如下：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="section">[defaults]</span></div><div class="line"><span class="comment"># some basic default values...</span></div><div class="line"><span class="attr">hostfile</span>       = /etc/ansible/hosts   \\指定默认hosts配置的位置</div><div class="line"><span class="comment"># library_path = /usr/share/my_modules/</span></div><div class="line"><span class="attr">remote_tmp</span>     = <span class="variable">$HOME</span>/.ansible/tmp</div><div class="line"><span class="attr">pattern</span>        = *</div><div class="line"><span class="attr">forks</span>          = <span class="number">5</span></div><div class="line"><span class="attr">poll_interval</span>  = <span class="number">15</span></div><div class="line"><span class="attr">sudo_user</span>      = root  \\远程sudo用户</div><div class="line"><span class="comment">#ask_sudo_pass = True  \\每次执行ansible命令是否询问ssh密码</span></div><div class="line"><span class="comment">#ask_pass      = True  \\每次执行ansible命令时是否询问sudo密码</span></div><div class="line"><span class="attr">transport</span>      = smart</div><div class="line"><span class="attr">remote_port</span>    = <span class="number">22</span></div><div class="line"><span class="attr">module_lang</span>    = C</div><div class="line"><span class="attr">gathering</span> = implicit</div><div class="line"><span class="attr">host_key_checking</span> = <span class="literal">False</span>    \\关闭第一次使用ansible连接客户端是输入命令提示</div><div class="line"><span class="attr">log_path</span>    = /var/log/ansible.log \\需要时可以自行添加。chown -R root:root ansible.log</div><div class="line"><span class="attr">system_warnings</span> = <span class="literal">False</span>    \\关闭运行ansible时系统的提示信息，一般为提示升级</div><div class="line"><span class="comment"># set plugin path directories here, separate with colons</span></div><div class="line"><span class="attr">action_plugins</span>     = /usr/share/ansible_plugins/action_plugins</div><div class="line"><span class="attr">callback_plugins</span>   = /usr/share/ansible_plugins/callback_plugins</div><div class="line"><span class="attr">connection_plugins</span> = /usr/share/ansible_plugins/connection_plugins</div><div class="line"><span class="attr">lookup_plugins</span>     = /usr/share/ansible_plugins/lookup_plugins</div><div class="line"><span class="attr">vars_plugins</span>       = /usr/share/ansible_plugins/vars_plugins</div><div class="line"><span class="attr">filter_plugins</span>     = /usr/share/ansible_plugins/filter_plugins</div><div class="line"><span class="attr">fact_caching</span> = memory</div><div class="line"><span class="section">[accelerate]</span></div><div class="line"><span class="attr">accelerate_port</span> = <span class="number">5099</span></div><div class="line"><span class="attr">accelerate_timeout</span> = <span class="number">30</span></div><div class="line"><span class="attr">accelerate_connect_timeout</span> = <span class="number">5.0</span></div><div class="line"><span class="comment"># The daemon timeout is measured in minutes. This time is measured</span></div><div class="line"><span class="comment"># from the last activity to the accelerate daemon.</span></div><div class="line"><span class="attr">accelerate_daemon_timeout</span> = <span class="number">30</span></div></pre></td></tr></table></figure>
<p>在ansible.cfg配置文件中，也会找到如下部分：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># uncomment this to disable SSH key host checking</span></div><div class="line"><span class="attr">host_key_checking</span> = <span class="literal">False</span></div></pre></td></tr></table></figure>
<p>默认host_key_checking部分是注释的，通过找开该行的注释，同样也可以实现跳过 ssh 首次连接提示验证部分。</p>
<p>我这里做了免秘钥的查看日志如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@docker ~]<span class="comment"># ansible tomcat_C1 -a "uptime"</span></div><div class="line"><span class="meta">192.168.1.177 | SUCCESS | rc=0 &gt;</span>&gt;</div><div class="line"> 09<span class="symbol">:</span><span class="number">28</span><span class="symbol">:</span><span class="number">03</span> up <span class="number">24</span> days, <span class="number">15</span><span class="symbol">:</span><span class="number">39</span>,  <span class="number">4</span> users,  load <span class="symbol">average:</span> <span class="number">0</span>.<span class="number">00</span>, <span class="number">0</span>.<span class="number">00</span>, <span class="number">0</span>.<span class="number">00</span></div><div class="line"></div><div class="line">[root@docker ~]<span class="comment">#</span></div><div class="line">[root@docker ~]<span class="comment">#</span></div><div class="line">[root@docker ~]<span class="comment">#  cat /var/log/ansible.log</span></div><div class="line"><span class="number">2016</span>-09-<span class="number">05</span> 09<span class="symbol">:</span><span class="number">19</span><span class="symbol">:</span><span class="number">23</span>,<span class="number">235</span> p=<span class="number">1412</span> u=root <span class="params">|  ERROR! Missing target hosts</span></div><div class="line">2016-09-05 09:19:54,580 p=1417 u=root |  <span class="number">192.168</span>.<span class="number">1.177</span> <span class="params">| SUCCESS |</span> rc=<span class="number">0</span> <span class="meta">&gt;&gt;</span></div><div class="line"> 09<span class="symbol">:</span><span class="number">20</span><span class="symbol">:</span><span class="number">24</span> up <span class="number">24</span> days, <span class="number">15</span><span class="symbol">:</span><span class="number">31</span>,  <span class="number">4</span> users,  load <span class="symbol">average:</span> <span class="number">0</span>.<span class="number">00</span>, <span class="number">0</span>.<span class="number">00</span>, <span class="number">0</span>.<span class="number">00</span></div><div class="line"></div><div class="line"><span class="number">2016</span>-09-<span class="number">05</span> 09<span class="symbol">:</span><span class="number">20</span><span class="symbol">:</span><span class="number">07</span>,<span class="number">206</span> p=<span class="number">1440</span> u=root <span class="params">|  192.168.1.177 |</span> SUCCESS <span class="params">| rc=0 &gt;&gt;</span></div><div class="line"> 09:20:37 up 24 days, 15:31,  4 users,  load average: 0.00, 0.00, 0.00</div><div class="line"></div><div class="line">2016-09-05 09:27:31,607 p=1460 u=root |  <span class="number">192.168</span>.<span class="number">1.177</span> <span class="params">| SUCCESS |</span> rc=<span class="number">0</span> <span class="meta">&gt;&gt;</span></div><div class="line"> 09<span class="symbol">:</span><span class="number">28</span><span class="symbol">:</span><span class="number">01</span> up <span class="number">24</span> days, <span class="number">15</span><span class="symbol">:</span><span class="number">39</span>,  <span class="number">4</span> users,  load <span class="symbol">average:</span> <span class="number">0</span>.<span class="number">00</span>, <span class="number">0</span>.<span class="number">00</span>, <span class="number">0</span>.<span class="number">00</span></div><div class="line"></div><div class="line"><span class="number">2016</span>-09-<span class="number">05</span> 09<span class="symbol">:</span><span class="number">27</span><span class="symbol">:</span><span class="number">33</span>,<span class="number">800</span> p=<span class="number">1482</span> u=root <span class="params">|  192.168.1.177 |</span> SUCCESS <span class="params">| rc=0 &gt;&gt;</span></div><div class="line"> 09:28:03 up 24 days, 15:39,  4 users,  load average: 0.00, 0.00, 0.00</div></pre></td></tr></table></figure>
<p>更多部分可以参看<a href="http://docs.ansible.com/intro_configuration.html" target="_blank" rel="external">官方文档</a></p>

	

	

</article>




	<article>
	
		<h1><a href="/2016/03/07/自动化+Jenkins/Ansible/ Ansible 学习入门 /">Ansible 学习入门</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-03-07</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/automation/">automation</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Ansible/">Ansible</a>
			</span>
		
	</div>

	

	
		<h1 id="Ansible介绍"><a href="#Ansible介绍" class="headerlink" title="Ansible介绍"></a>Ansible介绍</h1><hr>
<p><strong>学习ansible这里我自己做了简单的介绍总结：</strong></p>
<p>Ansible是一个自动化工具。它可以配置系统,部署软件,编排更高级的任务,比如连续部署或零停机时间滚动更新。</p>
<p>Ansible的目标是最简单和最易用。它也有一个强烈关注安全性和可靠性,以最少的移动部件,使用OpenSSH运输(加速插座模式和拉模式选择),和设计语言,人类可审核性的——甚至是那些不熟悉程序。</p>
<p>我们认为简单是所有大小的环境和相关的设计对于忙碌的所有类型的用户——这是否意味着开发人员、系统管理员,发布工程师,经理,无处不在。Ansible适合管理小设置少量的实例以及与许多成千上万的企业环境。</p>
<p>Ansible管理机器以最好的方式。没有一个问题如何升级远程守护进程或无法管理系统的问题因为守护进程是卸载。OpenSSH是最同行评议的开源组件,使用该工具的安全风险大大降低。Ansible是分散的,它依赖于现有的操作系统凭证来控制访问远程机器,如果需要使用Kerberos,它可以很容易地连接LDAP和其他管理系统的集中式身份验证。</p>
<p>Ansible是一个彻底的简单自动化引擎,自动化云配置,配置管理、应用程序部署,intra-service编排,以及许多其他的需求。</p>
<p>被设计为多层部署自第一天,Ansible模型你的IT基础设施,描述如何推动你所有的系统,而不仅仅是管理一个系统。</p>
<p>它使用没有代理,没有额外的自定义安全基础设施,所以很容易部署,最重要的是,它使用一个非常简单的语言(YAML Ansible Playbooks的形式),让你描述你的自动化工作的方式方法简明英语。</p>
<p>我们利用Ansible主要是作为内网服务器的一些管理，因为他用ssh来管理配置，内网同学还是很快速的，外网主要是利用Saltstack，利用消息队列远程通信，我感觉是比Ansible好的。</p>
<p><strong>为什么选择ansible</strong></p>
<p>Ansible大家都知道，和salt/puppet等一样，是一款配置管理工具。为什么选择它，就是因为它简单，不需要安装agent，只要服务器能用ssh访问，就可以使用它去管理大家如果要问，和我用rsync直接同步或写个for循环执行rpm或yum有什么区别.</p>
<p>我想最大的区别应该就是“并发”<br><strong>当然，大企业会自己去开发自己的持续部署平台，而大部分的还是中小型企业</strong></p>
<p>其实部署每个环节都可以用rpm安装发布。</p>
<p>我们的某个应用直接构建成rpm，是直接放到我们另一个内部服务器中，提供http接口，然后执行的就是yum模块进行安装。</p>
<p>也有人问我salt有没有用过。其实我们最初是使用salt的，后来因为网络的原因，选择了没有agent的ansible。在阿里云上面还是salt去服务管理。</p>
<p> 参考官网<a href="https://www.ansible.com/quick-start-video" target="_blank" rel="external">入门学习视频</a></p>

	

	

</article>




	<article>
	
		<h1><a href="/2016/02/14/个人生活记录/在一起的第588天💕/">在一起的第588天💕</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-02-14</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/生活/">生活</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Personal-life-record/">Personal life record</a>
			</span>
		
	</div>

	

	
		<h3 id="今天2016年2月14日我们的第二个情人节："><a href="#今天2016年2月14日我们的第二个情人节：" class="headerlink" title="今天2016年2月14日我们的第二个情人节："></a>今天2016年2月14日我们的第二个情人节：</h3><p>夜已经很深了，我还坐在电脑前写信给你,慢慢把我们在一起点点滴滴记录下来,这些天总是有很多话想对你说,但对你的思念扰乱了我所有的思绪。我不知道该说些什么或怎么说？说心里话，和你的每一天我很快乐很幸福，是我一生中从未有过的！真的XXL。<br><img src="http://7xrthw.com1.z0.glb.clouddn.com/IMG_0200.JPG" alt=""></p>
		<p><a class="article__read-more-link" href="/2016/02/14/个人生活记录/在一起的第588天💕/">...read more</a></p>
	

	

</article>




	<article>
	
		<h1><a href="/2016/01/30/日志分析平台/Elasticsearch/Elasticsearch5.x版本的索引定时自动清理和检测进程状态自动启动/">Elasticsearch5.x版本的索引定时自动清理和检测进程状态自动启动</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-01-30</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/Log-Analysis-Platform/">Log Analysis Platform</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Elasticsearch/">Elasticsearch</a>
			</span>
		
	</div>

	

	
		<h1 id="elasticsearch的索引定时自动清理"><a href="#elasticsearch的索引定时自动清理" class="headerlink" title="elasticsearch的索引定时自动清理"></a>elasticsearch的索引定时自动清理</h1><p>之前用 logstash来做日志收集 并用 elasticsearch来搜索，因为日志没有进行过滤，没几天就发现elasticsearch的索引文件大的吓人，之前还真没清理过。其实要说清理也简单，直接到 elasticsearch data文件夹里删掉就行了，写个脚本定期清理集群es的日志数据。</p>
<p>这里我清理1月7号的。</p>
<p>这里后面是索引名称。<br>app_error-2017.01.07</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@es_01 sh]<span class="comment"># curl -XDELETE 'http://10.47.88.206:9200/app_error-2017.01.07'</span></div><div class="line">&#123;<span class="string">"acknowledged"</span>:<span class="literal">true</span>&#125;[root@es_01 sh]<span class="comment">#</span></div></pre></td></tr></table></figure>
<p>shell 7天清理一次数据写在计划任务里面：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line">now=`date +%Y%m%d`</div><div class="line"><span class="built_in">echo</span> <span class="variable">$now</span></div><div class="line">days_07_before=`date <span class="_">-d</span> <span class="string">"<span class="variable">$now</span> 7 days ago"</span> +%Y.%m.%d`</div><div class="line"><span class="built_in">echo</span> <span class="variable">$days_07_before</span></div><div class="line">curl -XDELETE <span class="string">"http://<span class="variable">$(hostname)</span>:9200/log-spm-product-<span class="variable">$days_07_before</span>"</span>  &gt; /dev/null 2&gt;&amp;1</div><div class="line">curl -XDELETE <span class="string">"http://<span class="variable">$(hostname)</span>:9200/log-dataexport-product-<span class="variable">$days_07_before</span>"</span>  &gt; /dev/null 2&gt;&amp;1</div></pre></td></tr></table></figure>
<p>计划任务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">10 0 * * * /opt/sh/logstash-null.sh</div></pre></td></tr></table></figure>
<p>官网：<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/doc-exists.html" target="_blank" rel="external">检查状态是否存在</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">检查文档是否存在编辑</div><div class="line">如果只想检查一个文档是否存在 --根本不想关心内容--那么用 HEAD 方法来代替 GET 方法。 HEAD 请求没有返回体，只返回一个 HTTP 请求报头：</div><div class="line"></div><div class="line">curl -i -XHEAD http://localhost:9200/website/blog/123</div><div class="line">如果文档存在， Elasticsearch 将返回一个 200 ok 的状态码：</div><div class="line"></div><div class="line">HTTP/1.1 200 OK</div><div class="line">Content-Type: text/plain; charset=UTF-8</div><div class="line">Content-Length: 0</div><div class="line">若文档不存在， Elasticsearch 将返回一个 404 Not Found 的状态码：</div><div class="line"></div><div class="line">curl -i -XHEAD http://localhost:9200/website/blog/124</div><div class="line">HTTP/1.1 404 Not Found</div><div class="line">Content-Type: text/plain; charset=UTF-8</div><div class="line">Content-Length: 0</div><div class="line">当然，一个文档仅仅是在检查的时候不存在，并不意味着一毫秒之后它也不存在：也许同时正好另一个进程就创建了该文档。</div></pre></td></tr></table></figure>
<h4 id="自动检测es端口状态如何不存在启动"><a href="#自动检测es端口状态如何不存在启动" class="headerlink" title="自动检测es端口状态如何不存在启动"></a>自动检测es端口状态如何不存在启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">vim /bin/whole51/es_poss.sh</div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="built_in">source</span> /etc/profile</div><div class="line">curl -Is <span class="string">"10.11.10.26:9200"</span> | grep -q <span class="string">'HTTP/1.1 200 OK'</span> || su - elasticsearch -c <span class="string">"/usr/local/elasticsearch-5.5.2/bin/elasticsearch -d"</span></div><div class="line">curl -Is <span class="string">"10.11.10.26:5601"</span> | grep -q <span class="string">'HTTP/1.1 200 OK'</span> ||  /usr/<span class="built_in">local</span>/kibana-5.5.2/bin/kibana &amp;</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">*/2 * * * * /bin/whole51/es.sh</div></pre></td></tr></table></figure>
<h3 id="交流学习："><a href="#交流学习：" class="headerlink" title="交流学习："></a>交流学习：</h3><p>🐧  Linux shell_高级运维派: <code>459096184</code>    圈子 (系统运维-应用运维-自动化运维-虚拟化技术研究欢迎加入)<br>🐧  BigData-Exchange School : <code>521621407</code>  圈子（大数据运维)（Hadoop开发人员)（大数据研究爱好者) 欢迎加入</p>
<p>相应Bidata有内部微信交流群互相学习，加入QQ群有链接。</p>

	

	

</article>




	<article>
	
		<h1><a href="/2016/01/29/日志分析平台/Elasticsearch/logstash如何收集tomcat日志分析/">logstash如何写tomcat,redis,nginx日志收集规则</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2016-01-29</span><br />
		
			<span class="article__category">
				<a class="article-category-link" href="/categories/Log-Analysis-Platform/">Log Analysis Platform</a>
			</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-link" href="/tags/Log-analysis-platform/">Log analysis platform</a>
			</span>
		
	</div>

	

	
		<h5 id="logstash如何收集tomcat日志分析（可以参考我下面写的模板）"><a href="#logstash如何收集tomcat日志分析（可以参考我下面写的模板）" class="headerlink" title="logstash如何收集tomcat日志分析（可以参考我下面写的模板）"></a>logstash如何收集tomcat日志分析（可以参考我下面写的模板）</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">我想实现对tomcat的日志采集，正常应该创建一个file的input，这个input指定了监听的文件或者目录....然后过滤器（如果没有特殊要求，先可以不进行解析，原始的日志直接存就行）....最后使用一个elastcisearch插件，发送到es中去.</div><div class="line"></div><div class="line">input &#123;</div><div class="line">        stdin&#123;&#125;</div><div class="line"></div><div class="line">        file &#123;</div><div class="line">                <span class="built_in">type</span> =&gt; <span class="string">"tomcat_card"</span></div><div class="line">                path =&gt; <span class="string">"/srv/tomcat/logs/card/*.log"</span></div><div class="line">                start_position =&gt; <span class="string">"beginning"</span></div><div class="line">        &#125;</div><div class="line">        file &#123;</div><div class="line">                <span class="built_in">type</span> =&gt; <span class="string">"tomcat_family"</span></div><div class="line">                path =&gt; <span class="string">"/srv/tomcat/logs/family/*.log"</span></div><div class="line">                start_position =&gt; <span class="string">"beginning"</span></div><div class="line"></div><div class="line">        &#125;</div><div class="line">        file &#123;</div><div class="line">                <span class="built_in">type</span> =&gt; <span class="string">"tomcat_mission"</span></div><div class="line">                path =&gt; <span class="string">"/srv/tomcat/logs/mission/*.log"</span></div><div class="line">                start_position =&gt; <span class="string">"beginning"</span></div><div class="line"></div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">filter &#123;</div><div class="line"></div><div class="line">        grok &#123;</div><div class="line">                match =&gt; [</div><div class="line">                                <span class="string">"message"</span>, <span class="string">"%&#123;TIMESTAMP_ISO8601:logdate&#125; %&#123;WORD:loglevel&#125;%&#123;SPACE&#125;%&#123;NOTSPACE:loggername&#125; - %&#123;GREEDYDATA:msg&#125;"</span>,</div><div class="line">                                <span class="string">"message"</span>, <span class="string">"%&#123;GREEDYDATA:msg&#125;"</span></div><div class="line">                         ]</div><div class="line"></div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">output&#123;</div><div class="line">        <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"tomcat_card"</span> &#123;</div><div class="line">        elasticsearch &#123;</div><div class="line">                host =&gt; <span class="string">"192.168.1.234"</span></div><div class="line">                protocol =&gt; <span class="string">"http"</span></div><div class="line">                index   =&gt; <span class="string">"tomcat_card-%&#123;+YYYYY.MM.dd&#125;"</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line">        <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"tomcat_family"</span> &#123;</div><div class="line">        elasticsearch &#123;</div><div class="line">                host =&gt; <span class="string">"192.168.1.234"</span></div><div class="line">                protocol =&gt; <span class="string">"http"</span></div><div class="line">                index   =&gt; <span class="string">"tomcat_card-%&#123;+YYYYY.MM.dd&#125;"</span></div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"tomcat_mission"</span> &#123;</div><div class="line">        elasticsearch &#123;</div><div class="line">                host =&gt; <span class="string">"192.168.1.234"</span></div><div class="line">                protocol =&gt; <span class="string">"http"</span></div><div class="line">                index   =&gt; <span class="string">"tomcat_mission-%&#123;+YYYYY.MM.dd&#125;"</span></div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="logstash日志采集nginx配置"><a href="#logstash日志采集nginx配置" class="headerlink" title="logstash日志采集nginx配置"></a>logstash日志采集nginx配置</h5><p>/etc/logstash/conf.d/nginx.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">file &#123;</div><div class="line">path =&gt; <span class="string">"/data/wwwlogs/nginx_json.log"</span></div><div class="line">codec =&gt; <span class="string">"json"</span></div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">filter &#123;</div><div class="line">mutate &#123;</div><div class="line">split =&gt; [ <span class="string">"upstreamtime"</span>, <span class="string">","</span> ]</div><div class="line">&#125;</div><div class="line">mutate &#123;</div><div class="line">convert =&gt; [ <span class="string">"upstreamtime"</span>, <span class="string">"float"</span> ]</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">output &#123;</div><div class="line">kafka &#123;</div><div class="line">bootstrap_servers =&gt; <span class="string">"10.0.0.11:9092"</span></div><div class="line">topic_id =&gt; <span class="string">"logstash"</span></div><div class="line">compression_type =&gt; <span class="string">"gzip"</span></div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="创建一个从日志文件读取，并写入redis的配置文件-本文件采用默认方式进行输入，输出"><a href="#创建一个从日志文件读取，并写入redis的配置文件-本文件采用默认方式进行输入，输出" class="headerlink" title="创建一个从日志文件读取，并写入redis的配置文件(本文件采用默认方式进行输入，输出)"></a>创建一个从日志文件读取，并写入redis的配置文件(本文件采用默认方式进行输入，输出)</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#cat agent.conf</span></div><div class="line">input &#123;</div><div class="line">    file &#123;</div><div class="line">        path =&gt; <span class="string">"/var/log/httpd/access_log"</span>    //设置读取的日志路径</div><div class="line">        sincedb_path =&gt; <span class="string">"../.sincedb"</span></div><div class="line">        <span class="built_in">type</span> =&gt; <span class="string">"httpd"</span></div><div class="line">        start_position =&gt; <span class="string">"beginning"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">output &#123;</div><div class="line">    redis &#123;</div><div class="line">        host =&gt; [<span class="string">"127.0.0.1"</span>]</div><div class="line">        port =&gt; 6379</div><div class="line">        batch =&gt; <span class="literal">true</span></div><div class="line">            batch_events =&gt; 5</div><div class="line">            data_type =&gt; <span class="string">"list"</span></div><div class="line">            key =&gt; <span class="string">"logstash:redis"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">配置一个从redis读取日志并输出到es的配置文件</div><div class="line"></div><div class="line"><span class="comment">#cat index.conf</span></div><div class="line">input &#123;</div><div class="line">  redis &#123;</div><div class="line">    host =&gt; [<span class="string">"127.0.0.1"</span>]</div><div class="line">    port =&gt; 6379</div><div class="line">    data_type =&gt; <span class="string">"list"</span></div><div class="line">    key =&gt; “<span class="built_in">log</span> stash:redis<span class="string">"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">output &#123;</div><div class="line">        elasticsearch &#123;</div><div class="line">        host =&gt; "127.0.0.1<span class="string">"</span></div><div class="line">        protocol =&gt; "http<span class="string">"</span></div><div class="line">        index =&gt; "logstash-%&#123;<span class="built_in">type</span>&#125;-%&#123;+YYYY.MM.dd&#125;<span class="string">"</span></div><div class="line">        index_type =&gt; "%&#123;<span class="built_in">type</span>&#125;<span class="string">"</span></div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">启动logstash</div></pre></td></tr></table></figure>
<h3 id="交流学习："><a href="#交流学习：" class="headerlink" title="交流学习："></a>交流学习：</h3><p>🐧  Linux shell_高级运维派: <code>459096184</code>    圈子 (系统运维-应用运维-自动化运维-虚拟化技术研究欢迎加入)<br>🐧  BigData-Exchange School : <code>521621407</code>  圈子（大数据运维)（Hadoop开发人员)（大数据研究爱好者) 欢迎加入</p>
<p>相应Bidata有内部微信交流群互相学习，加入QQ群有链接。</p>

	

	

</article>





	<span class="different-posts">📖 <a href="/page/10">more posts</a> 📖</span>



	</main>

	<footer class="footer">
	<div class="footer-content">
		
	      <div class="footer__element">
	<h5>Hi there,</h5>
	<p style="text-align:justify;">my name is Yancy, they know me as Radiant🐑🐑. This blog is about Bi-data and my live.<br> I like 🌳🌳🌳</p>
</div>


	    
	      <div class="footer__element">
	<h5>Check out</h5>
	<ul class="footer-links">
		<li class="footer-links__link"><a href="/archives">Archive</a></li>
		
		  <li class="footer-links__link"><a href="/atom.xml">RSS</a></li>
	    
		<li class="footer-links__link"><a href="/about">about page</a></li>
		<li class="footer-links__link"><a href="/tags">Tags</a></li>
		<li class="footer-links__link"><a href="/categories">Categories</a></li>
	</ul>
</div>

	    

		<div class="footer-credit">
			<span>© 2017 Yancy | Powered by <a href="http://blog.yancy.cc/">Yancy</a> | Theme <a href="https://github.com/yangcvo">Yancy_GitHub</a></span>
		</div>

	</div>


</footer>



</body>

</html>
