
 <!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  
    <title>Bigdata-ZooKeeper集群快速搭建与优化 | Yancy&#39;s blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="Yancy">
    
    <meta name="description" content="ZooKeeper集群快速搭建与优化之前搞过了hadoop和spark，hue，现在在弄下zookeeper集群，文档就整理下。本文是ZooKeeper的快速搭建,旨在帮助大家以最快的速度完成一个ZK集群的搭建,以便开展其它工作。
集群：本文使用了3台机器部署ZooKeeper集群，IP和主机名对应">
    
    
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="yangaov" />
    <meta name="twitter:title" content="Bigdata-ZooKeeper集群快速搭建与优化 | Yancy&#39;s blog" />
      
    
    
    <link rel="alternate" href="atom.xml" title="Yancy&#39;s blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="Yancy&#39;s blog" title="Yancy&#39;s blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Yancy&#39;s blog">Yancy&#39;s blog</a></h1>
				<h2 class="blog-motto">SIMPLICITY IS PREREQUISITE FOR  RELIABILITY</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/sitemap.xml">Sitemap</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:blog.yancy.cc">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/05/26/Bigdata-hadoop/zookeeper/Bigdata-ZooKeeper集群快速搭建与优化/" title="Bigdata-ZooKeeper集群快速搭建与优化" itemprop="url">Bigdata-ZooKeeper集群快速搭建与优化</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://blog.yancy.cc" title="Yancy">Yancy</a>
    </p>
  <p class="article-time">
    <time datetime="2017-05-26T06:46:00.000Z" itemprop="datePublished">2017-05-26</time>
    更新日期:<time datetime="2017-09-19T08:36:29.000Z" itemprop="dateModified">2017-09-19</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#ZooKeeper集群快速搭建与优化"><span class="toc-number">1.</span> <span class="toc-text">ZooKeeper集群快速搭建与优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#集群："><span class="toc-number"></span> <span class="toc-text">集群：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装说明"><span class="toc-number">1.</span> <span class="toc-text">安装说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-etc-hosts"><span class="toc-number">2.</span> <span class="toc-text">配置/etc/hosts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step1"><span class="toc-number">3.</span> <span class="toc-text">Step1:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step2"><span class="toc-number">4.</span> <span class="toc-text">Step2:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step3"><span class="toc-number">5.</span> <span class="toc-text">Step3:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建maid"><span class="toc-number">6.</span> <span class="toc-text">创建maid:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step4"><span class="toc-number">7.</span> <span class="toc-text">Step4:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step5"><span class="toc-number">8.</span> <span class="toc-text">Step5:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step6"><span class="toc-number">9.</span> <span class="toc-text">Step6:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#链接测试"><span class="toc-number">10.</span> <span class="toc-text">链接测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step7"><span class="toc-number">11.</span> <span class="toc-text">Step7:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step8-如何扩容zookeeper？"><span class="toc-number">12.</span> <span class="toc-text">Step8: 如何扩容zookeeper？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设置开机自动启动"><span class="toc-number">13.</span> <span class="toc-text">设置开机自动启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#报错-占用端口："><span class="toc-number">14.</span> <span class="toc-text">报错 占用端口：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#报错-启动服务正常。"><span class="toc-number">15.</span> <span class="toc-text">报错: 启动服务正常。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#走kafka查看是否所有节点都启动："><span class="toc-number">16.</span> <span class="toc-text">走kafka查看是否所有节点都启动：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step9-相关文档"><span class="toc-number">17.</span> <span class="toc-text">Step9: 相关文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step10-结束语"><span class="toc-number">18.</span> <span class="toc-text">Step10:  结束语</span></a></li></ol>
		</div>
		
		<h3 id="ZooKeeper集群快速搭建与优化"><a href="#ZooKeeper集群快速搭建与优化" class="headerlink" title="ZooKeeper集群快速搭建与优化"></a>ZooKeeper集群快速搭建与优化</h3><p>之前搞过了hadoop和spark，hue，现在在弄下zookeeper集群，文档就整理下。<br>本文是<code>ZooKeeper</code>的快速搭建,旨在帮助大家以最快的速度完成一个<code>ZK</code>集群的搭建,以便开展其它工作。</p>
<h2 id="集群："><a href="#集群：" class="headerlink" title="集群："></a>集群：</h2><p>本文使用了3台机器部署ZooKeeper集群，IP和主机名对应关系如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">IP            主机名</div><div class="line">10.46.72.172  namenode</div><div class="line">10.47.88.103  datenode1</div><div class="line">10.47.88.206  datenode2</div></pre></td></tr></table></figure>
<h3 id="安装说明"><a href="#安装说明" class="headerlink" title="安装说明"></a>安装说明</h3><p><code>Zookeeper</code>机器间不需要设置免密码登录，其它hadoop也可以不设置，只要不使用hadoop-daemons.sh来启动、停止进程，注意不是hadoop-daemon.sh，而是带“s”的那个，带“s”的会读取hadoop的salves文件，远程ssh启动DataNode和备NameNode等。</p>
<h3 id="配置-etc-hosts"><a href="#配置-etc-hosts" class="headerlink" title="配置/etc/hosts"></a>配置/etc/hosts</h3><p>将3台机器的IP和主机名映射关系，在3台机器上都配置一下，亦即在3台机器的/etc/hosts文件中，均增加以下内容（可以先配置好一台，然后通过scp等命令复制到其它机器上，注意主机名不能包含任何下划线）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">127.0.0.1 localhost  namenode</div><div class="line">::1        localhost localhost.localdomain localhost6 localhost6.localdomain6</div><div class="line">10.47.100.90 salt</div><div class="line">10.46.72.172  namenode</div><div class="line">10.47.88.103 datenode1</div><div class="line">10.47.88.206 datenode2</div><div class="line">10.47.102.137 datenode3</div></pre></td></tr></table></figure>
<h3 id="Step1"><a href="#Step1" class="headerlink" title="Step1:"></a>Step1:</h3><p>配置 JAVA 环境。检验方法:执行 <code>java –version</code> 和 <code>javac –version</code> 命令。</p>
<p>下载并解压 <code>zookeeper</code>。<a href="http://mirror.bjtu.edu.cn/apache/zookeeper/zookeeper-3.4.3/" target="_blank" rel="external">链接一</a> ，<a href="http://www-eu.apache.org/dist/zookeeper/" target="_blank" rel="external">链接二</a> (更多版本:<a href="http://dwz.cn/37HGI" target="_blank" rel="external">http://dwz.cn/37HGI</a>)</p>
<h3 id="Step2"><a href="#Step2" class="headerlink" title="Step2:"></a>Step2:</h3><p>2.zookeeper的环境变量的配置：<br>为了今后操作方便，我们需要对Zookeeper的环境变量进行配置，方法如下：<br>在/etc/profile文件中加入如下的内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#set zookeeper environment</span></div><div class="line"></div><div class="line"><span class="built_in">export</span> ZOOKEEPER_HOME=/srv/hadoop/zookeeper-3.3.6</div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$ZOOKEEPER_HOME</span>/bin:<span class="variable">$ZOOKEEPER_HOME</span>/conf</div></pre></td></tr></table></figure>
<h3 id="Step3"><a href="#Step3" class="headerlink" title="Step3:"></a>Step3:</h3><p>下载以后解压到我自己新建的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[hadoop@namenode ~]$ tar -zxvf zookeeper-3.3.6.tar.gz -C /srv/hadoop/</div><div class="line">[hadoop@namenode ]$ <span class="built_in">cd</span> /srv/hadoop/zookeeper-3.3.6/conf/</div></pre></td></tr></table></figure>
<p>将<code>zoo_sample.cfg</code>拷贝一份命名为<code>zoo.cfg</code>,这里我拷贝一份命名为：<code>zoo.cfg</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[hadoop@namenode conf]$ cp -r zoo_sample.cfg zoo.cfg</div></pre></td></tr></table></figure>
<p>这里先创建/data和/logs 这两个目录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir -p /srv/hadoop/zookeeper-3.3.6/zookeeper/data</div><div class="line">mkdir -p /srv/hadoop/zookeeper-3.3.6/zookeeper/logs</div></pre></td></tr></table></figure>
<p>注意上图的配置中master，slave1分别为主机名。</p>
<p>在上面的配置文件中<code>&quot;server.id=host:port:port&quot;</code>中的第一个port是从机器<code>（follower）</code>连接到主机器<code>（leader）</code>的端口号，第二个port是进行leadership选举的端口号。</p>
<p>修改配置：</p>
<p><code>vi zoo.cfg</code>，修改有的默认存在，添加红色的内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">tickTime=2000</div><div class="line"></div><div class="line">clientPort=2181</div><div class="line"></div><div class="line">initLimit=10</div><div class="line"></div><div class="line">syncLimit=5</div><div class="line">maxClientCnxns=0 这个是设置连接数0没有做限制</div><div class="line">dataDir=/haozhuo/hadoop/zookeeper-3.3.6/zookeeper/data</div><div class="line">dataLogDir=/haozhuo/hadoop/zookeeper-3.3.6/zookeeper/logs</div><div class="line"></div><div class="line">server.0=namenode:2888:3888</div><div class="line">server.1=datanode1:2888:3888</div><div class="line">server.2=datanode2:2888:3888</div></pre></td></tr></table></figure>
<h3 id="创建maid"><a href="#创建maid" class="headerlink" title="创建maid:"></a>创建maid:</h3><p>这里所有节点都需要创建。<br>接下来在<code>dataDir</code>所指定的目录下创建一个文件名为<code>myid</code>的文件，文件中的内容只有一行，为本主机对应的id值，也就是上图中server.id中的id。例如：在服务器1中的myid的内容应该写入1。<br>创建myid：在<code>zoo.cfg</code>配置文件中的dataDir的目录下面创建<code>myid</code>，每个节点myid要求不一样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /srv/hadoop/zookeeper-3.3.6/zookeeper/data</div><div class="line">touch myid</div></pre></td></tr></table></figure>
<h3 id="Step4"><a href="#Step4" class="headerlink" title="Step4:"></a>Step4:</h3><p>远程复制分发安装文件<br>最好是把文件打包scp过去<br>接下来将上面的安装文件拷贝到集群中的其他机器上对应的目录下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">haduser@master:~/zookeeper$ scp -r zookeeper-3.4.5/ slave1:/srv/hadoop/</div><div class="line"></div><div class="line">haduser@master:~/zookeeper$ scp -r zookeeper-3.4.5/ slave2:/srv/hadoop/</div></pre></td></tr></table></figure>
<p>拷贝完成后修改对应的机器上的myid。例如修改slave1中的myid如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">haduser@slave1:~/zookeeper/zookeeper-3.4.5$ <span class="built_in">echo</span> <span class="string">"2"</span> &gt; data/myid</div><div class="line">haduser@slave1:~/zookeeper/zookeeper-3.4.5$ cat data/myid</div><div class="line">[hadoop@namenode hadoop]$ <span class="built_in">echo</span> 0 &gt; /haozhuo/hadoop/zookeeper-3.3.6/zookeeper/data/myid</div><div class="line">[hadoop@datanode1 hadoop]$ <span class="built_in">echo</span> 1 &gt; /haozhuo/hadoop/zookeeper-3.3.6/zookeeper/data/myid</div><div class="line">[hadoop@datanode2 hadoop]$ <span class="built_in">echo</span> 2 &gt; /haozhuo/hadoop/zookeeper-3.3.6/zookeeper/data/myid</div></pre></td></tr></table></figure>
<h3 id="Step5"><a href="#Step5" class="headerlink" title="Step5:"></a>Step5:</h3><p>启动 ZooKeeper集群<br>在ZooKeeper集群的每个结点上，执行启动ZooKeeper服务的脚本，如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">hadoop@namenode:~ /srv/hadoop/zookeeper-3.3.6/bin/zkServer.sh start</div><div class="line">hadoop@datanode1:~ /srv/hadoop/zookeeper-3.3.6/bin/zkServer.sh start</div><div class="line">haduser@datanode2:~ /srv/hadoop/zookeeper-3.3.6/bin/zkServer.sh start</div></pre></td></tr></table></figure>
<p>执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/haozhuo/hadoop/zookeeper-3.3.6/bin/zkServer.sh start</div></pre></td></tr></table></figure>
<h3 id="Step6"><a href="#Step6" class="headerlink" title="Step6:"></a>Step6:</h3><p>检测是否成功启动:执行 <code>jps</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">24933 QuorumPeerMain</div></pre></td></tr></table></figure>
<p>其中，QuorumPeerMain是zookeeper进程，启动正常。</p>
<p><code>./zkServer.sh status</code> 查看当前运行状态。</p>
<p>namenode1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[hadoop@namenode zookeeper-3.3.6]<span class="comment"># ./zkServer.sh status</span></div><div class="line">JMX enabled by default</div><div class="line">Using config: /srv/zookeeper-3.3.6/bin/../conf/zoo.cfg</div><div class="line">Mode: follower</div><div class="line"></div><div class="line">[hadoop@datanode1 zookeeper-3.3.6]<span class="comment"># ./bin/zkServer.sh status</span></div><div class="line">JMX enabled by default</div><div class="line">Using config: /srv/zookeeper-3.3.6/bin/../conf/zoo.cfg</div><div class="line">Mode: leader</div><div class="line"></div><div class="line">[hadoop@datanode2 zookeeper-3.3.6]<span class="comment"># ./bin/zkServer.sh status</span></div><div class="line">JMX enabled by default</div><div class="line">Using config: /srv/zookeeper-3.3.6/bin/../conf/zoo.cfg</div><div class="line">Mode: leader</div></pre></td></tr></table></figure>
<h3 id="链接测试"><a href="#链接测试" class="headerlink" title="链接测试"></a>链接测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">bin/zkCli.sh -server 127.0.0.1:2181</div><div class="line">bin/zkCli.sh -server 127.0.0.1:2181</div><div class="line">bin/zkCli.sh -server 127.0.0.1:2181</div></pre></td></tr></table></figure>
<h3 id="Step7"><a href="#Step7" class="headerlink" title="Step7:"></a>Step7:</h3><p>如果单台可以其他几台不行，看配置，如果没有问题。启动查看状态出现异常。</p>
<p>异常解决:<code>Error contacting service. It is probably not running.</code></p>
<p>而其他一个节点却是现实正常;</p>
<p>先<code>stop</code> 掉原<code>zk</code></p>
<p><code>./bin/zkServer.sh stop</code></p>
<p>然后以start-foreground方式启动，会看到启动日志</p>
<p><code>./bin/zkServer.sh start</code></p>
<p>当出现问题的时候，记得查看日志zookeeper.out，在你配置的dataDir（在conf/zoo.cfg中查看）目录下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">2015-12-29 11:09:38,034 [myid:1] - WARN  [WorkerSender[myid=1]:QuorumCnxManager@400] - Cannot open channel to 3 at election address Node2/10.0.0.102:38888</div><div class="line">java.net.ConnectException: 拒绝连接</div><div class="line">        at java.net.PlainSocketImpl.socketConnect(Native Method)</div><div class="line">        at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:339)</div><div class="line">        at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:200)</div><div class="line">        at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:182)</div><div class="line">        at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)</div><div class="line">        at java.net.Socket.connect(Socket.java:579)</div><div class="line">        at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:381)</div><div class="line">        at org.apache.zookeeper.server.quorum.QuorumCnxManager.toSend(QuorumCnxManager.java:354)</div><div class="line">        at org.apache.zookeeper.server.quorum.FastLeaderElection<span class="variable">$Messenger</span><span class="variable">$WorkerSender</span>.process(FastLeaderElection.java:452)</div><div class="line">        at org.apache.zookeeper.server.quorum.FastLeaderElection<span class="variable">$Messenger</span><span class="variable">$WorkerSender</span>.run(FastLeaderElection.java:433)</div><div class="line">        at java.lang.Thread.run(Thread.java:745)</div></pre></td></tr></table></figure>
<p>可以看到是连接到Node2的3888端口不通（我配置文件设置的节点端口，server.3=Node2:2888:3888），这样就找到问题了，所以当遇到问题的时候记得查看日志文件，这才是最有帮助的，而不是修改什么nc参数。</p>
<p>这里主要看下是否加入hosts</p>
<p>查看Node2节点发现，38888端口绑带到127.0.0.1上了，这让Master节点怎么连接呀，只需修改/etc/hosts文件即可，同理，修改Node1，然后重启zookeeper，发现问题解决。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">127.0.0.1 localhost  namenode</div><div class="line">::1        localhost localhost.localdomain localhost6 localhost6.localdomain6</div><div class="line">10.47.100.90 salt</div><div class="line">10.46.72.172  namenode</div><div class="line">10.47.88.103 datenode1</div><div class="line">10.47.88.206 datenode2</div><div class="line">10.47.102.137 datenode3</div></pre></td></tr></table></figure>
<p>这里我<code>127.0.0.1 localhost namenode</code> 就可以了。</p>
<h3 id="Step8-如何扩容zookeeper？"><a href="#Step8-如何扩容zookeeper？" class="headerlink" title="Step8: 如何扩容zookeeper？"></a>Step8: 如何扩容zookeeper？</h3><p>只需要将已有的zookeeper打包复制到新的机器上，然后修改myid文件并设置好，然后启动zookeeper即可。</p>
<hr>
<h3 id="设置开机自动启动"><a href="#设置开机自动启动" class="headerlink" title="设置开机自动启动"></a>设置开机自动启动</h3><p>1.写个启动脚本放到/etc/rc.d/init.d/zookeeper</p>
<p>这里touch zookeeper &amp;&amp; chmod +x zookeeper &amp;&amp; vim zookeeper</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">!/bin/bash</div><div class="line"><span class="comment">#chkconfig:2345 20 90</span></div><div class="line"><span class="comment">#description:zookeeper</span></div><div class="line"><span class="comment">#processname:zookeeper</span></div><div class="line"><span class="built_in">export</span> JAVA_HOME=/srv/jdk1.8.0_66</div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></div><div class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></div><div class="line">    start) su root /srv/zookeeper-3.3.6/bin/zkServer.sh start;;</div><div class="line">    stop) su root /srv/zookeeper-3.3.6/bin/zkServer.sh stop;;</div><div class="line">    status) su root /srv/zookeeper-3.3.6/bin/zkServer.sh status;;</div><div class="line">    restart) su root /srv/zookeeper-3.3.6/bin/zkServer.shrestart;;</div><div class="line">    *)  <span class="built_in">echo</span> <span class="string">"requirestart|stop|status|restart"</span>;;</div><div class="line"><span class="keyword">esac</span></div></pre></td></tr></table></figure>
<p>2.设置开机启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chkconfig zookeeper on</div></pre></td></tr></table></figure>
<p>3.验证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chkconfig --add zookeeper</div><div class="line">chkconfig --list zookeeper</div></pre></td></tr></table></figure>
<p>这个时候我们就可以用service zookeeper start/stop来启动停止zookeeper服务了.<br>使用<code>chkconfig--add zookeeper</code>命令把<code>zookeeper</code>添加到开机启动里面<br>添加完成之后接这个使用<code>chkconfig--list</code>来看看我们添加的<code>zookeeper</code>是否在里面<br>如果上面的操作都正常的话；重启服务器测试就行。</p>
<div class="tip"><br><br>注意：zookeeper重启出现几种报错：<br><br>1. 启动服务报错找不到指定好的pid文件。<br>2. 关闭服务报错没有在/tmp/路径下面没有/srv/zookeeper-3.3.6/zookeeper/data/zookeeper_server.pid<br></div>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@zookeeper zookeeper-3.3.6]<span class="comment"># ./bin/zkServer.sh start</span></div><div class="line">JMX enabled by default</div><div class="line">Using config: /srv/zookeeper-3.3.6/bin/../conf/zoo.cfg</div><div class="line">Starting zookeeper ... ./bin/zkServer.sh: line 93: [: /tmp/zookeeper: binary operator expected</div><div class="line">./bin/zkServer.sh: line 103: /tmp/zookeeper</div><div class="line">/srv/zookeeper-3.3.6/zookeeper/data/zookeeper_server.pid: 没有那个文件或目录</div><div class="line">FAILED TO WRITE PID</div><div class="line">[root@zookeeper zookeeper-3.3.6]<span class="comment"># ./bin/zkServer.sh stop</span></div><div class="line">JMX enabled by default</div><div class="line">Using config: /srv/zookeeper-3.3.6/bin/../conf/zoo.cfg</div><div class="line">Stopping zookeeper ... no zookeeper to stop (could not find file /tmp/zookeeper</div><div class="line">/srv/zookeeper-3.3.6/zookeeper/data/zookeeper_server.pid)</div></pre></td></tr></table></figure>
<p>解决方法：网上很少有人讲这么详细，这里我就说下，就是你在修改zoo.cfg配置文件里面：</p>
<p>dataDir指定的路径是自定义的话等于的时候不要空格写。</p>
<p>如果重新另外写dataDir ,不要注释掉之前的，最好直接删除，重新指定这样就不会报错了，如果注释掉默认的<code>#dataDir = /tmp</code>这里需要空格。</p>
<h3 id="报错-占用端口："><a href="#报错-占用端口：" class="headerlink" title="报错 占用端口："></a>报错 占用端口：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">JMX enabled by default</div><div class="line">Using config: /opt/app/zookeeper/bin/../conf/zoo3.cfg</div><div class="line">Starting zookeeper ... STARTED</div></pre></td></tr></table></figure>
<p>查看状态：<br>用jps命令查看进程：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># jps</span></div><div class="line">24617 QuorumPeerMain （这个就是zookeeper进程）</div><div class="line"></div><div class="line">/opt/app/zookeeper/bin/zkServer.sh status zoo1.cfg</div><div class="line">JMX enabled by default</div><div class="line">Using config: /opt/app/zookeeper/bin/../conf/zoo1.cfg</div><div class="line">Error contacting service. It is probably not running.</div></pre></td></tr></table></figure>
<p>Ihaozhuo_b3314<br>说明有错误，查看日志文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd &lt;zookeeper_home&gt;</span></div><div class="line"><span class="comment"># less zookeeper.out</span></div><div class="line">java.net.BindException: 地址已在使用</div><div class="line">杀掉当前进程：</div><div class="line"><span class="comment"># kill -9 24617</span></div></pre></td></tr></table></figure>
<h3 id="报错-启动服务正常。"><a href="#报错-启动服务正常。" class="headerlink" title="报错: 启动服务正常。"></a>报错: 启动服务正常。</h3><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@api1 zookeeper<span class="number">-3.3</span><span class="number">.6</span>]<span class="comment"># ./bin/zkServer.sh start</span></div><div class="line">JMX enabled <span class="keyword">by</span> <span class="keyword">default</span></div><div class="line">Using config: <span class="regexp">/srv/zookeeper-3.3.6/bin/</span>../conf/zoo.cfg</div><div class="line">Starting zookeeper ... STARTED</div></pre></td></tr></table></figure>
<p>可是查询进程不存在，可是看pid是有的，然后关闭服务就说没有这个进程。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">JMX enabled by <span class="keyword">default</span></div><div class="line">Using <span class="string">config:</span> <span class="regexp">/srv/</span>zookeeper<span class="number">-3.3</span><span class="number">.6</span><span class="regexp">/bin/</span>..<span class="regexp">/conf/</span>zoo.cfg</div><div class="line">Stopping zookeeper ... ./zkServer.<span class="string">sh:</span> line <span class="number">133</span>: <span class="string">kill:</span> (<span class="number">31415</span>) - 没有那个进程</div></pre></td></tr></table></figure>
<h3 id="走kafka查看是否所有节点都启动："><a href="#走kafka查看是否所有节点都启动：" class="headerlink" title="走kafka查看是否所有节点都启动："></a>走kafka查看是否所有节点都启动：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@kafka_03 bin]<span class="comment"># sh zkCli.sh</span></div><div class="line">Connecting to localhost:2181</div><div class="line">2017-01-04 19:20:24,849 [myid:] - INFO  [main:Environment@100] - Client environment:zookeeper.version=3.4.6-1569965, built on 02/20/2014 09:09 GMT</div><div class="line">2017-01-04 19:20:24,853 [myid:] - INFO  [main:Environment@100] - Client environment:host.name=kafka_03</div><div class="line">2017-01-04 19:20:24,853 [myid:] - INFO  [main:Environment@100] - Client environment:java.version=1.8.0_66</div><div class="line">2017-01-04 19:20:24,856 [myid:] - INFO  [main:Environment@100] - Client environment:java.vendor=Oracle Corporation</div><div class="line">2017-01-04 19:20:24,856 [myid:] - INFO  [main:Environment@100] - Client environment:java.home=/srv/jdk1.8.0_66/jre</div><div class="line">2017-01-04 19:20:24,856 [myid:] - INFO  [main:Environment@100] - Client environment:java.class.path=/srv/zookeeper-3.4.6/bin/../build/classes:/srv/zookeeper-3.4.6/bin/../build/lib/*.jar:/srv/zookeeper-3.4.6/bin/../lib/slf4j-log4j12-1.6.1.jar:/srv/zookeeper-3.4.6/bin/../lib/slf4j-api-1.6.1.jar:/srv/zookeeper-3.4.6/bin/../lib/netty-3.7.0.Final.jar:/srv/zookeeper-3.4.6/bin/../lib/<span class="built_in">log</span>4j-1.2.16.jar:/srv/zookeeper-3.4.6/bin/../lib/jline-0.9.94.jar:/srv/zookeeper-3.4.6/bin/../zookeeper-3.4.6.jar:/srv/zookeeper-3.4.6/bin/../src/java/lib/*.jar:/srv/zookeeper-3.4.6/bin/../conf:</div><div class="line">2017-01-04 19:20:24,856 [myid:] - INFO  [main:Environment@100] - Client environment:java.library.path=/usr/java/packages/lib/amd64:/usr/lib64:/lib64:/lib:/usr/lib</div><div class="line"></div><div class="line">[zk: localhost:2181(CONNECTED) 0] ls /</div><div class="line">[controller_epoch, brokers, zookeeper, kafka, dubbo, admin, isr_change_notification, consumers, config, sthp]</div><div class="line">[zk: localhost:2181(CONNECTED) 5] ls /kafka/brokers/ids</div><div class="line">[0, 1, 2]</div><div class="line"></div><div class="line">显示0 1 2 三台集群机器。</div></pre></td></tr></table></figure>
<p>kafka 三台集群这里可以看到获取到ids。</p>
<h3 id="Step9-相关文档"><a href="#Step9-相关文档" class="headerlink" title="Step9: 相关文档"></a>Step9: 相关文档</h3><p>《HBase-0.98.0分布式安装指南》</p>
<p>《Hive 0.12.0安装指南》</p>
<p>《ZooKeeper-3.4.6分布式安装指南》</p>
<p>《Hadoop 2.3.0源码反向工程》</p>
<p>《在Linux上编译Hadoop-2.4.0》</p>
<p>《Accumulo-1.5.1安装指南》</p>
<p>《Drill 1.0.0安装指南》</p>
<p>《Shark 0.9.1安装指南》</p>
<p>更多，敬请关注技术博客：<a href="http://blog.yancy.cc">http://blog.yancy.cc</a></p>
<h3 id="Step10-结束语"><a href="#Step10-结束语" class="headerlink" title="Step10:  结束语"></a>Step10:  结束语</h3><p>至此，ZooKeeper分布式安装大告成功！更多细节，请浏览<a href="http://zookeeper.apache.org/doc/trunk/zookeeperStarted.html" target="_blank" rel="external">官方文档</a></p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/Big-data-Hadoop/">Big data Hadoop</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/大数据/">大数据</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://blog.yancy.cc/2017/05/26/Bigdata-hadoop/zookeeper/Bigdata-ZooKeeper集群快速搭建与优化/" data-title="Bigdata-ZooKeeper集群快速搭建与优化 | Yancy&#39;s blog" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2017/05/27/Bigdata-hadoop/zookeeper/Bigdata-ZooKeeper的配置详解优化/" title="Bigdata-ZooKeeper的配置详解优化">
  <strong>PREVIOUS:</strong><br/>
  <span>
  Bigdata-ZooKeeper的配置详解优化</span>
</a>
</div>


<div class="next">
<a href="/2017/05/08/Bigdata-hadoop/HORTONW0RKS数据平台实现搭建Ambari配置和部署HDP集群监控Hadoop集群 /"  title="HORTONW0RKS数据平台实现搭建Ambari配置和部署HDP集群监控Hadoop集群">
 <strong>NEXT:</strong><br/> 
 <span>HORTONW0RKS数据平台实现搭建Ambari配置和部署HDP集群监控Hadoop集群
</span>
</a>
</div>

</nav>

	
<section class="comment">
	<div class="ds-thread"></div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#ZooKeeper集群快速搭建与优化"><span class="toc-number">1.</span> <span class="toc-text">ZooKeeper集群快速搭建与优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#集群："><span class="toc-number"></span> <span class="toc-text">集群：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装说明"><span class="toc-number">1.</span> <span class="toc-text">安装说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-etc-hosts"><span class="toc-number">2.</span> <span class="toc-text">配置/etc/hosts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step1"><span class="toc-number">3.</span> <span class="toc-text">Step1:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step2"><span class="toc-number">4.</span> <span class="toc-text">Step2:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step3"><span class="toc-number">5.</span> <span class="toc-text">Step3:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建maid"><span class="toc-number">6.</span> <span class="toc-text">创建maid:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step4"><span class="toc-number">7.</span> <span class="toc-text">Step4:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step5"><span class="toc-number">8.</span> <span class="toc-text">Step5:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step6"><span class="toc-number">9.</span> <span class="toc-text">Step6:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#链接测试"><span class="toc-number">10.</span> <span class="toc-text">链接测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step7"><span class="toc-number">11.</span> <span class="toc-text">Step7:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step8-如何扩容zookeeper？"><span class="toc-number">12.</span> <span class="toc-text">Step8: 如何扩容zookeeper？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设置开机自动启动"><span class="toc-number">13.</span> <span class="toc-text">设置开机自动启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#报错-占用端口："><span class="toc-number">14.</span> <span class="toc-text">报错 占用端口：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#报错-启动服务正常。"><span class="toc-number">15.</span> <span class="toc-text">报错: 启动服务正常。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#走kafka查看是否所有节点都启动："><span class="toc-number">16.</span> <span class="toc-text">走kafka查看是否所有节点都启动：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step9-相关文档"><span class="toc-number">17.</span> <span class="toc-text">Step9: 相关文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step10-结束语"><span class="toc-number">18.</span> <span class="toc-text">Step10:  结束语</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/Big-data-Hadoop/" title="Big data Hadoop">Big data Hadoop<sup>3</sup></a></li>
		
			<li><a href="/categories/Kafka/" title="Kafka">Kafka<sup>2</sup></a></li>
		
			<li><a href="/categories/大数据/" title="大数据">大数据<sup>10</sup></a></li>
		
			<li><a href="/categories/日志分析平台/" title="日志分析平台">日志分析平台<sup>8</sup></a></li>
		
			<li><a href="/categories/生活/" title="生活">生活<sup>6</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Ambari/" title="Ambari">Ambari<sup>1</sup></a></li>
		
			<li><a href="/tags/Big-data-Hadoop/" title="Big data Hadoop">Big data Hadoop<sup>8</sup></a></li>
		
			<li><a href="/tags/Countly/" title="Countly">Countly<sup>1</sup></a></li>
		
			<li><a href="/tags/Elasticsearch/" title="Elasticsearch">Elasticsearch<sup>4</sup></a></li>
		
			<li><a href="/tags/Kafka/" title="Kafka">Kafka<sup>10</sup></a></li>
		
			<li><a href="/tags/Kibana/" title="Kibana">Kibana<sup>1</sup></a></li>
		
			<li><a href="/tags/Log-analysis-platform/" title="Log analysis platform">Log analysis platform<sup>8</sup></a></li>
		
			<li><a href="/tags/Personal-life-record/" title="Personal life record">Personal life record<sup>6</sup></a></li>
		
			<li><a href="/tags/Zabbix/" title="Zabbix">Zabbix<sup>2</sup></a></li>
		
			<li><a href="/tags/ZooKeeper/" title="ZooKeeper">ZooKeeper<sup>1</sup></a></li>
		
			<li><a href="/tags/旅行日记/" title="旅行日记">旅行日记<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not. </p>
	</section>
	 
	<div class="social-font clearfix">
		
		<a href="http://weibo.com/yangcvo" target="_blank" title="weibo"></a>
		
		
		<a href="https://twitter.com/yangaov" target="_blank" title="twitter"></a>
		
		
		<a href="https://github.com/yangcvo" target="_blank" title="github"></a>
		
		
		<a href="https://www.facebook.com/yangcvo" target="_blank" title="facebook"></a>
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2017 
		
		<a href="http://blog.yancy.cc" target="_blank" title="Yancy">Yancy</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"null"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



  </body>
</html>
