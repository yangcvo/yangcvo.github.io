<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Personal blog, thinking and sharing of technology and life">
    <meta name="keyword"  content="undefined">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          Mongod入门系列之实战 - Yancy&#39;s blog
        
    </title>

    <link rel="canonical" href="http://blog.yancy.cc/2017/06/18/数据库/Mongodb/mongod入门系列之实战/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Jolly-Yancy&#39;s blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/About-me.html">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archives/archives.html">Archives</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="http://blog.yancy.cc/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#Database" title="Database">Database</a>
                        
                    </div>
                    <h1>Mongod入门系列之实战</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by Yancy on
                        2017-06-18
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h3 id="软件相关信息介绍"><a href="#软件相关信息介绍" class="headerlink" title="软件相关信息介绍"></a>软件相关信息介绍</h3><p> MongoDB 是一款开源的文档数据库，并且是业内领先的 NoSQL 数据库，用 C++ 编写而成。</p>
<h4 id="软件包介绍"><a href="#软件包介绍" class="headerlink" title="软件包介绍"></a>软件包介绍</h4><p> MongoDB 提供的官方支持的软件包是在自己的软件库中编译的。软件库通过软下列件包提供 MongoDB 相关软件。</p>
<p><code>mongodb-org</code>: 这个包是一个 元包 （ metapackage ），它会自动安装下列4个软件包。<br><code>mongodb-org-server</code>: 这个软件包中包含 mongod 守护进程和相关的配置以及初始化脚本。<br><code>mongodb-org-mongos</code>: 这个包中包含 mongos 守护进程。<br><code>mongodb-org-shell</code>: 这个包中包含 mongo 命令行工具。<br><code>mongodb-org-tools</code>：这个包中包含下列 MongoDB 工具： <code>mongoimport bsondump, mongodump, mongoexport, mongofiles, mongoimport, mongooplog, mongoperf, mongorestore, mongostat, and mongotop</code>。</p>
<h4 id="mongodb功能"><a href="#mongodb功能" class="headerlink" title="mongodb功能"></a>mongodb功能</h4><ol>
<li>面向集合的存储:适合存储对象及 JSON 形式的数据。</li>
<li>动态查询:MongoDB 支持丰富的查询表达式。查询指令使用 JSON 形式的标记,可轻易查询文档中内嵌的对象及数组。</li>
<li>完整的索引支持:包括文档内嵌对象及数组。MongoDB 的查询优化器会分析查询表达式,并生成一个高效的查询计划。</li>
<li>查询监视:MongoDB 包􏰀一系列监视工具用于分析数据库操作的性能。</li>
<li>复制及自动故障转移:MongoDB 数据库支持服务器之间的数据复制,支持主-从模式及服务器之间的相互复制。复制的主要目标是提供冗余及自动故障转移。</li>
<li>高效的传统存储方式:支持二进制数据及大型对象(如照片或图片)。</li>
<li>自动分片以支持云级􏰁的伸缩性:自动分片功能支持水平的数据库集群,可动态添加额外的机器。</li>
</ol>
<h4 id="适合场景"><a href="#适合场景" class="headerlink" title="适合场景"></a>适合场景</h4><ul>
<li>网站数据:MongoDB 非常适合实时的插入,更新与查询,并具备网站实时数据存储所 需的复制及高度伸缩性。</li>
<li>缓存:由于性能很高,MongoDB 也适合作为信息基础设施的缓存层。在系统重启之后, 由 MongoDB 搭建的持久化缓存层可以避免下层的数据源过载。</li>
<li>大尺寸,低价值的数据:使用传统的关系型数据库存储一些数据时可能会比较昂贵,在 此之前,很多时候程序员往往会选择传统的文件进行存储。</li>
<li>高伸缩性的场景:MongoDB 非常适合由数十或数百台服务器组成的数据库。MongoDB 的路线图中已经包􏰀对 MapReduce 引擎的内置支持。</li>
<li>用于对象及 JSON 数据的存储:MongoDB 的 BSON 数据格式非常适合文档化格式的存储及查询。</li>
</ul>
<h4 id="数据逻辑结构"><a href="#数据逻辑结构" class="headerlink" title="数据逻辑结构"></a>数据逻辑结构</h4><ul>
<li>MongoDB 的逻辑结构是一种层次结构。主要由: 文档(document)、集合(collection)、数据库(database)这三部分组成的。逻辑结构是面向用户 的,用户使用 MongoDB 开发应用程序使用的就是逻辑结构。</li>
<li>MongoDB 的文档(document),相当于关系数据库中的一行记录。</li>
<li>􏰂多个文档组成一个集合(collection),相当于关系数据库的表。</li>
<li>多个集合(collection),逻辑上组织在一起,就是数据库(database)。一个 MongoDB 实例支持多个数据库(database)。 </li>
</ul>
<h4 id="逻辑结构对比"><a href="#逻辑结构对比" class="headerlink" title="逻辑结构对比"></a>逻辑结构对比</h4><blockquote>
<p>MongoDB</p>
</blockquote>
<ul>
<li>关系型数据库</li>
</ul>
<table>
<thead>
<tr>
<th>文档（document)</th>
<th>行（ROW）</th>
</tr>
</thead>
<tbody>
<tr>
<td>集合（collection）</td>
<td>表（table）</td>
</tr>
<tr>
<td>数据库（database）</td>
<td>数据库（database）</td>
</tr>
</tbody>
</table>
<ul>
<li>数据存储结构</li>
</ul>
<p>MongoDB 的默认数据目录是/data/db,它负责存储所有的 MongoDB 的数据文件。在 MongoDB 内部,每个数据库都包􏰀一个.ns 文件和一些数据文件,而且这些数据文件会随着数据量的 增加而变得越来越多。所以如果系统中有一个叫做 foo 的数据库,那么构成 foo 这个数据库 的文件就会由 foo.ns,foo.0,foo.1,foo.2 等等组成,具体如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@localhost db]<span class="comment"># ll /data/db/</span></div><div class="line">-rw------- 1 root root 16777216 04-21 17:30 foo.0</div><div class="line">-rw------- 1 root root 33554432 04-21 17:30 foo.1</div><div class="line">-rw------- 1 root root 67108864 04-21 17:30 foo.2</div><div class="line">-rw------- 1 root root 16777216 04-21 17:30 foo.ns</div></pre></td></tr></table></figure>
<p>MongoDB 内部有预分配空间的机制,每个预分配的文件都用 0 进行填充,由于有了这个机制, MongoDB 始终保持额外的空间和空余的数据文件,从而有效避免了由于数据暴增而带来 的磁盘压力过大的问题。 由于表中数据量的增加,数据文件每新分配一次,它的大小都会是上一个数据文件大小的 2 倍,每个数据文件最大 2G。这样的机制有利于防止较小的数据库浪费过多的磁盘空间,同 时又能保证较大的数据库有相应的预留空间使用。 数据库的每张表都对应一个命名空间,每个索引也有对应的命名空间。这些命名空间的元数据都集中在*.ns 文件中。</p>
<h4 id="Mongod实战"><a href="#Mongod实战" class="headerlink" title="Mongod实战"></a>Mongod实战</h4><blockquote>
<p>mongodb 在 bin目录下的工具简介：</p>
</blockquote>
<ul>
<li><code>bsondump</code>: 将 bson 格式的文件转储为 json 格式的数据。</li>
<li><code>mongo</code>: 客户端命令行工具,其实也是一个 js 解释器,支持 js 语法。</li>
<li><code>mongod</code>: 数据库服务端,每个实例启动一个进程,可以 fork 为后台运行。</li>
<li><code>mongodump/ mongorestore</code> 数据库备份和恢复工具。</li>
<li>mongoexport/ mongoimport`: 数据导出和导入工具。</li>
<li><code>mongofiles: GridFS</code>管理工具,可实现二制文件的存取。</li>
<li><code>mongos</code>: 分片路由,如果使用了 sharding 功能,则应用程序连接的是mongos 而不是 mongod。</li>
<li><code>mongosniff</code>: 这一工具的作用类似于tcpdump,不同的是他只监控MongoDB相关的包请 求,并且是以指定的可读性的形式输出。</li>
<li><code>mongostat</code>: 实时性能监控工具。</li>
</ul>
<blockquote>
<p>单实例配置</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/lcoal/src</div><div class="line">wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-3.4.6.tgz</div><div class="line">tar -zxf mongodb-linux-x86_64-rhel70-3.4.6.tgz </div><div class="line">mv mongodb-linux-x86_64-rhel70-3.4.6 /data/app/</div><div class="line">ln <span class="_">-s</span> /data/app/mongodb-linux-x86_64-rhel70-3.4.6 /data/app/mongod</div><div class="line">mkdir /data/app/mongod/&#123;db,logs,config&#125;</div><div class="line">cat &gt;/data/app/mongod/config/mongo.conf &lt;&lt;EOF</div><div class="line"><span class="comment"># where to write logging data.</span></div><div class="line">systemLog:</div><div class="line">  destination: file</div><div class="line">  <span class="built_in">log</span>Append: <span class="literal">true</span></div><div class="line">  path: /data/app/mongod/logs/mongod.log</div><div class="line"></div><div class="line"><span class="comment"># Where and how to store data.</span></div><div class="line">storage:</div><div class="line">  dbPath: /data/app/mongod/db</div><div class="line">  journal:</div><div class="line">    enabled: <span class="literal">true</span></div><div class="line"><span class="comment">#  engine:</span></div><div class="line"><span class="comment">#  mmapv1:</span></div><div class="line"><span class="comment">#  wiredTiger:</span></div><div class="line"></div><div class="line"><span class="comment"># how the process runs</span></div><div class="line">processManagement:</div><div class="line">  fork: <span class="literal">true</span></div><div class="line">  pidFilePath: /data/app/mongod/mongod.pid</div><div class="line"></div><div class="line"><span class="comment"># network interfaces</span></div><div class="line">net:</div><div class="line">  port: 27017</div><div class="line">  <span class="built_in">bind</span>Ip: 192.168.56.13</div><div class="line">EOF</div><div class="line">/data/app/mongod/bin/mongod --config /data/app/mongod/config/mongo.conf</div></pre></td></tr></table></figure>
<p>查看日志文件<code>cat /data/app/mongod/logs/mongod.log</code>出现如下字样，表示启动成功。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[initandlisten] waiting <span class="keyword">for</span> connections on port &lt;port&gt;</div></pre></td></tr></table></figure>
<h4 id="mongodb复制集配置"><a href="#mongodb复制集配置" class="headerlink" title="mongodb复制集配置"></a>mongodb复制集配置</h4><blockquote>
<p>安装包参考上面的单实例安装。<br>下面的命令在三台服务器上批量执行。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">mkdir /data/app/mongod/db/replset -p</div><div class="line">cat &gt;/data/app/mongod/config/replset.conf &lt;&lt;EOF</div><div class="line"><span class="comment"># where to write logging data.</span></div><div class="line">systemLog:</div><div class="line">  destination: file</div><div class="line">  <span class="built_in">log</span>Append: <span class="literal">true</span></div><div class="line">  path: /data/app/mongod/logs/replset.log</div><div class="line"></div><div class="line"><span class="comment"># Where and how to store data.</span></div><div class="line">storage:</div><div class="line">  dbPath: /data/app/mongod/db/replset</div><div class="line">  directoryPerDB: <span class="literal">true</span></div><div class="line">  journal:</div><div class="line">    enabled: <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment"># how the process runs</span></div><div class="line">processManagement:</div><div class="line">  fork: <span class="literal">true</span></div><div class="line">  pidFilePath: /data/app/mongod/replset.pid</div><div class="line"></div><div class="line"><span class="comment"># network interfaces</span></div><div class="line">net:</div><div class="line">  port: 22000</div><div class="line">  <span class="built_in">bind</span>Ip: 0.0.0.0</div><div class="line">replication:</div><div class="line">  replSetName: replset0</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>启动三台服务器的mongod服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/data/app/mongod/bin/mongod --config /data/app/mongod/config/replset.conf  </div><div class="line"><span class="comment">### 检查端口是否启动</span></div><div class="line">ss -lntup |grep 22000</div></pre></td></tr></table></figure>
<p>连接一台mongod服务，配置相关分片设置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">/data/app/mongod/bin/mongo --host 192.168.56.11 --port 22000</div><div class="line"></div><div class="line">rs.initiate(</div><div class="line">&#123;</div><div class="line">   <span class="string">"_id"</span> : <span class="string">"replset0"</span>,</div><div class="line">   <span class="string">"version"</span> : 1,</div><div class="line">   <span class="string">"members"</span> : [</div><div class="line">      &#123;</div><div class="line">         <span class="string">"_id"</span> : 1,</div><div class="line">         <span class="string">"host"</span> : <span class="string">"192.168.56.11:22000"</span></div><div class="line">      &#125;</div><div class="line">   ]</div><div class="line">&#125;</div><div class="line">)</div><div class="line"></div><div class="line">rs.add(<span class="string">"192.168.56.12:22000"</span>)</div><div class="line">rs.add(<span class="string">"192.168.56.13:22000"</span>)</div></pre></td></tr></table></figure>
<p>查看集群分片状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">/data/app/mongod/bin/mongo --host 192.168.56.11 --port 22000</div><div class="line">rs.conf() <span class="comment">## 查看集群配置信息</span></div><div class="line">replset0:PRIMARY&gt; rs.<span class="function"><span class="title">status</span></span>()</div><div class="line">&#123;</div><div class="line">        <span class="string">"set"</span> : <span class="string">"replset0"</span>,</div><div class="line">        <span class="string">"date"</span> : ISODate(<span class="string">"2017-08-01T02:48:51.672Z"</span>),</div><div class="line">        <span class="string">"myState"</span> : 1,</div><div class="line">        <span class="string">"term"</span> : NumberLong(1),</div><div class="line">        <span class="string">"heartbeatIntervalMillis"</span> : NumberLong(2000),</div><div class="line">        <span class="string">"optimes"</span> : &#123;</div><div class="line">                <span class="string">"lastCommittedOpTime"</span> : &#123;</div><div class="line">                        <span class="string">"ts"</span> : Timestamp(1501555722, 1),</div><div class="line">                        <span class="string">"t"</span> : NumberLong(1)</div><div class="line">                &#125;,</div><div class="line">                <span class="string">"appliedOpTime"</span> : &#123;</div><div class="line">                        <span class="string">"ts"</span> : Timestamp(1501555722, 1),</div><div class="line">                        <span class="string">"t"</span> : NumberLong(1)</div><div class="line">                &#125;,</div><div class="line">                <span class="string">"durableOpTime"</span> : &#123;</div><div class="line">                        <span class="string">"ts"</span> : Timestamp(1501555722, 1),</div><div class="line">                        <span class="string">"t"</span> : NumberLong(1)</div><div class="line">                &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"members"</span> : [</div><div class="line">                &#123;</div><div class="line">                        <span class="string">"_id"</span> : 1,</div><div class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.56.11:22000"</span>,</div><div class="line">                        <span class="string">"health"</span> : 1,</div><div class="line">                        <span class="string">"state"</span> : 1,</div><div class="line">                        <span class="string">"stateStr"</span> : <span class="string">"PRIMARY"</span>,</div><div class="line">                        <span class="string">"uptime"</span> : 397,</div><div class="line">                        <span class="string">"optime"</span> : &#123;</div><div class="line">                                <span class="string">"ts"</span> : Timestamp(1501555722, 1),</div><div class="line">                                <span class="string">"t"</span> : NumberLong(1)</div><div class="line">                        &#125;,</div><div class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2017-08-01T02:48:42Z"</span>),</div><div class="line">                        <span class="string">"electionTime"</span> : Timestamp(1501555501, 2),</div><div class="line">                        <span class="string">"electionDate"</span> : ISODate(<span class="string">"2017-08-01T02:45:01Z"</span>),</div><div class="line">                        <span class="string">"configVersion"</span> : 3,</div><div class="line">                        <span class="string">"self"</span> : <span class="literal">true</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                        <span class="string">"_id"</span> : 2,</div><div class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.56.12:22000"</span>,</div><div class="line">                        <span class="string">"health"</span> : 1,</div><div class="line">                        <span class="string">"state"</span> : 2,</div><div class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</div><div class="line">                        <span class="string">"uptime"</span> : 186,</div><div class="line">                        <span class="string">"optime"</span> : &#123;</div><div class="line">                                <span class="string">"ts"</span> : Timestamp(1501555722, 1),</div><div class="line">                                <span class="string">"t"</span> : NumberLong(1)</div><div class="line">                        &#125;,</div><div class="line">                        <span class="string">"optimeDurable"</span> : &#123;</div><div class="line">                                <span class="string">"ts"</span> : Timestamp(1501555722, 1),</div><div class="line">                                <span class="string">"t"</span> : NumberLong(1)</div><div class="line">                        &#125;,</div><div class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2017-08-01T02:48:42Z"</span>),</div><div class="line">                        <span class="string">"optimeDurableDate"</span> : ISODate(<span class="string">"2017-08-01T02:48:42Z"</span>),</div><div class="line">                        <span class="string">"lastHeartbeat"</span> : ISODate(<span class="string">"2017-08-01T02:48:50.961Z"</span>),</div><div class="line">                        <span class="string">"lastHeartbeatRecv"</span> : ISODate(<span class="string">"2017-08-01T02:48:49.953Z"</span>),</div><div class="line">                        <span class="string">"pingMs"</span> : NumberLong(0),</div><div class="line">                        <span class="string">"syncingTo"</span> : <span class="string">"192.168.56.11:22000"</span>,</div><div class="line">                        <span class="string">"configVersion"</span> : 3</div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                        <span class="string">"_id"</span> : 3,</div><div class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.56.13:22000"</span>,</div><div class="line">                        <span class="string">"health"</span> : 1,</div><div class="line">                        <span class="string">"state"</span> : 2,</div><div class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</div><div class="line">                        <span class="string">"uptime"</span> : 184,</div><div class="line">                        <span class="string">"optime"</span> : &#123;</div><div class="line">                                <span class="string">"ts"</span> : Timestamp(1501555722, 1),</div><div class="line">                                <span class="string">"t"</span> : NumberLong(1)</div><div class="line">                        &#125;,</div><div class="line">                        <span class="string">"optimeDurable"</span> : &#123;</div><div class="line">                                <span class="string">"ts"</span> : Timestamp(1501555722, 1),</div><div class="line">                                <span class="string">"t"</span> : NumberLong(1)</div><div class="line">                        &#125;,</div><div class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2017-08-01T02:48:42Z"</span>),</div><div class="line">                        <span class="string">"optimeDurableDate"</span> : ISODate(<span class="string">"2017-08-01T02:48:42Z"</span>),</div><div class="line">                        <span class="string">"lastHeartbeat"</span> : ISODate(<span class="string">"2017-08-01T02:48:51.031Z"</span>),</div><div class="line">                        <span class="string">"lastHeartbeatRecv"</span> : ISODate(<span class="string">"2017-08-01T02:48:50.225Z"</span>),</div><div class="line">                        <span class="string">"pingMs"</span> : NumberLong(0),</div><div class="line">                        <span class="string">"syncingTo"</span> : <span class="string">"192.168.56.12:22000"</span>,</div><div class="line">                        <span class="string">"configVersion"</span> : 3</div><div class="line">                &#125;</div><div class="line">        ],</div><div class="line">        <span class="string">"ok"</span> : 1</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="mongodb分片配置"><a href="#mongodb分片配置" class="headerlink" title="mongodb分片配置"></a>mongodb分片配置</h4><p> 要构建一个 MongoDB Sharding Cluster,需要三种角色: 􏰂 Shard Server 即存储实际数据的分片,每个 Shard 可以是一个 mongod 实例,也可以是一组 mongod 实例 构成的 Replica Set。为了实现每个 Shard 内部的 auto-failover,MongoDB 官方建议每个 Shard 为一组 Replica Set。 􏰂 Config Server 为了将一个特定的 collection 存储在多个 shard 中,需要为该 collection 指定一个 shard key, 例如{age: 1} ,shard key 可以决定该条记录属于哪个 chunk。Config Servers 就是用来存储: 所有 shard 节点的配置信息、每个 chunk 的 shard key 范围、chunk 在各 shard 的分布情况、 该集群中所有 DB 和 collection 的 sharding 配置信息。 􏰂 Route Process 这是一个前端路由,客户端由此接入,然后询问 Config Servers 需要到哪个 Shard 上查询或 保存记录,再连接相应的 Shard 进行操作,最后将结果返回给客户端。客户端只需要将原本 发给 mongod 的查询或更新请求原封不动地发给 Routing Process,而不必关心所操作的记录 存储在哪个 Shard 上。</p>
<blockquote>
<p>何时分片：</p>
</blockquote>
<ul>
<li>机器的磁盘不够用了。</li>
<li>单个mongod已经不能满足写数据的性能需要了。</li>
<li>想将大量数据放在内存中提高性能。</li>
</ul>
<blockquote>
<p>创建相关目录</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir -p /data/app/mongod/db/&#123;shard0,shard1,config&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>编写相应的配置文件：</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line">cat &gt;/data/app/mongod/config/shard0.conf &lt;&lt;EOF</div><div class="line"><span class="comment"># where to write logging data.</span></div><div class="line">systemLog:</div><div class="line">  destination: file</div><div class="line">  <span class="built_in">log</span>Append: <span class="literal">true</span></div><div class="line">  path: /data/app/mongod/logs/shard0.log</div><div class="line"></div><div class="line"><span class="comment"># Where and how to store data.</span></div><div class="line">storage:</div><div class="line">  dbPath: /data/app/mongod/db/shard0</div><div class="line">  directoryPerDB: <span class="literal">true</span></div><div class="line">  journal:</div><div class="line">    enabled: <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment"># how the process runs</span></div><div class="line">processManagement:</div><div class="line">  fork: <span class="literal">true</span></div><div class="line">  pidFilePath: /data/app/mongod/shard0.pid</div><div class="line"></div><div class="line"><span class="comment"># network interfaces</span></div><div class="line">net:</div><div class="line">  port: 20000</div><div class="line">  <span class="built_in">bind</span>Ip: 192.168.56.13</div><div class="line">replication:</div><div class="line">  replSetName: rs0</div><div class="line">sharding:</div><div class="line">  clusterRole: shardsvr</div><div class="line">EOF</div><div class="line">cat &gt;/data/app/mongod/config/shard1.conf &lt;&lt;EOF</div><div class="line"><span class="comment"># where to write logging data.</span></div><div class="line">systemLog:</div><div class="line">  destination: file</div><div class="line">  <span class="built_in">log</span>Append: <span class="literal">true</span></div><div class="line">  path: /data/app/mongod/logs/shard1.log</div><div class="line"></div><div class="line"><span class="comment"># Where and how to store data.</span></div><div class="line">storage:</div><div class="line">  dbPath: /data/app/mongod/db/shard1</div><div class="line">  directoryPerDB: <span class="literal">true</span></div><div class="line">  journal:</div><div class="line">    enabled: <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment"># how the process runs</span></div><div class="line">processManagement:</div><div class="line">  fork: <span class="literal">true</span></div><div class="line">  pidFilePath: /data/app/mongod/shard1.pid</div><div class="line"></div><div class="line"><span class="comment"># network interfaces</span></div><div class="line">net:</div><div class="line">  port: 20001</div><div class="line">  <span class="built_in">bind</span>Ip: 192.168.56.13</div><div class="line">replication:</div><div class="line">  replSetName: rs0</div><div class="line">sharding:</div><div class="line">  clusterRole: shardsvr</div><div class="line">EOF</div><div class="line">启动config server</div><div class="line"></div><div class="line"> cat &gt;/data/app/mongod/config/config.conf &lt;&lt;EOF</div><div class="line"><span class="comment"># where to write logging data.</span></div><div class="line">systemLog:</div><div class="line">  destination: file</div><div class="line">  <span class="built_in">log</span>Append: <span class="literal">true</span></div><div class="line">  path: /data/app/mongod/logs/config.log</div><div class="line"></div><div class="line"><span class="comment"># Where and how to store data.</span></div><div class="line">storage:</div><div class="line">  dbPath: /data/app/mongod/db/config</div><div class="line">  directoryPerDB: <span class="literal">true</span></div><div class="line">  journal:</div><div class="line">    enabled: <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment"># how the process runs</span></div><div class="line">processManagement:</div><div class="line">  fork: <span class="literal">true</span></div><div class="line">  pidFilePath: /data/app/mongod/config.pid</div><div class="line"></div><div class="line"><span class="comment"># network interfaces</span></div><div class="line">net:</div><div class="line">  port: 30000</div><div class="line">  <span class="built_in">bind</span>Ip: 192.168.56.13</div><div class="line">replication:</div><div class="line">  replSetName: configRS</div><div class="line">sharding:</div><div class="line">  clusterRole: configsvr</div><div class="line">EOF</div><div class="line">启动mongod配置：</div><div class="line"></div><div class="line">/data/app/mongod/bin/mongod --config /data/app/mongod/config/shard0.conf  </div><div class="line">/data/app/mongod/bin/mongod --config /data/app/mongod/config/shard1.conf  </div><div class="line">/data/app/mongod/bin/mongod --config /data/app/mongod/config/config.conf  </div><div class="line">初始化config服务</div><div class="line"></div><div class="line">/data/app/mongod/bin/mongo --host 192.168.56.13 --port 30000</div><div class="line"> rs.initiate(</div><div class="line">  &#123;</div><div class="line">    _id: <span class="string">"configRS"</span>,</div><div class="line">    configsvr: <span class="literal">true</span>,</div><div class="line">    members: [</div><div class="line">      &#123; _id : 0, host : <span class="string">"192.168.56.13:30000"</span> &#125;,</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">)</div></pre></td></tr></table></figure>
<blockquote>
<p>初始化shard分片服务</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">/data/app/mongod/bin/mongo --host 192.168.56.13 --port 20000</div><div class="line">rs.initiate(</div><div class="line">  &#123;</div><div class="line">    _id : <span class="string">"rs0"</span>,</div><div class="line">    members: [</div><div class="line">      &#123; _id : 0, host : <span class="string">"192.168.56.13:20000"</span> &#125;,</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">)</div><div class="line"></div><div class="line">/data/app/mongod/bin/mongo --host 192.168.56.13 --port 20001</div><div class="line">rs.initiate(</div><div class="line">  &#123;</div><div class="line">    _id : <span class="string">"rs1"</span>,</div><div class="line">    members: [</div><div class="line">      &#123; _id : 0, host : <span class="string">"192.168.56.13:20001"</span> &#125;,</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">)</div><div class="line">启动route server </div><div class="line"></div><div class="line"> cat &gt;/data/app/mongod/config/route.conf &lt;&lt;EOF</div><div class="line"><span class="comment"># where to write logging data.</span></div><div class="line">systemLog:</div><div class="line">  destination: file</div><div class="line">  <span class="built_in">log</span>Append: <span class="literal">true</span></div><div class="line">  path: /data/app/mongod/logs/route.log</div><div class="line"></div><div class="line"><span class="comment"># how the process runs</span></div><div class="line">processManagement:</div><div class="line">  fork: <span class="literal">true</span></div><div class="line">  pidFilePath: /data/app/mongod/route.pid</div><div class="line"></div><div class="line"><span class="comment"># network interfaces</span></div><div class="line">net:</div><div class="line">  port: 40000</div><div class="line">  <span class="built_in">bind</span>Ip: 192.168.56.13</div><div class="line">sharding:</div><div class="line">  configDB: configRS/192.168.56.13:30000</div><div class="line">EOF</div><div class="line">/data/app/mongod/bin/mongos --config /data/app/mongod/config/route.conf</div></pre></td></tr></table></figure>
<blockquote>
<p>配置分片服务设置</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/data/app/mongod/bin/mongo --host 192.168.56.13 --port 40000</div><div class="line">sh.addShard( <span class="string">"rs0/192.168.56.13:20000"</span>)</div><div class="line">sh.addShard( <span class="string">"rs1/192.168.56.13:20001"</span>)</div><div class="line">sh.enableSharding(<span class="string">"test"</span>)</div><div class="line">sh.shardCollection(<span class="string">"test.users"</span>, &#123; _id:1 &#125; )</div></pre></td></tr></table></figure>
<h4 id="如何配置分片"><a href="#如何配置分片" class="headerlink" title="如何配置分片"></a>如何配置分片</h4><h4 id="分片和复制集整合配置"><a href="#分片和复制集整合配置" class="headerlink" title="分片和复制集整合配置"></a>分片和复制集整合配置</h4><p>根据Replica Set、Sharding策略部署mongod。将两个sharding组部署到三台服务器上，每个sharding组有三个replica set成员。</p>
<blockquote>
<p>前提：保证三台服务器时间相同。</p>
</blockquote>
<p>服务器规划</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">主机名</div><div class="line"><span class="keyword">shard0</span></div><div class="line"><span class="keyword">shard1</span></div><div class="line"><span class="built_in">config</span></div><div class="line">route</div></pre></td></tr></table></figure>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="number">192.168</span><span class="number">.56</span><span class="number">.11</span>     <span class="number">192.168</span><span class="number">.56</span><span class="number">.12</span>   <span class="number">192.168</span><span class="number">.56</span><span class="number">.13</span></div><div class="line">   <span class="number">20000</span>               <span class="number">20000</span>        <span class="number">20001</span></div><div class="line">   <span class="number">20001</span>               <span class="number">20001</span>       <span class="number">20001</span></div><div class="line">   <span class="number">30000</span>               <span class="number">30000</span>       <span class="number">30000</span></div><div class="line">   <span class="number">40000</span>               <span class="number">40000</span>       <span class="number">40000</span></div></pre></td></tr></table></figure>
<p>初始化三台机器的mongod实例 三台服务器上都执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /usr/lcoal/src</div><div class="line">wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-3.4.6.tgz</div><div class="line">tar -zxf mongodb-linux-x86_64-rhel70-3.4.6.tgz </div><div class="line">mv mongodb-linux-x86_64-rhel70-3.4.6 /data/app/</div><div class="line">ln <span class="_">-s</span> /data/app/mongodb-linux-x86_64-rhel70-3.4.6 /data/app/mongod</div><div class="line">mkdir /data/app/mongod/&#123;db,logs,config&#125;</div><div class="line">mkdir -p /data/app/mongod/db/&#123;shard0,shard1,config&#125;</div></pre></td></tr></table></figure>
<p>在三台服务器上批量执行如下命令：</p>
<p>先创建两台shard实例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">cat &gt;/data/app/mongod/config/shard0.conf &lt;&lt;EOF</div><div class="line"><span class="comment"># where to write logging data.</span></div><div class="line">systemLog:</div><div class="line">  destination: file</div><div class="line">  <span class="built_in">log</span>Append: <span class="literal">true</span></div><div class="line">  path: /data/app/mongod/logs/shard0.log</div><div class="line"></div><div class="line"><span class="comment"># Where and how to store data.</span></div><div class="line">storage:</div><div class="line">  dbPath: /data/app/mongod/db/shard0</div><div class="line">  directoryPerDB: <span class="literal">true</span></div><div class="line">  journal:</div><div class="line">    enabled: <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment"># how the process runs</span></div><div class="line">processManagement:</div><div class="line">  fork: <span class="literal">true</span></div><div class="line">  pidFilePath: /data/app/mongod/shard0.pid</div><div class="line"></div><div class="line"><span class="comment"># network interfaces</span></div><div class="line">net:</div><div class="line">  port: 20000</div><div class="line">  <span class="built_in">bind</span>Ip: 0.0.0.0</div><div class="line">replication:</div><div class="line">  replSetName: rs0</div><div class="line">sharding:</div><div class="line">  clusterRole: shardsvr</div><div class="line">EOF</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">cat &gt;/data/app/mongod/config/shard0.conf &lt;&lt;EOF</div><div class="line"><span class="comment"># where to write logging data.</span></div><div class="line">systemLog:</div><div class="line">  destination: file</div><div class="line">  <span class="built_in">log</span>Append: <span class="literal">true</span></div><div class="line">  path: /data/app/mongod/logs/shard0.log</div><div class="line"></div><div class="line"><span class="comment"># Where and how to store data.</span></div><div class="line">storage:</div><div class="line">  dbPath: /data/app/mongod/db/shard0</div><div class="line">  directoryPerDB: <span class="literal">true</span></div><div class="line">  journal:</div><div class="line">    enabled: <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment"># how the process runs</span></div><div class="line">processManagement:</div><div class="line">  fork: <span class="literal">true</span></div><div class="line">  pidFilePath: /data/app/mongod/shard0.pid</div><div class="line"></div><div class="line"><span class="comment"># network interfaces</span></div><div class="line">net:</div><div class="line">  port: 20000</div><div class="line">  <span class="built_in">bind</span>Ip: 0.0.0.0</div><div class="line">replication:</div><div class="line">  replSetName: rs0</div><div class="line">sharding:</div><div class="line">  clusterRole: shardsvr</div><div class="line">EOF</div></pre></td></tr></table></figure>
<blockquote>
<p>启动config server</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"> cat &gt;/data/app/mongod/config/config.conf &lt;&lt;EOF</div><div class="line"><span class="comment"># where to write logging data.</span></div><div class="line">systemLog:</div><div class="line">  destination: file</div><div class="line">  <span class="built_in">log</span>Append: <span class="literal">true</span></div><div class="line">  path: /data/app/mongod/logs/config.log</div><div class="line"></div><div class="line"><span class="comment"># Where and how to store data.</span></div><div class="line">storage:</div><div class="line">  dbPath: /data/app/mongod/db/config</div><div class="line">  directoryPerDB: <span class="literal">true</span></div><div class="line">  journal:</div><div class="line">    enabled: <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment"># how the process runs</span></div><div class="line">processManagement:</div><div class="line">  fork: <span class="literal">true</span></div><div class="line">  pidFilePath: /data/app/mongod/config.pid</div><div class="line"></div><div class="line"><span class="comment"># network interfaces</span></div><div class="line">net:</div><div class="line">  port: 30000</div><div class="line">  <span class="built_in">bind</span>Ip: 0.0.0.0</div><div class="line">replication:</div><div class="line">  replSetName: configRS</div><div class="line">sharding:</div><div class="line">  clusterRole: configsvr</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>启动shard0，shard1，config服务：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/data/</span>app<span class="regexp">/mongod/</span>bin<span class="regexp">/mongod --config /</span>data<span class="regexp">/app/m</span>ongod<span class="regexp">/config/</span>shard0.conf  </div><div class="line"><span class="regexp">/data/</span>app<span class="regexp">/mongod/</span>bin<span class="regexp">/mongod --config /</span>data<span class="regexp">/app/m</span>ongod<span class="regexp">/config/</span>shard1.conf  </div><div class="line"><span class="regexp">/data/</span>app<span class="regexp">/mongod/</span>bin<span class="regexp">/mongod --config /</span>data<span class="regexp">/app/m</span>ongod<span class="regexp">/config/</span>config.conf</div></pre></td></tr></table></figure>
<p>连上其中一台服务器的config端口，配置实例化参数，让三台config互相认识。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/data/</span>app<span class="regexp">/mongod/</span>bin/mongo --host <span class="number">192.168</span><span class="number">.56</span><span class="number">.11</span> --port <span class="number">30000</span></div><div class="line">rs.initiate(</div><div class="line"> &#123;</div><div class="line"><span class="symbol">   _id:</span> <span class="string">"configRS"</span>,</div><div class="line"><span class="symbol">   configsvr:</span> <span class="literal">true</span>,</div><div class="line"><span class="symbol">   members:</span> [</div><div class="line">     &#123; <span class="string">_id :</span> <span class="number">0</span>, <span class="string">host :</span> <span class="string">"192.168.56.11:30000"</span> &#125;,</div><div class="line">     &#123; <span class="string">_id :</span> <span class="number">1</span>, <span class="string">host :</span> <span class="string">"192.168.56.12:30000"</span> &#125;,</div><div class="line">     &#123; <span class="string">_id :</span> <span class="number">2</span>, <span class="string">host :</span> <span class="string">"192.168.56.13:30000"</span> &#125;,</div><div class="line">   ]</div><div class="line"> &#125;</div><div class="line">)</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">/data/app/mongod/bin/mongo --host 192.168.56.11 --port 20000</div><div class="line">rs.initiate(</div><div class="line">  &#123;</div><div class="line">    _id : <span class="string">"rs0"</span>,</div><div class="line">    members: [</div><div class="line">      &#123; _id : 0, host : <span class="string">"192.168.56.11:20000"</span> &#125;,</div><div class="line">      &#123; _id : 1, host : <span class="string">"192.168.56.12:20000"</span> &#125;,</div><div class="line">      &#123; _id : 2, host : <span class="string">"192.168.56.13:20000"</span> &#125;,</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">)</div><div class="line"></div><div class="line">/data/app/mongod/bin/mongo --host 192.168.56.11 --port 20001</div><div class="line">rs.initiate(</div><div class="line">  &#123;</div><div class="line">    _id : <span class="string">"rs1"</span>,</div><div class="line">    members: [</div><div class="line">      &#123; _id : 0, host : <span class="string">"192.168.56.11:20001"</span> &#125;,</div><div class="line">      &#123; _id : 1, host : <span class="string">"192.168.56.12:20001"</span> &#125;,</div><div class="line">      &#123; _id : 2, host : <span class="string">"192.168.56.13:20001"</span> &#125;,</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">)</div></pre></td></tr></table></figure>
<p>配置route服务器 <code>shell cat &gt;/data/app/mongod/config/route.conf &lt;&lt;EOF</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">where</span> to write logging data.</div><div class="line">systemLog: destination: file <span class="built_in">log</span>Append: <span class="literal">true</span> path: /data/app/mongod/logs/route.log</div><div class="line"></div><div class="line">how the process runs</div><div class="line">processManagement: fork: <span class="literal">true</span> pidFilePath: /data/app/mongod/route.pid</div><div class="line"></div><div class="line">network interfaces</div><div class="line">net: port: 40000 <span class="built_in">bind</span>Ip: 0.0.0.0 sharding: configDB: configRS/192.168.56.11:30000,192.168.56.12:30000,192.168.56.13:30000 EOF</div></pre></td></tr></table></figure>
<p>启动route server </p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/data/</span>app<span class="regexp">/mongod/</span>bin<span class="regexp">/mongos --config /</span>data<span class="regexp">/app/m</span>ongod<span class="regexp">/config/</span>route.conf</div></pre></td></tr></table></figure>
<p>配置分片服务设置</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/data/app/mongod/bin/mongo --host <span class="number">192.168.56.11</span> --port <span class="number">40000</span></div><div class="line">sh.addShard( "rs<span class="number">0/192.168.56</span>.<span class="number">11:20000,192</span>.<span class="number">168.56.12</span>:<span class="number">20000,192.168</span>.<span class="number">56.13:20000</span>")</div><div class="line">sh.addShard( "rs<span class="number">1/192.168.56</span>.<span class="number">11:20001,192</span>.<span class="number">168.56.12</span>:<span class="number">20001,192.168</span>.<span class="number">56.13:20001</span>")</div><div class="line">sh.enableSharding("test")</div><div class="line">sh.shardCollection("test.users", &#123; _id:<span class="number">1</span> &#125;</div></pre></td></tr></table></figure>
<p>要使单个Collection分片存储，需要给Collection指定一个分片key。</p>
<ol>
<li>分片的collection系统会自动创建一个索引（也可用户提前创建好）</li>
<li>分片的collection只能有一个在分片key上的唯一索引，其它唯一索引不被允许</li>
</ol>
<h4 id="检查shard分片结果是否正常"><a href="#检查shard分片结果是否正常" class="headerlink" title="检查shard分片结果是否正常"></a>检查shard分片结果是否正常</h4><figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">mongos&gt; use admin;</div><div class="line">switched <span class="keyword">to</span> db admin</div><div class="line">mongos&gt; db.runCommand( &#123; listshards : <span class="number">1</span> &#125; );</div><div class="line">&#123;</div><div class="line">        <span class="string">"shards"</span> : [</div><div class="line">                &#123;</div><div class="line">                        <span class="string">"_id"</span> : <span class="string">"rs0"</span>,</div><div class="line">                        <span class="string">"host"</span> : <span class="string">"rs0/192.168.56.11:20000,192.168.56.12:20000,192.168.56.13:20000"</span>,</div><div class="line">                        <span class="string">"state"</span> : <span class="number">1</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                        <span class="string">"_id"</span> : <span class="string">"rs1"</span>,</div><div class="line">                        <span class="string">"host"</span> : <span class="string">"rs1/192.168.56.11:20001,192.168.56.12:20001,192.168.56.13:20001"</span>,</div><div class="line">                        <span class="string">"state"</span> : <span class="number">1</span></div><div class="line">                &#125;</div><div class="line">        ],</div><div class="line">        <span class="string">"ok"</span> : <span class="number">1</span></div><div class="line">&#125;</div><div class="line">mongos&gt;</div></pre></td></tr></table></figure>
<p>如果列出(sharding)了以上二个你加的shards，表示shards已经配置成功。</p>
<p>查看Sharding状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">use admin;</div><div class="line">db.printShardingStatus();</div></pre></td></tr></table></figure>
<p>来查看分片状态。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="keyword">test</span>;</div><div class="line">db.users.stats();</div></pre></td></tr></table></figure>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结:"></a>总结:</h4><ol>
<li>一个或多个分片，其中每个分片持有部分数据（自动管理）。读写操作自动路由到合适的分片上。每个分片是一个replica set。</li>
<li>一个replica set是一台或多台服务器，每台机器持有相同数据的拷贝。在特定的时间点，一台机器是主节点而其他机器是从节点。如果主节点死掉了，其中一台从节点自动接管为主节点。所有的写操作和一致性读操作都进入主节点，而所有的最终一致性读操作分布到所有从节点上。</li>
<li>多台配置服务器，其中每台配置服务器持有表明数据位于哪个分片的元数据的拷贝。</li>
<li>一个或多个路由器，其中每个路由器都作为一个或多个客户端的服务器。客户端向路由器发起查询和更新，路由器询问配置服务器后将请求分发到合适的分片上。</li>
<li>一个或多个客户端，其中每个客户端都是用户应用程序的一部分，它使用自身语言的mongo客户端驱动向路由器发起请求。</li>
<li>当集群中某个分片宕掉以后，只要不涉及到该节点的操纵仍然能进行。当宕掉的节点重启后，集群能自动从故障中恢复过来。</li>
</ol>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2017/06/28/Bigdata-hadoop/Kafka/Bigdata-开源的Kafka集群管理器(Kafka Manager)/" data-toggle="tooltip" data-placement="top" title="Bigdata-开源的Kafka集群管理器(Kafka Manager)">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2017/06/01/Bigdata-hadoop/Zabbix监控Kafka集群 Brokers服务/" data-toggle="tooltip" data-placement="top" title="Zabbix监控Kafka集群 Brokers服务">Next Post &rarr;</a>
                        </li>
                    
                </ul>
		 

                

                

            </div>
    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Database" title="Database">Database</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="http://openskill.cn/" target="_blank">openskill.cn</a></li>
                    
                        <li><a href="http://yuzhouwan.com/" target="_blank">Benedict Jin&#39;s Blog</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>








<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                    <li>
                        <a target="_blank" href="https://twitter.com/yancyoo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/benet1006">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/yangcvo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/yangcvo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Jolly-Yancy&#39;s blog 2017 
                    <br>
                 Theme by <a href="http://blog.yancy.cc">Yancy</a>
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span>
                    Ported by <a href="http://github.com/yangcvo">Github</a>

                    <!--<iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>--> 
		</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://blog.yancy.cc/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->


<!-- Side Catalog -->





<!-- Image to hack wechat -->
<img src="http://blog.yancy.cc/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
