<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Redis主从集群搭建及容灾部署 · Cheng yang's Blog</title><meta name="description" content="Redis主从集群搭建及容灾部署 - yangc"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.yangcvo.me/atom.xml" title="Cheng yang's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/yangcvo" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/yangcvo" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://blog.yangcvo.me/2014/05/04/%E4%B8%AA%E4%BA%BA%E8%AE%B0%E5%BD%95/About-me/" target="_blank" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Redis主从集群搭建及容灾部署</h1><div class="post-info">2015年11月19日</div><div class="post-content"><h2 id="Redis-主从复制原理及分析"><a href="#Redis-主从复制原理及分析" class="headerlink" title="Redis-主从复制原理及分析"></a>Redis-主从复制原理及分析</h2><h3 id="Slave向Master同步的实现是："><a href="#Slave向Master同步的实现是：" class="headerlink" title="Slave向Master同步的实现是："></a>Slave向Master同步的实现是：</h3><p>Slave向Master发出同步请求（发送sync命令），Master先dump出rdb文件，然后将rdb文件全量传输给slave，然后Master把缓存的写命令转发给Slave，初次同步完成。</p>
<h3 id="以及以后的同步实现是："><a href="#以及以后的同步实现是：" class="headerlink" title="以及以后的同步实现是："></a>以及以后的同步实现是：</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Master将变量的快照直接实时依次发送给各个Slave。</span><br><span class="line">但不管什么原因导致Slave和Master断开重连都会重复以上两个步骤的过程。</span><br><span class="line">Redis的主从复制是建立在内存快照的持久化基础上的，只要有Slave就一定会有内存快照发生。</span><br></pre></td></tr></table></figure>
<h3 id="主从复制原理总结几点："><a href="#主从复制原理总结几点：" class="headerlink" title="主从复制原理总结几点："></a>主从复制原理总结几点：</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1.Slave启动后，无论是第一次连接还是重连到Master，它都会主动发出一个SYNC命令</span><br><span class="line">2.当Master收到SYNC命令之后，将会执行BGSAVE(后台存盘进程)，即在后台保存数据到磁盘（rdb快照文件），同时收集所有新收到的写入和修改数据集的命令存入缓冲区（非查询类）</span><br><span class="line">3.Master在后台把数据保存到快照文件完成后，会传送整个数据库文件到Slave</span><br><span class="line">4.Slave接收到数据库文件后，会把内存清空，然后加载该文件到内存中以完成一次完全同步</span><br><span class="line">5.然后Master会把之前收集到缓冲区中的命令和新的修改命令依次传送给Slave</span><br><span class="line">6.Slave接受到之后在本地执行这些数据修改命令，从而达到最终的数据同步</span><br><span class="line">7.之后Master与Slave之间将会不断的通过异步方式进行命令的同步，从而保证数据的时时同步</span><br><span class="line">8.如果Master和Slave之间的链接出现断连，Slave可以自动重连Master。</span><br><span class="line"></span><br><span class="line">根据版本的不同，断连后同步的方式也不同：</span><br><span class="line"></span><br><span class="line">2.8之前：重连成功之后，一次全量同步操作将被自动执行</span><br><span class="line">2.8之后：重连成功之后，进行部分同步操作</span><br></pre></td></tr></table></figure>
<p><img src="http://7xrthw.com1.z0.glb.clouddn.com/redis.png" alt=""></p>
<h3 id="Redis-sentinel原理分析"><a href="#Redis-sentinel原理分析" class="headerlink" title="Redis-sentinel原理分析"></a>Redis-sentinel原理分析</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Redis-sentinel是Redis实例的监控管理、通知和实例失效备援服务，是Redis集群的管理工具。在一般的分布式中心节点数据库中，Redis-sentinel的作用是中心节点的工作，监控各个其他节点的工作情况并且进行故障恢复，来提高集群的高可用性。</span><br><span class="line"></span><br><span class="line">Redis-sentinel是Redis的作者antirez在2013年6月份完成的，因为Redis实例在各个大公司的应用，每个公司都需要一个Redis集群的管理工具，被迫都自己写管理工具来管理Redis集群，antirez考虑到社区的急迫需要，花了几个星期写出了Redis-sentinel。</span><br></pre></td></tr></table></figure>
<h3 id="Redis-sentinel三大功能"><a href="#Redis-sentinel三大功能" class="headerlink" title="Redis-sentinel三大功能"></a>Redis-sentinel三大功能</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Redis-sentinel的三大功能：监测、通知、自动故障恢复。首先Redis-sentinel要建立一个监控的master列表，然后针对master列表的每个master获取监控其的sentinels和slaves供以后故障恢复使用。</span><br></pre></td></tr></table></figure>
<h3 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h3><p>网站的访问量慢慢上来了。为了网站的性能方面，开始用了redis做缓存策略。刚开始的时候，redis是一个单点，当一台机器岩机的时候，redis的 服务完全停止，这时就会影响其他服务的正常运行。费话不多说了，下面利用redis sentinel做一个主从切换的集群管理。做这个集群管理的时候，查过很多资料才完全了解，从数据类型、主从原理、持久化方式等方面着手看了不少资料，也进行了一些实践操作。redis的配置都比较简单，网络上相关资料比较多，把实践的过程记录下来以备查阅。</p>
<h3 id="补充摘要："><a href="#补充摘要：" class="headerlink" title="补充摘要："></a>补充摘要：</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">redis 安装包：http://redis.io/download</span><br><span class="line">中文redis社区:http://redis.cn/community.html</span><br><span class="line">参考资料：http://redis.io/topics/sentinel</span><br></pre></td></tr></table></figure>
<h3 id="系统环境环境："><a href="#系统环境环境：" class="headerlink" title="系统环境环境："></a>系统环境环境：</h3><p>这里我用kvm 虚拟出三台服务器：然后搭好了环境。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">virsh <span class="comment"># list --all</span></span><br><span class="line"> Id      名称                        状态</span><br><span class="line">-------------------------------------------------</span><br><span class="line"> 1   redis_sentinel                 running</span><br><span class="line"> 2   LAN_redis2                     running</span><br><span class="line"> 3   LAN_redis1                     running</span><br></pre></td></tr></table></figure>
<p>集群配置最少需要三台机器，那么我就三台虚拟机,三台虚拟机分别安装同样的redis的环境</p>
<p>ip分别：</p>
<ul>
<li>192.168.1.172  （redis sentinel 集群监控）</li>
<li>192.168.1.173  （redis master 节点）</li>
<li>192.168.1.174  （redis slave  节点）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@sentinel ~]<span class="comment"># cat /etc/issue</span></span><br><span class="line">CentOS release 6.7 (Final)</span><br><span class="line">Kernel \r on an \m</span><br></pre></td></tr></table></figure>
<h3 id="redis安装配置"><a href="#redis安装配置" class="headerlink" title="redis安装配置:"></a>redis安装配置:</h3><p>下载，解压和编译Redis的：master默认配置：</p>
<h3 id="master："><a href="#master：" class="headerlink" title="master："></a>master：</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@LAN_redis1 ~]<span class="comment"># curl -O http://download.redis.io/releases/redis-3.2.1.tar.gz -C /tmp/.</span></span><br><span class="line">[root@LAN_redis1 ~]<span class="comment"># tar xzf redis-3.2.1.tar.gz -C /usr/local/.</span></span><br><span class="line">[root@LAN_redis1 ~]<span class="comment"># cd /usr/local/redis-3.2.1/</span></span><br><span class="line">[root@LAN_redis1 redis-3.2.1]<span class="comment"># make</span></span><br><span class="line">[root@LAN_redis1 redis-3.2.1]<span class="comment"># src/redis-server</span></span><br><span class="line">4772:C 20 Jun 18:43:42.681 <span class="comment"># Warning: no config file specified, using the default config. In order to specify a config file use src/redis-server /path/to/redis.conf</span></span><br><span class="line">                _._</span><br><span class="line">           _.-``__ <span class="string">''</span>-._</span><br><span class="line">      _.-``    `.  `_.  <span class="string">''</span>-._           Redis 3.2.1 (00000000/0) 64 bit</span><br><span class="line">  .-`` .-```.  ```\/    _.,_ <span class="string">''</span>-._</span><br><span class="line"> (    <span class="string">'      ,       .-`  | `,    )     Running in standalone mode</span><br><span class="line"> |`-._`-...-` __...-.``-._|'</span>` _.-<span class="string">'|     Port: 6379</span><br><span class="line"> |    `-._   `._    /     _.-'</span>    |     PID: 4772</span><br><span class="line">  `-._    `-._  `-./  _.-<span class="string">'    _.-'</span></span><br><span class="line"> |`-._`-._    `-.__.-<span class="string">'    _.-'</span>_.-<span class="string">'|</span><br><span class="line"> |    `-._`-._        _.-'</span>_.-<span class="string">'    |           http://redis.io</span><br><span class="line">  `-._    `-._`-.__.-'</span>_.-<span class="string">'    _.-'</span></span><br><span class="line"> |`-._`-._    `-.__.-<span class="string">'    _.-'</span>_.-<span class="string">'|</span><br><span class="line"> |    `-._`-._        _.-'</span>_.-<span class="string">'    |</span><br><span class="line">  `-._    `-._`-.__.-'</span>_.-<span class="string">'    _.-'</span></span><br><span class="line">      `-._    `-.__.-<span class="string">'    _.-'</span></span><br><span class="line">          `-._        _.-<span class="string">'</span><br><span class="line">              `-.__.-'</span></span><br><span class="line"></span><br><span class="line">4772:M 20 Jun 18:43:42.683 <span class="comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></span><br><span class="line">4772:M 20 Jun 18:43:42.683 <span class="comment"># Server started, Redis version 3.2.1</span></span><br><span class="line">4772:M 20 Jun 18:43:42.683 <span class="comment"># WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.</span></span><br><span class="line">4772:M 20 Jun 18:43:42.683 <span class="comment"># WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</span></span><br><span class="line">4772:M 20 Jun 18:43:42.683 * The server is now ready to accept connections on port 6379</span><br><span class="line">这里提醒：Ctrl+C 退出 以后执行：src/redis-server &amp;</span><br><span class="line">这样让服务都在后台执行。就不需要重新开启终端了。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@LAN_redis1 redis-3.2.1]<span class="comment"># netstat -ntulp</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</span><br><span class="line">tcp        0      0 0.0.0.0:6379                0.0.0.0:*                   LISTEN      4780/src/redis-serv</span><br><span class="line">tcp        0      0 0.0.0.0:22                  0.0.0.0:*                   LISTEN      1381/sshd</span><br><span class="line">tcp        0      0 127.0.0.1:25                0.0.0.0:*                   LISTEN      1461/master</span><br><span class="line">tcp        0      0 :::6379                     :::*                        LISTEN      4780/src/redis-serv</span><br><span class="line">tcp        0      0 :::22                       :::*                        LISTEN      1381/sshd</span><br><span class="line">tcp        0      0 ::1:25                      :::*                        LISTEN      1461/master</span><br><span class="line"></span><br><span class="line">这里我们都先关闭服务：</span><br><span class="line"></span><br><span class="line">[root@LAN_redis1 redis-3.2.1]<span class="comment"># /usr/local/redis-3.2.1/src/redis-cli -n 6379 shutdown</span></span><br></pre></td></tr></table></figure>
<h3 id="redis-master-配置："><a href="#redis-master-配置：" class="headerlink" title="redis master 配置："></a>redis master 配置：</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">创建日志目录</span><br><span class="line">[root@LAN_redis1 redis-3.2.1]<span class="comment"># mkdir /var/log/redis</span></span><br><span class="line">[root@LAN_redis1 redis-3.2.1]<span class="comment"># touch /var/log/redis/redis.log</span></span><br><span class="line">创建数据目录</span><br><span class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># mkdir -p /data/redis</span></span><br><span class="line"></span><br><span class="line">找到配置文件/usr/<span class="built_in">local</span>/redis-3.2.1/redis.conf</span><br><span class="line">[root@LAN_redis1 redis-3.2.1]<span class="comment"># vim redis.conf</span></span><br><span class="line">修改如下内容：</span><br><span class="line"><span class="comment">#bind 127.0.0.1 # 注释</span></span><br><span class="line">daemonize no 改为 yes <span class="comment"># 是否后台运行</span></span><br><span class="line">port 6379 这里端口我保持默认不做修改。</span><br><span class="line">logfile <span class="string">"/var/log/redis/redis.log"</span>  <span class="comment">## 添加日志保存绝对路径。</span></span><br><span class="line">dir /data/redis/    <span class="comment"># 数据目录 </span></span><br><span class="line">masterauth <span class="string">"ghost+db@hz2016"</span></span><br><span class="line">requirepass <span class="string">"ghost+db@hz2016"</span> 设置密码</span><br></pre></td></tr></table></figure>
<h3 id="slave"><a href="#slave" class="headerlink" title="slave:"></a>slave:</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@LAN_redis2 ~]<span class="comment"># curl -O http://download.redis.io/releases/redis-3.2.1.tar.gz -C /tmp/.</span></span><br><span class="line">[root@LAN_redis2 ~]<span class="comment"># tar xzf redis-3.2.1.tar.gz -C /usr/local/.</span></span><br><span class="line">[root@LAN_redis2 ~]<span class="comment"># cd /usr/local/redis-3.2.1/</span></span><br><span class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment">#  make</span></span><br><span class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># src/redis-server</span></span><br><span class="line">7263:C 20 Jun 18:46:14.140 <span class="comment"># Warning: no config file specified, using the default config. In order to specify a config file use src/redis-server /path/to/redis.conf</span></span><br><span class="line">                _._</span><br><span class="line">           _.-``__ <span class="string">''</span>-._</span><br><span class="line">      _.-``    `.  `_.  <span class="string">''</span>-._           Redis 3.2.1 (00000000/0) 64 bit</span><br><span class="line">  .-`` .-```.  ```\/    _.,_ <span class="string">''</span>-._</span><br><span class="line"> (    <span class="string">'      ,       .-`  | `,    )     Running in standalone mode</span><br><span class="line"> |`-._`-...-` __...-.``-._|'</span>` _.-<span class="string">'|     Port: 6379</span><br><span class="line"> |    `-._   `._    /     _.-'</span>    |     PID: 7263</span><br><span class="line">  `-._    `-._  `-./  _.-<span class="string">'    _.-'</span></span><br><span class="line"> |`-._`-._    `-.__.-<span class="string">'    _.-'</span>_.-<span class="string">'|</span><br><span class="line"> |    `-._`-._        _.-'</span>_.-<span class="string">'    |           http://redis.io</span><br><span class="line">  `-._    `-._`-.__.-'</span>_.-<span class="string">'    _.-'</span></span><br><span class="line"> |`-._`-._    `-.__.-<span class="string">'    _.-'</span>_.-<span class="string">'|</span><br><span class="line"> |    `-._`-._        _.-'</span>_.-<span class="string">'    |</span><br><span class="line">  `-._    `-._`-.__.-'</span>_.-<span class="string">'    _.-'</span></span><br><span class="line">      `-._    `-.__.-<span class="string">'    _.-'</span></span><br><span class="line">          `-._        _.-<span class="string">'</span><br><span class="line">              `-.__.-'</span></span><br><span class="line"></span><br><span class="line">7263:M 20 Jun 18:46:14.142 <span class="comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></span><br><span class="line">7263:M 20 Jun 18:46:14.142 <span class="comment"># Server started, Redis version 3.2.1</span></span><br><span class="line">7263:M 20 Jun 18:46:14.142 <span class="comment"># WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.</span></span><br><span class="line">7263:M 20 Jun 18:46:14.143 <span class="comment"># WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</span></span><br><span class="line">7263:M 20 Jun 18:46:14.143 * The server is now ready to accept connections on port 6379</span><br><span class="line"></span><br><span class="line">这里提醒：Ctrl+C 退出 以后执行：src/redis-server &amp;</span><br><span class="line">这样让服务都在后台执行。就不需要重新开启终端了。</span><br><span class="line"></span><br><span class="line">测试：</span><br><span class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># src/redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> foo bar</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get foo</span><br><span class="line"><span class="string">"bar"</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># netstat -ntulp</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</span><br><span class="line">tcp        0      0 0.0.0.0:6379                0.0.0.0:*                   LISTEN      7266/src/redis-serv</span><br><span class="line">tcp        0      0 0.0.0.0:22                  0.0.0.0:*                   LISTEN      3810/sshd</span><br><span class="line">tcp        0      0 127.0.0.1:25                0.0.0.0:*                   LISTEN      1363/master</span><br><span class="line">tcp        0      0 :::6379                     :::*                        LISTEN      7266/src/redis-serv</span><br><span class="line">tcp        0      0 :::22                       :::*                        LISTEN      3810/sshd</span><br><span class="line">tcp        0      0 ::1:25                      :::*                        LISTEN      1363/master</span><br></pre></td></tr></table></figure>
<h3 id="redis-slave-配置："><a href="#redis-slave-配置：" class="headerlink" title="redis slave 配置："></a>redis slave 配置：</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">创建日志目录</span><br><span class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># mkdir /var/log/redis</span></span><br><span class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># touch /var/log/redis/redis.log</span></span><br><span class="line">创建数据目录</span><br><span class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># mkdir -p /data/redis</span></span><br><span class="line">找到配置文件/usr/<span class="built_in">local</span>/redis-3.2.1/redis.conf</span><br><span class="line"></span><br><span class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># vim redis.conf</span></span><br><span class="line">修改如下内容：</span><br><span class="line"><span class="comment">#bind 127.0.0.1 # 注释</span></span><br><span class="line">daemonize no 改为 yes <span class="comment"># 是否后台运行</span></span><br><span class="line">port 6379 这里端口我保持默认不做修改。</span><br><span class="line">logfile <span class="string">"/var/log/redis/redis.log"</span>  <span class="comment">## 添加日志保存绝对路径。</span></span><br><span class="line">dir /data/redis/    <span class="comment"># 数据目录 </span></span><br><span class="line">slaveof  192.168.1.173 6379  <span class="comment"># slaveof master的ip master的端口 设置当本机为 slav 服务时，设置 master 服务的 IP 地址及端口，在 Redis 启动时，它会自动从 master 进行数据同步</span></span><br><span class="line">masterauth <span class="string">"ghost+db@hz2016"</span>   <span class="comment">## 当 master 服务设置了密码保护时， slav 服务连接 master 的密码</span></span><br><span class="line">requirepass <span class="string">"ghost+db@hz2016"</span>  设置密码</span><br></pre></td></tr></table></figure>
<h3 id="配置附件：剩下的后面默认就好"><a href="#配置附件：剩下的后面默认就好" class="headerlink" title="配置附件：剩下的后面默认就好."></a>配置附件：剩下的后面默认就好.</h3><p>这里主从我设置了密码：master和slave 都需要设置密码，不然同步不成功。<br>不成功报错日志：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">8395:S 21 Jun 14:09:22.073 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">8395:S 21 Jun 14:09:22.073 <span class="comment"># Error condition on socket for SYNC: Connection refused</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">protected-mode yes  </span><br><span class="line">port 6379        <span class="comment"># 监听端口</span></span><br><span class="line">tcp-backlog 511   <span class="comment"># TCP接收队列长度，受/proc/sys/net/core/somaxconn和tcp_max_syn_backlog这两个内核参数的影响</span></span><br><span class="line">timeout 0         <span class="comment">## 一个客户端空闲多少秒后关闭连接(0代表禁用，永不关闭)</span></span><br><span class="line">tcp-keepalive 300</span><br><span class="line">daemonize yes     <span class="comment"># 守护进程模式</span></span><br><span class="line">supervised no</span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line">masterauth <span class="string">"ghost+db@hz2016"</span>  <span class="comment"># 当master服务设置了密码保护时，slav服务连接master的密码</span></span><br><span class="line">loglevel notice</span><br><span class="line">logfile <span class="string">"/var/log/redis/redis.log"</span>  <span class="comment"># 指明日志文件名</span></span><br><span class="line">databases 16</span><br><span class="line">save 900 1 <span class="comment">## 900秒内有1次修改将会保存</span></span><br><span class="line">save 300 10 <span class="comment">## 300秒内有10次修改将会保存</span></span><br><span class="line">save 60 10000 <span class="comment">## 60秒内有10000次修改保存</span></span><br><span class="line">stop-writes-on-bgsave-error yes  <span class="comment"># 默认如果开启RDB快照(至少一条save指令)并且最新的后台保存失败，Redis将会停止接受写操作</span></span><br><span class="line"><span class="comment"># 这将使用户知道数据没有正确的持久化到硬盘，否则可能没人注意到并且造成一些灾难</span></span><br><span class="line">rdbcompression yes <span class="comment">## 开启rdb压缩</span></span><br><span class="line">rdbchecksum yes  <span class="comment"># 版本5的RDB有一个CRC64算法的校验和放在了文件的最后。这将使文件格式更加可靠。</span></span><br><span class="line">dbfilename dump.rdb <span class="comment">## DB名字</span></span><br><span class="line">dir  /data/redis/    <span class="comment">## 工作目录，一定要指定</span></span><br><span class="line">requirepass <span class="string">"ghost+db@hz2016"</span> 设置redis访问的密码 <span class="comment"># 密码验证</span></span><br><span class="line"><span class="comment"># 警告：因为Redis太快了，所以外面的人可以尝试每秒150k的密码来试图破解密码。这意味着你需要</span></span><br><span class="line"><span class="comment"># 一个高强度的密码，否则破解太容易了</span></span><br><span class="line">slave-serve-stale-data yes</span><br><span class="line">slave-read-only yes</span><br><span class="line">repl-diskless-sync no</span><br><span class="line">repl-diskless-sync-delay 5</span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line">slave-priority 100</span><br><span class="line">appendonly no</span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line">lua-time-limit 5000</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128</span><br><span class="line">latency-monitor-threshold 0</span><br><span class="line">notify-keyspace-events <span class="string">""</span></span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-entries 512</span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-value 64</span><br><span class="line">list-max-ziplist-size -2</span><br><span class="line">list-compress-depth 0</span><br><span class="line"><span class="built_in">set</span>-max-intset-entries 512</span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line">activerehashing yes</span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit slave 256mb 64mb 60</span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line">hz 10</span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure>
<h3 id="启动master："><a href="#启动master：" class="headerlink" title="启动master："></a>启动master：</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@LAN_redis1 redis-3.2.1]# /usr/local/redis-3.2.1/src/redis-server /usr/local/redis-3.2.1/redis.conf &amp;</span><br><span class="line">[1] 5738</span><br><span class="line">[root@LAN_redis1 redis-3.2.1]#</span><br><span class="line">[1]+  Done                    /usr/local/redis-3.2.1/src/redis-server /usr/local/redis-3.2.1/redis.conf</span><br><span class="line">[root@LAN_redis1 redis-3.2.1]#</span><br><span class="line">[root@LAN_redis1 redis-3.2.1]#</span><br><span class="line">[root@LAN_redis1 redis-3.2.1]# netstat -ntulp</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</span><br><span class="line">tcp        0      0 192.168.1.173:10050         0.0.0.0:*                   LISTEN      1479/zabbix_agentd</span><br><span class="line">tcp        0      0 0.0.0.0:6379                0.0.0.0:*                   LISTEN      5739/redis-server *</span><br><span class="line">tcp        0      0 0.0.0.0:22                  0.0.0.0:*                   LISTEN      1381/sshd</span><br><span class="line">tcp        0      0 127.0.0.1:25                0.0.0.0:*                   LISTEN      1461/master</span><br><span class="line">tcp        0      0 :::6379                     :::*                        LISTEN      5739/redis-server *</span><br><span class="line">tcp        0      0 :::22                       :::*                        LISTEN      1381/sshd</span><br><span class="line">tcp        0      0 ::1:25                      :::*                        LISTEN      1461/master</span><br></pre></td></tr></table></figure>
<h3 id="启动-slave-："><a href="#启动-slave-：" class="headerlink" title="启动 slave ："></a>启动 slave ：</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment">#/usr/local/redis-3.2.1/src/redis-server /usr/local/redis-3.2.1/redis.conf &amp;</span></span><br><span class="line">[1]+  Done                    /usr/<span class="built_in">local</span>/redis-3.2.1/src/redis-server /usr/<span class="built_in">local</span>/redis-3.2.1/redis.conf</span><br><span class="line"> </span><br><span class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># netstat -ntulp</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</span><br><span class="line">tcp        0      0 192.168.1.174:10050         0.0.0.0:*                   LISTEN      3998/zabbix_agentd</span><br><span class="line">tcp        0      0 0.0.0.0:6379                0.0.0.0:*                   LISTEN      8192/redis-server *</span><br><span class="line">tcp        0      0 0.0.0.0:22                  0.0.0.0:*                   LISTEN      3810/sshd</span><br><span class="line">tcp        0      0 127.0.0.1:25                0.0.0.0:*                   LISTEN      1363/master</span><br><span class="line">tcp        0      0 :::6379                     :::*                        LISTEN      8192/redis-server *</span><br><span class="line">tcp        0      0 :::22                       :::*                        LISTEN      3810/sshd</span><br><span class="line">tcp        0      0 ::1:25                      :::*                        LISTEN      1363/master</span><br></pre></td></tr></table></figure>
<h3 id="主从测试并查看数据同步情况："><a href="#主从测试并查看数据同步情况：" class="headerlink" title="主从测试并查看数据同步情况："></a>主从测试并查看数据同步情况：</h3><p>master :</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@LAN_redis1 redis-3.2.1]<span class="comment"># /usr/local/redis-3.2.1/src/redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> name <span class="built_in">test</span></span><br><span class="line">(error) NOAUTH Authentication required.</span><br><span class="line">127.0.0.1:6379&gt; auth ghost+db@hz2016</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> name <span class="built_in">test</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; save</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> aa 123</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get aa</span><br><span class="line"><span class="string">"123"</span></span><br></pre></td></tr></table></figure>
<p>slave:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># /usr/local/redis-3.2.1/src/redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line">127.0.0.1:6379&gt; get aa</span><br><span class="line">(error) NOAUTH Authentication required.</span><br><span class="line">127.0.0.1:6379&gt; auth ghost+db@hz2016</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get aa</span><br><span class="line"><span class="string">"123"</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line"><span class="string">"test"</span></span><br></pre></td></tr></table></figure>
<h3 id="查看主从关系："><a href="#查看主从关系：" class="headerlink" title="查看主从关系："></a>查看主从关系：</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@LAN_redis1 etc]<span class="comment">#  /usr/local/redis-3.2.1/src/redis-cli -a ghost+db@hz2016 -p 6379 info Replication</span></span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=192.168.1.174,port=6379,state=online,offset=57,lag=1</span><br><span class="line">slave1:ip=192.168.1.172,port=6379,state=online,offset=43,lag=1</span><br><span class="line">master_repl_offset:57</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:2</span><br><span class="line">repl_backlog_histlen:56</span><br><span class="line">``` </span><br><span class="line">这里两slave，因为我把哨兵也加上了。</span><br><span class="line"><span class="comment">### 安装Redis Sentinel配置 </span></span><br><span class="line">Sentinel是一个管理多个redis实例的工具，它可以实现对redis的监控、通知、自动故障转移。</span><br><span class="line"></span><br><span class="line">sentinel不断的检测redis实例是否可以正常工作，通过API向其他程序报告redis的状态，如果redis master不能工作，则会自动启动故障转移进程，将其中的一个slave提升为master，其他的slave重新设置新的master实例。也就是说，它提供了：</span><br><span class="line"></span><br><span class="line">监控（Monitoring）： Sentinel 会不断地检查你的主实例和从实例是否正常。</span><br><span class="line">通知（Notification）： 当被监控的某个 Redis 实例出现问题时， Sentinel 进程可</span><br><span class="line">以通过 API 向管理员或者其他应用程序发送通知。</span><br><span class="line"></span><br><span class="line">自动故障迁移（Automatic failover）： 当一个主redis实例失效时， Sentinel 会开始记性一次failover， 它会将失效主实例的其中一个从实例升级为新的主实例， 并让失效主实例的其他从实例改为复制新的主实例； 而当客户端试图连接失效的主实例时， 集群也会向客户端返回新主实例的地址， 使得集群可以使用新主实例代替失效实例。</span><br><span class="line">Redis Sentinel自身也是一个分布式系统， 你可以在一个架构中运行多个 Sentinel 进程， 这些进程使用流言协议（gossip protocols)来接收关于主Redis实例是否失效的信息， 然后使用投票协议来决定是否执行自动failover，以及评选出从Redis实例作为新的主Redis实例。</span><br><span class="line"></span><br><span class="line">同样在192.168.1.172 安装最新版的3.2.1 redis</span><br><span class="line"><span class="comment">### 启动sentinel的方法</span></span><br><span class="line">当前Redis stable版已经自带了redis-sentinel这个工具。虽然 Redis Sentinel 已经提供了一个单独的可执行文件 redis-sentinel ， 但实际上它只是一个运行在特殊模式下的 Redis实例， 你可以在启动一个普通 Redis实例时通过给定 –sentinel 选项来启动 Redis Sentinel 实例。也就是说：</span><br><span class="line">             </span><br><span class="line">    redis-sentinel /etc/sentinel.conf</span><br><span class="line">等同于</span><br><span class="line">     </span><br><span class="line">    redis-server /etc/sentinel.conf --sentinel</span><br><span class="line"></span><br><span class="line">其中sentinel.conf是redis的配置文件，Redis sentinel会需要写入配置文件来保存sentinel的当前状态。当配置文件无法写入时，Sentinel启动失败。并正确设置防火墙.</span><br><span class="line"></span><br><span class="line"><span class="comment">### sentinel部署须知</span></span><br><span class="line">一个稳健的redis集群，应该使用至少三个sentinel实例，并且保证讲这些实例放到不同的机器上，甚至不同的物理区域。</span><br><span class="line">sentinel无法保证强一致性, 大概分布式环境都会有这方面的权衡.</span><br><span class="line">确保client库支持sentinel.</span><br><span class="line">sentinel需要通过不断的测试和观察，才能保证高可用。</span><br><span class="line">sentinel配合docker使用时，要注意端口映射带来的影响.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">``` bash </span><br><span class="line">安装好了redis </span><br><span class="line">[root@sentinel redis-3.2.1]<span class="comment"># cp /usr/local/redis-3.2.1/sentinel.conf /etc/sentinel.conf</span></span><br><span class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># cp /usr/local/redis-3.2.1/sentinel.conf /etc/sentinel.conf</span></span><br><span class="line">[root@LAN_redis1 redis-3.2.1]<span class="comment"># cp /usr/local/redis-3.2.1/sentinel.conf /etc/sentinel.conf</span></span><br><span class="line">机器所有都拷贝一份,创建下面文件目录。</span><br><span class="line">[root@sentinel redis-3.2.1]<span class="comment"># touch /var/log/redis/sentinel.log</span></span><br><span class="line">[root@sentinel redis-3.2.1]<span class="comment"># touch /var/run/sentinel.pid</span></span><br></pre></td></tr></table></figure>
<p>配置:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">logfile <span class="string">"/var/log/redis/sentinel.log"</span></span><br><span class="line">pidfile <span class="string">"/var/run/sentinel.pid"</span></span><br><span class="line">dir <span class="string">"/tmp"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Master 6379</span></span><br><span class="line">sentinel monitor mymaster 192.168.1.173 6379 2   </span><br><span class="line">sentinel down-after-milliseconds mymaster 5000</span><br><span class="line">sentinel parallel-syncs mymaster 10000        </span><br><span class="line">sentinel auth-pass mymaster redis4Hz@2015</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br></pre></td></tr></table></figure>
<p>其他两台一样配置。<br>启动3个sentinel节点。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@LAN_redis1 etc]<span class="comment"># /usr/local/redis-3.2.1/src/redis-sentinel /etc/sentinel.conf  --sentinel</span></span><br></pre></td></tr></table></figure>
<p>查看节点是否都已经启动：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@LAN_redis1 etc]<span class="comment">#  ps -ef | grep redis-sentinel</span></span><br><span class="line">root      5992     1  0 15:06 ?        00:00:00 /usr/<span class="built_in">local</span>/redis-3.2.1/src/redis-sentinel *:26379 [sentinel]</span><br><span class="line">root      5996  5574  0 15:07 pts/1    00:00:00 grep redis-sentinel</span><br></pre></td></tr></table></figure>
<p>然后查看日志：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@sentinel redis-3.2.1]<span class="comment"># tailf /var/log/redis/sentinel.log</span></span><br><span class="line"> |    `-._`-._        _.-<span class="string">'_.-'</span>    |</span><br><span class="line">  `-._    `-._`-.__.-<span class="string">'_.-'</span>    _.-<span class="string">'</span><br><span class="line">      `-._    `-.__.-'</span>    _.-<span class="string">'</span><br><span class="line">          `-._        _.-'</span></span><br><span class="line">              `-.__.-<span class="string">'</span><br><span class="line"></span><br><span class="line">9541:X 21 Jun 15:05:15.398 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span><br><span class="line">9541:X 21 Jun 15:05:15.406 # Sentinel ID is c1143e64b85a9ce321d4b33c5b463b7958477f37</span><br><span class="line">9541:X 21 Jun 15:05:15.406 # +monitor master mymaster 192.168.1.173 6379 quorum 2</span><br><span class="line">9541:X 21 Jun 15:05:20.406 # +sdown master mymaster 192.168.1.173 6379</span></span><br></pre></td></tr></table></figure>
<p>这里的ID 在看看/etc/sentinel 的配置。</p>
<h3 id="哨兵一配置-参考：sentinel1-conf"><a href="#哨兵一配置-参考：sentinel1-conf" class="headerlink" title="哨兵一配置 参考：sentinel1.conf"></a>哨兵一配置 参考：sentinel1.conf</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Example sentinel.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># port &lt;sentinel-port&gt;</span></span><br><span class="line">port 26371</span><br><span class="line"></span><br><span class="line"><span class="comment"># 守护进程模式</span></span><br><span class="line">daemonize yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指明日志文件名</span></span><br><span class="line">logfile <span class="string">"/var/log/redis/sentinel.log"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作路径，sentinel一般指定/tmp比较简单</span></span><br><span class="line">dir /tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 哨兵监控这个master，在至少quorum个哨兵实例都认为master down后把master标记为odown</span></span><br><span class="line"><span class="comment"># （objective down客观down；相对应的存在sdown，subjective down，主观down）状态。</span></span><br><span class="line"><span class="comment"># slaves是自动发现，所以你没必要明确指定slaves。</span></span><br><span class="line">sentinel monitor TestMaster 127.0.0.1 7003 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># master或slave多长时间（默认30秒）不能使用后标记为s_down状态。</span></span><br><span class="line">sentinel down-after-milliseconds TestMaster 1500</span><br><span class="line"></span><br><span class="line"><span class="comment"># 若sentinel在该配置值内未能完成failover操作（即故障时master/slave自动切换），则认为本次failover失败。</span></span><br><span class="line">sentinel failover-timeout TestMaster 10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置master和slaves验证密码</span></span><br><span class="line">sentinel auth-pass TestMaster 0234kz9*l</span><br><span class="line"></span><br><span class="line">sentinel config-epoch TestMaster 15</span><br><span class="line">sentinel leader-epoch TestMaster 8394</span><br><span class="line"></span><br><span class="line"><span class="comment"># #除了当前哨兵, 还有哪些在监控这个master的哨兵</span></span><br><span class="line">sentinel known-sentinel TestMaster 127.0.0.1 26372 0aca3a57038e2907c8a07be2b3c0d15171e44da5</span><br><span class="line">sentinel known-sentinel TestMaster 127.0.0.1 26373 ac1ef015411583d4b9f3d81cee830060b2f29862</span><br><span class="line"></span><br><span class="line">sentinel current-epoch 8394</span><br></pre></td></tr></table></figure>
<p>master：sentinel.conf配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">logfile <span class="string">"/var/log/redis/sentinel.log"</span></span><br><span class="line">pidfile <span class="string">"/var/run/sentinel.pid"</span></span><br><span class="line">dir <span class="string">"/tmp"</span></span><br><span class="line"><span class="comment">#Master 6379</span></span><br><span class="line">sentinel monitor mymaster 192.168.1.173 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 5000</span><br><span class="line">sentinel auth-pass mymaster redis4Hz@2015</span><br><span class="line">sentinel config-epoch mymaster 2919</span><br><span class="line">sentinel leader-epoch mymaster 2919</span><br><span class="line"><span class="comment"># Generated by CONFIG REWRITE</span></span><br><span class="line">sentinel known-sentinel mymaster 192.168.1.174 26379 a3a6df103a7acaa56e4e6e9af63808dc9b525d1e</span><br><span class="line">sentinel known-sentinel mymaster 192.168.1.172 26379 c1143e64b85a9ce321d4b33c5b463b7958477f37</span><br><span class="line">sentinel current-epoch 2926</span><br></pre></td></tr></table></figure>
<p>slave : sentinel.conf配置：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">logfile <span class="string">"/var/log/redis/sentinel.log"</span></span><br><span class="line">pidfile <span class="string">"/var/run/sentinel.pid"</span></span><br><span class="line">dir <span class="string">"/tmp"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Master 6379</span></span><br><span class="line">sentinel monitor mymaster 192.168.1.173 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 5000</span><br><span class="line">sentinel auth-pass mymaster redis4Hz@2015</span><br><span class="line">sentinel config-epoch mymaster 2919</span><br><span class="line">sentinel leader-epoch mymaster 2918</span><br><span class="line"><span class="comment"># Generated by CONFIG REWRITE</span></span><br><span class="line">sentinel known-sentinel mymaster 192.168.1.173 26379 ec452bf207d6cc720d3289180f66e9fa5a945f67</span><br><span class="line">sentinel known-sentinel mymaster 192.168.1.172 26379 c1143e64b85a9ce321d4b33c5b463b7958477f37</span><br><span class="line">sentinel current-epoch 2926</span><br></pre></td></tr></table></figure>
<p>sentinel sentinel.conf配置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">logfile &quot;/var/log/redis/sentinel.log&quot;</span><br><span class="line">pidfile &quot;/var/run/sentinel.pid&quot;</span><br><span class="line">dir &quot;/tmp&quot;</span><br><span class="line"></span><br><span class="line">#Master 6379</span><br><span class="line">sentinel monitor mymaster 192.168.1.173 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 5000</span><br><span class="line">sentinel auth-pass mymaster redis4Hz@2015</span><br><span class="line">sentinel config-epoch mymaster 2919</span><br><span class="line">sentinel leader-epoch mymaster 2926</span><br><span class="line"># Generated by CONFIG REWRITE</span><br><span class="line">sentinel known-sentinel mymaster 192.168.1.174 26379 a3a6df103a7acaa56e4e6e9af63808dc9b525d1e</span><br><span class="line">sentinel known-sentinel mymaster 192.168.1.173 26379 ec452bf207d6cc720d3289180f66e9fa5a945f67</span><br><span class="line">sentinel current-epoch 2926</span><br></pre></td></tr></table></figure>
<p>然后在重新启动一遍。</p>
<p>然后在查看下每台日志：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">master :</span><br><span class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># tailf /var/log/redis/sentinel.log</span></span><br><span class="line">      `-._    `-.__.-<span class="string">'    _.-'</span></span><br><span class="line">          `-._        _.-<span class="string">'</span><br><span class="line">              `-.__.-'</span></span><br><span class="line"></span><br><span class="line">8510:X 21 Jun 15:36:41.973 <span class="comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></span><br><span class="line">8510:X 21 Jun 15:36:41.974 <span class="comment"># Sentinel ID is 59bd001bd3a719a2a53669db766ff6caf93cca33</span></span><br><span class="line">8510:X 21 Jun 15:36:41.974 <span class="comment"># +monitor master mymaster 192.168.1.173 6379 quorum 2</span></span><br><span class="line">8510:X 21 Jun 15:36:46.999 <span class="comment"># +sdown master mymaster 192.168.1.173 6379</span></span><br><span class="line">8510:X 21 Jun 15:36:47.000 <span class="comment"># +sdown sentinel c1143e64b85a9ce321d4b33c5b463b7958477f37 192.168.1.172 26379 @ mymaster 192.168.1.173 6379</span></span><br><span class="line">8510:X 21 Jun 15:36:47.000 <span class="comment"># +sdown sentinel ec452bf207d6cc720d3289180f66e9fa5a945f67 192.168.1.173 26379 @ mymaster 192.168.1.173 6379</span></span><br><span class="line"></span><br><span class="line">slave :</span><br><span class="line">master:</span><br><span class="line"></span><br><span class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># tailf /var/log/redis/sentinel.log</span></span><br><span class="line">      `-._    `-.__.-<span class="string">'    _.-'</span></span><br><span class="line">          `-._        _.-<span class="string">'</span><br><span class="line">              `-.__.-'</span></span><br><span class="line"></span><br><span class="line">8510:X 21 Jun 15:36:41.973 <span class="comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></span><br><span class="line">8510:X 21 Jun 15:36:41.974 <span class="comment"># Sentinel ID is 59bd001bd3a719a2a53669db766ff6caf93cca33</span></span><br><span class="line">8510:X 21 Jun 15:36:41.974 <span class="comment"># +monitor master mymaster 192.168.1.173 6379 quorum 2</span></span><br><span class="line">8510:X 21 Jun 15:36:46.999 <span class="comment"># +sdown master mymaster 192.168.1.173 6379</span></span><br><span class="line">8510:X 21 Jun 15:36:47.000 <span class="comment"># +sdown sentinel c1143e64b85a9ce321d4b33c5b463b7958477f37 192.168.1.172 26379 @ mymaster 192.168.1.173 6379</span></span><br><span class="line">8510:X 21 Jun 15:36:47.000 <span class="comment"># +sdown sentinel ec452bf207d6cc720d3289180f66e9fa5a945f67 192.168.1.173 26379 @ mymaster 192.168.1.173 6379</span></span><br><span class="line"></span><br><span class="line">sentinel:</span><br><span class="line">[root@sentinel redis-3.2.1]<span class="comment"># tailf /var/log/redis/sentinel.log</span></span><br><span class="line">      `-._    `-.__.-<span class="string">'    _.-'</span></span><br><span class="line">          `-._        _.-<span class="string">'</span><br><span class="line">              `-.__.-'</span></span><br><span class="line"></span><br><span class="line">9590:X 21 Jun 15:36:36.222 <span class="comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></span><br><span class="line">9590:X 21 Jun 15:36:36.223 <span class="comment"># Sentinel ID is 54add3cbee8adc68b5b89f808a560a7425fd5166</span></span><br><span class="line">9590:X 21 Jun 15:36:36.223 <span class="comment"># +monitor master mymaster 192.168.1.173 6379 quorum 2</span></span><br><span class="line">9590:X 21 Jun 15:36:41.262 <span class="comment"># +sdown master mymaster 192.168.1.173 6379</span></span><br><span class="line">9590:X 21 Jun 15:36:41.262 <span class="comment"># +sdown sentinel a3a6df103a7acaa56e4e6e9af63808dc9b525d1e 192.168.1.174 26379 @ mymaster 192.168.1.173 6379</span></span><br><span class="line">9590:X 21 Jun 15:36:41.262 <span class="comment"># +sdown sentinel ec452bf207d6cc720d3289180f66e9fa5a945f67 192.168.1.173 26379 @ mymaster 192.168.1.173 6379</span></span><br></pre></td></tr></table></figure>
<p>日志我先开着，然后我们关闭master<br>这里我们都先关闭服务：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">master:</span><br><span class="line"></span><br><span class="line">[root@LAN_redis1 etc]<span class="comment">#  /usr/local/redis-3.2.1/src/redis-cli -a ghost+db@hz2016 -n 6379 shutdown</span></span><br><span class="line"></span><br><span class="line">然后在去查看sentinel 机器信息：</span><br><span class="line">[root@sentinel redis-3.2.1]<span class="comment">#  /usr/local/redis-3.2.1/src/redis-cli -a ghost+db@hz2016 -p 6379 info Replication</span></span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:192.168.1.174</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:down</span><br><span class="line">master_last_io_seconds_ago:-1</span><br><span class="line">master_sync_<span class="keyword">in</span>_progress:0</span><br><span class="line">slave_repl_offset:1</span><br><span class="line">master_link_down_since_seconds:1466495392</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_<span class="built_in">read</span>_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_repl_offset:0</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br></pre></td></tr></table></figure>
<p>这里master 已经主观转移</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:192.168.1.174</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:-1</span><br><span class="line">master_sync_<span class="keyword">in</span>_progress:0</span><br><span class="line">slave_repl_offset:673</span><br><span class="line">master_link_down_since_seconds:49</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_<span class="built_in">read</span>_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_repl_offset:0</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br></pre></td></tr></table></figure>
<p>防火墙配置：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-A INPUT -p tcp -m state --state NEW -m tcp --dport 6379 -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m state --state NEW -m tcp --dport 26379 -j ACCEPT</span><br></pre></td></tr></table></figure>
<h3 id="启动Sentinel"><a href="#启动Sentinel" class="headerlink" title="启动Sentinel"></a>启动Sentinel</h3><p>使用–sentinel参数启动，并必须指定一个对应的配置文件，系统会使用配置文件来保存 Sentinel 的当前状态， 并在 Sentinel 重启时通过载入配置文件来进行状态还原。</p>
<pre><code>redis-server /etc/sentinel.conf --sentinel
</code></pre><p>使用TCP端口26379，可以使用redis-cli或其他任何客户端与其通讯。</p>
<p>如果启动 Sentinel 时没有指定相应的配置文件， 或者指定的配置文件不可写（not writable）， 那么 Sentinel 会拒绝启动。</p>
<p>这里提个说明：</p>
<h3 id="外网访问连不上解错误分析及解决办法"><a href="#外网访问连不上解错误分析及解决办法" class="headerlink" title="外网访问连不上解错误分析及解决办法"></a>外网访问连不上解错误分析及解决办法</h3><p>错误的原因很简单，就是没有连接上redis服务，由于redis采用的安全策略，默认会只准许本地访问。需要通过简单配置，完成允许外网访问。<br>修改redis的配置文件，将所有bind信息全部屏蔽。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># bind 192.168.1.100 10.0.0.1</span></span><br><span class="line"><span class="comment"># bind 192.168.1.8</span></span><br><span class="line"><span class="comment"># bind 127.0.0.1</span></span><br></pre></td></tr></table></figure>
<p>修改完成后，需要重新启动redis服务。</p>
<h3 id="Redis-常见问题"><a href="#Redis-常见问题" class="headerlink" title="Redis 常见问题"></a>Redis 常见问题</h3><p>最大内存问题：要设置好最大内存，以防不停的申请内存，造成系统内存都被用完。</p>
<p>Fork 进程问题： ‘vm.overcommit_memory = 1’ 这一个选项要加到系统的配置中，防止 fork 因内存不足而失败。</p>
<p>密码问题：需要设置复杂一些，防止暴力破解。</p>
<p>修改 Linux 的防火墙(iptables)，开启你的redis服务端口，默认是6379</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-A INPUT -p tcp -m state --state NEW -m tcp --dport 6379 -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m state --state NEW -m tcp --dport 26379 -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>请注意，一定要将redis的防火墙配置放在 REJECT 的前面。然后执行 service iptables restart<br>至此，访问刚刚上面的代码，就能够链接到redis服务，并且能够正确显示了。</p>
<ul>
<li>可通过info 查看当前redis的状态，默认采用info default, 可采用info all 查看所有的信息状态；</li>
<li>通过 “info cpu” 单独查看cpu的状态信息，”info memory” “info replication” “info …”</li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2015/11/20/Redis/Redis安装报错-报错搜集/" class="prev">PREV</a><a href="/2015/06/18/kvm/KVM虚拟化 (二) help帮助文档大全/" class="next">NEXT</a></div><div data-thread-key="2015/11/19/Redis/Redis-Sentinel实现redis主从集群搭建及容灾部署/" data-title="Redis主从集群搭建及容灾部署" data-url="http://blog.yangcvo.me/2015/11/19/Redis/Redis-Sentinel实现redis主从集群搭建及容灾部署/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"true"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2014 - 2016 <a href="http://blog.yangcvo.me">yangc</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yangcvo" target="_blank">Github-yangcvo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>