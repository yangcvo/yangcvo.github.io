<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Personal blog, thinking and sharing of technology and life">
    <meta name="keyword"  content="undefined">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          Redis主从集群搭建及容灾部署 - yangcvo的博客 | Chengyang&#39;s Blog
        
    </title>

    <link rel="canonical" href="http://blog.yangcvo.me/2015/11/19/数据库/Redis/Redis-Sentinel实现redis主从集群搭建及容灾部署/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Chengyang&#39;s Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/about/About-me.html">About</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="http://blog.yangcvo.me/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#Redis" title="Redis">Redis</a>
                        
                    </div>
                    <h1>Redis主从集群搭建及容灾部署</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by yangc on
                        2015-11-19
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h2 id="Redis-主从复制原理及分析"><a href="#Redis-主从复制原理及分析" class="headerlink" title="Redis-主从复制原理及分析"></a>Redis-主从复制原理及分析</h2><h3 id="Slave向Master同步的实现是："><a href="#Slave向Master同步的实现是：" class="headerlink" title="Slave向Master同步的实现是："></a>Slave向Master同步的实现是：</h3><p>Slave向Master发出同步请求（发送sync命令），Master先dump出rdb文件，然后将rdb文件全量传输给slave，然后Master把缓存的写命令转发给Slave，初次同步完成。</p>
<h3 id="以及以后的同步实现是："><a href="#以及以后的同步实现是：" class="headerlink" title="以及以后的同步实现是："></a>以及以后的同步实现是：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Master将变量的快照直接实时依次发送给各个Slave。</div><div class="line">但不管什么原因导致Slave和Master断开重连都会重复以上两个步骤的过程。</div><div class="line">Redis的主从复制是建立在内存快照的持久化基础上的，只要有Slave就一定会有内存快照发生。</div></pre></td></tr></table></figure>
<h3 id="主从复制原理总结几点："><a href="#主从复制原理总结几点：" class="headerlink" title="主从复制原理总结几点："></a>主从复制原理总结几点：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">1.Slave启动后，无论是第一次连接还是重连到Master，它都会主动发出一个SYNC命令</div><div class="line">2.当Master收到SYNC命令之后，将会执行BGSAVE(后台存盘进程)，即在后台保存数据到磁盘（rdb快照文件），同时收集所有新收到的写入和修改数据集的命令存入缓冲区（非查询类）</div><div class="line">3.Master在后台把数据保存到快照文件完成后，会传送整个数据库文件到Slave</div><div class="line">4.Slave接收到数据库文件后，会把内存清空，然后加载该文件到内存中以完成一次完全同步</div><div class="line">5.然后Master会把之前收集到缓冲区中的命令和新的修改命令依次传送给Slave</div><div class="line">6.Slave接受到之后在本地执行这些数据修改命令，从而达到最终的数据同步</div><div class="line">7.之后Master与Slave之间将会不断的通过异步方式进行命令的同步，从而保证数据的时时同步</div><div class="line">8.如果Master和Slave之间的链接出现断连，Slave可以自动重连Master。</div><div class="line"></div><div class="line">根据版本的不同，断连后同步的方式也不同：</div><div class="line"></div><div class="line">2.8之前：重连成功之后，一次全量同步操作将被自动执行</div><div class="line">2.8之后：重连成功之后，进行部分同步操作</div></pre></td></tr></table></figure>
<p><img src="http://7xrthw.com1.z0.glb.clouddn.com/redis.png" alt=""></p>
<h3 id="Redis-sentinel原理分析"><a href="#Redis-sentinel原理分析" class="headerlink" title="Redis-sentinel原理分析"></a>Redis-sentinel原理分析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Redis-sentinel是Redis实例的监控管理、通知和实例失效备援服务，是Redis集群的管理工具。在一般的分布式中心节点数据库中，Redis-sentinel的作用是中心节点的工作，监控各个其他节点的工作情况并且进行故障恢复，来提高集群的高可用性。</div><div class="line"></div><div class="line">Redis-sentinel是Redis的作者antirez在2013年6月份完成的，因为Redis实例在各个大公司的应用，每个公司都需要一个Redis集群的管理工具，被迫都自己写管理工具来管理Redis集群，antirez考虑到社区的急迫需要，花了几个星期写出了Redis-sentinel。</div></pre></td></tr></table></figure>
<h3 id="Redis-sentinel三大功能"><a href="#Redis-sentinel三大功能" class="headerlink" title="Redis-sentinel三大功能"></a>Redis-sentinel三大功能</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Redis-sentinel的三大功能：监测、通知、自动故障恢复。首先Redis-sentinel要建立一个监控的master列表，然后针对master列表的每个master获取监控其的sentinels和slaves供以后故障恢复使用。</div></pre></td></tr></table></figure>
<h3 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h3><p>网站的访问量慢慢上来了。为了网站的性能方面，开始用了redis做缓存策略。刚开始的时候，redis是一个单点，当一台机器岩机的时候，redis的 服务完全停止，这时就会影响其他服务的正常运行。费话不多说了，下面利用redis sentinel做一个主从切换的集群管理。做这个集群管理的时候，查过很多资料才完全了解，从数据类型、主从原理、持久化方式等方面着手看了不少资料，也进行了一些实践操作。redis的配置都比较简单，网络上相关资料比较多，把实践的过程记录下来以备查阅。</p>
<h3 id="补充摘要："><a href="#补充摘要：" class="headerlink" title="补充摘要："></a>补充摘要：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">redis 安装包：http://redis.io/download</div><div class="line">中文redis社区:http://redis.cn/community.html</div><div class="line">参考资料：http://redis.io/topics/sentinel</div></pre></td></tr></table></figure>
<h3 id="系统环境环境："><a href="#系统环境环境：" class="headerlink" title="系统环境环境："></a>系统环境环境：</h3><p>这里我用kvm 虚拟出三台服务器：然后搭好了环境。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">virsh <span class="comment"># list --all</span></div><div class="line"> Id      名称                        状态</div><div class="line">-------------------------------------------------</div><div class="line"> 1   redis_sentinel                 running</div><div class="line"> 2   LAN_redis2                     running</div><div class="line"> 3   LAN_redis1                     running</div></pre></td></tr></table></figure>
<p>集群配置最少需要三台机器，那么我就三台虚拟机,三台虚拟机分别安装同样的redis的环境</p>
<p>ip分别：</p>
<ul>
<li>192.168.1.172  （redis sentinel 集群监控）</li>
<li>192.168.1.173  （redis master 节点）</li>
<li>192.168.1.174  （redis slave  节点）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@sentinel ~]<span class="comment"># cat /etc/issue</span></div><div class="line">CentOS release 6.7 (Final)</div><div class="line">Kernel \r on an \m</div></pre></td></tr></table></figure>
<h3 id="redis安装配置"><a href="#redis安装配置" class="headerlink" title="redis安装配置:"></a>redis安装配置:</h3><p>下载，解压和编译Redis的：master默认配置：</p>
<h3 id="master："><a href="#master：" class="headerlink" title="master："></a>master：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">[root@LAN_redis1 ~]<span class="comment"># curl -O http://download.redis.io/releases/redis-3.2.1.tar.gz -C /tmp/.</span></div><div class="line">[root@LAN_redis1 ~]<span class="comment"># tar xzf redis-3.2.1.tar.gz -C /usr/local/.</span></div><div class="line">[root@LAN_redis1 ~]<span class="comment"># cd /usr/local/redis-3.2.1/</span></div><div class="line">[root@LAN_redis1 redis-3.2.1]<span class="comment"># make</span></div><div class="line">[root@LAN_redis1 redis-3.2.1]<span class="comment"># src/redis-server</span></div><div class="line">4772:C 20 Jun 18:43:42.681 <span class="comment"># Warning: no config file specified, using the default config. In order to specify a config file use src/redis-server /path/to/redis.conf</span></div><div class="line">                _._</div><div class="line">           _.-``__ <span class="string">''</span>-._</div><div class="line">      _.-``    `.  `_.  <span class="string">''</span>-._           Redis 3.2.1 (00000000/0) 64 bit</div><div class="line">  .-`` .-```.  ```\/    _.,_ <span class="string">''</span>-._</div><div class="line"> (    <span class="string">'      ,       .-`  | `,    )     Running in standalone mode</span></div><div class="line"> |`-._`-...-` __...-.``-._|'` _.-<span class="string">'|     Port: 6379</span></div><div class="line"> |    `-._   `._    /     _.-'    |     PID: 4772</div><div class="line">  `-._    `-._  `-./  _.-<span class="string">'    _.-'</span></div><div class="line"> |`-._`-._    `-.__.-<span class="string">'    _.-'</span>_.-<span class="string">'|</span></div><div class="line"> |    `-._`-._        _.-'_.-<span class="string">'    |           http://redis.io</span></div><div class="line">  `-._    `-._`-.__.-'_.-<span class="string">'    _.-'</span></div><div class="line"> |`-._`-._    `-.__.-<span class="string">'    _.-'</span>_.-<span class="string">'|</span></div><div class="line"> |    `-._`-._        _.-'_.-<span class="string">'    |</span></div><div class="line">  `-._    `-._`-.__.-'_.-<span class="string">'    _.-'</span></div><div class="line">      `-._    `-.__.-<span class="string">'    _.-'</span></div><div class="line">          `-._        _.-<span class="string">'</span></div><div class="line">              `-.__.-'</div><div class="line"></div><div class="line">4772:M 20 Jun 18:43:42.683 <span class="comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></div><div class="line">4772:M 20 Jun 18:43:42.683 <span class="comment"># Server started, Redis version 3.2.1</span></div><div class="line">4772:M 20 Jun 18:43:42.683 <span class="comment"># WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.</span></div><div class="line">4772:M 20 Jun 18:43:42.683 <span class="comment"># WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</span></div><div class="line">4772:M 20 Jun 18:43:42.683 * The server is now ready to accept connections on port 6379</div><div class="line">这里提醒：Ctrl+C 退出 以后执行：src/redis-server &amp;</div><div class="line">这样让服务都在后台执行。就不需要重新开启终端了。</div><div class="line"></div><div class="line"></div><div class="line">[root@LAN_redis1 redis-3.2.1]<span class="comment"># netstat -ntulp</span></div><div class="line">Active Internet connections (only servers)</div><div class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</div><div class="line">tcp        0      0 0.0.0.0:6379                0.0.0.0:*                   LISTEN      4780/src/redis-serv</div><div class="line">tcp        0      0 0.0.0.0:22                  0.0.0.0:*                   LISTEN      1381/sshd</div><div class="line">tcp        0      0 127.0.0.1:25                0.0.0.0:*                   LISTEN      1461/master</div><div class="line">tcp        0      0 :::6379                     :::*                        LISTEN      4780/src/redis-serv</div><div class="line">tcp        0      0 :::22                       :::*                        LISTEN      1381/sshd</div><div class="line">tcp        0      0 ::1:25                      :::*                        LISTEN      1461/master</div><div class="line"></div><div class="line">这里我们都先关闭服务：</div><div class="line"></div><div class="line">[root@LAN_redis1 redis-3.2.1]<span class="comment"># /usr/local/redis-3.2.1/src/redis-cli -n 6379 shutdown</span></div></pre></td></tr></table></figure>
<h3 id="redis-master-配置："><a href="#redis-master-配置：" class="headerlink" title="redis master 配置："></a>redis master 配置：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">创建日志目录</div><div class="line">[root@LAN_redis1 redis-3.2.1]<span class="comment"># mkdir /var/log/redis</span></div><div class="line">[root@LAN_redis1 redis-3.2.1]<span class="comment"># touch /var/log/redis/redis.log</span></div><div class="line">创建数据目录</div><div class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># mkdir -p /data/redis</span></div><div class="line"></div><div class="line">找到配置文件/usr/<span class="built_in">local</span>/redis-3.2.1/redis.conf</div><div class="line">[root@LAN_redis1 redis-3.2.1]<span class="comment"># vim redis.conf</span></div><div class="line">修改如下内容：</div><div class="line"><span class="comment">#bind 127.0.0.1 # 注释</span></div><div class="line">daemonize no 改为 yes <span class="comment"># 是否后台运行</span></div><div class="line">port 6379 这里端口我保持默认不做修改。</div><div class="line">logfile <span class="string">"/var/log/redis/redis.log"</span>  <span class="comment">## 添加日志保存绝对路径。</span></div><div class="line">dir /data/redis/    <span class="comment"># 数据目录 </span></div><div class="line">masterauth <span class="string">"ghost+db@hz2016"</span></div><div class="line">requirepass <span class="string">"ghost+db@hz2016"</span> 设置密码</div></pre></td></tr></table></figure>
<h3 id="slave"><a href="#slave" class="headerlink" title="slave:"></a>slave:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">[root@LAN_redis2 ~]<span class="comment"># curl -O http://download.redis.io/releases/redis-3.2.1.tar.gz -C /tmp/.</span></div><div class="line">[root@LAN_redis2 ~]<span class="comment"># tar xzf redis-3.2.1.tar.gz -C /usr/local/.</span></div><div class="line">[root@LAN_redis2 ~]<span class="comment"># cd /usr/local/redis-3.2.1/</span></div><div class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment">#  make</span></div><div class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># src/redis-server</span></div><div class="line">7263:C 20 Jun 18:46:14.140 <span class="comment"># Warning: no config file specified, using the default config. In order to specify a config file use src/redis-server /path/to/redis.conf</span></div><div class="line">                _._</div><div class="line">           _.-``__ <span class="string">''</span>-._</div><div class="line">      _.-``    `.  `_.  <span class="string">''</span>-._           Redis 3.2.1 (00000000/0) 64 bit</div><div class="line">  .-`` .-```.  ```\/    _.,_ <span class="string">''</span>-._</div><div class="line"> (    <span class="string">'      ,       .-`  | `,    )     Running in standalone mode</span></div><div class="line"> |`-._`-...-` __...-.``-._|'` _.-<span class="string">'|     Port: 6379</span></div><div class="line"> |    `-._   `._    /     _.-'    |     PID: 7263</div><div class="line">  `-._    `-._  `-./  _.-<span class="string">'    _.-'</span></div><div class="line"> |`-._`-._    `-.__.-<span class="string">'    _.-'</span>_.-<span class="string">'|</span></div><div class="line"> |    `-._`-._        _.-'_.-<span class="string">'    |           http://redis.io</span></div><div class="line">  `-._    `-._`-.__.-'_.-<span class="string">'    _.-'</span></div><div class="line"> |`-._`-._    `-.__.-<span class="string">'    _.-'</span>_.-<span class="string">'|</span></div><div class="line"> |    `-._`-._        _.-'_.-<span class="string">'    |</span></div><div class="line">  `-._    `-._`-.__.-'_.-<span class="string">'    _.-'</span></div><div class="line">      `-._    `-.__.-<span class="string">'    _.-'</span></div><div class="line">          `-._        _.-<span class="string">'</span></div><div class="line">              `-.__.-'</div><div class="line"></div><div class="line">7263:M 20 Jun 18:46:14.142 <span class="comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></div><div class="line">7263:M 20 Jun 18:46:14.142 <span class="comment"># Server started, Redis version 3.2.1</span></div><div class="line">7263:M 20 Jun 18:46:14.142 <span class="comment"># WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.</span></div><div class="line">7263:M 20 Jun 18:46:14.143 <span class="comment"># WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</span></div><div class="line">7263:M 20 Jun 18:46:14.143 * The server is now ready to accept connections on port 6379</div><div class="line"></div><div class="line">这里提醒：Ctrl+C 退出 以后执行：src/redis-server &amp;</div><div class="line">这样让服务都在后台执行。就不需要重新开启终端了。</div><div class="line"></div><div class="line">测试：</div><div class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># src/redis-cli</span></div><div class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> foo bar</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; get foo</div><div class="line"><span class="string">"bar"</span></div><div class="line">127.0.0.1:6379&gt;</div><div class="line"></div><div class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># netstat -ntulp</span></div><div class="line">Active Internet connections (only servers)</div><div class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</div><div class="line">tcp        0      0 0.0.0.0:6379                0.0.0.0:*                   LISTEN      7266/src/redis-serv</div><div class="line">tcp        0      0 0.0.0.0:22                  0.0.0.0:*                   LISTEN      3810/sshd</div><div class="line">tcp        0      0 127.0.0.1:25                0.0.0.0:*                   LISTEN      1363/master</div><div class="line">tcp        0      0 :::6379                     :::*                        LISTEN      7266/src/redis-serv</div><div class="line">tcp        0      0 :::22                       :::*                        LISTEN      3810/sshd</div><div class="line">tcp        0      0 ::1:25                      :::*                        LISTEN      1363/master</div></pre></td></tr></table></figure>
<h3 id="redis-slave-配置："><a href="#redis-slave-配置：" class="headerlink" title="redis slave 配置："></a>redis slave 配置：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">创建日志目录</div><div class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># mkdir /var/log/redis</span></div><div class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># touch /var/log/redis/redis.log</span></div><div class="line">创建数据目录</div><div class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># mkdir -p /data/redis</span></div><div class="line">找到配置文件/usr/<span class="built_in">local</span>/redis-3.2.1/redis.conf</div><div class="line"></div><div class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># vim redis.conf</span></div><div class="line">修改如下内容：</div><div class="line"><span class="comment">#bind 127.0.0.1 # 注释</span></div><div class="line">daemonize no 改为 yes <span class="comment"># 是否后台运行</span></div><div class="line">port 6379 这里端口我保持默认不做修改。</div><div class="line">logfile <span class="string">"/var/log/redis/redis.log"</span>  <span class="comment">## 添加日志保存绝对路径。</span></div><div class="line">dir /data/redis/    <span class="comment"># 数据目录 </span></div><div class="line">slaveof  192.168.1.173 6379  <span class="comment"># slaveof master的ip master的端口 设置当本机为 slav 服务时，设置 master 服务的 IP 地址及端口，在 Redis 启动时，它会自动从 master 进行数据同步</span></div><div class="line">masterauth <span class="string">"ghost+db@hz2016"</span>   <span class="comment">## 当 master 服务设置了密码保护时， slav 服务连接 master 的密码</span></div><div class="line">requirepass <span class="string">"ghost+db@hz2016"</span>  设置密码</div></pre></td></tr></table></figure>
<h3 id="配置附件：剩下的后面默认就好"><a href="#配置附件：剩下的后面默认就好" class="headerlink" title="配置附件：剩下的后面默认就好."></a>配置附件：剩下的后面默认就好.</h3><p>这里主从我设置了密码：master和slave 都需要设置密码，不然同步不成功。<br>不成功报错日志：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">8395:S 21 Jun 14:09:22.073 * MASTER &lt;-&gt; SLAVE sync started</div><div class="line">8395:S 21 Jun 14:09:22.073 <span class="comment"># Error condition on socket for SYNC: Connection refused</span></div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">protected-mode yes  </div><div class="line">port 6379        <span class="comment"># 监听端口</span></div><div class="line">tcp-backlog 511   <span class="comment"># TCP接收队列长度，受/proc/sys/net/core/somaxconn和tcp_max_syn_backlog这两个内核参数的影响</span></div><div class="line">timeout 0         <span class="comment">## 一个客户端空闲多少秒后关闭连接(0代表禁用，永不关闭)</span></div><div class="line">tcp-keepalive 300</div><div class="line">daemonize yes     <span class="comment"># 守护进程模式</span></div><div class="line">supervised no</div><div class="line">pidfile /var/run/redis_6379.pid</div><div class="line">masterauth <span class="string">"ghost+db@hz2016"</span>  <span class="comment"># 当master服务设置了密码保护时，slav服务连接master的密码</span></div><div class="line">loglevel notice</div><div class="line">logfile <span class="string">"/var/log/redis/redis.log"</span>  <span class="comment"># 指明日志文件名</span></div><div class="line">databases 16</div><div class="line">save 900 1 <span class="comment">## 900秒内有1次修改将会保存</span></div><div class="line">save 300 10 <span class="comment">## 300秒内有10次修改将会保存</span></div><div class="line">save 60 10000 <span class="comment">## 60秒内有10000次修改保存</span></div><div class="line">stop-writes-on-bgsave-error yes  <span class="comment"># 默认如果开启RDB快照(至少一条save指令)并且最新的后台保存失败，Redis将会停止接受写操作</span></div><div class="line"><span class="comment"># 这将使用户知道数据没有正确的持久化到硬盘，否则可能没人注意到并且造成一些灾难</span></div><div class="line">rdbcompression yes <span class="comment">## 开启rdb压缩</span></div><div class="line">rdbchecksum yes  <span class="comment"># 版本5的RDB有一个CRC64算法的校验和放在了文件的最后。这将使文件格式更加可靠。</span></div><div class="line">dbfilename dump.rdb <span class="comment">## DB名字</span></div><div class="line">dir  /data/redis/    <span class="comment">## 工作目录，一定要指定</span></div><div class="line">requirepass <span class="string">"ghost+db@hz2016"</span> 设置redis访问的密码 <span class="comment"># 密码验证</span></div><div class="line"><span class="comment"># 警告：因为Redis太快了，所以外面的人可以尝试每秒150k的密码来试图破解密码。这意味着你需要</span></div><div class="line"><span class="comment"># 一个高强度的密码，否则破解太容易了</span></div><div class="line">slave-serve-stale-data yes</div><div class="line">slave-read-only yes</div><div class="line">repl-diskless-sync no</div><div class="line">repl-diskless-sync-delay 5</div><div class="line">repl-disable-tcp-nodelay no</div><div class="line">slave-priority 100</div><div class="line">appendonly no</div><div class="line">appendfilename <span class="string">"appendonly.aof"</span></div><div class="line">appendfsync everysec</div><div class="line">no-appendfsync-on-rewrite no</div><div class="line">auto-aof-rewrite-percentage 100</div><div class="line">auto-aof-rewrite-min-size 64mb</div><div class="line">aof-load-truncated yes</div><div class="line">lua-time-limit 5000</div><div class="line">slowlog-log-slower-than 10000</div><div class="line">slowlog-max-len 128</div><div class="line">latency-monitor-threshold 0</div><div class="line">notify-keyspace-events <span class="string">""</span></div><div class="line"><span class="built_in">hash</span>-max-ziplist-entries 512</div><div class="line"><span class="built_in">hash</span>-max-ziplist-value 64</div><div class="line">list-max-ziplist-size -2</div><div class="line">list-compress-depth 0</div><div class="line"><span class="built_in">set</span>-max-intset-entries 512</div><div class="line">zset-max-ziplist-entries 128</div><div class="line">zset-max-ziplist-value 64</div><div class="line">hll-sparse-max-bytes 3000</div><div class="line">activerehashing yes</div><div class="line">client-output-buffer-limit normal 0 0 0</div><div class="line">client-output-buffer-limit slave 256mb 64mb 60</div><div class="line">client-output-buffer-limit pubsub 32mb 8mb 60</div><div class="line">hz 10</div><div class="line">aof-rewrite-incremental-fsync yes</div></pre></td></tr></table></figure>
<h3 id="启动master："><a href="#启动master：" class="headerlink" title="启动master："></a>启动master：</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@LAN_redis1 redis-<span class="number">3.2</span><span class="meta">.1</span>]# /usr/local/redis-<span class="number">3.2</span><span class="meta">.1</span>/src/redis-server /usr/local/redis-<span class="number">3.2</span><span class="meta">.1</span>/redis.conf &amp;</div><div class="line">[<span class="number">1</span>] <span class="number">5738</span></div><div class="line">[root@LAN_redis1 redis-<span class="number">3.2</span><span class="meta">.1</span>]#</div><div class="line">[<span class="number">1</span>]+  Done                    /usr/local/redis-<span class="number">3.2</span><span class="meta">.1</span>/src/redis-server /usr/local/redis-<span class="number">3.2</span><span class="meta">.1</span>/redis.conf</div><div class="line">[root@LAN_redis1 redis-<span class="number">3.2</span><span class="meta">.1</span>]#</div><div class="line">[root@LAN_redis1 redis-<span class="number">3.2</span><span class="meta">.1</span>]#</div><div class="line">[root@LAN_redis1 redis-<span class="number">3.2</span><span class="meta">.1</span>]# netstat -ntulp</div><div class="line">Active Internet connections (only servers)</div><div class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">192.168</span><span class="meta">.1</span><span class="meta">.173</span>:<span class="number">10050</span>         <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*                   LISTEN      <span class="number">1479</span>/zabbix_agentd</div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">6379</span>                <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*                   LISTEN      <span class="number">5739</span>/redis-server *</div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">22</span>                  <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*                   LISTEN      <span class="number">1381</span>/sshd</div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">25</span>                <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*                   LISTEN      <span class="number">1461</span>/master</div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> :::<span class="number">6379</span>                     :::*                        LISTEN      <span class="number">5739</span>/redis-server *</div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> :::<span class="number">22</span>                       :::*                        LISTEN      <span class="number">1381</span>/sshd</div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> ::<span class="number">1</span>:<span class="number">25</span>                      :::*                        LISTEN      <span class="number">1461</span>/master</div></pre></td></tr></table></figure>
<h3 id="启动-slave-："><a href="#启动-slave-：" class="headerlink" title="启动 slave ："></a>启动 slave ：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment">#/usr/local/redis-3.2.1/src/redis-server /usr/local/redis-3.2.1/redis.conf &amp;</span></div><div class="line">[1]+  Done                    /usr/<span class="built_in">local</span>/redis-3.2.1/src/redis-server /usr/<span class="built_in">local</span>/redis-3.2.1/redis.conf</div><div class="line"> </div><div class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># netstat -ntulp</span></div><div class="line">Active Internet connections (only servers)</div><div class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</div><div class="line">tcp        0      0 192.168.1.174:10050         0.0.0.0:*                   LISTEN      3998/zabbix_agentd</div><div class="line">tcp        0      0 0.0.0.0:6379                0.0.0.0:*                   LISTEN      8192/redis-server *</div><div class="line">tcp        0      0 0.0.0.0:22                  0.0.0.0:*                   LISTEN      3810/sshd</div><div class="line">tcp        0      0 127.0.0.1:25                0.0.0.0:*                   LISTEN      1363/master</div><div class="line">tcp        0      0 :::6379                     :::*                        LISTEN      8192/redis-server *</div><div class="line">tcp        0      0 :::22                       :::*                        LISTEN      3810/sshd</div><div class="line">tcp        0      0 ::1:25                      :::*                        LISTEN      1363/master</div></pre></td></tr></table></figure>
<h3 id="主从测试并查看数据同步情况："><a href="#主从测试并查看数据同步情况：" class="headerlink" title="主从测试并查看数据同步情况："></a>主从测试并查看数据同步情况：</h3><p>master :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@LAN_redis1 redis-3.2.1]<span class="comment"># /usr/local/redis-3.2.1/src/redis-cli</span></div><div class="line">127.0.0.1:6379&gt;</div><div class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> name <span class="built_in">test</span></div><div class="line">(error) NOAUTH Authentication required.</div><div class="line">127.0.0.1:6379&gt; auth ghost+db@hz2016</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> name <span class="built_in">test</span></div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; save</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> aa 123</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; get aa</div><div class="line"><span class="string">"123"</span></div></pre></td></tr></table></figure>
<p>slave:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># /usr/local/redis-3.2.1/src/redis-cli</span></div><div class="line">127.0.0.1:6379&gt;</div><div class="line">127.0.0.1:6379&gt;</div><div class="line">127.0.0.1:6379&gt; get aa</div><div class="line">(error) NOAUTH Authentication required.</div><div class="line">127.0.0.1:6379&gt; auth ghost+db@hz2016</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; get aa</div><div class="line"><span class="string">"123"</span></div><div class="line">127.0.0.1:6379&gt;</div><div class="line">127.0.0.1:6379&gt; get name</div><div class="line"><span class="string">"test"</span></div></pre></td></tr></table></figure>
<h3 id="查看主从关系："><a href="#查看主从关系：" class="headerlink" title="查看主从关系："></a>查看主从关系：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">[root@LAN_redis1 etc]<span class="comment">#  /usr/local/redis-3.2.1/src/redis-cli -a ghost+db@hz2016 -p 6379 info Replication</span></div><div class="line"><span class="comment"># Replication</span></div><div class="line">role:master</div><div class="line">connected_slaves:2</div><div class="line">slave0:ip=192.168.1.174,port=6379,state=online,offset=57,lag=1</div><div class="line">slave1:ip=192.168.1.172,port=6379,state=online,offset=43,lag=1</div><div class="line">master_repl_offset:57</div><div class="line">repl_backlog_active:1</div><div class="line">repl_backlog_size:1048576</div><div class="line">repl_backlog_first_byte_offset:2</div><div class="line">repl_backlog_histlen:56</div><div class="line">``` </div><div class="line">这里两slave，因为我把哨兵也加上了。</div><div class="line"><span class="comment">### 安装Redis Sentinel配置 </span></div><div class="line">Sentinel是一个管理多个redis实例的工具，它可以实现对redis的监控、通知、自动故障转移。</div><div class="line"></div><div class="line">sentinel不断的检测redis实例是否可以正常工作，通过API向其他程序报告redis的状态，如果redis master不能工作，则会自动启动故障转移进程，将其中的一个slave提升为master，其他的slave重新设置新的master实例。也就是说，它提供了：</div><div class="line"></div><div class="line">监控（Monitoring）： Sentinel 会不断地检查你的主实例和从实例是否正常。</div><div class="line">通知（Notification）： 当被监控的某个 Redis 实例出现问题时， Sentinel 进程可</div><div class="line">以通过 API 向管理员或者其他应用程序发送通知。</div><div class="line"></div><div class="line">自动故障迁移（Automatic failover）： 当一个主redis实例失效时， Sentinel 会开始记性一次failover， 它会将失效主实例的其中一个从实例升级为新的主实例， 并让失效主实例的其他从实例改为复制新的主实例； 而当客户端试图连接失效的主实例时， 集群也会向客户端返回新主实例的地址， 使得集群可以使用新主实例代替失效实例。</div><div class="line">Redis Sentinel自身也是一个分布式系统， 你可以在一个架构中运行多个 Sentinel 进程， 这些进程使用流言协议（gossip protocols)来接收关于主Redis实例是否失效的信息， 然后使用投票协议来决定是否执行自动failover，以及评选出从Redis实例作为新的主Redis实例。</div><div class="line"></div><div class="line">同样在192.168.1.172 安装最新版的3.2.1 redis</div><div class="line"><span class="comment">### 启动sentinel的方法</span></div><div class="line">当前Redis stable版已经自带了redis-sentinel这个工具。虽然 Redis Sentinel 已经提供了一个单独的可执行文件 redis-sentinel ， 但实际上它只是一个运行在特殊模式下的 Redis实例， 你可以在启动一个普通 Redis实例时通过给定 –sentinel 选项来启动 Redis Sentinel 实例。也就是说：</div><div class="line">             </div><div class="line">    redis-sentinel /etc/sentinel.conf</div><div class="line">等同于</div><div class="line">     </div><div class="line">    redis-server /etc/sentinel.conf --sentinel</div><div class="line"></div><div class="line">其中sentinel.conf是redis的配置文件，Redis sentinel会需要写入配置文件来保存sentinel的当前状态。当配置文件无法写入时，Sentinel启动失败。并正确设置防火墙.</div><div class="line"></div><div class="line"><span class="comment">### sentinel部署须知</span></div><div class="line">一个稳健的redis集群，应该使用至少三个sentinel实例，并且保证讲这些实例放到不同的机器上，甚至不同的物理区域。</div><div class="line">sentinel无法保证强一致性, 大概分布式环境都会有这方面的权衡.</div><div class="line">确保client库支持sentinel.</div><div class="line">sentinel需要通过不断的测试和观察，才能保证高可用。</div><div class="line">sentinel配合docker使用时，要注意端口映射带来的影响.</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">``` bash </div><div class="line">安装好了redis </div><div class="line">[root@sentinel redis-3.2.1]<span class="comment"># cp /usr/local/redis-3.2.1/sentinel.conf /etc/sentinel.conf</span></div><div class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># cp /usr/local/redis-3.2.1/sentinel.conf /etc/sentinel.conf</span></div><div class="line">[root@LAN_redis1 redis-3.2.1]<span class="comment"># cp /usr/local/redis-3.2.1/sentinel.conf /etc/sentinel.conf</span></div><div class="line">机器所有都拷贝一份,创建下面文件目录。</div><div class="line">[root@sentinel redis-3.2.1]<span class="comment"># touch /var/log/redis/sentinel.log</span></div><div class="line">[root@sentinel redis-3.2.1]<span class="comment"># touch /var/run/sentinel.pid</span></div></pre></td></tr></table></figure>
<p>配置:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">port 26379</div><div class="line">daemonize yes</div><div class="line">logfile <span class="string">"/var/log/redis/sentinel.log"</span></div><div class="line">pidfile <span class="string">"/var/run/sentinel.pid"</span></div><div class="line">dir <span class="string">"/tmp"</span></div><div class="line"></div><div class="line"><span class="comment">#Master 6379</span></div><div class="line">sentinel monitor mymaster 192.168.1.173 6379 2   </div><div class="line">sentinel down-after-milliseconds mymaster 5000</div><div class="line">sentinel parallel-syncs mymaster 10000        </div><div class="line">sentinel auth-pass mymaster redis4Hz@2015</div><div class="line">sentinel parallel-syncs mymaster 1</div><div class="line">sentinel failover-timeout mymaster 180000</div></pre></td></tr></table></figure>
<p>其他两台一样配置。<br>启动3个sentinel节点。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@LAN_redis1 etc]<span class="comment"># /usr/local/redis-3.2.1/src/redis-sentinel /etc/sentinel.conf  --sentinel</span></div></pre></td></tr></table></figure>
<p>查看节点是否都已经启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@LAN_redis1 etc]<span class="comment">#  ps -ef | grep redis-sentinel</span></div><div class="line">root      5992     1  0 15:06 ?        00:00:00 /usr/<span class="built_in">local</span>/redis-3.2.1/src/redis-sentinel *:26379 [sentinel]</div><div class="line">root      5996  5574  0 15:07 pts/1    00:00:00 grep redis-sentinel</div></pre></td></tr></table></figure>
<p>然后查看日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@sentinel redis-3.2.1]<span class="comment"># tailf /var/log/redis/sentinel.log</span></div><div class="line"> |    `-._`-._        _.-<span class="string">'_.-'</span>    |</div><div class="line">  `-._    `-._`-.__.-<span class="string">'_.-'</span>    _.-<span class="string">'</span></div><div class="line">      `-._    `-.__.-'    _.-<span class="string">'</span></div><div class="line">          `-._        _.-'</div><div class="line">              `-.__.-<span class="string">'</span></div><div class="line"></div><div class="line">9541:X 21 Jun 15:05:15.398 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</div><div class="line">9541:X 21 Jun 15:05:15.406 # Sentinel ID is c1143e64b85a9ce321d4b33c5b463b7958477f37</div><div class="line">9541:X 21 Jun 15:05:15.406 # +monitor master mymaster 192.168.1.173 6379 quorum 2</div><div class="line">9541:X 21 Jun 15:05:20.406 # +sdown master mymaster 192.168.1.173 6379</div></pre></td></tr></table></figure>
<p>这里的ID 在看看/etc/sentinel 的配置。</p>
<h3 id="哨兵一配置-参考：sentinel1-conf"><a href="#哨兵一配置-参考：sentinel1-conf" class="headerlink" title="哨兵一配置 参考：sentinel1.conf"></a>哨兵一配置 参考：sentinel1.conf</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Example sentinel.conf</span></div><div class="line"></div><div class="line"><span class="comment"># port &lt;sentinel-port&gt;</span></div><div class="line">port 26371</div><div class="line"></div><div class="line"><span class="comment"># 守护进程模式</span></div><div class="line">daemonize yes</div><div class="line"></div><div class="line"><span class="comment"># 指明日志文件名</span></div><div class="line">logfile <span class="string">"/var/log/redis/sentinel.log"</span></div><div class="line"></div><div class="line"><span class="comment"># 工作路径，sentinel一般指定/tmp比较简单</span></div><div class="line">dir /tmp</div><div class="line"></div><div class="line"><span class="comment"># 哨兵监控这个master，在至少quorum个哨兵实例都认为master down后把master标记为odown</span></div><div class="line"><span class="comment"># （objective down客观down；相对应的存在sdown，subjective down，主观down）状态。</span></div><div class="line"><span class="comment"># slaves是自动发现，所以你没必要明确指定slaves。</span></div><div class="line">sentinel monitor TestMaster 127.0.0.1 7003 1</div><div class="line"></div><div class="line"><span class="comment"># master或slave多长时间（默认30秒）不能使用后标记为s_down状态。</span></div><div class="line">sentinel down-after-milliseconds TestMaster 1500</div><div class="line"></div><div class="line"><span class="comment"># 若sentinel在该配置值内未能完成failover操作（即故障时master/slave自动切换），则认为本次failover失败。</span></div><div class="line">sentinel failover-timeout TestMaster 10000</div><div class="line"></div><div class="line"><span class="comment"># 设置master和slaves验证密码</span></div><div class="line">sentinel auth-pass TestMaster 0234kz9*l</div><div class="line"></div><div class="line">sentinel config-epoch TestMaster 15</div><div class="line">sentinel leader-epoch TestMaster 8394</div><div class="line"></div><div class="line"><span class="comment"># #除了当前哨兵, 还有哪些在监控这个master的哨兵</span></div><div class="line">sentinel known-sentinel TestMaster 127.0.0.1 26372 0aca3a57038e2907c8a07be2b3c0d15171e44da5</div><div class="line">sentinel known-sentinel TestMaster 127.0.0.1 26373 ac1ef015411583d4b9f3d81cee830060b2f29862</div><div class="line"></div><div class="line">sentinel current-epoch 8394</div></pre></td></tr></table></figure>
<p>master：sentinel.conf配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">port 26379</div><div class="line">daemonize yes</div><div class="line">logfile <span class="string">"/var/log/redis/sentinel.log"</span></div><div class="line">pidfile <span class="string">"/var/run/sentinel.pid"</span></div><div class="line">dir <span class="string">"/tmp"</span></div><div class="line"><span class="comment">#Master 6379</span></div><div class="line">sentinel monitor mymaster 192.168.1.173 6379 2</div><div class="line">sentinel down-after-milliseconds mymaster 5000</div><div class="line">sentinel auth-pass mymaster redis4Hz@2015</div><div class="line">sentinel config-epoch mymaster 2919</div><div class="line">sentinel leader-epoch mymaster 2919</div><div class="line"><span class="comment"># Generated by CONFIG REWRITE</span></div><div class="line">sentinel known-sentinel mymaster 192.168.1.174 26379 a3a6df103a7acaa56e4e6e9af63808dc9b525d1e</div><div class="line">sentinel known-sentinel mymaster 192.168.1.172 26379 c1143e64b85a9ce321d4b33c5b463b7958477f37</div><div class="line">sentinel current-epoch 2926</div></pre></td></tr></table></figure>
<p>slave : sentinel.conf配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">port 26379</div><div class="line">daemonize yes</div><div class="line">logfile <span class="string">"/var/log/redis/sentinel.log"</span></div><div class="line">pidfile <span class="string">"/var/run/sentinel.pid"</span></div><div class="line">dir <span class="string">"/tmp"</span></div><div class="line"></div><div class="line"><span class="comment">#Master 6379</span></div><div class="line">sentinel monitor mymaster 192.168.1.173 6379 2</div><div class="line">sentinel down-after-milliseconds mymaster 5000</div><div class="line">sentinel auth-pass mymaster redis4Hz@2015</div><div class="line">sentinel config-epoch mymaster 2919</div><div class="line">sentinel leader-epoch mymaster 2918</div><div class="line"><span class="comment"># Generated by CONFIG REWRITE</span></div><div class="line">sentinel known-sentinel mymaster 192.168.1.173 26379 ec452bf207d6cc720d3289180f66e9fa5a945f67</div><div class="line">sentinel known-sentinel mymaster 192.168.1.172 26379 c1143e64b85a9ce321d4b33c5b463b7958477f37</div><div class="line">sentinel current-epoch 2926</div></pre></td></tr></table></figure>
<p>sentinel sentinel.conf配置：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">port <span class="number">26379</span></div><div class="line">daemonize yes</div><div class="line">logfile <span class="string">"/var/log/redis/sentinel.log"</span></div><div class="line">pidfile <span class="string">"/var/run/sentinel.pid"</span></div><div class="line">dir <span class="string">"/tmp"</span></div><div class="line"></div><div class="line">#Master <span class="number">6379</span></div><div class="line">sentinel monitor mymaster <span class="number">192.168</span><span class="number">.1</span><span class="number">.173</span> <span class="number">6379</span> <span class="number">2</span></div><div class="line">sentinel down-after-milliseconds mymaster <span class="number">5000</span></div><div class="line">sentinel auth-pass mymaster redis4Hz@<span class="number">2015</span></div><div class="line">sentinel config-epoch mymaster <span class="number">2919</span></div><div class="line">sentinel leader-epoch mymaster <span class="number">2926</span></div><div class="line"># Generated by CONFIG REWRITE</div><div class="line">sentinel known-sentinel mymaster <span class="number">192.168</span><span class="number">.1</span><span class="number">.174</span> <span class="number">26379</span> a3a6df103a7acaa56e4e6e9af63808dc9b525d1e</div><div class="line">sentinel known-sentinel mymaster <span class="number">192.168</span><span class="number">.1</span><span class="number">.173</span> <span class="number">26379</span> ec452bf207d6cc720d3289180f66e9fa5a945f67</div><div class="line">sentinel current-epoch <span class="number">2926</span></div></pre></td></tr></table></figure>
<p>然后在重新启动一遍。</p>
<p>然后在查看下每台日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">master :</div><div class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># tailf /var/log/redis/sentinel.log</span></div><div class="line">      `-._    `-.__.-<span class="string">'    _.-'</span></div><div class="line">          `-._        _.-<span class="string">'</span></div><div class="line">              `-.__.-'</div><div class="line"></div><div class="line">8510:X 21 Jun 15:36:41.973 <span class="comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></div><div class="line">8510:X 21 Jun 15:36:41.974 <span class="comment"># Sentinel ID is 59bd001bd3a719a2a53669db766ff6caf93cca33</span></div><div class="line">8510:X 21 Jun 15:36:41.974 <span class="comment"># +monitor master mymaster 192.168.1.173 6379 quorum 2</span></div><div class="line">8510:X 21 Jun 15:36:46.999 <span class="comment"># +sdown master mymaster 192.168.1.173 6379</span></div><div class="line">8510:X 21 Jun 15:36:47.000 <span class="comment"># +sdown sentinel c1143e64b85a9ce321d4b33c5b463b7958477f37 192.168.1.172 26379 @ mymaster 192.168.1.173 6379</span></div><div class="line">8510:X 21 Jun 15:36:47.000 <span class="comment"># +sdown sentinel ec452bf207d6cc720d3289180f66e9fa5a945f67 192.168.1.173 26379 @ mymaster 192.168.1.173 6379</span></div><div class="line"></div><div class="line">slave :</div><div class="line">master:</div><div class="line"></div><div class="line">[root@LAN_redis2 redis-3.2.1]<span class="comment"># tailf /var/log/redis/sentinel.log</span></div><div class="line">      `-._    `-.__.-<span class="string">'    _.-'</span></div><div class="line">          `-._        _.-<span class="string">'</span></div><div class="line">              `-.__.-'</div><div class="line"></div><div class="line">8510:X 21 Jun 15:36:41.973 <span class="comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></div><div class="line">8510:X 21 Jun 15:36:41.974 <span class="comment"># Sentinel ID is 59bd001bd3a719a2a53669db766ff6caf93cca33</span></div><div class="line">8510:X 21 Jun 15:36:41.974 <span class="comment"># +monitor master mymaster 192.168.1.173 6379 quorum 2</span></div><div class="line">8510:X 21 Jun 15:36:46.999 <span class="comment"># +sdown master mymaster 192.168.1.173 6379</span></div><div class="line">8510:X 21 Jun 15:36:47.000 <span class="comment"># +sdown sentinel c1143e64b85a9ce321d4b33c5b463b7958477f37 192.168.1.172 26379 @ mymaster 192.168.1.173 6379</span></div><div class="line">8510:X 21 Jun 15:36:47.000 <span class="comment"># +sdown sentinel ec452bf207d6cc720d3289180f66e9fa5a945f67 192.168.1.173 26379 @ mymaster 192.168.1.173 6379</span></div><div class="line"></div><div class="line">sentinel:</div><div class="line">[root@sentinel redis-3.2.1]<span class="comment"># tailf /var/log/redis/sentinel.log</span></div><div class="line">      `-._    `-.__.-<span class="string">'    _.-'</span></div><div class="line">          `-._        _.-<span class="string">'</span></div><div class="line">              `-.__.-'</div><div class="line"></div><div class="line">9590:X 21 Jun 15:36:36.222 <span class="comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></div><div class="line">9590:X 21 Jun 15:36:36.223 <span class="comment"># Sentinel ID is 54add3cbee8adc68b5b89f808a560a7425fd5166</span></div><div class="line">9590:X 21 Jun 15:36:36.223 <span class="comment"># +monitor master mymaster 192.168.1.173 6379 quorum 2</span></div><div class="line">9590:X 21 Jun 15:36:41.262 <span class="comment"># +sdown master mymaster 192.168.1.173 6379</span></div><div class="line">9590:X 21 Jun 15:36:41.262 <span class="comment"># +sdown sentinel a3a6df103a7acaa56e4e6e9af63808dc9b525d1e 192.168.1.174 26379 @ mymaster 192.168.1.173 6379</span></div><div class="line">9590:X 21 Jun 15:36:41.262 <span class="comment"># +sdown sentinel ec452bf207d6cc720d3289180f66e9fa5a945f67 192.168.1.173 26379 @ mymaster 192.168.1.173 6379</span></div></pre></td></tr></table></figure>
<p>日志我先开着，然后我们关闭master<br>这里我们都先关闭服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">master:</div><div class="line"></div><div class="line">[root@LAN_redis1 etc]<span class="comment">#  /usr/local/redis-3.2.1/src/redis-cli -a ghost+db@hz2016 -n 6379 shutdown</span></div><div class="line"></div><div class="line">然后在去查看sentinel 机器信息：</div><div class="line">[root@sentinel redis-3.2.1]<span class="comment">#  /usr/local/redis-3.2.1/src/redis-cli -a ghost+db@hz2016 -p 6379 info Replication</span></div><div class="line"><span class="comment"># Replication</span></div><div class="line">role:slave</div><div class="line">master_host:192.168.1.174</div><div class="line">master_port:6379</div><div class="line">master_link_status:down</div><div class="line">master_last_io_seconds_ago:-1</div><div class="line">master_sync_in_progress:0</div><div class="line">slave_repl_offset:1</div><div class="line">master_link_down_since_seconds:1466495392</div><div class="line">slave_priority:100</div><div class="line">slave_read_only:1</div><div class="line">connected_slaves:0</div><div class="line">master_repl_offset:0</div><div class="line">repl_backlog_active:0</div><div class="line">repl_backlog_size:1048576</div><div class="line">repl_backlog_first_byte_offset:0</div><div class="line">repl_backlog_histlen:0</div></pre></td></tr></table></figure>
<p>这里master 已经主观转移</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Replication</span></div><div class="line">role:slave</div><div class="line">master_host:192.168.1.174</div><div class="line">master_port:6379</div><div class="line">master_link_status:up</div><div class="line">master_last_io_seconds_ago:-1</div><div class="line">master_sync_in_progress:0</div><div class="line">slave_repl_offset:673</div><div class="line">master_link_down_since_seconds:49</div><div class="line">slave_priority:100</div><div class="line">slave_read_only:1</div><div class="line">connected_slaves:0</div><div class="line">master_repl_offset:0</div><div class="line">repl_backlog_active:0</div><div class="line">repl_backlog_size:1048576</div><div class="line">repl_backlog_first_byte_offset:0</div><div class="line">repl_backlog_histlen:0</div></pre></td></tr></table></figure>
<p>防火墙配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-A INPUT -p tcp -m state --state NEW -m tcp --dport 6379 -j ACCEPT</div><div class="line">-A INPUT -p tcp -m state --state NEW -m tcp --dport 26379 -j ACCEPT</div></pre></td></tr></table></figure>
<h3 id="启动Sentinel"><a href="#启动Sentinel" class="headerlink" title="启动Sentinel"></a>启动Sentinel</h3><p>使用–sentinel参数启动，并必须指定一个对应的配置文件，系统会使用配置文件来保存 Sentinel 的当前状态， 并在 Sentinel 重启时通过载入配置文件来进行状态还原。</p>
<pre><code>redis-server /etc/sentinel.conf --sentinel
</code></pre><p>使用TCP端口26379，可以使用redis-cli或其他任何客户端与其通讯。</p>
<p>如果启动 Sentinel 时没有指定相应的配置文件， 或者指定的配置文件不可写（not writable）， 那么 Sentinel 会拒绝启动。</p>
<p>这里提个说明：</p>
<h3 id="外网访问连不上解错误分析及解决办法"><a href="#外网访问连不上解错误分析及解决办法" class="headerlink" title="外网访问连不上解错误分析及解决办法"></a>外网访问连不上解错误分析及解决办法</h3><p>错误的原因很简单，就是没有连接上redis服务，由于redis采用的安全策略，默认会只准许本地访问。需要通过简单配置，完成允许外网访问。<br>修改redis的配置文件，将所有bind信息全部屏蔽。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># bind 192.168.1.100 10.0.0.1</span></div><div class="line"><span class="comment"># bind 192.168.1.8</span></div><div class="line"><span class="comment"># bind 127.0.0.1</span></div></pre></td></tr></table></figure>
<p>修改完成后，需要重新启动redis服务。</p>
<h3 id="Redis-常见问题"><a href="#Redis-常见问题" class="headerlink" title="Redis 常见问题"></a>Redis 常见问题</h3><p>最大内存问题：要设置好最大内存，以防不停的申请内存，造成系统内存都被用完。</p>
<p>Fork 进程问题： ‘vm.overcommit_memory = 1’ 这一个选项要加到系统的配置中，防止 fork 因内存不足而失败。</p>
<p>密码问题：需要设置复杂一些，防止暴力破解。</p>
<p>修改 Linux 的防火墙(iptables)，开启你的redis服务端口，默认是6379</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-A INPUT -p tcp -m state --state NEW -m tcp --dport 6379 -j ACCEPT</div><div class="line">-A INPUT -p tcp -m state --state NEW -m tcp --dport 26379 -j ACCEPT</div></pre></td></tr></table></figure>
<p>请注意，一定要将redis的防火墙配置放在 REJECT 的前面。然后执行 service iptables restart<br>至此，访问刚刚上面的代码，就能够链接到redis服务，并且能够正确显示了。</p>
<ul>
<li>可通过info 查看当前redis的状态，默认采用info default, 可采用info all 查看所有的信息状态；</li>
<li>通过 “info cpu” 单独查看cpu的状态信息，”info memory” “info replication” “info …”</li>
</ul>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2015/11/20/数据库/Redis/Redis安装报错-报错搜集/" data-toggle="tooltip" data-placement="top" title="Redis安装报错总结-文件解释">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2015/11/01/自动化+可视化/saltstack/自动化运维工具--SaltStack-分组（使用记录,groups） /" data-toggle="tooltip" data-placement="top" title="自动化运维工具--SaltStack-分组（使用记录,groups）">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

            </div>
    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Redis" title="Redis">Redis</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="http://openskill.cn/" target="_blank">openskill.cn</a></li>
                    
                        <li><a href="#" target="_blank">Foo</a></li>
                    
                        <li><a href="#" target="_blank">Bar</a></li>
                    
                        <li><a href="#" target="_blank">Example Friends</a></li>
                    
                        <li><a href="#" target="_blank">It helps SEO</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>




<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "blog-yangcvo-me";
    var disqus_identifier = "http://blog.yangcvo.me/2015/11/19/数据库/Redis/Redis-Sentinel实现redis主从集群搭建及容灾部署/";
    var disqus_url = "http://blog.yangcvo.me/2015/11/19/数据库/Redis/Redis-Sentinel实现redis主从集群搭建及容灾部署/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                    <li>
                        <a target="_blank" href="https://twitter.com/yangcvox">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/benet1006">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/yangcvo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/yangcvo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Chengyang&#39;s Blog 2017 
                    <br>
                 Theme by <a href="http://blog.yangcvo.me">yangc</a>
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span>
                    Ported by <a href="http://github.com/yangcvo">Github</a>

                    <!--<iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>--> 
		</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://blog.yangcvo.me/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->


<!-- Side Catalog -->





<!-- Image to hack wechat -->
<img src="http://blog.yangcvo.me/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
