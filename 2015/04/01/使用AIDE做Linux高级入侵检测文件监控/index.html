<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 使用AIDE做Linux高级入侵检测文件监控 · Cheng yang's Blog</title><meta name="description" content="使用AIDE做Linux高级入侵检测文件监控 - yangc"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.yangcvo.me/atom.xml" title="Cheng yang's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/yangcvo" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/yangcvo" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://blog.yangcvo.me/2014/05/04/%E4%B8%AA%E4%BA%BA%E8%AE%B0%E5%BD%95/About-me/" target="_blank" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">使用AIDE做Linux高级入侵检测文件监控</h1><div class="post-info">2015年4月1日</div><div class="post-content"><h2 id="1、aide介绍"><a href="#1、aide介绍" class="headerlink" title="1、aide介绍"></a>1、aide介绍</h2><blockquote>
<p>AIDE(Adevanced Intrusion Detection Environment,高级入侵检测环境)是个入侵检测工具，主要用途是检查文本的完整性。</p>
<p>AIDE能够构造一个指定文档的数据库，他使用aide.conf作为其配置文档。AIDE数据库能够保存文档的各种属性，包括：权限(permission)、索引节点序号(inode number)、所属用户(user)、所属用户组(group)、文档大小、最后修改时间(mtime)、创建时间(ctime)、最后访问时间(atime)、增加的大小连同连接数。AIDE还能够使用下列算法：sha1、md5、rmd160、tiger，以密文形式建立每个文档的校验码或散列号。</p>
<p>常见的入侵检测软件： tripwire–操作比较复杂,aide–用以代替tripwire,比较简单.</p>
</blockquote>
<h3 id="系统环境："><a href="#系统环境：" class="headerlink" title="系统环境："></a>系统环境：</h3><p>　　RHEL 6.2 [2.6.32-220.el6.i686]</p>
<p>　　软件环境：</p>
<h3 id="2、aide安装-配置使用"><a href="#2、aide安装-配置使用" class="headerlink" title="2、aide安装 配置使用"></a>2、aide安装 配置使用</h3><p>yum rpm二进制安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum -y install aide</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我的配置文件</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mv /etc/aide.conf /etc/aide.conf.bak</span><br><span class="line">vim /etc/aide.conf</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment"># Example configuration file for AIDE.</span></span><br><span class="line">@@define DBDIR /var/lib/aide <span class="comment">#基准数据库目录</span></span><br><span class="line">@@define LOGDIR /var/<span class="built_in">log</span>/aide <span class="comment">#日志目录</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment"># The location of the database to be read.</span></span><br><span class="line">database=file:@@&#123;DBDIR&#125;/aide.db.gz <span class="comment">#基础数据库文件</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># The location of the database to be written.    #database_out=sql:host:port:database:login_name:passwd:table</span></span><br><span class="line"><span class="comment">#database_out=file:aide.db.new</span></span><br><span class="line">database_out=file:@@&#123;DBDIR&#125;/aide.db.new.gz <span class="comment">#更新数据库文件</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Whether to gzip the output to database</span></span><br><span class="line">gzip_dbout=yes</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Default.</span></span><br><span class="line">verbose=5</span><br><span class="line"> </span><br><span class="line">report_url=file:@@&#123;LOGDIR&#125;/aide.log</span><br><span class="line">report_url=stdout</span><br><span class="line"><span class="comment">#report_url=stderr</span></span><br><span class="line"><span class="comment">#NOT IMPLEMENTED report_url=mailto:root@foo.com</span></span><br><span class="line"><span class="comment">#NOT IMPLEMENTED report_url=syslog:LOG_AUTH</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># These are the default rules.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#p:      permissions</span></span><br><span class="line"><span class="comment">#i:      inode:</span></span><br><span class="line"><span class="comment">#n:      number of links</span></span><br><span class="line"><span class="comment">#u:      user</span></span><br><span class="line"><span class="comment">#g:      group</span></span><br><span class="line"><span class="comment">#s:      size</span></span><br><span class="line"><span class="comment">#b:      block count</span></span><br><span class="line"><span class="comment">#m:      mtime</span></span><br><span class="line"><span class="comment">#a:      atime</span></span><br><span class="line"><span class="comment">#c:      ctime</span></span><br><span class="line"><span class="comment">#S:      check for growing size</span></span><br><span class="line"><span class="comment">#acl:           Access Control Lists</span></span><br><span class="line"><span class="comment">#selinux        SELinux security context</span></span><br><span class="line"><span class="comment">#xattrs:        Extended file attributes</span></span><br><span class="line"><span class="comment">#md5:    md5 checksum</span></span><br><span class="line"><span class="comment">#sha1:   sha1 checksum</span></span><br><span class="line"><span class="comment">#sha256:        sha256 checksum</span></span><br><span class="line"><span class="comment">#sha512:        sha512 checksum</span></span><br><span class="line"><span class="comment">#rmd160: rmd160 checksum</span></span><br><span class="line"><span class="comment">#tiger:  tiger checksum</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#haval:  haval checksum (MHASH only)</span></span><br><span class="line"><span class="comment">#gost:   gost checksum (MHASH only)</span></span><br><span class="line"><span class="comment">#crc32:  crc32 checksum (MHASH only)</span></span><br><span class="line"><span class="comment">#whirlpool:     whirlpool checksum (MHASH only)</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">#R:              p+i+n+u+g+s+m+c+acl+selinux+xattrs+md5</span></span><br><span class="line"><span class="comment">#L:             p+i+n+u+g+acl+selinux+xattrs</span></span><br><span class="line"><span class="comment">#E:             Empty group</span></span><br><span class="line"><span class="comment">#&gt;:             Growing logfile       p+u+g+i+n+S+acl+selinux+xattrs</span></span><br><span class="line">R = p+i+n+u+g+s+m+c+acl+selinux+xattrs+md5</span><br><span class="line">L = p+i+n+u+g+acl+selinux+xattrs</span><br><span class="line">&gt; = p+u+g+i+n+S+acl+selinux+xattrs</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># You can create custom rules like this.</span></span><br><span class="line"><span class="comment"># With MHASH...</span></span><br><span class="line"><span class="comment"># ALLXTRAHASHES =      sha1+rmd160+sha256+sha512+whirlpool+tiger+haval+gost+crc32</span></span><br><span class="line">ALLXTRAHASHES = sha1+rmd160+sha256+sha512+tiger</span><br><span class="line"><span class="comment"># Everything but access time (Ie. all changes)</span></span><br><span class="line">EVERYTHING = R+ALLXTRAHASHES</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Sane, with multiple hashes</span></span><br><span class="line"><span class="comment"># NORMAL = R+rmd160+sha256+whirlpool</span></span><br><span class="line">NORMAL = R+rmd160+sha256</span><br><span class="line"> </span><br><span class="line"><span class="comment"># For directories, don't bother doing hashes</span></span><br><span class="line">DIR = p+i+n+u+g+acl+selinux+xattrs</span><br><span class="line"> </span><br><span class="line"> <span class="comment"># Access control only</span></span><br><span class="line"> PERMS = p+i+u+g+acl+selinux</span><br><span class="line"> </span><br><span class="line"> <span class="comment"># Logfile are special, in that they often change</span></span><br><span class="line"> LOG = &gt;</span><br><span class="line"> </span><br><span class="line"> <span class="comment"># Just do md5 and sha256 hashes</span></span><br><span class="line"> LSPP = R+sha256</span><br><span class="line"> </span><br><span class="line"> <span class="comment"># Some files get updated automatically, so the     inode/ctime/mtime change</span></span><br><span class="line"> <span class="comment"># but we want to know when the data inside them   changes</span></span><br><span class="line"> DATAONLY =     p+n+u+g+s+acl+selinux+xattrs+md5+sha256+rmd160+tiger</span><br><span class="line"> </span><br><span class="line"> <span class="comment"># Next decide what directories/files you want in the database.</span></span><br><span class="line"> </span><br><span class="line">/boot   NORMAL</span><br><span class="line">/bin    NORMAL</span><br><span class="line">/sbin   NORMAL</span><br><span class="line">/lib    NORMAL</span><br><span class="line">/lib64  NORMAL</span><br><span class="line">/opt    NORMAL</span><br><span class="line">/usr    NORMAL</span><br><span class="line">/root   NORMAL</span><br><span class="line"><span class="comment"># These are too volatile</span></span><br><span class="line">!/usr/src</span><br><span class="line">!/usr/tmp</span><br><span class="line">!/usr/share <span class="comment">#通过文件路径前面加感叹号 ! 排除这个路径的监控,请自定义</span></span><br><span class="line"> <span class="comment"># Check only permissions, inode, user and group for /etc, but</span></span><br><span class="line"><span class="comment"># cover some important files closely.</span></span><br><span class="line">/etc    PERMS</span><br><span class="line">!/etc/mtab</span><br><span class="line"> <span class="comment"># Ignore backup files</span></span><br><span class="line">!/etc/.*~</span><br><span class="line">/etc/exports  NORMAL</span><br><span class="line">/etc/fstab    NORMAL</span><br><span class="line">/etc/passwd   NORMAL</span><br><span class="line">/etc/group    NORMAL</span><br><span class="line">/etc/gshadow  NORMAL</span><br><span class="line">/etc/shadow   NORMAL</span><br><span class="line">/etc/security/opasswd   NORMAL</span><br><span class="line"> </span><br><span class="line">/etc/hosts.allow   NORMAL</span><br><span class="line">/etc/hosts.deny    NORMAL</span><br><span class="line"> </span><br><span class="line">/etc/sudoers NORMAL</span><br><span class="line">/etc/skel NORMAL</span><br><span class="line"> </span><br><span class="line">/etc/logrotate.d NORMAL</span><br><span class="line"> </span><br><span class="line">/etc/resolv.conf DATAONLY</span><br><span class="line"> </span><br><span class="line">/etc/nscd.conf NORMAL</span><br><span class="line">/etc/securetty NORMAL</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Shell/X starting files</span></span><br><span class="line">/etc/profile NORMAL</span><br><span class="line">/etc/bashrc NORMAL</span><br><span class="line">/etc/bash_completion.d/ NORMAL</span><br><span class="line">/etc/login.defs NORMAL</span><br><span class="line">/etc/zprofile NORMAL</span><br><span class="line">/etc/zshrc NORMAL</span><br><span class="line">/etc/zlogin NORMAL</span><br><span class="line">/etc/zlogout NORMAL</span><br><span class="line">/etc/profile.d/ NORMAL</span><br><span class="line">/etc/X11/ NORMAL</span><br><span class="line">  </span><br><span class="line"><span class="comment"># Pkg manager</span></span><br><span class="line">/etc/yum.conf NORMAL</span><br><span class="line">/etc/yumex.conf NORMAL</span><br><span class="line">/etc/yumex.profiles.conf NORMAL</span><br><span class="line">/etc/yum/ NORMAL</span><br><span class="line"> /etc/yum.repos.d/ NORMAL</span><br><span class="line"> </span><br><span class="line"> /var/<span class="built_in">log</span>   LOG</span><br><span class="line"> /var/run/utmp LOG</span><br><span class="line"> </span><br><span class="line"> <span class="comment"># This gets new/removes-old filenames daily</span></span><br><span class="line">!/var/<span class="built_in">log</span>/sa</span><br><span class="line"> <span class="comment"># As we are checking it, we've truncated     yesterdays size to zero.</span></span><br><span class="line"> !/var/<span class="built_in">log</span>/aide.log</span><br><span class="line"> </span><br><span class="line"><span class="comment"># LSPP rules...</span></span><br><span class="line"><span class="comment"># AIDE produces an audit record, so this becomes       # /var/log/audit/ LSPP</span></span><br><span class="line">/etc/audit/ LSPP</span><br><span class="line">/etc/libaudit.conf LSPP</span><br><span class="line">/usr/sbin/stunnel LSPP</span><br><span class="line">/var/spool/at LSPP</span><br><span class="line">/etc/at.allow LSPP</span><br><span class="line">/etc/at.deny LSPP</span><br><span class="line">/etc/cron.allow LSPP</span><br><span class="line">/etc/cron.deny LSPP</span><br><span class="line">/etc/cron.d/ LSPP</span><br><span class="line">/etc/cron.daily/ LSPP</span><br><span class="line">/etc/cron.hourly/ LSPP</span><br><span class="line">/etc/cron.monthly/ LSPP</span><br><span class="line">/etc/cron.weekly/ LSPP</span><br><span class="line">/etc/crontab LSPP</span><br><span class="line">/var/spool/cron/root LSPP</span><br><span class="line"> </span><br><span class="line">/etc/login.defs LSPP</span><br><span class="line">/etc/securetty LSPP</span><br><span class="line">/var/<span class="built_in">log</span>/faillog LSPP</span><br><span class="line">/var/<span class="built_in">log</span>/lastlog LSPP</span><br><span class="line"> </span><br><span class="line">/etc/hosts LSPP</span><br><span class="line">/etc/sysconfig LSPP</span><br><span class="line"> </span><br><span class="line">/etc/inittab LSPP</span><br><span class="line">/etc/grub/ LSPP</span><br><span class="line">/etc/rc.d LSPP</span><br><span class="line"> </span><br><span class="line">/etc/ld.so.conf LSPP</span><br><span class="line"> </span><br><span class="line"> /etc/localtime LSPP</span><br><span class="line"> </span><br><span class="line">/etc/sysctl.conf LSPP</span><br><span class="line"> </span><br><span class="line">/etc/modprobe.conf LSPP</span><br><span class="line"> </span><br><span class="line">/etc/pam.d LSPP</span><br><span class="line">/etc/security LSPP</span><br><span class="line">/etc/aliases LSPP</span><br><span class="line">/etc/postfix LSPP</span><br><span class="line"> </span><br><span class="line">/etc/ssh/sshd_config LSPP</span><br><span class="line"> /etc/ssh/ssh_config LSPP</span><br><span class="line"> </span><br><span class="line">/etc/stunnel LSPP</span><br><span class="line"> </span><br><span class="line">/etc/vsftpd.ftpusers LSPP</span><br><span class="line"> /etc/vsftpd LSPP</span><br><span class="line"> </span><br><span class="line">/etc/issue LSPP</span><br><span class="line">/etc/issue.net LSPP</span><br><span class="line">  </span><br><span class="line">/etc/cups LSPP</span><br><span class="line"> </span><br><span class="line"><span class="comment"># With AIDE's default verbosity level of 5, these would give lots of</span></span><br><span class="line"><span class="comment"># warnings upon tree traversal. It might change with  future version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#=/lost\+found    DIR</span></span><br><span class="line"><span class="comment">#=/home           DIR</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Ditto /var/log/sa reason...</span></span><br><span class="line">!/var/<span class="built_in">log</span>/and-httpd</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Admins dot files constantly change, just check perms</span></span><br><span class="line">/root/\..* PERMS</span><br></pre></td></tr></table></figure>
<h4 id="下一步："><a href="#下一步：" class="headerlink" title="下一步："></a>下一步：</h4><p> 初始化监控数据库(这需要一些时间)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">  /usr/sbin/aide -c /etc/aide.conf --init</span><br><span class="line">``` </span><br><span class="line">把当前初始化的数据库作为开始的基础数据库</span><br><span class="line"></span><br><span class="line">``` bash</span><br><span class="line">     cp /var/lib/aide/aide.db.new.gz       /var/lib/aide/aide.db.gz</span><br></pre></td></tr></table></figure>
<p>如果是正常的改动 更新改动到基础数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">aide --update</span><br><span class="line"><span class="built_in">cd</span> /var/lib/aide/</span><br></pre></td></tr></table></figure>
<p>覆盖替换旧的数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mv aide.db.new.gz aide.db.gz</span><br></pre></td></tr></table></figure>
<p>在终端中查看检测结果</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">aide --check</span><br></pre></td></tr></table></figure>
<p>检查文件改动 保存到文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">    aide --check --report=file:/tmp/aide-report-`date +%Y%m%d`.txt</span><br><span class="line">``` </span><br><span class="line">定时任务执行aide检测报告和自动邮件发送aide检测报告(如果没有mail, yum install mail,还需要有本地邮件服务支持, yum install sendmail;/etc/init.d/sendmail start)</span><br><span class="line">  </span><br><span class="line">``` bash</span><br><span class="line">    crontab <span class="_">-e</span></span><br><span class="line">    00 02 * * * /usr/sbin/aide -C -V4 | /bin/mail <span class="_">-s</span> <span class="string">"AIDE REPORT <span class="variable">$(date +%Y%m%d)</span>"</span>  root@localhost</span><br></pre></td></tr></table></figure>
<h3 id="5、参考"><a href="#5、参考" class="headerlink" title="5、参考"></a>5、参考</h3><ul>
<li><p>官网 :<a href="http://aide.sourceforge.net/" target="_blank" rel="external">http://aide.sourceforge.net/</a></p>
</li>
<li><p>AIDE –Linux高级入侵检测 <a href="http://gupt12.blog.51cto.com/7651206/1263183" target="_blank" rel="external">http://gupt12.blog.51cto.com/7651206/1263183</a></p>
</li>
<li><p>参考：<a href="http://www.iamle.com/archives/1664.html" target="_blank" rel="external">http://www.iamle.com/archives/1664.html</a></p>
</li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2015/06/16/kvm/KVM虚拟化(六)调整虚拟机CPU大小,添加memory内存,添加虚拟机硬盘disk,虚拟机内存减半现象/" class="prev">PREV</a><a href="/2015/02/23/CDN/CDN加速助力高并发网站架构/" class="next">NEXT</a></div><div data-thread-key="2015/04/01/使用AIDE做Linux高级入侵检测文件监控/" data-title="使用AIDE做Linux高级入侵检测文件监控" data-url="http://blog.yangcvo.me/2015/04/01/使用AIDE做Linux高级入侵检测文件监控/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"true"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2014 - 2016 <a href="http://blog.yangcvo.me">yangc</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yangcvo" target="_blank">Github-yangcvo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>